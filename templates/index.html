<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Pilot</title>
    <link rel="icon" type="image/png" href="/static/thumbnail.png">
    <link rel="apple-touch-icon" href="/static/thumbnail.png">
    <script src="{{ url_for('static', filename='vue.global.prod.min.js') }}"></script>
    <script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='tailwind.min.js') }}"></script>
    <style>
        [v-cloak] { display: none !important; }
        .chart-container { height: 500px; width: 100%; } /* Fixed height for chart */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Text Content Styling */
        .prose-sm { font-size: 0.875rem; line-height: 1.6; }
        .analysis-card { background: #ffffff; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .analysis-header { border-left: 4px solid #3b82f6; padding-left: 1rem; margin-bottom: 0.75rem; }
        .market-card { background: linear-gradient(to bottom right, #eff6ff, #ffffff); border: 1px solid #bfdbfe; }
        
        /* Button Animation */
        .btn-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Stock Card Animation */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stock-card {
            animation: fade-in-up 0.5s ease-out;
        }
        
        .stock-card:nth-child(1) { animation-delay: 0s; }
        .stock-card:nth-child(2) { animation-delay: 0.1s; }
        .stock-card:nth-child(3) { animation-delay: 0.2s; }
        .stock-card:nth-child(4) { animation-delay: 0.3s; }
        .stock-card:nth-child(5) { animation-delay: 0.4s; }
        .stock-card:nth-child(6) { animation-delay: 0.5s; }
        .stock-card:nth-child(7) { animation-delay: 0.6s; }
        .stock-card:nth-child(8) { animation-delay: 0.7s; }
        
        /* Text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Task List Animation */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* Task Item Animation */
        @keyframes task-add {
            0% {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .task-item {
            animation: task-add 0.3s ease-out;
        }
        
        /* Toast Notification */
        @keyframes toast-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toast-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: toast-slide-in 0.3s ease-out;
        }
        
        .toast-exit {
            animation: toast-slide-out 0.3s ease-out;
        }
        
        /* Button Click Animation */
        @keyframes button-click {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .btn-click-animation {
            animation: button-click 0.3s ease-out;
        }
        
        /* Loading Spinner */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Sticky Column Styles for Portfolio Table */
        tr:hover td.sticky {
            background-color: #f9fafb !important;
        }
        
        thead tr th.sticky {
            background-color: #f9fafb !important;
        }
        
        /* Task List Slide Animation */
        .task-list-slide {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Pulse Animation for New Task */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }
        
        .task-new {
            animation: pulse-glow 1.5s ease-out, task-add 0.3s ease-out;
        }
        
        /* Draggable Button Styles */
        .dragging {
            cursor: grabbing !important;
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        /* Recommendation Card Enhancements */
        .recommendation-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .recommendation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #3b82f6;
        }
        
        /* Portfolio Diagnosis Enhancements */
        .portfolio-input-group {
            position: relative;
        }
        
        .portfolio-input-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #9333ea, #ec4899);
            border-radius: 3px 0 0 3px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .portfolio-input-group:focus-within::before {
            opacity: 1;
        }
        
        .portfolio-result-card {
            background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);
            border: 2px solid #e9d5ff;
            box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.1), 0 4px 6px -2px rgba(139, 92, 246, 0.05);
        }
        
        /* Shimmer animation for buttons */
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        .animate-shimmer {
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="flex flex-col min-h-screen">
        <!-- Disclaimer Banner (Always Visible at Top) -->
        <div v-if="showDisclaimer" class="bg-gradient-to-r from-red-50 via-orange-50 to-yellow-50 border-b-2 border-red-400 shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-base font-bold text-red-900 mb-1 flex items-center gap-2">
                            <span>[[ currentLanguage === 'zh' ? '免责声明' : 'Disclaimer' ]]</span>
                        </div>
                        <div class="text-sm text-red-800 leading-relaxed">
                            [[ currentLanguage === 'zh' ? 
                                '本项目仅供学习和研究使用，不构成任何投资建议。股市有风险，投资需谨慎。' : 
                                'This project is for learning and research purposes only and does not constitute any investment advice. The stock market involves risks, and investment requires caution. Users are solely responsible for all consequences of using this system for investment decisions.' 
                            ]]
                        </div>
                    </div>
                    <button 
                        @click="closeDisclaimer"
                        class="flex-shrink-0 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full p-1 transition-colors"
                        :title="currentLanguage === 'zh' ? '关闭' : 'Close'"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Login/Register Modal -->
        <div v-if="!currentUser" class="fixed inset-0 backdrop-blur-md bg-white/30 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade-in">
                <!-- Header -->
                <div class="flex justify-center items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? '注册账户' : 'Register') : (currentLanguage === 'zh' ? '登录账户' : 'Login') ]]
                    </h2>
                </div>

                <!-- Error Message -->
                <div v-if="authError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    [[ authError ]]
                </div>

                <!-- Login/Register Form -->
                <form @submit.prevent="handleAuthSubmit">
                    <!-- Nickname (Register only) -->
                    <div v-if="isRegisterMode" class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '昵称' : 'Nickname' ]]
                        </label>
                        <input 
                            v-model="loginForm.nickname"
                            type="text"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? '请输入您的昵称' : 'Enter your nickname'"
                        >
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '邮箱' : 'Email' ]]
                        </label>
                        <input 
                            v-model="loginForm.email"
                            type="email"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? '请输入您的邮箱' : 'Enter your email'"
                        >
                    </div>

                    <!-- Password -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '密码' : 'Password' ]]
                        </label>
                        <div class="relative">
                            <input 
                                v-model="loginForm.password"
                                :type="showPassword ? 'text' : 'password'"
                                required
                                :minlength="isRegisterMode ? 6 : 1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
                                :placeholder="currentLanguage === 'zh' ? (isRegisterMode ? '至少6位密码' : '请输入密码') : (isRegisterMode ? 'At least 6 characters' : 'Enter password')"
                            >
                            <button 
                                type="button"
                                @click.prevent.stop="showPassword = !showPassword"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                            >
                                <svg v-if="showPassword" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        <span v-if="!authLoading">
                            [[ isRegisterMode ? (currentLanguage === 'zh' ? '注册' : 'Register') : (currentLanguage === 'zh' ? '登录' : 'Login') ]]
                        </span>
                        <span v-else class="flex items-center justify-center gap-2">
                            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '处理中...' : 'Processing...' ]]
                        </span>
                    </button>
                </form>

                <!-- Toggle Login/Register -->
                <div class="mt-6 text-center text-sm">
                    <span class="text-gray-600">
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? '已有账户？' : 'Already have an account?') : (currentLanguage === 'zh' ? '还没有账户？' : "Don't have an account?") ]]
                    </span>
                    <button 
                        @click="toggleAuthMode"
                        class="ml-2 text-blue-600 font-bold hover:text-blue-700 transition-colors"
                    >
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? '立即登录' : 'Login') : (currentLanguage === 'zh' ? '立即注册' : 'Register') ]]
                    </button>
                </div>

                <!-- Privacy Notice -->
                <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-xs text-blue-800">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? '您的密码将被加密存储，我们重视您的隐私和数据安全。' : 'Your password will be encrypted. We value your privacy and data security.' ]]
                    </p>
                </div>

                <!-- Login Required Notice -->
                <div class="mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                    <p class="text-sm text-amber-900 text-center font-semibold">
                        <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? '本应用仅限登录后使用' : 'Login required to use this application' ]]
                    </p>
                </div>
            </div>
        </div>

        <!-- Email Confirmation Dialog -->
        <div v-if="showEmailConfirmDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 animate-fade-in">
                <!-- Header -->
                <div class="flex items-center gap-3 mb-6">
                    <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 class="text-xl font-bold text-gray-800">
                        [[ currentLanguage === 'zh' ? '邮箱确认' : 'Email Confirmation' ]]
                    </h3>
                </div>

                <!-- Content -->
                <div class="mb-6 space-y-4">
                    <p class="text-gray-700">
                        [[ currentLanguage === 'zh' ? '检测到您输入的邮箱可能存在拼写错误：' : 'We detected a possible typo in your email address:' ]]
                    </p>
                    
                    <!-- Current Email -->
                    <div class="p-4 bg-red-50 border-2 border-red-200 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">
                            [[ currentLanguage === 'zh' ? '您输入的邮箱：' : 'Your input:' ]]
                        </p>
                        <p class="text-lg font-mono font-bold text-red-700">
                            [[ emailConfirmInfo.email ]]
                        </p>
                    </div>

                    <!-- Suggested Email -->
                    <div v-if="emailConfirmInfo.typo_suggestion" class="p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">
                            [[ currentLanguage === 'zh' ? '建议使用：' : 'Suggested:' ]]
                        </p>
                        <p class="text-lg font-mono font-bold text-green-700">
                            [[ emailConfirmInfo.typo_suggestion ]]
                        </p>
                    </div>

                    <!-- Score Info -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? `邮箱可信度评分：${emailConfirmInfo.score}/100` : `Email credibility score: ${emailConfirmInfo.score}/100` ]]
                        </p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col gap-3">
                    <!-- Use Suggested Email -->
                    <button 
                        v-if="emailConfirmInfo.typo_suggestion"
                        @click="useSuggestedEmail"
                        class="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? '使用建议的邮箱' : 'Use Suggested Email' ]]
                    </button>

                    <!-- Continue with Current Email -->
                    <button 
                        @click="confirmEmail"
                        class="w-full py-3 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? '继续使用当前邮箱' : 'Continue with Current Email' ]]
                    </button>

                    <!-- Cancel -->
                    <button 
                        @click="cancelEmailConfirm"
                        class="w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors"
                    >
                        [[ currentLanguage === 'zh' ? '取消' : 'Cancel' ]]
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div 
            v-if="toastMessage"
            class="fixed top-20 right-4 z-50 toast-enter"
            :class="toastType === 'success' ? 'bg-green-500' : toastType === 'error' ? 'bg-red-500' : 'bg-blue-500'"
        >
            <div class="flex items-center gap-3 px-6 py-4 rounded-lg shadow-xl text-white min-w-[300px]">
                <svg v-if="toastType === 'success'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <svg v-else-if="toastType === 'error'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-6 h-6 flex-shrink-0 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <div class="flex-1">
                    <p class="font-semibold text-sm">[[ toastMessage ]]</p>
                </div>
                <button @click="toastMessage = ''" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
                </div>
                
        <!-- Duplicate Task Dialog -->
        <div 
            v-if="showDuplicateTaskDialog"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in"
            @click.self="showDuplicateTaskDialog = false"
        >
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all animate-fade-in">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                    </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">
                                [[ currentLanguage === 'zh' ? '任务已存在' : 'Task Already Running' ]]
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">
                                [[ currentLanguage === 'zh' ? '检测到正在运行的任务' : 'A running task detected' ]]
                            </p>
                </div>
            </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 font-medium mb-1">
                                    [[ currentLanguage === 'zh' ? '已有正在运行的任务：' : 'Running task: ' ]]
                                    <span class="font-bold text-blue-700">[[ duplicateTaskInfo.symbol ]]</span>
                                </p>
                                <p class="text-xs text-gray-500">
                                    [[ currentLanguage === 'zh' ? '创建时间：' : 'Created: ' ]]
                                    [[ formatTime(duplicateTaskInfo.created_at) ]]
                                </p>
                            </div>
                        </div>
                </div>

                    <div class="space-y-3">
                        <button 
                            @click="handleDuplicateTaskChoice('wait')"
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '等待现有任务完成' : 'Wait for Existing Task' ]]
                        </button>
                        <button 
                            @click="handleDuplicateTaskChoice('cancel')"
                            class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '取消现有任务并创建新任务' : 'Cancel Existing & Create New' ]]
                        </button>
                        <button 
                            @click="showDuplicateTaskDialog = false"
                            class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors"
                        >
                            [[ currentLanguage === 'zh' ? '取消' : 'Cancel' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Sidebar (Always Visible) -->
        <div class="fixed right-0 top-20 h-[calc(50vh-5rem)] w-80 bg-white shadow-2xl z-40 task-list-slide rounded-l-xl" :class="taskListVisible ? 'translate-x-0' : 'translate-x-full'">
            <div class="h-full flex flex-col">
                <!-- Task List Header -->
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '任务列表' : 'Task List' ]]
                        </h3>
                        <button @click="taskListVisible = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Status Filter -->
                    <div class="flex gap-2 flex-wrap">
                        <button 
                            v-for="status in taskStatusFilters" 
                            :key="status.value"
                            @click="taskFilterStatus = status.value"
                            class="px-3 py-1 text-xs rounded-full font-medium transition-colors"
                            :class="taskFilterStatus === status.value ? 
                                'bg-blue-600 text-white' : 
                                'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        >
                            [[ status.label ]]
                        </button>
                    </div>
                </div>
                
                <!-- Task List Content -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="filteredTasks.length === 0" class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>[[ currentLanguage === 'zh' ? '暂无任务' : 'No tasks' ]]</p>
                    </div>
                    <div v-else class="space-y-3">
                        <div 
                            v-for="task in filteredTasks" 
                            :key="task.task_id"
                            class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                            :class="{
                                'task-new': task._isNew,
                                'task-item': !task._isNew,
                                'border-blue-300 bg-blue-50': task.status === 'running',
                                'border-green-300 bg-green-50': task.status === 'completed',
                                'border-red-300 bg-red-50': task.status === 'failed',
                                'border-gray-300 bg-gray-50': task.status === 'terminated'
                            }"
                        >
                            <!-- Task Header -->
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 text-xs rounded font-bold" :class="{
                                            'bg-blue-100 text-blue-700': task.status === 'running',
                                            'bg-green-100 text-green-700': task.status === 'completed',
                                            'bg-red-100 text-red-700': task.status === 'failed',
                                            'bg-gray-100 text-gray-700': task.status === 'terminated'
                                        }">
                                            [[ getTaskStatusLabel(task.status) ]]
                                        </span>
                                        <span class="text-xs text-gray-500">[[ getTaskTypeLabel(task.task_type) ]]</span>
                                </div>
                                    <div class="text-sm font-medium text-gray-800" v-if="task.task_params">
                                        [[ getTaskTitle(task) ]]
                            </div>
                        </div>
                            </div>
                            
                            <!-- Task Time -->
                            <div class="text-xs text-gray-500 mb-3">
                                [[ formatTime(task.created_at) ]]
                            </div>
                            
                            <!-- Task Actions -->
                            <div class="flex gap-2">
                        <button 
                                    v-if="task.status === 'running'"
                                    @click="terminateTask(task.task_id)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? '终止' : 'Terminate' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'completed'"
                                    @click="showTaskResult(task)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? '显示结果' : 'Show Result' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'failed'"
                                    class="flex-1 px-3 py-1.5 text-xs bg-gray-100 text-gray-600 rounded cursor-not-allowed"
                                    :title="task.error_message"
                                >
                                    [[ currentLanguage === 'zh' ? '失败' : 'Failed' ]]
                        </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Toggle Button (Draggable) -->
        <div 
            ref="taskButtonRef"
            class="fixed bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition-colors z-30 flex items-center gap-2 cursor-move select-none"
            :class="{'bg-red-600 hover:bg-red-700': taskListVisible}"
            :style="{ left: taskButtonPosition.x + 'px', top: taskButtonPosition.y + 'px' }"
            @mousedown="startDrag"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span class="font-bold" v-if="runningTasksCount > 0">[[ runningTasksCount ]]</span>
            <button 
                @click.stop="taskListVisible = !taskListVisible"
                class="ml-1 text-white hover:text-gray-200"
                :title="currentLanguage === 'zh' ? '点击切换任务列表' : 'Click to toggle task list'"
            >
                <svg v-if="taskListVisible" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>

        <div class="container mx-auto px-4 py-4 flex-1 flex flex-col">
        <!-- Top Navigation Bar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40 mb-4" :class="{'top-[52px]': showDisclaimer, 'top-0': !showDisclaimer}">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <!-- Logo & Brand -->
                    <div class="flex items-center cursor-pointer" @click="currentTab = 'analysis'">
                        <img src="/static/thumbnail.png" alt="Logo" class="h-8 w-8 mr-2">
                        <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">Invest Pilot</span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex space-x-8 items-center">
            <button 
                @click="currentTab = 'portfolio'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'portfolio' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? '持仓管理' : 'Portfolio' ]]
            </button>
            <button 
                @click="currentTab = 'analysis'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'analysis' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? 'K线分析' : 'K-Line Analysis' ]]
            </button>
            <button 
                @click="currentTab = 'recommend'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'recommend' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? '市场风向' : 'Market Trends' ]]
            </button>
        </div>

                    <!-- Right Side Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Model Selector -->
                        <div class="relative hidden lg:block w-40">
                            <select 
                                v-model="selectedModel" 
                                class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 pr-8 cursor-pointer font-medium truncate"
                            >
                                <option v-for="m in availableModels" :key="m.id" :value="m.id" :disabled="m.disabled || m.isHeader" :class="{'font-bold text-gray-400': m.isHeader}">
                                    [[ m.name ]] [[ m.status === 'limit' ? '(Limit)' : '' ]]
                                </option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>

                        <!-- Language Switcher -->
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button @click="currentLanguage = 'zh'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'zh' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">CN</button>
                            <button @click="currentLanguage = 'en'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">EN</button>
                        </div>
                        
                        <!-- User Profile / Login -->
                        <div v-if="currentUser" class="relative" id="user-menu-container">
                            <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" @click.stop="showUserMenu = !showUserMenu">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-xs">
                                    [[ currentUser.nickname.charAt(0).toUpperCase() ]]
                                </div>
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <!-- User Dropdown Menu -->
                            <div v-if="showUserMenu" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50 animate-fade-in" @click.stop>
                                <div class="px-4 py-3 border-b border-gray-100">
                                    <p class="text-sm font-bold text-gray-800">[[ currentUser.nickname ]]</p>
                                    <p class="text-xs text-gray-500 truncate">[[ currentUser.email ]]</p>
                                </div>
                                <button 
                                    @click.stop="handleLogout"
                                    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? '退出登录' : 'Logout' ]]
                                </button>
                            </div>
                        </div>
                        <button v-else @click="openLoginModal" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                            [[ currentLanguage === 'zh' ? '登录' : 'Login' ]]
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Loading State -->
        <div v-if="(currentTab === 'analysis' && loadingAnalysis) || (currentTab === 'recommend' && loadingRecommend) || (currentTab === 'portfolio' && loadingPortfolio)" class="flex-1 flex items-center justify-center min-h-[400px]">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'AI 正在深度分析中...' : 'AI is analyzing deep data...' ]]</p>
                <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? '正在搜索实时市场资讯 & 计算策略...' : 'Searching real-time market info & calculating strategies...' ]]</p>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <template v-if="currentTab === 'analysis'">
            <!-- Compact Search Section -->
            <div class="mb-6">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 flex items-center gap-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                v-model="query" 
                                @input="handleSearch"
                                @keyup.enter="klineSymbolSelected ? analyzeStock(query) : null"
                                :readonly="klineSymbolSelected"
                                :placeholder="getPlaceholderText()"
                                :class="[
                                    'w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white outline-none text-sm font-medium transition-all',
                                    klineSymbolSelected ? 'bg-blue-50 border-blue-300 text-blue-900 font-semibold' : ''
                                ]"
                            >
                            <!--清除按钮-->
                            <button 
                                v-if="query && klineSymbolSelected"
                                @click="clearKlineSelection"
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition-colors"
                                title="[[ currentLanguage === 'zh' ? '清除选择' : 'Clear selection' ]]"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <div v-if="suggestions && suggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-lg shadow-xl border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in suggestions"
                                    @click="selectStock(item)"
                                    class="px-4 py-2.5 hover:bg-blue-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-100 last:border-0 transition-colors"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">[[ item.symbol ]]</span>
                                        <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">[[ item.type || 'STOCK' ]]</span>
                                        <span class="text-gray-500 text-xs">[[ item.name ]]</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                            <!--提示信息：必须从搜索结果中选择-->
                            <div v-if="query && !klineSymbolSelected" class="absolute z-40 w-full mt-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200">
                                <span class="font-medium">⚠️ [[ currentLanguage === 'zh' ? '请从搜索结果中选择' : 'Please select from search results' ]]</span>
                            </div>
                        </div>
                        
                        <!-- Asset Type Selector -->
                        <div class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg hover:border-blue-300 transition-all">
                            <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                            <select 
                                v-model="klineAssetType"
                                class="bg-transparent border-none outline-none text-sm font-semibold text-gray-700 cursor-pointer pr-6 appearance-none"
                                style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.1rem center; background-size: 1.2em 1.2em;"
                            >
                                <option value="STOCK">[[ currentLanguage === 'zh' ? '📈 股票' : '📈 Stock' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? '₿ 加密货币' : '₿ Crypto' ]]</option>
                                <option value="COMMODITY">[[ currentLanguage === 'zh' ? '🛢️ 大宗商品' : '🛢️ Commodity' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? '🏦 中国基金' : '🏦 CN Fund' ]]</option>
                                <option value="BOND">[[ currentLanguage === 'zh' ? '📜 债券' : '📜 Bond' ]]</option>
                                <option value="INDEX">[[ currentLanguage === 'zh' ? '📊 指数' : '📊 Index' ]]</option>
                                <option value="ETF">[[ currentLanguage === 'zh' ? '🎯 ETF' : '🎯 ETF' ]]</option>
                            </select>
                        </div>
                        
                        <button
                            @click="analyzeStock(query)" 
                            :disabled="creatingTask || !query || !klineSymbolSelected"
                            :class="[
                                'px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed font-semibold text-sm whitespace-nowrap flex items-center gap-2 relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : ''
                            ]"
                        >
                            <svg v-if="!creatingTask" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <svg v-else class="w-4 h-4 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>
                                [[ creatingTask ? (currentLanguage === 'zh' ? '创建中...' : 'Creating...') : (currentLanguage === 'zh' ? '分析' : 'Analyze') ]]
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Result View -->
            <div v-if="!loadingAnalysis && analysisResult" class="flex-1 flex flex-col gap-6 animate-fade-in max-w-6xl mx-auto w-full">
                
                <!-- Model Info Banner -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-xl p-4 shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-blue-900 mb-1">
                                [[ currentLanguage === 'zh' ? '💡 重要提示' : '💡 Important Notice' ]]
                            </div>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                <p class="mb-1">
                                    [[ currentLanguage === 'zh' ? 
                                        '• 不同 AI 模型的分析结果可能不同，每个模型都有独立的交易历史记录' : 
                                        '• Different AI models may produce different analysis results. Each model maintains its own separate trading history' 
                                    ]]
                                </p>
                                <p>
                                    [[ currentLanguage === 'zh' ? 
                        '• 相同模型对同一资产的分析结果会被缓存，当天重复分析将直接返回缓存结果' :
                                        '• Analysis results from the same model are cached. Repeated analysis on the same day will return cached results' 
                                    ]]
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fallback Warning Banner -->
                <div v-if="analysisResult.analysis.is_fallback" class="bg-gradient-to-r from-orange-50 to-amber-50 border-l-4 border-orange-500 rounded-xl p-5 shadow-sm animate-pulse">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-orange-800 flex items-center gap-2">
                                    <span>⚡</span>
                                    [[ currentLanguage === 'zh' ? '本地量化策略' : 'Local Quantitative Strategy' ]]
                                </h3>
                                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                                    MA + RSI
                                </span>
                            </div>
                            <p class="text-sm text-orange-700 leading-relaxed mb-2">
                                [[ currentLanguage === 'zh' ? 
                                    '由于 AI 服务暂时不可用，系统已自动切换至本地量化策略。结果基于经典技术指标（均线交叉 + RSI 动量），仅供参考。' : 
                                    'AI service is temporarily unavailable. System has automatically switched to local quantitative strategy based on classic technical indicators (MA crossover + RSI momentum) for reference only.' 
                                ]]
                            </p>
                            <div class="flex items-center gap-2 text-xs text-orange-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-semibold">[[ currentLanguage === 'zh' ? '原因：' : 'Reason: ' ]]</span>
                                <span class="italic">[[ analysisResult.analysis.fallback_reason ]]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Info Banner -->
                <div v-if="currentPortfolio" class="bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 rounded-xl p-5 shadow-sm mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">
                                    [[ currentLanguage === 'zh' ? '当前持仓' : 'Current Holdings' ]]
                                </h3>
                                <div class="flex gap-4 text-sm text-gray-600 mt-1">
                                    <span>[[ currentLanguage === 'zh' ? '数量' : 'Qty' ]]: <strong>[[ currentPortfolio.total_quantity ]]</strong></span>
                                    <span>[[ currentLanguage === 'zh' ? '均价' : 'Avg' ]]: <strong>[[ currentPortfolio.avg_cost.toFixed(2) ]]</strong></span>
                                    <span>[[ currentLanguage === 'zh' ? '成本' : 'Cost' ]]: <strong>[[ currentPortfolio.total_cost.toFixed(2) ]]</strong></span>
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="openAddTransactionModal(currentPortfolio)"
                            class="px-4 py-2 bg-white border border-purple-200 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors text-sm font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '调整持仓' : 'Adjust' ]]
                        </button>
                    </div>
                </div>

                <!-- 1. Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-blue-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? '总交易次数' : 'Total Trades' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.totalTrades ]]</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.winRate >= 50 ? 'border-green-500' : 'border-yellow-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? '胜率' : 'Win Rate' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.winRate ]]%</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.totalReturn > 0 ? 'border-green-500' : 'border-red-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? '累计收益 (估算)' : 'Total Return' ]]</div>
                        <div class="text-2xl font-bold" :class="stats.totalReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ stats.totalReturn > 0 ? '+' : '' ]][[ stats.totalReturn ]]%
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-purple-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? '当前状态' : 'Status' ]]</div>
                        <div class="text-xl font-bold" :class="analysisResult.analysis.is_fallback ? 'text-orange-700' : 'text-purple-700'">[[ stats.currentStatus ]]</div>
                        <div v-if="stats.currentStatus === 'HOLDING' || stats.currentStatus === '持仓中'" class="text-sm mt-1 font-semibold" :class="stats.unrealizedReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ currentLanguage === 'zh' ? '未实现' : 'Unrealized' ]]: [[ stats.unrealizedReturn > 0 ? '+' : '' ]][[ stats.unrealizedReturn ]]%
                        </div>
                    </div>
                </div>

                <!-- Current Action Recommendation Card (Prominent Display) -->
                <div v-if="analysisResult.analysis.current_action" class="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 p-5 animate-fade-in"
                     :class="{
                         'border-green-400 shadow-green-100': analysisResult.analysis.current_action.action === 'BUY',
                         'border-red-400 shadow-red-100': analysisResult.analysis.current_action.action === 'SELL',
                         'border-orange-400 shadow-orange-100': analysisResult.analysis.current_action.action === 'WAIT',
                         'border-indigo-400 shadow-indigo-100': analysisResult.analysis.current_action.action === 'HOLD'
                     }">
                    <div class="flex items-start gap-4">
                        <!-- Icon Badge -->
                        <div class="flex-shrink-0">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg"
                                 :class="{
                                     'bg-gradient-to-br from-green-400 to-green-600': analysisResult.analysis.current_action.action === 'BUY',
                                     'bg-gradient-to-br from-red-400 to-red-600': analysisResult.analysis.current_action.action === 'SELL',
                                     'bg-gradient-to-br from-orange-400 to-orange-600': analysisResult.analysis.current_action.action === 'WAIT',
                                     'bg-gradient-to-br from-indigo-400 to-indigo-600': analysisResult.analysis.current_action.action === 'HOLD'
                                 }">
                                [[ analysisResult.analysis.current_action.action === 'BUY' ? (currentLanguage === 'zh' ? '买' : 'B') :
                                   analysisResult.analysis.current_action.action === 'SELL' ? (currentLanguage === 'zh' ? '卖' : 'S') :
                                   analysisResult.analysis.current_action.action === 'WAIT' ? (currentLanguage === 'zh' ? '等' : 'W') :
                                   (currentLanguage === 'zh' ? '持' : 'H') ]]
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    [[ currentLanguage === 'zh' ? '🎯 AI 操作建议' : '🎯 AI Recommendation' ]]
                                </h3>
                            </div>
                            <div class="text-2xl font-bold mb-2"
                                 :class="{
                                     'text-green-600': analysisResult.analysis.current_action.action === 'BUY',
                                     'text-red-600': analysisResult.analysis.current_action.action === 'SELL',
                                     'text-orange-600': analysisResult.analysis.current_action.action === 'WAIT',
                                     'text-indigo-600': analysisResult.analysis.current_action.action === 'HOLD'
                                 }">
                                [[ analysisResult.analysis.current_action.action === 'BUY' ? (currentLanguage === 'zh' ? '买入' : 'BUY') :
                                   analysisResult.analysis.current_action.action === 'SELL' ? (currentLanguage === 'zh' ? '卖出' : 'SELL') :
                                   analysisResult.analysis.current_action.action === 'WAIT' ? (currentLanguage === 'zh' ? '观望等待' : 'WAIT') :
                                   (currentLanguage === 'zh' ? '继续持有' : 'HOLD') ]]
                            </div>
                            <p class="text-sm text-gray-700 leading-relaxed mb-3">
                                [[ analysisResult.analysis.current_action.reason ]]
                            </p>
                            
                            <!-- Additional Details for BUY/SELL -->
                            <div v-if="analysisResult.analysis.current_action.action === 'BUY' || analysisResult.analysis.current_action.action === 'SELL'" 
                                 class="flex flex-wrap gap-3 text-xs">
                                <div v-if="analysisResult.analysis.current_action.price" 
                                     class="bg-white px-3 py-1.5 rounded-lg border border-gray-200 font-semibold">
                                    <span class="text-gray-500">[[ currentLanguage === 'zh' ? '建议价格' : 'Price' ]]:</span>
                                    <span class="text-gray-800 ml-1">[[ analysisResult.analysis.current_action.price ]]</span>
                                </div>
                                <div v-if="analysisResult.analysis.current_action.quantity_percent" 
                                     class="bg-white px-3 py-1.5 rounded-lg border border-gray-200 font-semibold">
                                    <span class="text-gray-500">[[ currentLanguage === 'zh' ? '仓位比例' : 'Position' ]]:</span>
                                    <span class="text-gray-800 ml-1">[[ analysisResult.analysis.current_action.quantity_percent ]]%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Main Chart Area (Full Width) -->
                <div class="bg-white rounded-xl shadow-sm p-4 w-full">
                    <div ref="chartRef" class="chart-container" style="height: 550px; width: 100%;"></div>
                </div>

                <!-- 3. Bottom Section: Analysis & Logs (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px] lg:h-[500px]">
                    
                    <!-- AI Summary (Takes 1/3) -->
                    <div class="analysis-card p-6 flex flex-col relative group lg:col-span-1 h-full overflow-hidden" :class="analysisResult.analysis.is_fallback ? 'border-orange-200 bg-orange-50/30' : ''">
                        <div class="flex justify-between items-center mb-4 flex-none">
                            <h3 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2" :class="analysisResult.analysis.is_fallback ? 'text-orange-800' : 'text-gray-800'">
                                <span class="w-1 h-4 rounded-full" :class="analysisResult.analysis.is_fallback ? 'bg-orange-600' : 'bg-blue-600'"></span>
                                [[ analysisResult.analysis.is_fallback ? 
                                    (currentLanguage === 'zh' ? '策略说明' : 'Strategy Info') : 
                                    (currentLanguage === 'zh' ? 'AI 分析摘要' : 'AI Summary') 
                                ]]
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 pr-2">
                            <p class="text-sm text-gray-700 leading-relaxed font-serif text-justify whitespace-pre-wrap">[[ analysisResult.analysis.analysis_summary ]]</p>
                            
                            <!-- Current Action Quick Reference (Simplified - Main display is at top) -->
                            <div v-if="analysisResult.analysis.current_action" class="mt-4 pt-4 border-t border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">
                                    [[ currentLanguage === 'zh' ? '💡 操作建议详情见上方卡片' : '💡 See recommendation card above' ]]
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Records Table (Takes 2/3) -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col overflow-hidden border border-gray-100 lg:col-span-2 h-full">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex-none">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">
                                [[ currentLanguage === 'zh' ? '交易记录' : 'Transaction Records' ]]
                                <span class="ml-2 text-xs text-gray-500">([[ allTransactionRecords?.length || 0 ]])</span>
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <!-- Empty State -->
                            <div v-if="!allTransactionRecords || allTransactionRecords.length === 0" class="flex items-center justify-center h-full text-gray-400 text-sm">
                                [[ currentLanguage === 'zh' ? '暂无交易记录' : 'No transaction records' ]]
                            </div>
                            
                            <!-- Transaction List -->
                            <div v-else class="divide-y divide-gray-100">
                                <div v-for="(record, index) in allTransactionRecords" :key="index" 
                                     class="px-4 py-3 hover:bg-gray-50 transition-colors"
                                     :class="{
                                         'bg-blue-50/30': record.source === 'user',
                                         'bg-green-50/20': record.source === 'ai' && record.type === 'BUY',
                                         'bg-red-50/20': record.source === 'ai' && record.type === 'SELL',
                                         'border-l-4 border-amber-400': record.is_current
                                     }">
                                    <div class="flex items-start justify-between gap-4">
                                        <!-- Left: Type Badge + Info -->
                                        <div class="flex items-start gap-3 flex-1 min-w-0">
                                            <!-- Type Badge -->
                                            <div class="flex-shrink-0">
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md font-bold text-xs whitespace-nowrap"
                                                      :class="{
                                                          'bg-blue-100 text-blue-700': record.source === 'user' && record.type === 'BUY',
                                                          'bg-orange-100 text-orange-700': record.source === 'user' && record.type === 'SELL',
                                                          'bg-green-100 text-green-700 border border-green-300': record.source === 'ai' && record.type === 'BUY' && record.adopted,
                                                          'bg-green-50 text-green-600 border border-green-200': record.source === 'ai' && record.type === 'BUY' && !record.adopted,
                                                          'bg-red-100 text-red-700 border border-red-300': record.source === 'ai' && record.type === 'SELL' && record.adopted,
                                                          'bg-red-50 text-red-600 border border-red-200': record.source === 'ai' && record.type === 'SELL' && !record.adopted
                                                      }">
                                                    <!-- Icon -->
                                                    <span v-if="record.source === 'user'">💎</span>
                                                    <span v-else-if="record.adopted">✓</span>
                                                    <span v-else>🤖</span>
                                                    
                                                    <!-- Label -->
                                                    <span v-if="record.source === 'user'">
                                                        [[ getUserActionLabel(record) ]]
                                                    </span>
                                                    <span v-else>
                                                        [[ getAIActionLabel(record) ]]
                                                    </span>
                                                </span>
                                                
                                                <!-- Current indicator -->
                                                <div v-if="record.is_current" class="mt-1 text-xs text-amber-600 font-semibold">
                                                    [[ currentLanguage === 'zh' ? '当前' : 'Current' ]]
                                                </div>
                                            </div>
                                            
                                            <!-- Transaction Details -->
                                            <div class="flex-1 min-w-0">
                                                <!-- Date & Price -->
                                                <div class="text-sm font-semibold text-gray-800 mb-1">
                                                    [[ record.date ]] @ <span class="text-indigo-600">[[ record.price ]]</span>
                                                </div>
                                                
                                                <!-- Quantity & Amount (for user transactions) -->
                                                <div v-if="record.source === 'user' && (record.quantity || record.amount)" class="text-xs text-gray-600 mb-1">
                                                    <span v-if="record.quantity">[[ currentLanguage === 'zh' ? '数量' : 'Qty' ]]: [[ record.quantity ]]</span>
                                                    <span v-if="record.quantity && record.amount" class="mx-1">|</span>
                                                    <span v-if="record.amount">[[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]: [[ record.amount ]]</span>
                                                </div>
                                                
                                                <!-- Reason/Notes -->
                                                <div v-if="record.reason" class="text-xs text-gray-600 leading-relaxed mt-1">
                                                    <span class="font-semibold text-gray-500">[[ currentLanguage === 'zh' ? '原因' : 'Reason' ]]:</span>
                                                    <span class="ml-1">[[ record.reason ]]</span>
                                                </div>
                                                
                                                <!-- Adopted indicator -->
                                                <div v-if="record.source === 'ai' && record.adopted" class="text-xs text-green-600 font-semibold mt-1">
                                                    ✓ [[ currentLanguage === 'zh' ? '已采纳' : 'Adopted' ]]
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loadingAnalysis && !analysisResult" class="flex-1 flex flex-col items-center justify-center animate-fade-in py-12">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 max-w-6xl w-full text-center">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">[[ currentLanguage === 'zh' ? '开启 AI 量化之旅' : 'Start AI Quant Journey' ]]</h2>
                    <p class="text-gray-500 mb-8 max-w-lg mx-auto leading-relaxed">
                        [[ currentLanguage === 'zh' ? '输入资产代码，让 AI 深度解析历史数据，结合技术指标与市场情绪，为您生成专业的买卖点建议。支持股票、加密货币、大宗商品和债券。' : 'Enter an asset symbol to let AI analyze historical data, technical indicators, and market sentiment for professional trading signals. Supports stocks, crypto, commodities, and bonds.' ]]
                    </p>
                    
                    <!-- Hot Assets Quick Analysis (Inside Card) -->
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider text-center">[[ currentLanguage === 'zh' ? '🔥 热门资产快速分析' : '🔥 Popular Assets' ]]</p>
                        
                        <!-- Loading State -->
                        <div v-if="loadingHotStocks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="i in 8" :key="i" class="p-4 border border-gray-200 rounded-xl bg-gray-50 animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-20 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-16 mb-3"></div>
                                <div class="h-6 bg-gray-300 rounded w-24 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-12"></div>
                            </div>
                        </div>
                        
                        <!-- Stocks Grid -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button 
                                v-for="stock in hotStocks" 
                                :key="stock.symbol"
                                @click="selectStock(stock.symbol); analyzeStock(stock.symbol)"
                                class="stock-card relative p-4 border border-gray-200 rounded-xl hover:border-blue-400 hover:shadow-lg transition-all group text-left bg-gradient-to-br from-white to-gray-50 overflow-hidden"
                            >
                                <!-- Trend Background -->
                                <div class="absolute inset-0 opacity-5 pointer-events-none">
                                    <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                        <polyline
                                            :points="stock.trendData"
                                            fill="none"
                                            :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                            stroke-width="2"
                                        />
                                    </svg>
                                </div>
                                
                                <!-- Content -->
                                <div class="relative z-10">
                                    <!-- Header -->
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-gray-900 group-hover:text-blue-700 text-sm">[[ stock.symbol ]]</div>
                                            <div class="text-xs text-gray-500 mt-0.5">[[ stock.name ]]</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-semibold" :class="stock.change >= 0 ? 'text-green-600' : 'text-red-600'">
                                                [[ stock.change >= 0 ? '+' : '' ]][[ stock.change ]]%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price & Mini Chart -->
                                    <div class="flex items-end justify-between mt-3">
                                        <div>
                                            <div class="text-lg font-bold text-gray-900">[[ stock.price ]]</div>
                                            <div class="text-xs text-gray-400">[[ stock.market ]]</div>
                                        </div>
                                        
                                        <!-- Mini Trend Line -->
                                        <div class="w-16 h-8">
                                            <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                                <polyline
                                                    :points="stock.trendData"
                                                    fill="none"
                                                    :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                                    stroke-width="3"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Volume -->
                                    <div class="mt-2 pt-2 border-t border-gray-100">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '成交量' : 'Volume' ]]</span>
                                            <span class="text-gray-600 font-medium">[[ stock.volume ]]</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hover Effect Indicator -->
                                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-indigo-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </template>

        <!-- Recommendation Tab Content -->
        <div v-if="currentTab === 'recommend' && !loadingRecommend" class="flex-1 grid grid-cols-1 gap-6 animate-fade-in max-w-7xl mx-auto w-full">
                
            <!-- Filters & Generate Button (Top Section) -->
            <div class="space-y-6">
                <!-- Filters & Generate Button -->
                <div class="bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/30 p-8 rounded-2xl shadow-lg border-2 border-blue-100/50 backdrop-blur-sm">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    [[ currentLanguage === 'zh' ? '市场机会挖掘' : 'Market Scanner' ]]
                        </h3>
                                <p class="text-xs text-gray-500 mt-1">[[ currentLanguage === 'zh' ? 'AI 驱动的智能选股推荐' : 'AI-Powered Stock Recommendations' ]]</p>
                            </div>
                        </div>
                        <button 
                            @click="getRecommendations" 
                            :disabled="creatingTask || loadingRecommend"
                            :class="[
                                'px-8 py-3 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white rounded-full hover:shadow-xl transition-all font-bold text-sm flex items-center gap-2 disabled:opacity-70 disabled:cursor-wait relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : 'btn-pulse'
                            ]"
                        >
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></span>
                            <svg v-if="!creatingTask && !loadingRecommend" class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <svg v-else class="w-5 h-5 spinner relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="relative z-10">
                                [[ creatingTask ? (currentLanguage === 'zh' ? '创建任务中...' : 'Creating task...') : (loadingRecommend ? (currentLanguage === 'zh' ? '扫描中...' : 'Scanning...') : (currentLanguage === 'zh' ? 'AI 智能扫描' : 'AI Smart Scan')) ]]
                            </span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '资产类型' : 'Asset Type' ]]
                            </label>
                            <select v-model="recCriteria.asset_type" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="STOCK">[[ currentLanguage === 'zh' ? '股票 (Stock)' : 'Stock' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? '中国基金 (CN Fund)' : 'Chinese Fund' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? '加密货币 (Crypto)' : 'Crypto' ]]</option>
                                <option value="COMMODITY">[[ currentLanguage === 'zh' ? '大宗商品 (Commodity)' : 'Commodity' ]]</option>
                                <option value="BOND">[[ currentLanguage === 'zh' ? '债券 (Bond)' : 'Bond' ]]</option>
                            </select>
                        </div>
                        <!-- ETF Toggle - only show for STOCK asset type -->
                        <div class="portfolio-input-group" v-show="recCriteria.asset_type === 'STOCK'" style="transition: all 0.3s ease;">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '包含 ETF' : 'Include ETF' ]]
                                <span class="text-xs text-gray-400 normal-case ml-1">([[ currentLanguage === 'zh' ? '仅股票' : 'Stock only' ]])</span>
                            </label>
                            <select v-model="recCriteria.include_etf" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="false">[[ currentLanguage === 'zh' ? '仅个股' : 'Individual Stocks Only' ]]</option>
                                <option value="true">[[ currentLanguage === 'zh' ? '包含 ETF' : 'Include ETFs' ]]</option>
                            </select>
                        </div>
                        <!-- Market selector - only show for STOCK asset type -->
                        <div class="portfolio-input-group" v-show="recCriteria.asset_type === 'STOCK'" style="transition: all 0.3s ease;">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '市场选择' : 'Market' ]]
                                <span class="text-xs text-gray-400 normal-case ml-1">([[ currentLanguage === 'zh' ? '仅股票' : 'Stock only' ]])</span>
                            </label>
                            <select v-model="recCriteria.market" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? '不限' : 'Any' ]]</option>
                                <option value="US">[[ currentLanguage === 'zh' ? '美股 (US)' : 'US Stocks' ]]</option>
                                <option value="HK">[[ currentLanguage === 'zh' ? '港股 (HK)' : 'HK Stocks' ]]</option>
                                <option value="A">[[ currentLanguage === 'zh' ? 'A股 (A)' : 'A-Shares' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '资金规模' : 'Capital' ]]
                            </label>
                            <select v-model="recCriteria.capital" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? '不限' : 'Any' ]]</option>
                                <option value="Small (<10w)">[[ currentLanguage === 'zh' ? '小资金 (<10w)' : 'Small (<10k)' ]]</option>
                                <option value="Medium (10w-50w)">[[ currentLanguage === 'zh' ? '中等资金 (10w-50w)' : 'Medium (10k-50k)' ]]</option>
                                <option value="Large (>50w)">[[ currentLanguage === 'zh' ? '大资金 (>50w)' : 'Large (>50k)' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '风险偏好' : 'Risk' ]]
                            </label>
                            <select v-model="recCriteria.risk" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? '不限' : 'Any' ]]</option>
                                <option value="Conservative">[[ currentLanguage === 'zh' ? '稳健型 (低风险)' : 'Conservative' ]]</option>
                                <option value="Balanced">[[ currentLanguage === 'zh' ? '平衡型 (中风险)' : 'Balanced' ]]</option>
                                <option value="Aggressive">[[ currentLanguage === 'zh' ? '进取型 (高风险)' : 'Aggressive' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '交易频率' : 'Frequency' ]]
                            </label>
                            <select v-model="recCriteria.frequency" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? '不限' : 'Any' ]]</option>
                                <option value="Short-term">[[ currentLanguage === 'zh' ? '短线 (日内/周)' : 'Short-term' ]]</option>
                                <option value="Swing">[[ currentLanguage === 'zh' ? '波段 (周/月)' : 'Swing' ]]</option>
                                <option value="Long-term">[[ currentLanguage === 'zh' ? '长线 (季度+)' : 'Long-term' ]]</option>
                            </select>
                        </div>
                        </div>
                    </div>
                </div>

            <!-- Dashboard & Right Panel Row (1/2 + 1/2) - Only show when no recommendations -->
            <div v-if="currentTab === 'recommend' && !recommendationResult" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Market Indices Dashboard (Left 1/2) -->
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">[[ currentLanguage === 'zh' ? '📊 全球市场大盘' : '📊 Global Market Indices' ]]</p>
                    
                    <!-- Loading State -->
                    <div v-if="loadingMarketIndices" class="grid grid-cols-2 gap-3">
                        <div v-for="i in 8" :key="i" class="p-3 border border-gray-200 rounded-lg bg-gray-50 animate-pulse">
                            <div class="h-3 bg-gray-300 rounded w-16 mb-2"></div>
                            <div class="h-5 bg-gray-300 rounded w-20 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-12"></div>
                        </div>
                    </div>
                    
                    <!-- Indices Grid (2 columns: 4 left, 4 right) -->
                    <div v-else class="grid grid-cols-2 gap-3">
                        <div 
                            v-for="index in marketIndices" 
                            :key="index.symbol"
                            @click="selectStock(index.symbol); currentTab='analysis'; analyzeStock(index.symbol)"
                            @mouseenter="(e) => { showTooltip = index.symbol; tooltipPosition = { x: e.clientX, y: e.clientY }; }"
                            @mouseleave="showTooltip = null"
                            @mousemove="(e) => { if (showTooltip === index.symbol) tooltipPosition = { x: e.clientX, y: e.clientY }; }"
                            class="group relative p-3 border border-gray-200 rounded-lg hover:border-blue-400 hover:shadow-md transition-all cursor-pointer bg-gradient-to-br from-white to-gray-50"
                        >
                            <!-- Enhanced Hover Tooltip (Fixed positioning to avoid overflow issues) -->
                            <div 
                                v-if="showTooltip === index.symbol"
                                class="fixed z-[100] pointer-events-none"
                                :style="{ 
                                    left: (tooltipPosition.x + 15) + 'px',
                                    top: (tooltipPosition.y - 15) + 'px',
                                    transform: 'translateY(-100%)'
                                }"
                            >
                                <div class="bg-gray-900 text-white text-xs rounded-lg px-4 py-3 shadow-2xl min-w-[220px]">
                                    <div class="font-bold mb-2 text-sm flex items-center gap-2">
                                        <span>[[ index.icon ]]</span>
                                        <span>[[ currentLanguage === 'zh' ? index.name_zh : index.name ]]</span>
                                        <span class="text-gray-400 text-xs">([[ index.symbol ]])</span>
                                    </div>
                                    <div class="space-y-1.5 border-t border-gray-700 pt-2 mt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '当前价' : 'Price' ]]</span>
                                            <span class="font-semibold">[[ index.price ]]</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '涨跌' : 'Change' ]]</span>
                                            <span :class="index.is_up ? 'text-green-400' : 'text-red-400'" class="font-medium">
                                                [[ index.is_up ? '+' : '' ]][[ index.change ]] ([[ index.is_up ? '+' : '' ]][[ index.change_pct ]]%)
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '最高' : 'High' ]]</span>
                                            <span class="text-gray-300">[[ index.high ]]</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '最低' : 'Low' ]]</span>
                                            <span class="text-gray-300">[[ index.low ]]</span>
                                        </div>
                                        <div v-if="index.volume" class="flex justify-between items-center border-t border-gray-700 pt-1.5 mt-1.5">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? '成交量' : 'Volume' ]]</span>
                                            <span class="text-gray-300">[[ index.volume ]]</span>
                                        </div>
                                    </div>
                                    <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
                                </div>
                </div>

                            <!-- Trend Background -->
                            <div class="absolute inset-0 opacity-5 pointer-events-none">
                                <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                    <polyline
                                        :points="index.trend_data"
                                        fill="none"
                                        :stroke="index.is_up ? '#10b981' : '#ef4444'"
                                        stroke-width="2"
                                    />
                                </svg>
                            </div>
                            
                            <!-- Content -->
                            <div class="relative z-10">
                                <!-- Icon & Name -->
                                <div class="flex items-center gap-1 mb-1.5">
                                    <span class="text-base">[[ index.icon ]]</span>
                                    <span class="text-xs font-bold text-gray-700 truncate">[[ currentLanguage === 'zh' ? index.name_zh : index.name ]]</span>
                                </div>
                                
                                <!-- Price -->
                                <div class="text-base font-bold text-gray-900 mb-1">[[ index.price ]]</div>
                                
                                <!-- Change -->
                                <div class="flex items-center gap-1">
                                    <span 
                                        class="text-xs font-semibold px-1.5 py-0.5 rounded"
                                        :class="index.is_up ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                    >
                                        [[ index.is_up ? '▲' : '▼' ]] [[ Math.abs(index.change_pct) ]]%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: News (Right 1/2) -->
                <div>
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">[[ currentLanguage === 'zh' ? '📈 实时市场动态' : '📈 Live Market Insights' ]]</p>
                    </div>
                    
                    <!-- News Container with Scroll -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm h-[600px] flex flex-col overflow-hidden">
                    <!-- Loading State -->
                            <div v-if="loadingMarketNews" class="flex-1 overflow-y-auto p-4 space-y-3">
                                <div v-for="i in 6" :key="i" class="bg-gray-50 p-4 rounded-lg border border-gray-100 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/2 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/4"></div>
                        </div>
                    </div>
                    
                            <!-- News List (Scrollable) -->
                            <div v-else-if="marketNews && marketNews.length > 0" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <a 
                            v-for="news in marketNews"
                            :key="news.id"
                            :href="news.link"
                            target="_blank"
                                    class="block bg-gradient-to-br from-gray-50 to-blue-50/30 p-4 rounded-lg border border-gray-100 hover:border-blue-300 hover:shadow-md transition-all group cursor-pointer"
                                >
                                    <!-- Type Badge -->
                                    <div class="flex items-center gap-2 mb-2">
                                        <span 
                                            class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                            :class="{
                                                'bg-purple-100 text-purple-700': news.type === 'earnings',
                                                'bg-yellow-100 text-yellow-700': news.type === 'rating',
                                                'bg-blue-100 text-blue-700': news.type === 'deal',
                                                'bg-green-100 text-green-700': news.type === 'dividend' || news.type === 'bullish',
                                                'bg-red-100 text-red-700': news.type === 'bearish',
                                                'bg-gray-100 text-gray-700': news.type === 'news'
                                            }"
                                        >
                                            [[ news.icon ]] 
                                            <span v-if="news.type === 'earnings'">[[ currentLanguage === 'zh' ? '财报' : 'Earnings' ]]</span>
                                            <span v-else-if="news.type === 'rating'">[[ currentLanguage === 'zh' ? '评级' : 'Rating' ]]</span>
                                            <span v-else-if="news.type === 'deal'">[[ currentLanguage === 'zh' ? '交易' : 'Deal' ]]</span>
                                            <span v-else-if="news.type === 'dividend'">[[ currentLanguage === 'zh' ? '分红' : 'Dividend' ]]</span>
                                            <span v-else-if="news.type === 'bullish'">[[ currentLanguage === 'zh' ? '利好' : 'Bullish' ]]</span>
                                            <span v-else-if="news.type === 'bearish'">[[ currentLanguage === 'zh' ? '利空' : 'Bearish' ]]</span>
                                            <span v-else>[[ currentLanguage === 'zh' ? '资讯' : 'News' ]]</span>
                                        </span>
                                        <span class="text-xs text-gray-400">[[ news.time_ago ]]</span>
                                    </div>
                                    
                                    <!-- Title -->
                                    <h4 class="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors line-clamp-2 leading-snug mb-2">
                                        [[ news.title ]]
                                    </h4>
                                    
                                    <!-- Footer -->
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <span class="truncate">[[ news.publisher ]]</span>
                                        <span v-if="news.related_symbols && news.related_symbols.length > 0" class="font-mono font-semibold ml-2">[[ news.related_symbols[0] ]]</span>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Empty State -->
                            <div v-else class="flex-1 flex items-center justify-center p-8">
                                <div class="text-center">
                                    <div class="text-gray-300 text-4xl mb-2">📰</div>
                                    <p class="text-gray-400 text-sm">[[ currentLanguage === 'zh' ? '暂无市场资讯' : 'No market news available' ]]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                    
            <!-- Market Overview & Recommendations (Replaces Dashboard when available) -->
            <div v-if="currentTab === 'recommend' && recommendationResult" class="space-y-6">
                <!-- Header with Clear Button -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">[[ currentLanguage === 'zh' ? '📊 市场推荐结果' : '📊 Market Recommendations' ]]</h2>
                    <button 
                        @click="recommendationResult = null"
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? '返回大盘视图' : 'Back to Dashboard' ]]
                    </button>
                </div>
                
                <!-- Market Overview -->
                <div v-if="recommendationResult.market_overview" class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-2 border-blue-200/50 p-6 rounded-2xl text-gray-800 leading-relaxed shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-200/20 rounded-full -mr-16 -mt-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-indigo-200/20 rounded-full -ml-12 -mb-12"></div>
                    <div class="relative z-10">
                        <div class="mb-3 flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                    </div>
                            <div class="font-bold text-blue-700 text-lg flex items-center gap-2">
                                [[ currentLanguage === 'zh' ? '市场风向' : 'Market Overview' ]]
                            </div>
                        </div>
                        <p class="font-serif text-gray-700 leading-relaxed text-base">[[ recommendationResult.market_overview ]]</p>
                    </div>
                </div>

                <!-- Recommendations List -->
                <div v-if="recommendationResult.recommendations && Array.isArray(recommendationResult.recommendations) && recommendationResult.recommendations.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-for="(rec, idx) in recommendationResult.recommendations" :key="idx" 
                         :class="[
                             'recommendation-card p-6 rounded-2xl group relative overflow-hidden',
                             rec.level.includes('🔻') ? 'border-2 border-red-300 bg-red-50/30' : 
                             rec.level.includes('⚠️') ? 'border-2 border-yellow-300 bg-yellow-50/30' : 
                             'border border-gray-200'
                         ]">
                        <!-- Decorative gradient overlay -->
                        <div :class="[
                            'absolute inset-0 transition-all duration-300',
                            rec.level.includes('🔻') ? 'bg-gradient-to-br from-red-50/0 via-red-100/0 to-red-50/0 group-hover:from-red-50/50 group-hover:via-red-100/30 group-hover:to-red-50/20' :
                            rec.level.includes('⚠️') ? 'bg-gradient-to-br from-yellow-50/0 via-yellow-100/0 to-yellow-50/0 group-hover:from-yellow-50/50 group-hover:via-yellow-100/30 group-hover:to-yellow-50/20' :
                            'bg-gradient-to-br from-blue-50/0 via-indigo-50/0 to-purple-50/0 group-hover:from-blue-50/50 group-hover:via-indigo-50/30 group-hover:to-purple-50/20'
                        ]"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                                        <h4 class="text-xl font-extrabold text-gray-900 group-hover:text-blue-600 transition-colors">[[ rec.symbol ]]</h4>
                                        <span class="text-sm text-gray-500 font-medium">[[ rec.name ]]</span>
                                        <span :class="[
                                            'px-3 py-1 text-white text-xs rounded-full font-bold shadow-sm',
                                            rec.level.includes('🔻') ? 'bg-gradient-to-r from-red-500 to-red-600' :
                                            rec.level.includes('⚠️') ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                                            rec.level.includes('⭐⭐⭐') ? 'bg-gradient-to-r from-green-400 to-emerald-500' :
                                            rec.level.includes('⭐⭐') ? 'bg-gradient-to-r from-blue-400 to-indigo-500' :
                                            'bg-gradient-to-r from-yellow-400 to-orange-400'
                                        ]">
                                            [[ rec.level ]]
                                        </span>
                                    </div>
                                    <div class="text-3xl font-extrabold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mt-2">
                                        [[ rec.price ]]
                                    </div>
                                </div>
                                <button 
                                    @click="selectStock(rec.symbol); currentTab='analysis'; analyzeStock(rec.symbol)" 
                                    class="ml-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg opacity-0 group-hover:opacity-100 transition-all transform hover:scale-105 flex items-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? '分析' : 'Analyze' ]]
                                </button>
                            </div>
                            <div :class="[
                                'text-sm leading-relaxed p-4 rounded-xl border',
                                rec.level.includes('🔻') ? 'text-red-800 bg-gradient-to-br from-red-50 to-red-100/50 border-red-200' :
                                rec.level.includes('⚠️') ? 'text-yellow-800 bg-gradient-to-br from-yellow-50 to-yellow-100/50 border-yellow-200' :
                                'text-gray-700 bg-gradient-to-br from-gray-50 to-blue-50/30 border-gray-100'
                            ]">
                                <p class="font-medium">[[ rec.reason ]]</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Empty State (when no recommendations) - Show below dashboard -->
            <div v-if="currentTab === 'recommend' && !recommendationResult" class="text-center py-12 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100 mt-6">
                <div class="text-gray-300 text-6xl mb-4">🔍</div>
                <p class="text-gray-500 text-sm">[[ currentLanguage === 'zh' ? 'AI 将根据您的筛选条件推荐优质资产' : 'AI will recommend quality assets based on your criteria' ]]</p>
            </div>

        <!-- Portfolio Diagnosis Tab Content -->
        <div v-if="currentTab === 'portfolio' && !loadingPortfolio" class="animate-fade-in">
            <div class="max-w-7xl mx-auto space-y-4">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">
                            [[ currentLanguage === 'zh' ? '持仓管理' : 'Portfolio Management' ]]
                        </h2>
                        <p class="text-xs text-gray-500 mt-0.5">
                            [[ currentLanguage === 'zh' ? '管理您的虚拟投资组合' : 'Manage your virtual investment portfolio' ]]
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            @click="diagnosePortfolio()"
                            :disabled="portfolios.length === 0"
                            class="px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-1.5 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '持仓分析' : 'Analysis' ]]
                        </button>
                        <button 
                            @click="openCashModal()"
                            class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1.5 text-xs font-medium"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '现金操作' : 'Cash' ]]
                        </button>
                        <button 
                            @click="openAddTransactionModal()"
                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5 text-xs font-medium"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? '添加交易' : 'Add Transaction' ]]
                        </button>
                    </div>
                </div>

                <!-- AI Analysis Result -->
                <div v-if="portfolioResult" class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-200 p-6 mb-4 animate-fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <h3 class="text-lg font-bold text-gray-900">
                                [[ currentLanguage === 'zh' ? 'AI 持仓分析' : 'AI Portfolio Analysis' ]]
                            </h3>
                            <span v-if="portfolioResult.overall_rating" class="ml-2 px-3 py-1 rounded-full text-sm font-semibold"
                                  :class="{
                                      'bg-green-100 text-green-800': portfolioResult.overall_rating === '优秀' || portfolioResult.overall_rating === 'Excellent',
                                      'bg-blue-100 text-blue-800': portfolioResult.overall_rating === '良好' || portfolioResult.overall_rating === 'Good',
                                      'bg-yellow-100 text-yellow-800': portfolioResult.overall_rating === '一般' || portfolioResult.overall_rating === 'Fair',
                                      'bg-red-100 text-red-800': portfolioResult.overall_rating === '较差' || portfolioResult.overall_rating === 'Poor'
                                  }">
                                [[ portfolioResult.overall_rating ]]
                            </span>
                        </div>
                        <button 
                            @click="portfolioResult = null"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Performance Analysis -->
                        <div v-if="portfolioResult.performance_analysis" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '收益分析' : 'Performance Analysis' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.performance_analysis ]]</p>
                        </div>
                        
                        <!-- Asset Allocation Analysis -->
                        <div v-if="portfolioResult.asset_allocation_analysis" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '资产配置分析' : 'Asset Allocation Analysis' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.asset_allocation_analysis ]]</p>
                        </div>
                        
                        <!-- Risk Assessment -->
                        <div v-if="portfolioResult.risk_assessment" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '风险评估' : 'Risk Assessment' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.risk_assessment ]]</p>
                        </div>
                        
                        <!-- Market Outlook -->
                        <div v-if="portfolioResult.market_outlook" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '市场展望' : 'Market Outlook' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.market_outlook ]]</p>
                        </div>
                        
                        <!-- Recommendations -->
                        <div v-if="portfolioResult.recommendations && portfolioResult.recommendations.length > 0" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? '操作建议' : 'Recommendations' ]]
                            </h4>
                            <ul class="space-y-2">
                                <li v-for="(rec, index) in portfolioResult.recommendations" :key="index" 
                                    class="flex items-start gap-2 text-sm text-gray-700">
                                    <span class="flex-shrink-0 w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-semibold mt-0.5">
                                        [[ index + 1 ]]
                                    </span>
                                    <span class="flex-1 leading-relaxed">[[ rec ]]</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div v-if="loadingPortfolios" class="space-y-4">
                    <!-- 骨架屏 - 总资产卡片 -->
                    <div class="bg-gradient-to-r from-gray-200 to-gray-300 rounded-lg p-5 animate-pulse">
                        <div class="h-4 bg-gray-400 rounded w-24 mb-3"></div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 骨架屏 - 持仓列表 -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-200 bg-gray-50">
                            <div class="h-5 bg-gray-300 rounded w-32 animate-pulse"></div>
                        </div>
                        <div class="divide-y divide-gray-200">
                            <div v-for="i in 3" :key="i" class="p-4 animate-pulse">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="h-5 bg-gray-300 rounded w-24 mb-2"></div>
                                        <div class="h-4 bg-gray-200 rounded w-32"></div>
                                    </div>
                                    <div class="text-right">
                                        <div class="h-5 bg-gray-300 rounded w-20 mb-2 ml-auto"></div>
                                        <div class="h-4 bg-gray-200 rounded w-16 ml-auto"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 加载提示 -->
                    <div class="flex justify-center items-center py-4">
                        <div class="spinner w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mr-3"></div>
                        <span class="text-gray-600 text-sm">
                            [[ currentLanguage === 'zh' ? '加载中...' : 'Loading...' ]]
                        </span>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-else-if="portfolios.length === 0" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        [[ currentLanguage === 'zh' ? '暂无持仓' : 'No Holdings' ]]
                    </h3>
                    <p class="text-sm text-gray-500">
                        [[ currentLanguage === 'zh' ? '点击上方按钮添加您的第一笔交易' : 'Click the button above to add your first transaction' ]]
                    </p>
                </div>

                <!-- Portfolio Display (with Total Assets Summary) -->
                <div v-else>
                    <!-- Total Assets Summary -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-5 mb-4 shadow-md">
                        <!-- 标题栏 -->
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-white text-sm font-semibold uppercase tracking-wider">
                                [[ currentLanguage === 'zh' ? '资产概览' : 'Assets Overview' ]]
                            </h2>
                            <button 
                                @click="toggleAmountVisibility"
                                class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors"
                                :title="currentLanguage === 'zh' ? (hideAmounts ? '显示金额' : '隐藏金额') : (hideAmounts ? 'Show Amounts' : 'Hide Amounts')"
                            >
                                <!-- 眼睛睁开图标 (显示状态) -->
                                <svg v-if="!hideAmounts" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <!-- 眼睛闭合图标 (隐藏状态) -->
                                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <!-- Total Assets -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm relative group">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                            [[ currentLanguage === 'zh' ? '总资产' : 'Total Assets' ]]
                                        </p>
                                        <p class="text-white text-2xl font-bold">
                                            [[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(displayedTotalAssets) ]]
                                        </p>
                                    </div>
                                    <button 
                                        @click="toggleCurrency"
                                        class="text-xs bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded transition-colors"
                                        :title="currentLanguage === 'zh' ? '切换币种' : 'Switch Currency'"
                                    >
                                        [[ displayCurrency ]]
                                    </button>
                                </div>
                            </div>
                            <!-- Today's Change -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? '今日涨跌' : 'Today\'s Change' ]]
                                </p>
                                <p :class="displayedTotalDailyChange >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ displayedTotalDailyChange >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(Math.abs(displayedTotalDailyChange)) ]]
                                </p>
                            </div>
                            <!-- Total Profit/Loss -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? '总盈亏' : 'Total Profit/Loss' ]]
                                </p>
                                <p :class="portfolioStats.total_pnl >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ portfolioStats.total_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(Math.abs(portfolioStats.total_pnl || 0)) ]]
                                </p>
                                <div class="text-blue-100 text-xs mt-2 space-y-1">
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? '已实现' : 'Realized' ]]:</span>
                                        <span :class="portfolioStats.realized_pnl >= 0 ? 'text-green-300' : 'text-red-300'">
                                            [[ portfolioStats.realized_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(Math.abs(portfolioStats.realized_pnl || 0)) ]]
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? '未实现' : 'Unrealized' ]]:</span>
                                        <span :class="portfolioStats.unrealized_pnl >= 0 ? 'text-green-300' : 'text-red-300'">
                                            [[ portfolioStats.unrealized_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(Math.abs(portfolioStats.unrealized_pnl || 0)) ]]
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Total Profit/Loss Percentage -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? '总收益率' : 'Total Return' ]]
                                </p>
                                <p :class="(portfolioStats.total_return_rate || 0) >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ (portfolioStats.total_return_rate || 0) >= 0 ? '+' : '' ]][[ ((portfolioStats.total_return_rate || 0)).toFixed(2) ]]%
                                </p>
                                <div class="text-blue-100 text-xs mt-2">
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? '净入金' : 'Net Deposit' ]]:</span>
                                        <span>[[ displayCurrency === 'USD' ? '$' : '¥' ]][[ maskAmount(portfolioStats.net_deposit) ]]</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio Tables by Asset Type -->
                    <div class="space-y-4">
                    <!-- Cash Holdings -->
                    <div v-if="portfoliosByType.CASH && portfoliosByType.CASH.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? '现金' : 'Cash' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '币种' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '余额' : 'Balance' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '占比' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '操作' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="p in portfoliosByType.CASH" :key="p.id" class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                    <td class="px-4 py-2.5 whitespace-nowrap">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-900">[[ p.currency ]]</span>
                                            <span v-if="p.currency !== 'USD' && p.exchange_rate" class="text-xs text-gray-500">
                                                1:[[ p.exchange_rate.toFixed(4) ]]
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-right">
                                        <div class="flex flex-col items-end">
                                            <span v-if="p.currency !== 'USD'" class="text-sm font-semibold text-gray-900">
                                                $[[ maskAmount(p.value_in_usd) ]]
                                            </span>
                                            <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-semibold text-gray-900'">
                                                [[ maskAmount(p.total_quantity) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-right">
                                        <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || p.total_quantity) ]]%</span>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-center">
                                        <button 
                                            @click.stop="openCashFlowModal()"
                                            class="text-green-600 hover:text-green-800 text-sm font-medium"
                                        >
                                            [[ currentLanguage === 'zh' ? '入金/出金' : 'Deposit/Withdraw' ]]
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stock Holdings -->
                    <div v-if="portfoliosByType.STOCK && portfoliosByType.STOCK.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? '股票' : 'Stocks' ]]
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full relative">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="sticky left-0 z-10 bg-gray-50 px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? '标的' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '货币' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '均价' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '现价' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '今日涨跌' : 'Today' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '涨跌金额' : 'Change $' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '市值' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '盈亏' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '占比' : 'Allocation' ]]
                                    </th>
                                    <th class="sticky right-0 z-10 bg-gray-50 px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? '操作' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.STOCK" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="sticky left-0 z-10 bg-white px-6 py-4 whitespace-nowrap border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="sticky right-0 z-10 bg-white px-6 py-4 whitespace-nowrap text-center border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '交易' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '分析' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-6 py-4">                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? '交易记录' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? '暂无交易记录' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '日期' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '类型' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '价格' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '备注' : 'Notes' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? '买入' : 'BUY') : (currentLanguage === 'zh' ? '卖出' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                    <!-- CN Fund Holdings -->
                    <div v-if="portfoliosByType.FUND_CN && portfoliosByType.FUND_CN.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? '中国基金' : 'CN Funds' ]]
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full relative">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="sticky left-0 z-10 bg-gray-50 px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? '标的' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '货币' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '份额' : 'Shares' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '均价' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '现价' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '今日涨跌' : 'Today' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '涨跌金额' : 'Change $' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '市值' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '盈亏' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '占比' : 'Allocation' ]]
                                    </th>
                                    <th class="sticky right-0 z-10 bg-gray-50 px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? '操作' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.FUND_CN" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="sticky left-0 z-10 bg-white px-6 py-4 whitespace-nowrap border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="sticky right-0 z-10 bg-white px-6 py-4 whitespace-nowrap text-center border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '交易' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol, 'FUND_CN', true)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '分析' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? '交易记录' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? '暂无交易记录' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '日期' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '类型' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '价格' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '份额' : 'Shares' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '备注' : 'Notes' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? '买入' : 'BUY') : (currentLanguage === 'zh' ? '卖出' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bitcoin Holdings -->
                    <div v-if="portfoliosByType.BITCOIN && portfoliosByType.BITCOIN.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? '比特币' : 'Bitcoin' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '标的' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '货币' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '均价' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '现价' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '市值' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '盈亏' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '占比' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '操作' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.BITCOIN" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '交易' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '分析' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? '交易记录' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? '暂无交易记录' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '日期' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '类型' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '价格' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '备注' : 'Notes' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? '买入' : 'BUY') : (currentLanguage === 'zh' ? '卖出' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Gold Holdings -->
                    <div v-if="portfoliosByType.GOLD && portfoliosByType.GOLD.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? '黄金' : 'Gold' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '标的' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '货币' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '均价' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '现价' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '市值' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '盈亏' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '占比' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? '操作' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.GOLD" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.current_value || p.total_cost) ]]%</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '交易' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? '分析' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? '交易记录' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? '暂无交易记录' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '日期' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '类型' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '价格' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? '备注' : 'Notes' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? '买入' : 'BUY') : (currentLanguage === 'zh' ? '卖出' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    </div>  <!-- End v-else block -->
                </div>
            </div>
        </div>

        <!-- Add Transaction Modal -->
        <div v-if="showAddTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showAddTransactionModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? '添加交易记录' : 'Add Transaction' ]]
                    </h3>
                    <button @click="showAddTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Symbol -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-700">
                                [[ currentLanguage === 'zh' ? '标的代码' : 'Symbol' ]]
                            </label>
                            <div class="flex bg-gray-100 rounded-lg p-1">
                                <button 
                                    @click="searchType = 'ALL'"
                                    :class="['px-3 py-1 text-xs rounded-md transition-all', searchType === 'ALL' ? 'bg-white shadow text-purple-600 font-bold' : 'text-gray-500 hover:text-gray-700']"
                                >
                                    Global
                                </button>
                                <button 
                                    @click="searchType = 'FUND_CN'"
                                    :class="['px-3 py-1 text-xs rounded-md transition-all', searchType === 'FUND_CN' ? 'bg-white shadow text-purple-600 font-bold' : 'text-gray-500 hover:text-gray-700']"
                                >
                                    CN Fund
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <input 
                                v-model="transactionForm.symbol" 
                                @input="handleTransactionSymbolSearch"
                                type="text" 
                                placeholder="AAPL"
                                :readonly="transactionSymbolSelected"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none uppercase"
                            >
                            <button 
                                v-if="transactionForm.symbol && transactionSymbolSelected"
                                @click="clearTransactionSymbol"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <div v-if="transactionSymbolSuggestions && transactionSymbolSuggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-lg shadow-xl border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in transactionSymbolSuggestions"
                                    @click="selectTransactionSymbol(item)"
                                    class="px-4 py-2.5 hover:bg-purple-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-100 last:border-0 transition-colors"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">[[ item.symbol ]]</span>
                                        <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">[[ item.type || 'STOCK' ]]</span>
                                        <span class="text-gray-500 text-xs">[[ item.name ]]</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                            <!--提示信息：必须从搜索结果中选择-->
                            <div v-if="transactionForm.symbol && !transactionSymbolSelected" class="absolute z-40 w-full mt-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200">
                                <span class="font-medium">⚠️ [[ currentLanguage === 'zh' ? '请从搜索结果中选择' : 'Please select from search results' ]]</span>
                            </div>
                        </div>                    </div>

                    <!-- Asset Type & Currency -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? '资产类型' : 'Asset Type' ]]
                            </label>
                            <select v-model="transactionForm.asset_type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                                <option value="STOCK">[[ currentLanguage === 'zh' ? '股票' : 'Stock' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? '中国基金' : 'CN Fund' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? '加密货币' : 'Crypto' ]]</option>
                                <option value="GOLD">[[ currentLanguage === 'zh' ? '黄金' : 'Gold' ]]</option>
                                <option value="CASH">[[ currentLanguage === 'zh' ? '现金' : 'Cash' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? '币种' : 'Currency' ]]
                            </label>
                            <select v-model="transactionForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                                <option value="USD">USD</option>
                                <option value="HKD">HKD</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                    </div>

                    <!-- Transaction Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '交易类型' : 'Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="transactionForm.transaction_type = 'BUY'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    transactionForm.transaction_type === 'BUY' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '买入' : 'BUY' ]]
                            </button>
                            <button 
                                @click="transactionForm.transaction_type = 'SELL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    transactionForm.transaction_type === 'SELL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '卖出' : 'SELL' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '交易日期' : 'Date' ]]
                        </label>
                        <input 
                            v-model="transactionForm.trade_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                        >
                    </div>

                    <!-- Price, Quantity & Total Amount -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? '价格' : 'Price' ]]
                            </label>
                            <input 
                                v-model="transactionForm.price" 
                                @input="calculateTotal"
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? '数量' : 'Quantity' ]]
                            </label>
                            <input 
                                v-model="transactionForm.quantity" 
                                @input="calculateTotal"
                                type="number" 
                                step="0.01"
                                placeholder="0"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? '总金额' : 'Total' ]]
                            </label>
                            <input 
                                v-model="transactionForm.total_amount" 
                                @input="calculateQuantity"
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '备注' : 'Notes' ]] ([[ currentLanguage === 'zh' ? '可选' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="transactionForm.notes" 
                            rows="3"
                            placeholder="..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showAddTransactionModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '取消' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="addTransaction"
                            :disabled="!transactionSymbolSelected"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition-all font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            [[ currentLanguage === 'zh' ? '确认' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Operation Modal -->
        <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showCashModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? '现金操作' : 'Cash Operation' ]]
                    </h3>
                    <button @click="showCashModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Operation Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '操作类型' : 'Operation Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="cashForm.transaction_type = 'BUY'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashForm.transaction_type === 'BUY' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '入金' : 'DEPOSIT' ]]
                            </button>
                            <button 
                                @click="cashForm.transaction_type = 'SELL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashForm.transaction_type === 'SELL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '出金' : 'WITHDRAW' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Currency -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '币种' : 'Currency' ]]
                        </label>
                        <select v-model="cashForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none">
                            <option value="USD">USD (美元)</option>
                            <option value="HKD">HKD (港币)</option>
                            <option value="CNY">CNY (人民币)</option>
                        </select>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]
                        </label>
                        <input 
                            v-model="cashForm.amount" 
                            type="number" 
                            step="0.01"
                            placeholder="0.00"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-lg font-bold"
                        >
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '日期' : 'Date' ]]
                        </label>
                        <input 
                            v-model="cashForm.trade_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                        >
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '备注' : 'Notes' ]] ([[ currentLanguage === 'zh' ? '可选' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="cashForm.notes" 
                            rows="3"
                            placeholder="..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showCashModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '取消' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="addCashTransaction"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '确认' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cash Flow Modal (v2.0 - Investment Return Tracking) -->
        <div v-if="showCashFlowModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showCashFlowModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? '资金流水' : 'Cash Flow' ]]
                    </h3>
                    <button @click="showCashFlowModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Flow Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '类型' : 'Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="cashFlowForm.flow_type = 'DEPOSIT'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashFlowForm.flow_type === 'DEPOSIT' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '入金' : 'Deposit' ]]
                            </button>
                            <button 
                                @click="cashFlowForm.flow_type = 'WITHDRAWAL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashFlowForm.flow_type === 'WITHDRAWAL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? '出金' : 'Withdrawal' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '日期' : 'Date' ]]
                        </label>
                        <input 
                            v-model="cashFlowForm.flow_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        >
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '金额' : 'Amount' ]]
                        </label>
                        <input 
                            v-model="cashFlowForm.amount" 
                            type="number" 
                            step="0.01"
                            min="0"
                            :placeholder="currentLanguage === 'zh' ? '请输入金额' : 'Enter amount'"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg font-bold"
                        >
                    </div>

                    <!-- Currency -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '币种' : 'Currency' ]]
                        </label>
                        <select v-model="cashFlowForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="USD">USD (美元)</option>
                            <option value="CNY">CNY (人民币)</option>
                            <option value="HKD">HKD (港币)</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? '备注' : 'Notes' ]] ([[ currentLanguage === 'zh' ? '选填' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="cashFlowForm.notes" 
                            rows="2"
                            :placeholder="currentLanguage === 'zh' ? '选填' : 'Optional'"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showCashFlowModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '取消' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="submitCashFlow"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? '确定' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, watch, onMounted } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // 迁移旧的 localStorage key 到新的 key
                if (localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences')) {
                    try {
                        const oldState = JSON.parse(localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences') || '{}');
                        localStorage.setItem('investPilotPreferences', JSON.stringify({
                            currentTab: oldState.currentTab,
                            currentLanguage: oldState.currentLanguage,
                            selectedModel: oldState.selectedModel
                        }));
                        localStorage.removeItem('quantAgentState'); // 删除旧 key
                        localStorage.removeItem('quantAgentPreferences'); // 删除旧 key
                    } catch (e) {
                        console.warn('Failed to migrate old state:', e);
                    }
                }
                
                // State Initialization with Persistence Check
                const getSavedPreferences = () => {
                    try {
                        return JSON.parse(localStorage.getItem('investPilotPreferences') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const getSessionData = () => {
                    try {
                        return JSON.parse(sessionStorage.getItem('investPilotSession') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const savedPreferences = getSavedPreferences();
                const sessionData = getSessionData();

                const currentTab = ref(savedPreferences.currentTab || 'portfolio');
                const currentLanguage = ref(savedPreferences.currentLanguage || 'en');
                
                // Disclaimer Banner State
                const showDisclaimer = ref(!localStorage.getItem('disclaimerDismissed'));
                
                // Toast Notification
                const toastMessage = ref('');
                const toastType = ref('info'); // 'success', 'error', 'info'
                
                // Duplicate Task Dialog
                const showDuplicateTaskDialog = ref(false);
                const duplicateTaskInfo = ref({ symbol: '', task_id: '', created_at: '' });
                const pendingAnalysisSymbol = ref(null);
                
                // Loading States (Independent)
                const loadingAnalysis = ref(false);
                const loadingRecommend = ref(false);
                const loadingPortfolio = ref(false);
                const creatingTask = ref(false);
                
                // 从 sessionStorage 恢复会话数据（刷新页面时保留）
                const recCriteria = ref(sessionData.recCriteria || { market: 'Any', asset_type: 'STOCK', include_etf: 'false', capital: 'Any', risk: 'Any', frequency: 'Any' });
                const recommendationResult = ref(sessionData.recommendationResult || null);
                const portfolio = ref(sessionData.portfolio || { symbol: '', avg_price: '', percentage: '', asset_type: 'STOCK' });
                const portfolioResult = ref(sessionData.portfolioResult || null);
                
                const query = ref(sessionData.query || '');
                const selectedAssetType = ref('STOCK');
                const suggestions = ref([]);
                const klineSymbolSelected = ref(false); // Track if user selected from suggestions
                const klineAssetType = ref(sessionData.klineAssetType || 'STOCK'); // K线分析的资产类型
                const analysisResult = ref(sessionData.analysisResult || null);
                const chartRef = ref(null);
                let chartInstance = null;
                
                // Model Management
                const models = ref([]);
                const selectedModel = ref(savedPreferences.selectedModel || 'gemini-3-flash-preview');
                
                // Market Indices Dashboard
                const marketIndices = ref([]);
                const loadingMarketIndices = ref(false);
                const showTooltip = ref(null);
                const tooltipPosition = ref({ x: 0, y: 0 });
                
                // Hot Stocks Management
                const hotStocks = ref([]);
                const loadingHotStocks = ref(false);
                
                // Market News Management
                const marketNews = ref([]);
                const loadingMarketNews = ref(false);

                // Portfolio Management State
                const portfolios = ref([]);
                const loadingPortfolios = ref(false);
                const displayCurrency = ref('USD');
                const rates = ref({ USD_CNY: 7.2 }); // Default fallback
                const hideAmounts = ref(localStorage.getItem('investPilotHideAmounts') === 'false' ? false : true); // 从localStorage读取，默认隐藏
                const lastRefreshTime = ref(0); // 记录上次刷新时间（用于限频）
                const showAddTransactionModal = ref(false);
                const selectedPortfolio = ref(null);
                const searchType = ref('ALL');
                const transactionForm = ref({
                    symbol: '',
                    asset_type: 'STOCK',
                    transaction_type: 'BUY',
                    trade_date: new Date().toISOString().split('T')[0],
                    price: '',
                    quantity: '',
                    total_amount: '',
                    notes: '',
                    currency: 'USD'
                });
                
                // Transaction symbol search
                const transactionSymbolSuggestions = ref([]);
                const transactionSymbolSelected = ref(false);
                
                // Portfolio expansion and transactions
                const expandedPortfolios = ref([]);
                const portfolioTransactions = ref({});
                const loadingTransactions = ref({});
                
                // Cash Management
                const showCashModal = ref(false);
                const cashForm = ref({
                    transaction_type: 'BUY', // BUY = 入金, SELL = 出金
                    trade_date: new Date().toISOString().split('T')[0],
                    amount: '',
                    notes: '',
                    currency: 'USD'
                });
                
                // Portfolio Stats (v2.0 - Investment Return Tracking)
                const portfolioStats = ref({
                    currency: 'USD',
                    net_deposit: 0,           // 净入金
                    total_market_value: 0,    // 总市值
                    cash_balance: 0,          // 现金余额
                    total_cost: 0,            // 总成本（不含现金）
                    realized_pnl: 0,          // 已实现盈亏
                    unrealized_pnl: 0,        // 未实现盈亏
                    total_pnl: 0,             // 总盈亏
                    total_return_rate: 0,     // 总收益率
                    total_daily_change: 0     // 今日涨跌总金额
                });
                
                // Cash Flow Management (v2.0)
                const showCashFlowModal = ref(false);
                const cashFlowForm = ref({
                    flow_type: 'DEPOSIT',
                    flow_date: new Date().toISOString().split('T')[0],
                    amount: '',
                    currency: 'USD',
                    notes: ''
                });
                const cashFlows = ref([]);
                
                // Computed: Group portfolios by asset type
                const portfoliosByType = computed(() => {
                    const grouped = {
                        CASH: [],
                        STOCK: [],
                        FUND_CN: [],
                        BITCOIN: [],
                        GOLD: []
                    };
                    portfolios.value.forEach(p => {
                        if (!grouped[p.asset_type]) {
                            grouped[p.asset_type] = [];
                        }
                        grouped[p.asset_type].push(p);
                    });
                    return grouped;
                });
                
                // Computed: Total assets value (using current market value)
                const totalAssetsValue = computed(() => {
                    return portfolios.value.reduce((sum, p) => {
                        // Use value_in_usd for all assets to ensure proper currency conversion
                        if (p.value_in_usd !== undefined) {
                            return sum + p.value_in_usd;
                        }
                        // Fallback for assets without value_in_usd
                        if (p.asset_type === 'CASH') {
                            return sum + p.total_quantity;
                        }
                        // Use current_value if available, otherwise use total_cost
                        return sum + (p.current_value || p.total_cost);
                    }, 0);
                });
                
                // Computed: Total cost (original investment)
                const totalCost = computed(() => {
                    return portfolios.value.reduce((sum, p) => {
                        // For cash, use value_in_usd if available for proper currency conversion
                        if (p.asset_type === 'CASH') {
                            if (p.value_in_usd !== undefined) {
                                return sum + p.value_in_usd;
                            }
                            return sum + p.total_quantity; // Fallback
                        }
                        return sum + p.total_cost;
                    }, 0);
                });
                
                // Computed: Total profit/loss
                const totalProfitLoss = computed(() => {
                    return portfolios.value.reduce((sum, p) => {
                        if (p.asset_type === 'CASH') {
                            return sum + 0; // Cash has no profit/loss
                        }
                        return sum + (p.profit_loss || 0);
                    }, 0);
                });
                
                // Computed: Total profit/loss percentage
                const totalProfitLossPercent = computed(() => {
                    if (totalCost.value === 0) return 0;
                    return (totalProfitLoss.value / totalCost.value) * 100;
                });
                
                // Computed: Displayed total assets (with currency conversion)
                const displayedTotalAssets = computed(() => {
                    const usdValue = totalAssetsValue.value;
                    const currency = displayCurrency.value;
                    const rate = rates.value?.USD_CNY || 7.2;
                    if (currency === 'CNY') {
                        return usdValue * rate;
                    }
                    return usdValue;
                });
                
                // Computed: Displayed total profit/loss (with currency conversion)
                const displayedTotalProfitLoss = computed(() => {
                    const usdValue = totalProfitLoss.value;
                    if (displayCurrency.value === 'CNY') {
                        const rate = rates.value?.USD_CNY || 7.2;
                        return usdValue * rate;
                    }
                    return usdValue;
                });
                
                // Computed: Displayed total daily change (with currency conversion)
                const displayedTotalDailyChange = computed(() => {
                    const usdValue = portfolioStats.value.total_daily_change || 0;
                    if (displayCurrency.value === 'CNY') {
                        const rate = rates.value?.USD_CNY || 7.2;
                        return usdValue * rate;
                    }
                    return usdValue;
                });
                
                // User Authentication
                const currentUser = ref(null);
                const showLoginModal = ref(false);
                const isRegisterMode = ref(false);
                const showPassword = ref(false);
                const authError = ref('');
                const authLoading = ref(false);
                const showUserMenu = ref(false);
                const loginForm = ref({ nickname: '', email: '', password: '' });
                const sessionId = ref(localStorage.getItem('investPilotSessionId') || null);
                
                // Email confirmation dialog
                const showEmailConfirmDialog = ref(false);
                const emailConfirmInfo = ref({
                    email: '',
                    typo_suggestion: '',
                    score: 0
                });
                
                // Task Management
                const tasks = ref([]);
                const taskListVisible = ref(false);
                const taskFilterStatus = ref(null); // null = all, 'running', 'completed', 'terminated', 'failed'
                const taskButtonRef = ref(null);
                const taskButtonPosition = ref({ x: 0, y: 0 });
                const isDragging = ref(false);
                const dragStartPos = ref({ x: 0, y: 0 });
                const taskStatusFilters = computed(() => {
                    const isZh = currentLanguage.value === 'zh';
                    return [
                        { value: null, label: isZh ? '全部' : 'All' },
                        { value: 'running', label: isZh ? '运行中' : 'Running' },
                        { value: 'completed', label: isZh ? '已完成' : 'Completed' },
                        { value: 'terminated', label: isZh ? '已终止' : 'Terminated' },
                        { value: 'failed', label: isZh ? '失败' : 'Failed' }
                    ];
                });
                let taskPollInterval = null;
                
                // Computed: Filtered tasks
                const filteredTasks = computed(() => {
                    if (!tasks.value || !Array.isArray(tasks.value)) {
                        return [];
                    }
                    if (!taskFilterStatus.value) {
                        return tasks.value;
                    }
                    return tasks.value.filter(t => t.status === taskFilterStatus.value);
                });
                
                // Computed: Running tasks count
                const runningTasksCount = computed(() => {
                    if (!tasks.value || !Array.isArray(tasks.value)) return 0;
                    return tasks.value.filter(t => t.status === 'running').length;
                });
                
                // Load models from API
                const loadModels = async () => {
                    try {
                        const res = await fetch('/api/models');
                        const modelList = await res.json();
                        
                        // Group models by provider
                        const grouped = {};
                        modelList.forEach(m => {
                            if (!grouped[m.provider]) {
                                grouped[m.provider] = [];
                            }
                            grouped[m.provider].push({
                                id: m.id,
                                name: m.name,
                                provider: m.provider,
                                supports_search: m.supports_search,
                                status: 'normal'
                            });
                        });
                        
                        // Flatten with provider labels
                        const flattened = [];
                        const providerOrder = ['gemini', 'openai', 'anthropic', 'xai', 'qwen', 'local'];
                        const providerNames = {
                            'gemini': 'Google Gemini',
                            'openai': 'OpenAI GPT',
                            'anthropic': 'Anthropic Claude',
                            'xai': 'xAI Grok',
                            'qwen': 'Alibaba Qwen',
                            'local': 'Local Strategy'
                        };
                        
                        providerOrder.forEach(provider => {
                            if (grouped[provider]) {
                                flattened.push({
                                    id: `header_${provider}`,
                                    name: `━━━ ${providerNames[provider]} ━━━`,
                                    isHeader: true,
                                    disabled: true
                                });
                                flattened.push(...grouped[provider]);
                            }
                        });
                        
                        models.value = flattened;
                        
                        // Validate saved model
                        const validIds = modelList.map(m => m.id);
                        if (!validIds.includes(selectedModel.value)) {
                            console.warn(`Invalid saved model: ${selectedModel.value}, resetting to default`);
                            selectedModel.value = 'gemini-3-flash-preview';
                        }
                    } catch (err) {
                        console.error('Failed to load models:', err);
                        // Fallback to default models
                        models.value = [
                            { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash (Preview)', status: 'normal' },
                            { id: 'local-strategy', name: 'Local Algo (MA+RSI)', status: 'normal' }
                        ];
                    }
                };
                
                // Load trending stocks from API
                const loadTrendingStocks = async () => {
                    loadingHotStocks.value = true;
                    try {
                        const res = await fetch('/api/trending');
                        if (res.ok) {
                            const trendingList = await res.json();
                            if (Array.isArray(trendingList)) {
                                hotStocks.value = trendingList;
                            } else {
                                console.error('Trending stocks data is not an array:', trendingList);
                                hotStocks.value = [];
                            }
                        } else {
                            throw new Error('Failed to fetch trending stocks');
                        }
                    } catch (err) {
                        console.error('Failed to load trending stocks:', err);
                        // Fallback to default stocks
                        hotStocks.value = [
                            { symbol: 'NVDA', name: 'NVIDIA', price: '$850', change: 2.5, volume: '50M', market: 'NASDAQ', trendData: '10,35 30,28 50,32 70,25 90,30' },
                            { symbol: 'TSLA', name: 'Tesla', price: '$245', change: -1.2, volume: '95M', market: 'NASDAQ', trendData: '10,15 30,18 50,22 70,25 90,20' },
                            { symbol: 'AAPL', name: 'Apple', price: '$195', change: 1.8, volume: '42M', market: 'NASDAQ', trendData: '10,28 30,25 50,30 70,27 90,32' },
                            { symbol: 'MSFT', name: 'Microsoft', price: '$420', change: 1.2, volume: '22M', market: 'NASDAQ', trendData: '10,25 30,22 50,28 70,24 90,30' },
                            { symbol: '600519.SS', name: '贵州茅台', price: '¥1,680', change: 0.5, volume: '1M', market: 'SSE', trendData: '10,20 30,23 50,19 70,25 90,22' },
                            { symbol: '0700.HK', name: '腾讯控股', price: 'HK$380', change: -0.8, volume: '18M', market: 'HKEX', trendData: '10,30 30,28 50,32 70,29 90,34' },
                            { symbol: '300750.SZ', name: '宁德时代', price: '¥235', change: 3.5, volume: '8M', market: 'SZSE', trendData: '10,35 30,32 50,37 70,34 90,38' },
                            { symbol: '9988.HK', name: '阿里巴巴', price: 'HK$90', change: 1.5, volume: '40M', market: 'HKEX', trendData: '10,22 30,25 50,20 70,27 90,24' }
                        ];
                    } finally {
                        loadingHotStocks.value = false;
                    }
                };
                
                // Load market indices for dashboard
                const loadMarketIndices = async () => {
                    loadingMarketIndices.value = true;
                    try {
                        const res = await fetch('/api/market_indices');
                        if (res.ok) {
                            const indicesList = await res.json();
                            if (Array.isArray(indicesList)) {
                                marketIndices.value = indicesList;
                            } else {
                                console.error('Market indices data is not an array:', indicesList);
                                throw new Error('Invalid data format');
                            }
                        } else {
                            throw new Error('Failed to fetch market indices');
                        }
                    } catch (err) {
                        console.error('Failed to load market indices:', err);
                        // Fallback to default indices
                        marketIndices.value = [
                            { symbol: '^GSPC', name: 'S&P 500', name_zh: '标普500', market: 'US', icon: '🇺🇸', price: '4,783.45', price_raw: 4783.45, change: 25.6, change_pct: 0.54, high: 4800.2, low: 4765.3, volume: '', trend_data: '0,35 25,32 50,38 75,34 100,40', is_up: true },
                            { symbol: '^NDX', name: 'NASDAQ 100', name_zh: '纳斯达克100', market: 'US', icon: '🇺🇸', price: '15,011.35', price_raw: 15011.35, change: 102.5, change_pct: 0.69, high: 15050.8, low: 14980.2, volume: '', trend_data: '0,30 25,28 50,35 75,32 100,38', is_up: true },
                            { symbol: '^HSI', name: 'Hang Seng Index', name_zh: '恒生指数', market: 'HK', icon: '🇭🇰', price: '16,543.21', price_raw: 16543.21, change: 125.5, change_pct: 0.76, high: 16600.0, low: 16500.0, volume: '', trend_data: '0,25 25,28 50,30 75,27 100,32', is_up: true },
                            { symbol: 'HSTECH.HK', name: 'Hang Seng Tech', name_zh: '恒生科技指数', market: 'HK', icon: '🇭🇰', price: '3,456.78', price_raw: 3456.78, change: -23.4, change_pct: -0.67, high: 3480.0, low: 3450.0, volume: '', trend_data: '0,30 25,28 50,25 75,27 100,24', is_up: false },
                            { symbol: '^N225', name: 'Nikkei 225', name_zh: '日经225', market: 'JP', icon: '🇯🇵', price: '33,464.17', price_raw: 33464.17, change: -156.2, change_pct: -0.46, high: 33650.5, low: 33420.8, volume: '', trend_data: '0,25 25,28 50,22 75,26 100,20', is_up: false },
                            { symbol: 'BTC-USD', name: 'Bitcoin', name_zh: '比特币', market: 'CRYPTO', icon: '₿', price: '$43,256.80', price_raw: 43256.80, change: 1250.3, change_pct: 2.98, high: 43500.0, low: 42800.5, volume: '25.3B', trend_data: '0,20 25,25 50,22 75,30 100,35', is_up: true }
                        ];
                    } finally {
                        loadingMarketIndices.value = false;
                    }
                };
                
                // Load market news from API
                const loadMarketNews = async () => {
                    loadingMarketNews.value = true;
                    try {
                        const res = await fetch('/api/market_news');
                        if (res.ok) {
                            const newsList = await res.json();
                            if (Array.isArray(newsList)) {
                                marketNews.value = newsList;
                            } else {
                                marketNews.value = [];
                            }
                        } else {
                            marketNews.value = [];
                        }
                    } catch (err) {
                        console.error('Failed to load market news:', err);
                        marketNews.value = [];
                    } finally {
                        loadingMarketNews.value = false;
                    }
                };

                // Load portfolios
                const loadPortfolios = async () => {
                    if (!currentUser.value) return;
                    
                    // 尝试从缓存加载数据
                    const cachedData = localStorage.getItem('portfolios_cache');
                    const hasCachedData = cachedData && cachedData !== 'null';
                    
                    if (hasCachedData) {
                        try {
                            const cached = JSON.parse(cachedData);
                            // 检查缓存是否属于当前用户
                            if (cached.userId === currentUser.value.id) {
                                portfolios.value = cached.portfolios || [];
                                if (cached.rates) {
                                    rates.value = { ...rates.value, ...cached.rates };
                                }
                                if (cached.stats) {
                                    portfolioStats.value = cached.stats;
                                }
                                // 有缓存时不显示加载状态
                                loadingPortfolios.value = false;
                            }
                        } catch (err) {
                            console.error('Failed to parse cached data:', err);
                        }
                    } else {
                        // 没有缓存时显示加载状态
                        loadingPortfolios.value = true;
                    }
                    
                    try {
                        // 1. 快速加载基础数据（不含实时价格和名称）
                        const res = await fetch('/api/portfolios', {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            // 如果没有缓存，使用基础数据
                            if (!hasCachedData) {
                                portfolios.value = (data && Array.isArray(data.portfolios)) ? data.portfolios : [];
                                if (data.rates) {
                                    rates.value = { ...rates.value, ...data.rates };
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Failed to load portfolios:', err);
                        if (!hasCachedData) {
                            showToast('加载持仓失败', 'error');
                        }
                    } finally {
                        loadingPortfolios.value = false;
                    }
                    
                    // Load portfolio stats (v2.0) - 如果没有缓存才加载
                    if (!hasCachedData) {
                        await loadPortfolioStats();
                    }
                    
                    // 2. 异步刷新实时数据（后台进行）
                    refreshPortfoliosData();
                };
                
                // 异步刷新持仓数据（获取实时价格和标的名称）
                const refreshPortfoliosData = async () => {
                    if (!currentUser.value) return;
                    
                    // 限频检查：30秒内只允许刷新一次
                    const now = Date.now();
                    const REFRESH_COOLDOWN = 30 * 1000; // 30秒
                    if (now - lastRefreshTime.value < REFRESH_COOLDOWN) {
                        return;
                    }
                    
                    lastRefreshTime.value = now;
                    
                    try {
                        const res = await fetch('/api/portfolios/refresh', {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            portfolios.value = (data && Array.isArray(data.portfolios)) ? data.portfolios : [];
                            if (data.rates) {
                                rates.value = { ...rates.value, ...data.rates };
                            }
                            
                            // 刷新统计数据
                            await loadPortfolioStats();
                            
                            // 保存到缓存
                            try {
                                const cacheData = {
                                    userId: currentUser.value.id,
                                    portfolios: portfolios.value,
                                    rates: rates.value,
                                    stats: portfolioStats.value,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem('portfolios_cache', JSON.stringify(cacheData));
                            } catch (err) {
                                console.error('Failed to cache portfolios:', err);
                            }
                            
                            // 显示美观的提示通知
                            showRefreshNotification();
                        }
                    } catch (err) {
                        console.error('Failed to refresh portfolios:', err);
                    }
                };
                
                // 显示刷新完成通知
                const showRefreshNotification = () => {
                    // 创建通知元素
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 z-50 animate-slide-in-right';
                    notification.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-medium">${currentLanguage.value === 'zh' ? '已获取实时数据' : 'Real-time data updated'}</span>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // 3秒后自动消失
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        notification.style.transition = 'all 0.3s ease-out';
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 3000);
                };
                
                // Load portfolio statistics (v2.0 - Investment Return Tracking)
                const loadPortfolioStats = async () => {
                    if (!currentUser.value) return;
                    
                    try {
                        const currency = displayCurrency.value || 'USD';
                        const res = await fetch(`/api/portfolio-stats?currency=${currency}`, {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            portfolioStats.value = data;
                            // 确保总收益率是数字类型
                            if (typeof portfolioStats.value.total_return_rate !== 'number') {
                                console.warn('⚠️ 总收益率不是数字类型:', portfolioStats.value.total_return_rate);
                                portfolioStats.value.total_return_rate = parseFloat(portfolioStats.value.total_return_rate) || 0;
                            }
                            
                            // 计算今日涨跌总金额
                            let totalDailyChange = 0;
                            portfolios.value.forEach(p => {
                                if (p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price && p.total_quantity) {
                                    const dailyChangeAmount = p.current_price * p.daily_change_percent / 100 * p.total_quantity;
                                    const dailyChangeInUSD = dailyChangeAmount * (p.exchange_rate || 1);
                                    totalDailyChange += dailyChangeInUSD;
                                }
                            });
                            portfolioStats.value.total_daily_change = totalDailyChange;
                        } else {
                            // 处理错误响应
                            const errorData = await res.json().catch(() => ({ error: '获取持仓统计数据失败' }));
                            const errorMsg = errorData.error || '获取持仓统计数据失败';
                            const details = errorData.details || [];
                            
                            // 显示错误提示
                            alert(`${errorMsg}\n\n${details.length > 0 ? '详细信息：\n' + details.join('\n') : ''}`);
                            console.error('Failed to load portfolio stats:', errorData);
                        }
                    } catch (err) {
                        console.error('Failed to load portfolio stats:', err);
                        alert('获取持仓统计数据时发生网络错误，请稍后重试');
                    }
                };
                
                // Load cash flows (v2.0)
                const loadCashFlows = async () => {
                    if (!currentUser.value) return;
                    
                    try {
                        const currency = displayCurrency.value || 'USD';
                        const res = await fetch(`/api/cash-flows?currency=${currency}`, {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            cashFlows.value = data.cash_flows || [];
                        }
                    } catch (err) {
                        console.error('Failed to load cash flows:', err);
                    }
                };
                
                // Open cash flow modal (v2.0)
                const openCashFlowModal = () => {
                    cashFlowForm.value = {
                        flow_type: 'DEPOSIT',
                        flow_date: new Date().toISOString().split('T')[0],
                        amount: '',
                        currency: displayCurrency.value || 'USD',
                        notes: ''
                    };
                    showCashFlowModal.value = true;
                };
                
                // Submit cash flow (v2.0)
                const submitCashFlow = async () => {
                    if (!cashFlowForm.value.amount || parseFloat(cashFlowForm.value.amount) <= 0) {
                        showToast(currentLanguage.value === 'zh' ? '请输入有效金额' : 'Please enter a valid amount', 'error');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/cash-flows', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify(cashFlowForm.value)
                        });
                        
                        if (res.ok) {
                            const successMsg = cashFlowForm.value.flow_type === 'DEPOSIT' 
                                ? (currentLanguage.value === 'zh' ? '入金成功' : 'Deposit successful')
                                : (currentLanguage.value === 'zh' ? '出金成功' : 'Withdrawal successful');
                            showToast(successMsg, 'success');
                            showCashFlowModal.value = false;
                            
                            // Refresh data
                            await loadPortfolios();
                            await loadCashFlows();
                        } else {
                            const error = await res.json();
                            showToast(error.error || (currentLanguage.value === 'zh' ? '操作失败' : 'Operation failed'), 'error');
                        }
                    } catch (err) {
                        console.error('Cash flow error:', err);
                        showToast(currentLanguage.value === 'zh' ? '操作失败' : 'Operation failed', 'error');
                    }
                };
                
                // Delete cash flow (v2.0)
                const deleteCashFlow = async (cashFlowId) => {
                    if (!confirm(currentLanguage.value === 'zh' ? '确定要删除这条资金流水吗？' : 'Are you sure you want to delete this cash flow?')) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/cash-flows/${cashFlowId}`, {
                            method: 'DELETE',
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        
                        if (res.ok) {
                            showToast(currentLanguage.value === 'zh' ? '删除成功' : 'Deleted successfully', 'success');
                            await loadCashFlows();
                            await loadPortfolioStats();
                            await loadPortfolios();
                        } else {
                            const error = await res.json();
                            showToast(error.error || (currentLanguage.value === 'zh' ? '删除失败' : 'Delete failed'), 'error');
                        }
                    } catch (err) {
                        console.error('Delete cash flow error:', err);
                        showToast(currentLanguage.value === 'zh' ? '删除失败' : 'Delete failed', 'error');
                    }
                };

                // Calculate total amount based on price and quantity
                const calculateTotal = () => {
                    if (transactionForm.value.price && transactionForm.value.quantity) {
                        transactionForm.value.total_amount = (parseFloat(transactionForm.value.price) * parseFloat(transactionForm.value.quantity)).toFixed(2);
                    }
                };

                // Calculate quantity based on price and total amount
                const calculateQuantity = () => {
                    if (transactionForm.value.price && transactionForm.value.total_amount) {
                        transactionForm.value.quantity = (parseFloat(transactionForm.value.total_amount) / parseFloat(transactionForm.value.price)).toFixed(4);
                    }
                };

                // Toggle display currency
                const toggleCurrency = () => {
                    console.log('Before toggle:', displayCurrency.value);
                    console.log('totalAssetsValue:', totalAssetsValue.value);
                    console.log('rates:', rates.value);
                    displayCurrency.value = displayCurrency.value === 'USD' ? 'CNY' : 'USD';
                    console.log('After toggle:', displayCurrency.value);
                    console.log('displayedTotalAssets:', displayedTotalAssets.value);
                };

                // 新增：切换金额显示/隐藏
                const toggleAmountVisibility = () => {
                    hideAmounts.value = !hideAmounts.value;
                    // 保存状态到localStorage
                    localStorage.setItem('investPilotHideAmounts', hideAmounts.value.toString());
                };

                // 新增：遮罩金额显示
                const maskAmount = (value) => {
                    if (!hideAmounts.value) {
                        return formatNumber(value);
                    }
                    // 统一显示 3 个星号，避免泄露金额大小信息
                    return '***';
                };

                // Add transaction
                const addTransaction = async () => {
                    if (!transactionForm.value.symbol || !transactionForm.value.price || (!transactionForm.value.quantity && !transactionForm.value.total_amount)) {
                        showToast('请填写完整信息', 'error');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/transactions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify(transactionForm.value)
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            showToast('交易记录添加成功', 'success');
                            showAddTransactionModal.value = false;
                            
                            // Reset form
                            transactionForm.value = {
                                symbol: '',
                                asset_type: 'STOCK',
                                transaction_type: 'BUY',
                                trade_date: new Date().toISOString().split('T')[0],
                                price: '',
                                quantity: '',
                                total_amount: '',
                                notes: '',
                                currency: 'USD'
                            };
                            
                            // Reload portfolios and stats
                            await loadPortfolios();
                            await loadPortfolioStats();                        } else {
                            const error = await res.json();
                            showToast(error.error || '添加失败', 'error');
                        }
                    } catch (err) {
                        console.error('Failed to add transaction:', err);
                        showToast('添加交易记录失败', 'error');
                    }
                };

                // Open add transaction modal
                const openAddTransactionModal = (portfolio = null) => {
                    if (portfolio) {
                        transactionForm.value.symbol = portfolio.symbol;
                        transactionForm.value.asset_type = portfolio.asset_type;
                        transactionForm.value.currency = portfolio.currency;
                        transactionSymbolSelected.value = true;
                    } else {
                        transactionSymbolSelected.value = false;
                    }
                    transactionSymbolSuggestions.value = [];
                    showAddTransactionModal.value = true;
                };
                
                // Handle transaction symbol search
                let transactionSearchTimeout = null;
                const handleTransactionSymbolSearch = (e) => {
                    const val = e.target.value;
                    if (val.length < 1) {
                        transactionSymbolSuggestions.value = [];
                        transactionSymbolSelected.value = false;
                        return;
                    }
                    
                    if (transactionSymbolSelected.value) {
                        return; // Don't search if already selected
                    }
                    
                    // Clear previous timeout
                    if (transactionSearchTimeout) {
                        clearTimeout(transactionSearchTimeout);
                    }
                    
                    // Set new timeout for debounce
                    transactionSearchTimeout = setTimeout(async () => {
                        try {
                            const res = await fetch(`/api/search?q=${val}&type=${searchType.value}`);
                            transactionSymbolSuggestions.value = await res.json();
                        } catch (err) {
                            console.error(err);
                        }
                    }, 300);
                };
                
                // Select transaction symbol from suggestions
                const selectTransactionSymbol = async (item) => {
                    transactionForm.value.symbol = item.symbol;
                    transactionForm.value.asset_type = item.type || 'STOCK';
                    if (item.type === 'FUND_CN') {
                        transactionForm.value.currency = 'CNY';
                    }
                    transactionForm.value.trade_date = new Date().toISOString().split('T')[0];
                    transactionSymbolSuggestions.value = [];
                    transactionSymbolSelected.value = true;
                    
                    // Auto-fetch current price
                    try {
                        const res = await fetch(`/api/current-price?symbol=${item.symbol}&asset_type=${item.type || 'STOCK'}`);
                        if (res.ok) {
                            const data = await res.json();
                            transactionForm.value.price = data.price;
                        }
                    } catch (err) {
                        console.error('Failed to fetch current price:', err);
                        // If price fetch fails, leave price empty for user to input
                    }
                };
                
                // Clear transaction symbol selection
                const clearTransactionSymbol = () => {
                    transactionForm.value.symbol = '';
                    transactionForm.value.asset_type = 'STOCK';
                    transactionForm.value.price = '';
                    transactionForm.value.trade_date = new Date().toISOString().split('T')[0];
                    transactionSymbolSelected.value = false;
                    transactionSymbolSuggestions.value = [];
                };
                
                // Open cash modal
                const openCashModal = () => {
                    showCashModal.value = true;
                };
                
                // Add cash transaction
                const addCashTransaction = async () => {
                    if (!cashForm.value.amount) {
                        showToast(currentLanguage.value === 'zh' ? '请填写金额' : 'Please enter amount', 'error');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/transactions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({
                                symbol: 'CASH',
                                asset_type: 'CASH',
                                transaction_type: cashForm.value.transaction_type,
                                trade_date: cashForm.value.trade_date,
                                price: 1, // 现金价格固定为1
                                quantity: parseFloat(cashForm.value.amount),
                                notes: cashForm.value.notes,
                                currency: cashForm.value.currency
                            })
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            showToast(
                                currentLanguage.value === 'zh' 
                                    ? (cashForm.value.transaction_type === 'BUY' ? '入金成功' : '出金成功')
                                    : (cashForm.value.transaction_type === 'BUY' ? 'Deposit successful' : 'Withdrawal successful'),
                                'success'
                            );
                            showCashModal.value = false;
                            
                            // Reset form
                            cashForm.value = {
                                transaction_type: 'BUY',
                                trade_date: new Date().toISOString().split('T')[0],
                                amount: '',
                                notes: '',
                                currency: 'USD'
                            };
                            
                            // Refresh portfolios
                            await loadPortfolios();
                        } else {
                            const error = await res.json();
                            showToast(error.error || (currentLanguage.value === 'zh' ? '操作失败' : 'Operation failed'), 'error');
                        }
                    } catch (err) {
                        console.error('Failed to add cash transaction:', err);
                        showToast(currentLanguage.value === 'zh' ? '操作失败' : 'Operation failed', 'error');
                    }
                };
                
                // Toggle portfolio expand/collapse
                const togglePortfolioExpand = async (portfolioId) => {
                    const index = expandedPortfolios.value.indexOf(portfolioId);
                    if (index > -1) {
                        // Collapse
                        expandedPortfolios.value.splice(index, 1);
                    } else {
                        // Expand and load transactions
                        expandedPortfolios.value.push(portfolioId);
                        await loadPortfolioTransactions(portfolioId);
                    }
                };
                
                // Load transactions for a portfolio
                const loadPortfolioTransactions = async (portfolioId) => {
                    if (!currentUser.value) return;
                    
                    // Find the portfolio object
                    const portfolio = portfolios.value.find(p => p.id === portfolioId);
                    if (!portfolio) {
                        console.error('Portfolio not found:', portfolioId);
                        return;
                    }
                    
                    loadingTransactions.value[portfolioId] = true;
                    try {
                        // Build query parameters
                        const params = new URLSearchParams({
                            asset_type: portfolio.asset_type || 'STOCK'
                        });
                        if (portfolio.currency) {
                            params.append('currency', portfolio.currency);
                        }
                        
                        const res = await fetch(`/api/portfolios/${portfolio.symbol}/transactions?${params.toString()}`, {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            portfolioTransactions.value[portfolioId] = data.transactions || [];
                        }
                    } catch (err) {
                        console.error('Failed to load transactions:', err);
                    } finally {
                        loadingTransactions.value[portfolioId] = false;
                    }
                };
                
                // Format number with commas
                const formatNumber = (num) => {
                    if (num === null || num === undefined) return '0';
                    const n = parseFloat(num);
                    if (isNaN(n)) return '0';
                    return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };
                
                // Calculate allocation percentage
                const calculateAllocation = (value) => {
                    const total = totalAssetsValue.value;
                    if (total === 0) return '0.00';
                    return ((value / total) * 100).toFixed(2);
                };
                
                // Trade Expansion State
                const expandedTrades = ref({});
                
                // All transaction records (AI signals + user transactions)
                const allTransactionRecords = ref([]);

                // --- Computed Properties ---

                const currentModelStatus = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.status : 'normal';
                });

                const selectedModelName = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.name : '';
                });

                // Filter models based on tab
                const availableModels = computed(() => {
                    let filtered = models.value;
                    
                    if (currentTab.value === 'recommend') {
                        // Disable local strategy for recommendation tab
                        filtered = filtered.map(m => {
                            if (m.id === 'local-strategy') {
                                return { ...m, disabled: true };
                            }
                            return m;
                        });
                    }
                    
                    return filtered;
                });

                // Computed Stats
                const stats = computed(() => {
                    if (!analysisResult.value) return {};
                    const trades = analysisResult.value.analysis.trades || [];
                    const totalTrades = trades.length;
                    
                    let winCount = 0;
                    let totalReturnVal = 0.0;
                    let unrealizedReturnVal = 0.0;
                    let closedCount = 0;
                    let isHolding = false;

                    trades.forEach(t => {
                        if (t.status === 'CLOSED') {
                            closedCount++;
                            const rateStr = t.return_rate.replace('%', '');
                            const rate = parseFloat(rateStr);
                            if (!isNaN(rate)) {
                                totalReturnVal += rate;
                                if (rate > 0) winCount++;
                            }
                        } else if (t.status === 'HOLDING') {
                            isHolding = true;
                            const rateStr = t.return_rate.split('%')[0];
                            const rate = parseFloat(rateStr);
                            if (!isNaN(rate)) {
                                unrealizedReturnVal += rate;
                            }
                        }
                    });

                    const winRate = closedCount > 0 ? Math.round((winCount / closedCount) * 100) : 0;
                    
                    return {
                        totalTrades,
                        winRate,
                        totalReturn: totalReturnVal.toFixed(1),
                        unrealizedReturn: unrealizedReturnVal.toFixed(1),
                        currentStatus: isHolding ? (currentLanguage.value === 'zh' ? '持仓中' : 'HOLDING') : (currentLanguage.value === 'zh' ? '空仓' : 'EMPTY')
                    };
                });

                // Computed: Current Portfolio for Analysis
                const currentPortfolio = computed(() => {
                    if (!query.value) return null;
                    return portfolios.value.find(p => p.symbol === query.value);
                });

                // --- Persistence & Watchers ---

                // 保存用户偏好设置到 localStorage（永久保存）
                watch(
                    [currentTab, currentLanguage, selectedModel],
                    () => {
                        const preferences = {
                            currentTab: currentTab.value,
                            currentLanguage: currentLanguage.value,
                            selectedModel: selectedModel.value
                        };
                        localStorage.setItem('investPilotPreferences', JSON.stringify(preferences));
                    },
                    { deep: true }
                );
                
                // 保存会话数据到 sessionStorage（刷新保留，关闭标签页清除）
                watch(
                    [recCriteria, recommendationResult, portfolio, portfolioResult, query, analysisResult],
                    () => {
                        const sessionData = {
                            recCriteria: recCriteria.value,
                            recommendationResult: recommendationResult.value,
                            portfolio: portfolio.value,
                            portfolioResult: portfolioResult.value,
                            query: query.value,
                            analysisResult: analysisResult.value
                        };
                        sessionStorage.setItem('investPilotSession', JSON.stringify(sessionData));
                    },
                    { deep: true }
                );

                // Auto-switch model if invalid for current tab
                watch(currentTab, (newTab) => {
                    if (newTab === 'recommend' && selectedModel.value === 'local-strategy') {
                        selectedModel.value = 'models/gemini-3-flash-preview';
                    }
                    if (newTab === 'portfolio' && currentUser.value) {
                        loadPortfolios();
                    }
                });

                // 监听 tab 切换，恢复 k 线图
                watch(currentTab, (newTab, oldTab) => {
                    if (newTab === 'analysis' && analysisResult.value) {
                        // 切换回分析页时，如果有数据，重新初始化图表
                        nextTick(() => {
                            if (chartRef.value) {
                                initChart(analysisResult.value);
                                // 确保图表尺寸正确
                                if (chartInstance) {
                                    setTimeout(() => {
                                        chartInstance.resize();
                                    }, 100);
                                }
                            }
                        });
                    }
                });

                // Draggable Task Button Functions
                const startDrag = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return; // Don't drag if clicking the toggle button
                    }
                    isDragging.value = true;
                    dragStartPos.value = {
                        x: e.clientX - taskButtonPosition.value.x,
                        y: e.clientY - taskButtonPosition.value.y
                    };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                    e.preventDefault();
                };
                
                const onDrag = (e) => {
                    if (!isDragging.value) return;
                    const newX = e.clientX - dragStartPos.value.x;
                    const newY = e.clientY - dragStartPos.value.y;
                    
                    // Constrain to viewport
                    const maxX = window.innerWidth - (taskButtonRef.value?.offsetWidth || 80);
                    const maxY = window.innerHeight - (taskButtonRef.value?.offsetHeight || 80);
                    
                    taskButtonPosition.value = {
                        x: Math.max(0, Math.min(newX, maxX)),
                        y: Math.max(0, Math.min(newY, maxY))
                    };
                    
                    // Save position to localStorage
                    localStorage.setItem('taskButtonPosition', JSON.stringify(taskButtonPosition.value));
                };
                
                const stopDrag = () => {
                    isDragging.value = false;
                    document.removeEventListener('mousemove', onDrag);
                    document.removeEventListener('mouseup', stopDrag);
                };
                
                // Load saved button position
                const loadButtonPosition = () => {
                    try {
                        const saved = localStorage.getItem('taskButtonPosition');
                        if (saved) {
                            const pos = JSON.parse(saved);
                            // Validate position is still within viewport
                            const maxX = window.innerWidth - 80;
                            const maxY = window.innerHeight - 80;
                            taskButtonPosition.value = {
                                x: Math.max(0, Math.min(pos.x, maxX)),
                                y: Math.max(0, Math.min(pos.y, maxY))
                            };
                        } else {
                            // Default position: bottom right
                            taskButtonPosition.value = {
                                x: window.innerWidth - 80,
                                y: window.innerHeight - 80
                            };
                        }
                    } catch {
                        taskButtonPosition.value = {
                            x: window.innerWidth - 80,
                            y: window.innerHeight - 80
                        };
                    }
                };

                // 刷新页面后恢复图表（如果有 analysisResult）
                onMounted(async () => {
                    // Load button position
                    loadButtonPosition();
                    
                    // Update position on window resize
                    window.addEventListener('resize', () => {
                        const maxX = window.innerWidth - 80;
                        const maxY = window.innerHeight - 80;
                        taskButtonPosition.value = {
                            x: Math.min(taskButtonPosition.value.x, maxX),
                            y: Math.min(taskButtonPosition.value.y, maxY)
                        };
                    });
                    
                    // Close user menu when clicking outside
                    document.addEventListener('click', (e) => {
                        const userMenuContainer = document.getElementById('user-menu-container');
                        if (showUserMenu.value && userMenuContainer && !userMenuContainer.contains(e.target)) {
                            showUserMenu.value = false;
                        }
                    });
                    
                    // Check authentication first
                    await checkAuth();
                    
                    // Load available models, trending stocks, and market news
                    loadModels();
                    loadMarketIndices();
                    loadTrendingStocks();
                    loadMarketNews();
                    
                    if (analysisResult.value) {
                        nextTick(() => {
                            initChart(analysisResult.value);
                        });
                    }
                    
                    // Start task polling if authenticated
                    if (currentUser.value) {
                        loadTasks();
                        startTaskPolling();
                        loadPortfolios();
                    }
                });

                // --- Functions ---

                const debounce = (fn, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                };

                const handleSearch = debounce(async (e) => {
                    const val = e.target.value;
                    if (val.length < 1) {
                        suggestions.value = [];
                        klineSymbolSelected.value = false; // Reset selection state
                        return;
                    }
                    klineSymbolSelected.value = false; // User is typing, not selected from suggestions
                    try {
                        // 根据选择的品类传递不同的 search_type
                        let searchType = 'ALL';
                        if (klineAssetType.value === 'FUND_CN') {
                            searchType = 'FUND_CN';
                        }
                        const res = await fetch(`/api/search?q=${val}&type=${searchType}`);
                        suggestions.value = await res.json();
                    } catch (err) {
                        console.error(err);
                    }
                }, 300);

                const selectStock = (item) => {
                    query.value = item.symbol;
                    selectedAssetType.value = item.type || 'STOCK';
                    klineAssetType.value = item.type || 'STOCK'; // 同步更新 klineAssetType
                    suggestions.value = [];
                    klineSymbolSelected.value = true; // Mark as selected from suggestions
                };

                const clearKlineSelection = () => {
                    query.value = '';
                    klineSymbolSelected.value = false;
                    suggestions.value = [];
                    selectedAssetType.value = 'STOCK';
                };

                const getPlaceholderText = () => {
                    const placeholders = {
                        'STOCK': {
                            'zh': '输入股票代码 (如 AAPL, TSLA, 600519.SS)',
                            'en': 'Enter stock symbol (e.g., AAPL, TSLA, 600519.SS)'
                        },
                        'CRYPTO': {
                            'zh': '输入加密货币代码 (如 BTC-USD, ETH-USD)',
                            'en': 'Enter crypto symbol (e.g., BTC-USD, ETH-USD)'
                        },
                        'COMMODITY': {
                            'zh': '输入商品代码 (如 GC=F, CL=F)',
                            'en': 'Enter commodity symbol (e.g., GC=F, CL=F)'
                        },
                        'FUND_CN': {
                            'zh': '输入基金代码 (如 000001, 110022)',
                            'en': 'Enter fund code (e.g., 000001, 110022)'
                        },
                        'BOND': {
                            'zh': '输入债券代码 (如 ^TNX, ^TYX)',
                            'en': 'Enter bond symbol (e.g., ^TNX, ^TYX)'
                        },
                        'INDEX': {
                            'zh': '输入指数代码 (如 ^GSPC, ^DJI, 000001.SS)',
                            'en': 'Enter index symbol (e.g., ^GSPC, ^DJI, 000001.SS)'
                        },
                        'ETF': {
                            'zh': '输入ETF代码 (如 SPY, QQQ, VOO)',
                            'en': 'Enter ETF symbol (e.g., SPY, QQQ, VOO)'
                        }
                    };
                    
                    const assetType = klineAssetType.value || 'STOCK';
                    const lang = currentLanguage.value === 'zh' ? 'zh' : 'en';
                    return placeholders[assetType]?.[lang] || placeholders['STOCK'][lang];
                };

                const toggleTrade = (index) => {
                    expandedTrades.value[index] = !expandedTrades.value[index];
                };

                const showToast = (message, type = 'info', duration = 3000) => {
                    toastMessage.value = message;
                    toastType.value = type;
                    setTimeout(() => {
                        toastMessage.value = '';
                    }, duration);
                };

                const analyzeStock = async (symbol, assetType = null) => {
                    if (!symbol) return;
                    
                    // Check authentication
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    // 使用传入的参数，如果没有则使用响应式变量的值
                    const finalAssetType = assetType !== null ? assetType : klineAssetType.value;
                    
                    // 更新响应式变量（用于UI显示）
                    if (assetType !== null) klineAssetType.value = assetType;
                    
                    // 判断是否为中国基金
                    const isCnFund = finalAssetType === 'FUND_CN';
                    
                    suggestions.value = []; // Clear suggestions
                    creatingTask.value = true;
                    
                    // Show initial toast
                    showToast(
                        currentLanguage.value === 'zh' ? '正在创建分析任务...' : 'Creating analysis task...',
                        'info',
                        2000
                    );
                    
                    try {
                        // Create async task
                        const res = await fetch('/api/analyze_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({ 
                                symbol,
                                asset_type: finalAssetType,
                                is_cn_fund: isCnFund,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            // Show success toast
                            showToast(
                                currentLanguage.value === 'zh' ? `任务已创建：${symbol}` : `Task created: ${symbol}`,
                                'success',
                                3000
                            );
                            
                            // Show task list with animation
                            taskListVisible.value = true;
                            
                            // Small delay to ensure task is saved to DB
                            await new Promise(resolve => setTimeout(resolve, 300));
                            await loadTasks();
                            
                            // Highlight the new task
                            const newTask = tasks.value.find(t => t.task_id === data.task_id);
                            if (newTask) {
                                newTask._isNew = true;
                                setTimeout(() => {
                                    if (newTask) delete newTask._isNew;
                                }, 2000);
                            }
                            
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                analysisResult.value = result;
                                expandedTrades.value = {};
                                if (result.analysis && result.analysis.analysis_summary && result.analysis.analysis_summary.includes('Quota Exceeded')) {
                            const m = models.value.find(m => m.id === selectedModel.value);
                            if (m) m.status = 'limit';
                        }

                                // Show completion toast
                                showToast(
                                    currentLanguage.value === 'zh' ? `🎉 分析完成：${symbol}` : `🎉 Analysis completed: ${symbol}`,
                                    'success',
                                    3000
                                );
                                
                                nextTick(() => {
                                    if (chartRef.value) {
                                        initChart(result);
                                    }
                                });
                            });
                        } else if (data.error === 'duplicate_task') {
                            // Handle duplicate task
                            duplicateTaskInfo.value = {
                                symbol: symbol,
                                task_id: data.existing_task_id,
                                created_at: data.existing_task_created_at
                            };
                            pendingAnalysisSymbol.value = symbol;
                            showDuplicateTaskDialog.value = true;
                        } else {
                            throw new Error(data.error || data.message || 'Failed to create task');
                        }
                    } catch (err) {
                        showToast(
                            currentLanguage.value === 'zh' ? `❌ 创建任务失败：${err.message}` : `❌ Failed to create task: ${err.message}`,
                            'error',
                            4000
                        );
                        console.error(err);
                    } finally {
                        creatingTask.value = false;
                    }
                };

                const initChart = (data) => {
                    if (!chartRef.value) return;
                    if (chartInstance) {
                        chartInstance.dispose();
                    }
                    chartInstance = echarts.init(chartRef.value);

                    const klineData = data.kline_data.map(item => [
                        item.open, item.close, item.low, item.high
                    ]);
                    const dates = data.kline_data.map(item => item.date);
                    const volumes = data.kline_data.map((item, index) => [index, item.volume, item.open > item.close ? 1 : -1]);

                    const trades = data.analysis.trades || [];
                    const signals = data.analysis.signals || [];
                    const userTransactions = data.analysis.user_transactions || [];
                    
                    // Debug: Check data
                    console.log('🔍 Debug - signals:', signals);
                    console.log('🔍 Debug - userTransactions:', userTransactions);
                    
                    // Separate AI signals into adopted and unadopted
                    const aiSignalsUnadopted = [];
                    const aiSignalsAdopted = [];
                    const userTradeMarks = [];
                    
                    // Process AI signals
                    signals.forEach(sig => {
                        // Skip WAIT and HOLD - they are shown in summary only
                        if (sig.type === 'WAIT' || sig.type === 'HOLD') {
                            return;
                        }
                        
                        let tradeInfo = null;
                        if (sig.type === 'BUY') {
                            tradeInfo = trades.find(t => t.buy_date === sig.date);
                        } else if (sig.type === 'SELL') {
                            tradeInfo = trades.find(t => t.sell_date === sig.date);
                        }
                        
                        // Only BUY and SELL are shown on chart
                        let displayValue, displayColor, displaySymbol;
                        if (sig.type === 'BUY') {
                            displayValue = currentLanguage.value === 'zh' ? 'AI买' : 'AI-B';
                            displayColor = '#34D399';  // 更清新的绿色（原 #10B981）
                            displaySymbol = 'pin';
                        } else if (sig.type === 'SELL') {
                            displayValue = currentLanguage.value === 'zh' ? 'AI卖' : 'AI-S';
                            displayColor = '#F87171';  // 更清新的红色（原 #EF4444）
                            displaySymbol = 'pin';
                        } else {
                            // Unknown type, skip
                            return;
                        }
                        
                        const markPoint = {
                            name: sig.type,
                            coord: [sig.date, sig.price],
                            value: displayValue,
                            symbol: displaySymbol,
                            symbolSize: sig.is_current ? 35 : 28,  // 更小巧的尺寸（原 60/50 → 35/28）
                            itemStyle: {
                                color: displayColor,
                                borderColor: sig.adopted ? '#374151' : (sig.is_current ? '#F59E0B' : '#E5E7EB'),  // 更柔和的边框色
                                borderWidth: sig.is_current ? 2 : (sig.adopted ? 1.5 : 1),  // 更细的边框
                                opacity: 0.85  // 添加透明度，不完全遮挡 K 线
                            },
                            tradeDetails: tradeInfo,
                            signalInfo: sig
                        };
                        
                        if (sig.adopted) {
                            aiSignalsAdopted.push(markPoint);
                        } else {
                            aiSignalsUnadopted.push(markPoint);
                        }
                    });
                    
                    // Process user's real transactions
                    userTransactions.forEach(trans => {
                        userTradeMarks.push({
                            name: trans.type,
                            coord: [trans.date, trans.price],
                            value: trans.type === 'BUY' ? (currentLanguage.value === 'zh' ? '真买' : 'R-B') : (currentLanguage.value === 'zh' ? '真卖' : 'R-S'),
                            symbol: 'diamond',  // Different symbol for real trades
                            symbolSize: 28,  // 更小巧的尺寸（原 50 → 28）
                            itemStyle: {
                                color: trans.type === 'BUY' ? '#60A5FA' : '#FBBF24',  // 更清新的颜色（浅蓝/浅黄）
                                borderColor: '#374151',  // 柔和的深灰边框
                                borderWidth: 1.5,  // 更细的边框
                                opacity: 0.85  // 添加透明度
                            },
                            transactionInfo: trans
                        });
                    });
                    
                    // Combine all mark points
                    const allMarkPoints = [
                        ...aiSignalsUnadopted,
                        ...aiSignalsAdopted,
                        ...userTradeMarks
                    ];
                    
                    // Build complete transaction records list for display
                    const transactionRecords = [];
                    
                    // Add AI signals (BUY/SELL only, skip HOLD/WAIT)
                    signals.forEach(sig => {
                        if (sig.type === 'BUY' || sig.type === 'SELL') {
                            transactionRecords.push({
                                date: sig.date,
                                type: sig.type,
                                price: sig.price,
                                reason: sig.reason || '',
                                source: 'ai',
                                adopted: sig.adopted || false,
                                is_current: sig.is_current || false,
                                position_action: sig.position_action || null
                            });
                        }
                    });
                    
                    // Add user real transactions
                    userTransactions.forEach(trans => {
                        transactionRecords.push({
                            date: trans.date,
                            type: trans.type,
                            price: trans.price,
                            reason: trans.notes || '',
                            source: 'user',
                            quantity: trans.quantity || null,
                            amount: trans.amount || null
                        });
                    });
                    
                    // Sort by date (newest first)
                    transactionRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Debug: Check final transaction records
                    console.log('🔍 Debug - transactionRecords:', transactionRecords);
                    console.log('🔍 Debug - transactionRecords.length:', transactionRecords.length);
                    
                    // Store in reactive variable
                    allTransactionRecords.value = transactionRecords;
                    
                    // Debug: Check reactive variable
                    console.log('🔍 Debug - allTransactionRecords.value:', allTransactionRecords.value);

                    const option = {
                        title: { text: `${data.symbol} ${currentLanguage.value === 'zh' ? 'K线趋势分析' : 'Trend'}`, left: 'center' },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(item => {
                                    if (item.componentSubType === 'candlestick') {
                                        const values = item.value;
                                        result += `开盘: ${values[1]}<br/>`;
                                        result += `收盘: ${values[2]}<br/>`;
                                        result += `最低: ${values[3]}<br/>`;
                                        result += `最高: ${values[4]}<br/>`;
                                    } else if (item.seriesName === 'Volume') {
                                        result += `成交量: ${item.value}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        grid: [
                            { left: '8%', right: '5%', top: '12%', height: '58%' },
                            { left: '8%', right: '5%', top: '75%', height: '15%' }
                        ],
                        xAxis: [
                            { 
                                type: 'category', 
                                data: dates, 
                                scale: true, 
                                boundaryGap: true,
                                axisLine: { onZero: false }, 
                                splitLine: { show: false }, 
                                min: 'dataMin', 
                                max: 'dataMax'
                            },
                            { 
                                type: 'category', 
                                gridIndex: 1, 
                                data: dates, 
                                axisLabel: { show: false } 
                            }
                        ],
                        yAxis: [
                            { 
                                scale: true, 
                                splitArea: { show: true },
                                splitNumber: 5,
                                axisLabel: {
                                    formatter: function (value) {
                                        if (Math.abs(value) < 1 && value !== 0) {
                                            return value.toFixed(4);
                                        }
                                        return value.toFixed(2);
                                    }
                                }
                            },
                            { 
                                scale: true, 
                                gridIndex: 1, 
                                splitNumber: 2, 
                                axisLabel: { show: false }, 
                                axisLine: { show: false }, 
                                axisTick: { show: false }, 
                                splitLine: { show: false } 
                            }
                        ],
                        dataZoom: [
                            { 
                                type: 'inside', 
                                xAxisIndex: [0, 1], 
                                start: 50, 
                                end: 100,
                                zoomOnMouseWheel: false, // Prevent page scroll hijack
                                moveOnMouseWheel: false,
                                moveOnMouseMove: true
                            },
                            { show: true, xAxisIndex: [0, 1], type: 'slider', top: '92%', height: 20, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'K-Line',
                                type: 'candlestick',
                                data: klineData,
                                itemStyle: {
                                    color: '#EF4444',
                                    color0: '#10B981',
                                    borderColor: '#EF4444',
                                    borderColor0: '#10B981'
                                },
                                markPoint: {
                                    data: allMarkPoints,
                                    symbol: 'pin',
                                    symbolSize: 40,
                                    label: { fontSize: 10 },
                                    tooltip: {
                                        trigger: 'item',
                                        formatter: function(params) {
                                            const data = params.data;
                                            const type = data.name; 
                                            const details = data.tradeDetails;
                                            const signalInfo = data.signalInfo;
                                            const transInfo = data.transactionInfo;
                                            const isZh = currentLanguage.value === 'zh';
                                            
                                            let html = `<div style="font-family: sans-serif; padding: 4px;">`;
                                            
                                            // Determine mark type
                                            if (transInfo) {
                                                // Real user transaction
                                                html += `<div style="font-weight: bold; margin-bottom: 4px; color: ${type === 'BUY' ? '#3B82F6' : '#F59E0B'}">`;
                                                html += `${isZh ? '真实交易' : 'Real Trade'} - ${params.value} (${type})`;
                                                html += `</div>`;
                                                html += `<div>${isZh ? '日期' : 'Date'}: ${transInfo.date}</div>`;
                                                html += `<div>${isZh ? '价格' : 'Price'}: <b>${transInfo.price}</b></div>`;
                                                html += `<div>${isZh ? '数量' : 'Quantity'}: ${transInfo.quantity}</div>`;
                                                if (transInfo.notes) {
                                                    html += `<div style="margin-top: 4px; font-size: 10px; color: #999;">${transInfo.notes}</div>`;
                                                }
                                            } else if (signalInfo) {
                                                // AI signal (only BUY/SELL shown on chart)
                                                const adoptedText = signalInfo.adopted ? (isZh ? '已采纳' : 'Adopted') : (isZh ? '未采纳' : 'Not Adopted');
                                                const adoptedColor = signalInfo.adopted ? '#10B981' : '#6B7280';
                                                
                                                // Determine color based on signal type
                                                const signalColor = type === 'BUY' ? '#10B981' : '#EF4444';
                                                
                                                html += `<div style="font-weight: bold; margin-bottom: 4px; color: ${signalColor}">`;
                                                html += `${isZh ? 'AI建议' : 'AI Suggestion'} - ${params.value} (${type})`;
                                                html += `</div>`;
                                                
                                                // Show current recommendation badge
                                                if (signalInfo.is_current) {
                                                    html += `<div style="display: inline-block; background: #FFD700; color: #000; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; font-weight: bold;">`;
                                                    html += `${isZh ? '当前建议' : 'Current'}`;
                                                    html += `</div>`;
                                                }
                                                
                                                html += `<div style="color: ${adoptedColor}; font-size: 11px; margin-bottom: 4px;">● ${adoptedText}</div>`;
                                                
                                                if (details) {
                                                    if (type === 'BUY') {
                                                        html += `<div>${isZh ? '日期' : 'Date'}: ${details.buy_date}</div>`;
                                                        html += `<div>${isZh ? '价格' : 'Price'}: <b>${details.buy_price}</b></div>`;
                                                    } else {
                                                        html += `<div>${isZh ? '日期' : 'Date'}: ${details.sell_date}</div>`;
                                                        html += `<div>${isZh ? '价格' : 'Price'}: <b>${details.sell_price}</b></div>`;
                                                        html += `<div style="margin-top: 4px;">${isZh ? '收益' : 'Return'}: <span style="font-weight: bold; color: ${details.return_rate.includes('+') ? '#10B981' : '#EF4444'}">${details.return_rate}</span></div>`;
                                                    }
                                                    if (details.reason) {
                                                         const reason = details.reason.length > 60 ? details.reason.substring(0, 60) + '...' : details.reason;
                                                         html += `<div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #555; padding-top: 4px; max-width: 200px; white-space: normal;">${reason}</div>`;
                                                    }
                                                } else {
                                                    html += `<div>${isZh ? '日期' : 'Date'}: ${data.coord[0]}</div>`;
                                                    html += `<div>${isZh ? '价格' : 'Price'}: ${data.coord[1]}</div>`;
                                                    if (signalInfo.reason) {
                                                        const reason = signalInfo.reason.length > 60 ? signalInfo.reason.substring(0, 60) + '...' : signalInfo.reason;
                                                        html += `<div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #555; padding-top: 4px; max-width: 200px; white-space: normal;">${reason}</div>`;
                                                    }
                                                }
                                            }
                                            html += `</div>`;
                                            return html;
                                        }
                                    }
                                }
                            },
                            {
                                name: 'Volume',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: volumes.map(item => item[1]),
                                itemStyle: {
                                    color: (params) => {
                                        return klineData[params.dataIndex][0] < klineData[params.dataIndex][1] ? '#EF4444' : '#10B981';
                                    }
                                }
                            }
                        ]
                    };

                    chartInstance.setOption(option);
                    window.addEventListener('resize', () => chartInstance.resize());
                };

                const getRecommendations = async () => {
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    loadingRecommend.value = true;
                    recommendationResult.value = null;
                    try {
                        // Create async task
                        const res = await fetch('/api/recommend_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({
                                ...recCriteria.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            // Show task list and add animation
                            taskListVisible.value = true;
                            await loadTasks();
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                // Ensure result has proper structure
                                if (result) {
                                    if (!result.recommendations) {
                                        result.recommendations = [];
                                    } else if (!Array.isArray(result.recommendations)) {
                                        result.recommendations = [];
                                    }
                                    recommendationResult.value = result;
                                } else {
                                    recommendationResult.value = null;
                                }
                                loadingRecommend.value = false;
                            });
                        } else {
                            throw new Error(data.error || 'Failed to create task');
                        }
                    } catch (err) {
                        alert('推荐请求失败: ' + err);
                        console.error(err);
                        loadingRecommend.value = false;
                    }
                };

                const diagnosePortfolio = async () => {
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    // Check if there are any portfolios
                    if (!portfolios.value || portfolios.value.length === 0) {
                        showToast(
                            currentLanguage.value === 'zh' ? '暂无持仓数据' : 'No portfolio data',
                            'warning',
                            2000
                        );
                        return;
                    }
                    
                    creatingTask.value = true;
                    loadingPortfolio.value = true; 
                    portfolioResult.value = null;
                    
                    showToast(
                        currentLanguage.value === 'zh' ? '正在创建持仓分析任务...' : 'Creating portfolio analysis task...',
                        'info',
                        2000
                    );
                    
                    try {
                        // Create async task with all portfolios
                        const res = await fetch('/api/portfolio_advice_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({
                                portfolios: portfolios.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast(
                                currentLanguage.value === 'zh' ? '持仓分析任务已创建' : 'Portfolio analysis task created',
                                'success',
                                3000
                            );
                            
                            // Show task list and add animation
                            taskListVisible.value = true;
                            await new Promise(resolve => setTimeout(resolve, 300));
                            await loadTasks();
                            
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                portfolioResult.value = result;
                                loadingPortfolio.value = false;
                                showToast(
                                    currentLanguage.value === 'zh' ? '🎉 持仓分析完成' : '🎉 Portfolio analysis completed',
                                    'success',
                                    3000
                                );
                            });
                        } else {
                            throw new Error(data.error || 'Failed to create task');
                        }
                    } catch (err) {
                        showToast(
                            currentLanguage.value === 'zh' ? `❌ 创建任务失败：${err.message}` : `❌ Failed to create task: ${err.message}`,
                            'error',
                            4000
                        );
                        console.error(err);
                        loadingPortfolio.value = false;
                    } finally {
                        creatingTask.value = false;
                    }
                };
                
                // ========== User Authentication Functions ==========
                
                const checkAuth = async () => {
                    if (!sessionId.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/auth/check?session_id=${sessionId.value}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.authenticated) {
                                currentUser.value = data.user;
                                return;
                            }
                        }
                    } catch (err) {
                        console.error('Auth check failed:', err);
                    }
                    
                    // Not authenticated, show login modal
                    showLoginModal.value = true;
                };
                
                const openLoginModal = () => {
                    isRegisterMode.value = false;
                    authError.value = '';
                    showLoginModal.value = true;
                };
                
                const closeLoginModal = () => {
                    showLoginModal.value = false;
                    authError.value = '';
                    loginForm.value = { nickname: '', email: '', password: '' };
                };
                
                const toggleAuthMode = () => {
                    isRegisterMode.value = !isRegisterMode.value;
                    authError.value = '';
                };
                
                const handleAuthSubmit = async () => {
                    if (isRegisterMode.value) {
                        await handleRegister();
                    } else {
                        await handleLogin();
                    }
                };
                
                const handleRegister = async (emailConfirmed = false) => {
                    authError.value = '';
                    authLoading.value = true;
                    
                    try {
                        const res = await fetch('/api/auth/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nickname: loginForm.value.nickname,
                                email: loginForm.value.email,
                                password: loginForm.value.password,
                                email_confirmed: emailConfirmed
                            })
                        });
                        
                        const data = await res.json();
                        
                        // 检查是否需要邮箱确认
                        if (data.need_confirmation) {
                            authLoading.value = false;
                            emailConfirmInfo.value = {
                                email: data.email,
                                typo_suggestion: data.typo_suggestion,
                                score: data.score
                            };
                            showEmailConfirmDialog.value = true;
                            return;
                        }
                        
                        if (data.success) {
                            currentUser.value = data.user;
                            sessionId.value = data.user.session_id;
                            localStorage.setItem('investPilotSessionId', sessionId.value);
                            showLoginModal.value = false;
                            loginForm.value = { nickname: '', email: '', password: '' };
                            
                            showToast(
                                currentLanguage.value === 'zh' ? '注册成功！' : 'Registration successful!',
                                'success',
                                3000
                            );
                            
                            // Load tasks and start polling
                            loadTasks();
                            startTaskPolling();
                        } else {
                            authError.value = data.error || (currentLanguage.value === 'zh' ? '注册失败' : 'Registration failed');
                        }
                    } catch (err) {
                        authError.value = currentLanguage.value === 'zh' ? '注册失败: ' + err.message : 'Registration failed: ' + err.message;
                        console.error(err);
                    } finally {
                        authLoading.value = false;
                    }
                };
                
                const handleLogin = async () => {
                    authError.value = '';
                    authLoading.value = true;
                    
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: loginForm.value.email,
                                password: loginForm.value.password,
                                session_id: sessionId.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            currentUser.value = data.user;
                            sessionId.value = data.user.session_id;
                            localStorage.setItem('investPilotSessionId', sessionId.value);
                            showLoginModal.value = false;
                            loginForm.value = { nickname: '', email: '', password: '' };
                            
                            showToast(
                                currentLanguage.value === 'zh' ? '登录成功！' : 'Login successful!',
                                'success',
                                3000
                            );
                            
                            // Load tasks and start polling
                            loadTasks();
                            startTaskPolling();
                        } else {
                            authError.value = data.error || (currentLanguage.value === 'zh' ? '登录失败' : 'Login failed');
                        }
                    } catch (err) {
                        authError.value = currentLanguage.value === 'zh' ? '登录失败: ' + err.message : 'Login failed: ' + err.message;
                        console.error(err);
                    } finally {
                        authLoading.value = false;
                    }
                };
                
                // Email confirmation handlers
                const confirmEmail = async () => {
                    showEmailConfirmDialog.value = false;
                    await handleRegister(true); // 用户确认使用当前邮箱
                };
                
                const useSuggestedEmail = () => {
                    // 使用建议的邮箱
                    loginForm.value.email = emailConfirmInfo.value.typo_suggestion;
                    showEmailConfirmDialog.value = false;
                    showToast(
                        currentLanguage.value === 'zh' 
                            ? '已更新为建议的邮箱地址' 
                            : 'Email updated to suggested address',
                        'info',
                        2000
                    );
                };
                
                const cancelEmailConfirm = () => {
                    showEmailConfirmDialog.value = false;
                    authError.value = '';
                };
                
                const handleLogout = async () => {
                    showUserMenu.value = false;
                    
                    try {
                        await fetch('/api/auth/logout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: sessionId.value })
                        });
                    } catch (err) {
                        console.error('Logout error:', err);
                    }
                    
                    // Clear local state
                    currentUser.value = null;
                    sessionId.value = null;
                    localStorage.removeItem('investPilotSessionId');
                    
                    // Stop task polling
                    if (taskPollInterval) {
                        clearInterval(taskPollInterval);
                        taskPollInterval = null;
                    }
                    
                    // Clear tasks
                    tasks.value = [];
                    
                    showToast(
                        currentLanguage.value === 'zh' ? '已退出登录' : 'Logged out',
                        'success',
                        2000
                    );
                    
                    // Show login modal
                    setTimeout(() => {
                        showLoginModal.value = true;
                    }, 500);
                };
                
                // ========== Task Management Functions ==========
                
                const loadTasks = async () => {
                    if (!currentUser.value) return;
                    
                    try {
                        const res = await fetch('/api/tasks', {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            tasks.value = (data && Array.isArray(data.tasks)) ? data.tasks : [];
                        } else {
                            const errorData = await res.json().catch(() => ({}));
                            console.error('Failed to load tasks:', errorData.error || res.statusText);
                        }
                    } catch (err) {
                        console.error('Failed to load tasks:', err);
                    }
                };
                
                const startTaskPolling = () => {
                    if (taskPollInterval) return;
                    taskPollInterval = setInterval(() => {
                        if (currentUser.value) {
                            // Always poll if there are running tasks, or if we just created a task
                            loadTasks();
                        }
                    }, 2000); // Poll every 2 seconds
                };
                
                const stopTaskPolling = () => {
                    if (taskPollInterval) {
                        clearInterval(taskPollInterval);
                        taskPollInterval = null;
                    }
                };
                
                const pollTaskUntilComplete = async (taskId, callback) => {
                    const maxAttempts = 300; // 10 minutes max
                    let attempts = 0;
                    
                    const poll = async () => {
                        try {
                            const res = await fetch(`/api/tasks/${taskId}`, {
                                headers: { 'X-Session-ID': sessionId.value }
                            });
                            if (res.ok) {
                                const task = await res.json();
                                if (task.status === 'completed') {
                                    callback(task.task_result);
                                    loadTasks(); // Refresh task list
                                    return;
                                } else if (task.status === 'failed' || task.status === 'terminated') {
                                    loadTasks(); // Refresh task list
                                    return;
                                }
                            }
                        } catch (err) {
                            console.error('Task poll error:', err);
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 2000);
                        }
                    };
                    
                    poll();
                };
                
                const terminateTask = async (taskId) => {
                    if (!confirm(currentLanguage.value === 'zh' ? '确定要终止此任务吗？' : 'Are you sure you want to terminate this task?')) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/tasks/${taskId}/terminate`, {
                            method: 'POST',
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            await loadTasks();
                        } else {
                            alert(currentLanguage.value === 'zh' ? '终止任务失败' : 'Failed to terminate task');
                        }
                    } catch (err) {
                        alert('终止任务失败: ' + err);
                        console.error(err);
                    }
                };
                
                const showTaskResult = (task) => {
                    console.log('showTaskResult called with task:', task);
                    
                    if (!task.task_result) {
                        console.log('No task_result found');
                        return;
                    }
                    
                    const result = task.task_result;
                    console.log('Task type:', task.task_type, 'Result:', result);
                    
                    // Determine task type and show appropriate result
                    if (task.task_type === 'kline_analysis') {
                        // Switch to analysis tab and show result
                        currentTab.value = 'analysis';
                        analysisResult.value = result;
                        query.value = result.symbol || '';
                        nextTick(() => {
                            if (chartRef.value) {
                                initChart(result);
                            }
                        });
                        taskListVisible.value = false; // Close task list
                    } else if (task.task_type === 'portfolio_diagnosis') {
                        // Switch to portfolio tab and show result
                        console.log('Setting portfolioResult to:', result);
                        currentTab.value = 'portfolio';
                        portfolioResult.value = result;
                        console.log('portfolioResult.value is now:', portfolioResult.value);
                        if (task.task_params && task.task_params.symbol) {
                            portfolio.value.symbol = task.task_params.symbol;
                        }
                        taskListVisible.value = false; // Close task list
                    } else if (task.task_type === 'stock_recommendation') {
                        // Switch to recommend tab and show result
                        currentTab.value = 'recommend';
                        // Ensure result has proper structure
                        if (result) {
                            if (!result.recommendations) {
                                result.recommendations = [];
                            } else if (!Array.isArray(result.recommendations)) {
                                result.recommendations = [];
                            }
                            recommendationResult.value = result;
                        } else {
                            recommendationResult.value = null;
                        }
                        taskListVisible.value = false; // Close task list
                    }
                };
                
                const getTaskStatusLabel = (status) => {
                    const labels = {
                        'running': currentLanguage.value === 'zh' ? '运行中' : 'Running',
                        'completed': currentLanguage.value === 'zh' ? '已完成' : 'Completed',
                        'terminated': currentLanguage.value === 'zh' ? '已终止' : 'Terminated',
                        'failed': currentLanguage.value === 'zh' ? '失败' : 'Failed'
                    };
                    return labels[status] || status;
                };
                
                const getTaskTypeLabel = (type) => {
                    const labels = {
                        'kline_analysis': currentLanguage.value === 'zh' ? 'K线分析' : 'K-Line Analysis',
                        'portfolio_diagnosis': currentLanguage.value === 'zh' ? '持仓诊断' : 'Portfolio Diagnosis',
                'stock_recommendation': currentLanguage.value === 'zh' ? '资产推荐' : 'Asset Recommendation'
                    };
                    return labels[type] || type;
                };
                
                const getTaskTitle = (task) => {
                    if (task.task_params) {
                        if (task.task_type === 'kline_analysis' && task.task_params.symbol) {
                            return task.task_params.symbol;
                        } else if (task.task_type === 'portfolio_diagnosis' && task.task_params.symbol) {
                            return `${task.task_params.symbol} - ${currentLanguage.value === 'zh' ? '持仓诊断' : 'Portfolio Diagnosis'}`;
                        } else if (task.task_type === 'stock_recommendation') {
                return currentLanguage.value === 'zh' ? '资产推荐' : 'Asset Recommendation';
                        }
                    }
                    return getTaskTypeLabel(task.task_type);
                };
                
                const formatTime = (timeStr) => {
                    if (!timeStr) return '';
                    // 后端存储的是UTC时间，需要添加'Z'后缀确保正确解析为UTC
                    const utcTimeStr = timeStr.endsWith('Z') ? timeStr : timeStr + 'Z';
                    const date = new Date(utcTimeStr);
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    
                    if (minutes < 1) {
                        return currentLanguage.value === 'zh' ? '刚刚' : 'Just now';
                    } else if (minutes < 60) {
                        return `${minutes}${currentLanguage.value === 'zh' ? '分钟前' : 'm ago'}`;
                    } else if (hours < 24) {
                        return `${hours}${currentLanguage.value === 'zh' ? '小时前' : 'h ago'}`;
                    } else {
                        return `${days}${currentLanguage.value === 'zh' ? '天前' : 'd ago'}`;
                    }
                };
                
                const handleDuplicateTaskChoice = async (choice) => {
                    showDuplicateTaskDialog.value = false;
                    const symbol = pendingAnalysisSymbol.value;
                    pendingAnalysisSymbol.value = null;
                    
                    if (choice === 'wait') {
                        // 等待现有任务完成
                        showToast(
                            currentLanguage.value === 'zh' ? '正在等待现有任务完成...' : 'Waiting for existing task to complete...',
                            'info',
                            2000
                        );
                        
                        // 打开任务列表
                        taskListVisible.value = true;
                        await loadTasks();
                        
                        // 找到现有任务并轮询
                        const existingTask = tasks.value.find(t => t.task_id === duplicateTaskInfo.value.task_id);
                        if (existingTask) {
                            pollTaskUntilComplete(existingTask.task_id, (result) => {
                                analysisResult.value = result;
                                expandedTrades.value = {};
                                if (result.analysis && result.analysis.analysis_summary && result.analysis.analysis_summary.includes('Quota Exceeded')) {
                                    const m = models.value.find(m => m.id === selectedModel.value);
                                    if (m) m.status = 'limit';
                                }
                                
                                showToast(
                                    currentLanguage.value === 'zh' ? `🎉 分析完成：${symbol}` : `🎉 Analysis completed: ${symbol}`,
                                    'success',
                                    3000
                                );
                                
                                nextTick(() => {
                                    if (chartRef.value) {
                                        initChart(result);
                                    }
                                });
                            });
                        }
                    } else if (choice === 'cancel') {
                        // 取消现有任务并创建新任务
                        try {
                            // 先终止现有任务
                            const res = await fetch(`/api/tasks/${duplicateTaskInfo.value.task_id}/terminate`, {
                                method: 'POST',
                                headers: { 'X-Session-ID': sessionId.value }
                            });
                            
                            if (res.ok) {
                                showToast(
                                    currentLanguage.value === 'zh' ? '已取消现有任务，正在创建新任务...' : 'Cancelled existing task, creating new...',
                                    'info',
                                    2000
                                );
                                
                                // 等待一小段时间确保任务已终止
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                // 重新调用分析
                                await analyzeStock(symbol);
                            } else {
                                throw new Error('Failed to terminate existing task');
                            }
                        } catch (err) {
                            showToast(
                                currentLanguage.value === 'zh' ? `❌ 取消任务失败：${err.message}` : `❌ Failed to cancel task: ${err.message}`,
                                'error',
                                4000
                            );
                        }
                    }
                };
                
                const closeDisclaimer = () => {
                    showDisclaimer.value = false;
                    localStorage.setItem('disclaimerDismissed', 'true');
                };
                
                // Watch for asset_type changes in recommendation criteria
                // Auto-reset market to 'Any' when switching to non-stock assets
                watch(() => recCriteria.value.asset_type, (newAssetType, oldAssetType) => {
                    if (newAssetType !== 'STOCK' && recCriteria.value.market !== 'Any') {
                        console.log(`Asset type changed from ${oldAssetType} to ${newAssetType}, resetting market to 'Any'`);
                        recCriteria.value.market = 'Any';
                    }
                });

                // 智能判断用户操作类型
                const getUserActionLabel = (record) => {
                    if (!record || !record.type) return '';
                    
                    // 获取当前分析股票的符号
                    const currentSymbol = analysisResult.value?.symbol || query.value;
                    if (!currentSymbol) {
                        // 如果没有当前股票信息，使用简单的标签
                        return record.type === 'BUY' ? 
                            (currentLanguage.value === 'zh' ? '真买' : 'Real Buy') : 
                            (currentLanguage.value === 'zh' ? '真卖' : 'Real Sell');
                    }
                    
                    // 获取当前股票的所有用户交易记录
                    const userTransactions = allTransactionRecords.value.filter(r => 
                        r.source === 'user'
                    ).sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    if (record.type === 'BUY') {
                        // 判断是否为首次买入
                        const buyTransactions = userTransactions.filter(r => r.type === 'BUY');
                        const recordIndex = buyTransactions.findIndex(r => 
                            r.date === record.date && Math.abs((r.price || 0) - (record.price || 0)) < 0.01
                        );
                        
                        if (recordIndex === 0) {
                            return currentLanguage.value === 'zh' ? '真买' : 'Real Buy';
                        } else {
                            return currentLanguage.value === 'zh' ? '真加仓' : 'Real Add';
                        }
                    } else if (record.type === 'SELL') {
                        // 判断是否为清仓
                        const recordDate = new Date(record.date);
                        const transactionsBeforeThis = userTransactions.filter(r => 
                            new Date(r.date) <= recordDate
                        );
                        
                        // 计算到此交易为止的持仓数量
                        let totalQuantity = 0;
                        for (const trans of transactionsBeforeThis) {
                            if (trans.type === 'BUY') {
                                totalQuantity += trans.quantity || 0;
                            } else if (trans.type === 'SELL') {
                                totalQuantity -= trans.quantity || 0;
                            }
                        }
                        
                        // 如果卖出后持仓为0，则为清仓
                        if (Math.abs(totalQuantity) < 0.001) {
                            return currentLanguage.value === 'zh' ? '真清仓' : 'Real Close';
                        } else {
                            return currentLanguage.value === 'zh' ? '真减仓' : 'Real Reduce';
                        }
                    }
                    
                    return currentLanguage.value === 'zh' ? '真操作' : 'Real Trade';
                };

                // 智能判断AI操作类型
                const getAIActionLabel = (record) => {
                    if (!record || !record.type) return '';
                    
                    // 如果有position_action字段，优先使用
                    if (record.position_action) {
                        const actionMap = {
                            'OPEN': currentLanguage.value === 'zh' ? 'AI建仓' : 'AI Open',
                            'ADD': currentLanguage.value === 'zh' ? 'AI加仓' : 'AI Add',
                            'REDUCE': currentLanguage.value === 'zh' ? 'AI减仓' : 'AI Reduce',
                            'CLOSE': currentLanguage.value === 'zh' ? 'AI平仓' : 'AI Close'
                        };
                        return actionMap[record.position_action] || (record.type === 'BUY' ? 
                            (currentLanguage.value === 'zh' ? 'AI买' : 'AI Buy') : 
                            (currentLanguage.value === 'zh' ? 'AI卖' : 'AI Sell'));
                    }
                    
                    // 默认显示
                    return record.type === 'BUY' ? 
                        (currentLanguage.value === 'zh' ? 'AI买' : 'AI Buy') : 
                        (currentLanguage.value === 'zh' ? 'AI卖' : 'AI Sell');
                };

                return {
                    currentTab,
                    currentLanguage,
                    recCriteria,
                    recommendationResult,
                    portfolio,
                    portfolioResult,
                    getRecommendations,
                    diagnosePortfolio,
                    query,
                    suggestions,
                    klineSymbolSelected,
                    klineAssetType,
                    getPlaceholderText,
                    loadingAnalysis,
                    loadingRecommend,
                    loadingPortfolio,
                    analysisResult,
                    chartRef,
                    handleSearch,
                    selectStock,
                    clearKlineSelection,
                    analyzeStock,
                    stats,
                    models,
                    availableModels,
                    selectedModel,
                    selectedModelName,
                    currentModelStatus,
                    expandedTrades,
                    toggleTrade,
                    allTransactionRecords,  // Transaction records for display
                    getUserActionLabel,
                    getAIActionLabel,
                    hotStocks,
                    loadingHotStocks,
                    marketIndices,
                    loadingMarketIndices,
                    marketNews,
                    loadingMarketNews,
                    showTooltip,
                    tooltipPosition,
                    // User Auth
                    currentUser,
                    showLoginModal,
                    openLoginModal,
                    closeLoginModal,
                    loginForm,
                    handleLogin,
                    handleLogout,
                    showUserMenu,
                    authError,
                    authLoading,
                    handleAuthSubmit,
                    isRegisterMode,
                    toggleAuthMode,
                    showPassword,
                    // Email Confirmation
                    showEmailConfirmDialog,
                    emailConfirmInfo,
                    confirmEmail,
                    useSuggestedEmail,
                    cancelEmailConfirm,
                    // Task Management
                    tasks,
                    taskListVisible,
                    taskFilterStatus,
                    taskStatusFilters,
                    filteredTasks,
                    runningTasksCount,
                    terminateTask,
                    showTaskResult,
                    getTaskStatusLabel,
                    getTaskTypeLabel,
                    getTaskTitle,
                    formatTime,
                    // Draggable Button
                    taskButtonRef,
                    taskButtonPosition,
                    isDragging,
                    startDrag,
                    // Toast
                    toastMessage,
                    toastType,
                    // Duplicate Task Dialog
                    showDuplicateTaskDialog,
                    duplicateTaskInfo,
                    handleDuplicateTaskChoice,
                    // Loading States
                    creatingTask,
                    // Disclaimer
                    showDisclaimer,
                    closeDisclaimer,
                    // Portfolio Management
                    portfolios,
                    loadingPortfolios,
                    loadPortfolios,
                    displayCurrency,
                    toggleCurrency,
                    hideAmounts,
                    toggleAmountVisibility,
                    maskAmount,
                    lastRefreshTime,
                    rates,
                    displayedTotalAssets,
                    displayedTotalProfitLoss,
                    displayedTotalDailyChange,
                    showAddTransactionModal,
                    selectedPortfolio,
                    searchType,
                    transactionForm,
                    transactionSymbolSuggestions,
                    transactionSymbolSelected,
                    addTransaction,
                    calculateTotal,
                    calculateQuantity,
                    openAddTransactionModal,
                    handleTransactionSymbolSearch,
                    selectTransactionSymbol,
                    clearTransactionSymbol,
                    currentPortfolio,
                    // Cash Management
                    showCashModal,
                    cashForm,
                    openCashModal,
                    addCashTransaction,
                    // Portfolio Stats & Cash Flow (v2.0)
                    portfolioStats,
                    loadPortfolioStats,
                    showCashFlowModal,
                    cashFlowForm,
                    cashFlows,
                    openCashFlowModal,
                    submitCashFlow,
                    loadCashFlows,
                    deleteCashFlow,
                    // Portfolio Grouping & Expansion
                    portfoliosByType,
                    totalAssetsValue,
                    totalCost,
                    totalProfitLoss,
                    totalProfitLossPercent,
                    expandedPortfolios,
                    portfolioTransactions,
                    loadingTransactions,
                    togglePortfolioExpand,
                    formatNumber,
                    calculateAllocation
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

