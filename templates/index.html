<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Pilot</title>
    <link rel="icon" type="image/png" href="/static/thumbnail.png">
    <link rel="apple-touch-icon" href="/static/thumbnail.png">
    <script src="{{ url_for('static', filename='vue.global.prod.min.js') }}"></script>
    <script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='tailwind.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="flex flex-col min-h-screen">
        <!-- Disclaimer Banner (Always Visible at Top) -->
        <div v-if="showDisclaimer" class="bg-gradient-to-r from-red-50 via-orange-50 to-yellow-50 border-b-2 border-red-400 shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-base font-bold text-red-900 mb-1 flex items-center gap-2">
                            <span>[[ currentLanguage === 'zh' ? 'å…è´£å£°æ˜' : 'Disclaimer' ]]</span>
                        </div>
                        <div class="text-sm text-red-800 leading-relaxed">
                            [[ currentLanguage === 'zh' ? 
                                'æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚' : 
                                'This project is for learning and research purposes only and does not constitute any investment advice. The stock market involves risks, and investment requires caution. Users are solely responsible for all consequences of using this system for investment decisions.' 
                            ]]
                        </div>
                    </div>
                    <button 
                        @click="closeDisclaimer"
                        class="flex-shrink-0 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full p-1 transition-colors"
                        :title="currentLanguage === 'zh' ? 'å…³é—­' : 'Close'"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Login/Register Modal -->
        <div v-if="!currentUser" class="fixed inset-0 backdrop-blur-md bg-white/30 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade-in">
                <!-- Header -->
                <div class="flex justify-center items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? 'æ³¨å†Œè´¦æˆ·' : 'Register') : (currentLanguage === 'zh' ? 'ç™»å½•è´¦æˆ·' : 'Login') ]]
                    </h2>
                </div>

                <!-- Error Message -->
                <div v-if="authError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    [[ authError ]]
                </div>

                <!-- Login/Register Form -->
                <form @submit.prevent="handleAuthSubmit">
                    <!-- Nickname (Register only) -->
                    <div v-if="isRegisterMode" class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ˜µç§°' : 'Nickname' ]]
                        </label>
                        <input 
                            v-model="loginForm.nickname"
                            type="text"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? 'è¯·è¾“å…¥æ‚¨çš„æ˜µç§°' : 'Enter your nickname'"
                        >
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'é‚®ç®±' : 'Email' ]]
                        </label>
                        <input 
                            v-model="loginForm.email"
                            type="email"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? 'è¯·è¾“å…¥æ‚¨çš„é‚®ç®±' : 'Enter your email'"
                        >
                    </div>

                    <!-- Password -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¯†ç ' : 'Password' ]]
                        </label>
                        <div class="relative">
                            <input 
                                v-model="loginForm.password"
                                :type="showPassword ? 'text' : 'password'"
                                required
                                :minlength="isRegisterMode ? 6 : 1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
                                :placeholder="currentLanguage === 'zh' ? (isRegisterMode ? 'è‡³å°‘6ä½å¯†ç ' : 'è¯·è¾“å…¥å¯†ç ') : (isRegisterMode ? 'At least 6 characters' : 'Enter password')"
                            >
                            <button 
                                type="button"
                                @click.prevent.stop="showPassword = !showPassword"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                            >
                                <svg v-if="showPassword" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        <span v-if="!authLoading">
                            [[ isRegisterMode ? (currentLanguage === 'zh' ? 'æ³¨å†Œ' : 'Register') : (currentLanguage === 'zh' ? 'ç™»å½•' : 'Login') ]]
                        </span>
                        <span v-else class="flex items-center justify-center gap-2">
                            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'å¤„ç†ä¸­...' : 'Processing...' ]]
                        </span>
                    </button>
                </form>

                <!-- Toggle Login/Register -->
                <div class="mt-6 text-center text-sm">
                    <span class="text-gray-600">
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? 'å·²æœ‰è´¦æˆ·ï¼Ÿ' : 'Already have an account?') : (currentLanguage === 'zh' ? 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ' : "Don't have an account?") ]]
                    </span>
                    <button 
                        @click="toggleAuthMode"
                        class="ml-2 text-blue-600 font-bold hover:text-blue-700 transition-colors"
                    >
                        [[ isRegisterMode ? (currentLanguage === 'zh' ? 'ç«‹å³ç™»å½•' : 'Login') : (currentLanguage === 'zh' ? 'ç«‹å³æ³¨å†Œ' : 'Register') ]]
                    </button>
                </div>

                <!-- Privacy Notice -->
                <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-xs text-blue-800">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? 'æ‚¨çš„å¯†ç å°†è¢«åŠ å¯†å­˜å‚¨ï¼Œæˆ‘ä»¬é‡è§†æ‚¨çš„éšç§å’Œæ•°æ®å®‰å…¨ã€‚' : 'Your password will be encrypted. We value your privacy and data security.' ]]
                    </p>
                </div>

                <!-- Login Required Notice -->
                <div class="mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                    <p class="text-sm text-amber-900 text-center font-semibold">
                        <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? 'æœ¬åº”ç”¨ä»…é™ç™»å½•åä½¿ç”¨' : 'Login required to use this application' ]]
                    </p>
                </div>
            </div>
        </div>

        <!-- Email Confirmation Dialog -->
        <div v-if="showEmailConfirmDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 animate-fade-in">
                <!-- Header -->
                <div class="flex items-center gap-3 mb-6">
                    <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 class="text-xl font-bold text-gray-800">
                        [[ currentLanguage === 'zh' ? 'é‚®ç®±ç¡®è®¤' : 'Email Confirmation' ]]
                    </h3>
                </div>

                <!-- Content -->
                <div class="mb-6 space-y-4">
                    <p class="text-gray-700">
                        [[ currentLanguage === 'zh' ? 'æ£€æµ‹åˆ°æ‚¨è¾“å…¥çš„é‚®ç®±å¯èƒ½å­˜åœ¨æ‹¼å†™é”™è¯¯ï¼š' : 'We detected a possible typo in your email address:' ]]
                    </p>
                    
                    <!-- Current Email -->
                    <div class="p-4 bg-red-50 border-2 border-red-200 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">
                            [[ currentLanguage === 'zh' ? 'æ‚¨è¾“å…¥çš„é‚®ç®±ï¼š' : 'Your input:' ]]
                        </p>
                        <p class="text-lg font-mono font-bold text-red-700">
                            [[ emailConfirmInfo.email ]]
                        </p>
                    </div>

                    <!-- Suggested Email -->
                    <div v-if="emailConfirmInfo.typo_suggestion" class="p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">
                            [[ currentLanguage === 'zh' ? 'å»ºè®®ä½¿ç”¨ï¼š' : 'Suggested:' ]]
                        </p>
                        <p class="text-lg font-mono font-bold text-green-700">
                            [[ emailConfirmInfo.typo_suggestion ]]
                        </p>
                    </div>

                    <!-- Score Info -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? `é‚®ç®±å¯ä¿¡åº¦è¯„åˆ†ï¼š${emailConfirmInfo.score}/100` : `Email credibility score: ${emailConfirmInfo.score}/100` ]]
                        </p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col gap-3">
                    <!-- Use Suggested Email -->
                    <button 
                        v-if="emailConfirmInfo.typo_suggestion"
                        @click="useSuggestedEmail"
                        class="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? 'ä½¿ç”¨å»ºè®®çš„é‚®ç®±' : 'Use Suggested Email' ]]
                    </button>

                    <!-- Continue with Current Email -->
                    <button 
                        @click="confirmEmail"
                        class="w-full py-3 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? 'ç»§ç»­ä½¿ç”¨å½“å‰é‚®ç®±' : 'Continue with Current Email' ]]
                    </button>

                    <!-- Cancel -->
                    <button 
                        @click="cancelEmailConfirm"
                        class="w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors"
                    >
                        [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div 
            v-if="toastMessage"
            class="fixed top-20 right-4 z-50 toast-enter"
            :class="toastType === 'success' ? 'bg-green-500' : toastType === 'error' ? 'bg-red-500' : 'bg-blue-500'"
        >
            <div class="flex items-center gap-3 px-6 py-4 rounded-lg shadow-xl text-white min-w-[300px]">
                <svg v-if="toastType === 'success'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <svg v-else-if="toastType === 'error'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-6 h-6 flex-shrink-0 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <div class="flex-1">
                    <p class="font-semibold text-sm">[[ toastMessage ]]</p>
                </div>
                <button @click="toastMessage = ''" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
                </div>
                
        <!-- Duplicate Task Dialog -->
        <div 
            v-if="showDuplicateTaskDialog"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in"
            @click.self="showDuplicateTaskDialog = false"
        >
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all animate-fade-in">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                    </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">
                                [[ currentLanguage === 'zh' ? 'ä»»åŠ¡å·²å­˜åœ¨' : 'Task Already Running' ]]
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">
                                [[ currentLanguage === 'zh' ? 'æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡' : 'A running task detected' ]]
                            </p>
                </div>
            </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 font-medium mb-1">
                                    [[ currentLanguage === 'zh' ? 'å·²æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼š' : 'Running task: ' ]]
                                    <span class="font-bold text-blue-700">[[ duplicateTaskInfo.symbol ]]</span>
                                </p>
                                <p class="text-xs text-gray-500">
                                    [[ currentLanguage === 'zh' ? 'åˆ›å»ºæ—¶é—´ï¼š' : 'Created: ' ]]
                                    [[ formatTime(duplicateTaskInfo.created_at) ]]
                                </p>
                            </div>
                        </div>
                </div>

                    <div class="space-y-3">
                        <button 
                            @click="handleDuplicateTaskChoice('wait')"
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ' : 'Wait for Existing Task' ]]
                        </button>
                        <button 
                            @click="handleDuplicateTaskChoice('cancel')"
                            class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆç°æœ‰ä»»åŠ¡å¹¶åˆ›å»ºæ–°ä»»åŠ¡' : 'Cancel Existing & Create New' ]]
                        </button>
                        <button 
                            @click="showDuplicateTaskDialog = false"
                            class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Sidebar (Always Visible) -->
        <div class="fixed right-0 top-20 h-[calc(50vh-5rem)] w-80 bg-white shadow-2xl z-40 task-list-slide rounded-l-xl" :class="taskListVisible ? 'translate-x-0' : 'translate-x-full'">
            <div class="h-full flex flex-col">
                <!-- Task List Header -->
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'ä»»åŠ¡åˆ—è¡¨' : 'Task List' ]]
                        </h3>
                        <button @click="taskListVisible = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Status Filter -->
                    <div class="flex gap-2 flex-wrap">
                        <button 
                            v-for="status in taskStatusFilters" 
                            :key="status.value"
                            @click="taskFilterStatus = status.value"
                            class="px-3 py-1 text-xs rounded-full font-medium transition-colors"
                            :class="taskFilterStatus === status.value ? 
                                'bg-blue-600 text-white' : 
                                'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        >
                            [[ status.label ]]
                        </button>
                    </div>
                </div>
                
                <!-- Task List Content -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="filteredTasks.length === 0" class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>[[ currentLanguage === 'zh' ? 'æš‚æ— ä»»åŠ¡' : 'No tasks' ]]</p>
                    </div>
                    <div v-else class="space-y-3">
                        <div 
                            v-for="task in filteredTasks" 
                            :key="task.task_id"
                            class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                            :class="{
                                'task-new': task._isNew,
                                'task-item': !task._isNew,
                                'border-blue-300 bg-blue-50': task.status === 'running',
                                'border-green-300 bg-green-50': task.status === 'completed',
                                'border-red-300 bg-red-50': task.status === 'failed',
                                'border-gray-300 bg-gray-50': task.status === 'terminated'
                            }"
                        >
                            <!-- Task Header -->
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 text-xs rounded font-bold" :class="{
                                            'bg-blue-100 text-blue-700': task.status === 'running',
                                            'bg-green-100 text-green-700': task.status === 'completed',
                                            'bg-red-100 text-red-700': task.status === 'failed',
                                            'bg-gray-100 text-gray-700': task.status === 'terminated'
                                        }">
                                            [[ getTaskStatusLabel(task.status) ]]
                                        </span>
                                        <span class="text-xs text-gray-500">[[ getTaskTypeLabel(task.task_type) ]]</span>
                                </div>
                                    <div class="text-sm font-medium text-gray-800" v-if="task.task_params">
                                        [[ getTaskTitle(task) ]]
                            </div>
                        </div>
                            </div>
                            
                            <!-- Task Time -->
                            <div class="text-xs text-gray-500 mb-3">
                                [[ formatTime(task.created_at) ]]
                            </div>
                            
                            <!-- Task Actions -->
                            <div class="flex gap-2">
                        <button 
                                    v-if="task.status === 'running'"
                                    @click="terminateTask(task.task_id)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? 'ç»ˆæ­¢' : 'Terminate' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'completed'"
                                    @click="showTaskResult(task)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? 'æ˜¾ç¤ºç»“æœ' : 'Show Result' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'failed'"
                                    class="flex-1 px-3 py-1.5 text-xs bg-gray-100 text-gray-600 rounded cursor-not-allowed"
                                    :title="task.error_message"
                                >
                                    [[ currentLanguage === 'zh' ? 'å¤±è´¥' : 'Failed' ]]
                        </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Toggle Button (Draggable) -->
        <div 
            ref="taskButtonRef"
            class="fixed bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition-colors z-30 flex items-center gap-2 cursor-move select-none"
            :class="{'bg-red-600 hover:bg-red-700': taskListVisible}"
            :style="{ left: taskButtonPosition.x + 'px', top: taskButtonPosition.y + 'px' }"
            @mousedown="startDrag"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span class="font-bold" v-if="runningTasksCount > 0">[[ runningTasksCount ]]</span>
            <button 
                @click.stop="taskListVisible = !taskListVisible"
                class="ml-1 text-white hover:text-gray-200"
                :title="currentLanguage === 'zh' ? 'ç‚¹å‡»åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨' : 'Click to toggle task list'"
            >
                <svg v-if="taskListVisible" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>

        <div class="container mx-auto px-4 py-4 flex-1 flex flex-col">
        <!-- Top Navigation Bar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40 mb-4" :class="{'top-[52px]': showDisclaimer, 'top-0': !showDisclaimer}">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <!-- Logo & Brand -->
                    <div class="flex items-center cursor-pointer" @click="currentTab = 'analysis'">
                        <img src="/static/thumbnail.png" alt="Logo" class="h-8 w-8 mr-2">
                        <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">Invest Pilot</span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex space-x-8 items-center">
            <button 
                @click="currentTab = 'portfolio'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'portfolio' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? 'æŒä»“ç®¡ç†' : 'Portfolio' ]]
            </button>
            <button 
                @click="currentTab = 'analysis'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'analysis' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? 'Kçº¿åˆ†æ' : 'K-Line Analysis' ]]
            </button>
            <button 
                @click="currentTab = 'recommend'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'recommend' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Market Trends' ]]
            </button>
            <button 
                @click="currentTab = 'tracking'"
                            class="px-3 py-2 text-sm font-medium transition-colors duration-200"
                            :class="currentTab === 'tracking' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-900'"
            >
                            [[ currentLanguage === 'zh' ? 'ç²¾é€‰è·Ÿè¸ª' : 'Curated Picks' ]]
            </button>
        </div>

                    <!-- Right Side Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Model Selector -->
                        <div class="relative hidden lg:block w-40">
                            <select 
                                v-model="selectedModel" 
                                class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 pr-8 cursor-pointer font-medium truncate"
                            >
                                <option v-for="m in availableModels" :key="m.id" :value="m.id" :disabled="m.disabled || m.isHeader" :class="{'font-bold text-gray-400': m.isHeader}">
                                    [[ m.name ]] [[ m.status === 'limit' ? '(Limit)' : '' ]]
                                </option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>

                        <!-- Language Switcher -->
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button @click="currentLanguage = 'zh'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'zh' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">CN</button>
                            <button @click="currentLanguage = 'en'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">EN</button>
                        </div>
                        
                        <!-- User Profile / Login -->
                        <div v-if="currentUser" class="relative" id="user-menu-container">
                            <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" @click.stop="showUserMenu = !showUserMenu">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-xs">
                                    [[ currentUser.nickname.charAt(0).toUpperCase() ]]
                                </div>
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <!-- User Dropdown Menu -->
                            <div v-if="showUserMenu" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50 animate-fade-in" @click.stop>
                                <div class="px-4 py-3 border-b border-gray-100">
                                    <p class="text-sm font-bold text-gray-800">[[ currentUser.nickname ]]</p>
                                    <p class="text-xs text-gray-500 truncate">[[ currentUser.email ]]</p>
                                </div>
                                <button 
                                    @click.stop="handleLogout"
                                    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'é€€å‡ºç™»å½•' : 'Logout' ]]
                                </button>
                            </div>
                        </div>
                        <button v-else @click="openLoginModal" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                            [[ currentLanguage === 'zh' ? 'ç™»å½•' : 'Login' ]]
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Loading State -->
        <div v-if="(currentTab === 'analysis' && loadingAnalysis) || (currentTab === 'recommend' && loadingRecommend) || (currentTab === 'portfolio' && loadingPortfolio) || (currentTab === 'tracking' && loadingTracking)" class="flex-1 flex items-center justify-center min-h-[400px]">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <template v-if="currentTab === 'tracking'">
                    <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'æ­£åœ¨åŠ è½½è·Ÿè¸ªæ•°æ®...' : 'Loading tracking data...' ]]</p>
                    <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? 'æ­£åœ¨è·å–æŒä»“ä¿¡æ¯ä¸æ”¶ç›Šæ•°æ®' : 'Fetching holdings and performance data' ]]</p>
                </template>
                <template v-else>
                    <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...' : 'AI is analyzing deep data...' ]]</p>
                    <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? 'æ­£åœ¨æœç´¢å®æ—¶å¸‚åœºèµ„è®¯ & è®¡ç®—ç­–ç•¥...' : 'Searching real-time market info & calculating strategies...' ]]</p>
                </template>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <template v-if="currentTab === 'analysis'">
            <!-- Compact Search Section -->
            <div class="mb-6">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 flex items-center gap-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                v-model="query" 
                                @input="handleSearch"
                                @keyup.enter="klineSymbolSelected ? analyzeStock(query) : null"
                                :readonly="klineSymbolSelected"
                                :placeholder="getPlaceholderText()"
                                :class="[
                                    'w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white outline-none text-sm font-medium transition-all',
                                    klineSymbolSelected ? 'bg-blue-50 border-blue-300 text-blue-900 font-semibold' : ''
                                ]"
                            >
                            <!--æ¸…é™¤æŒ‰é’®-->
                            <button 
                                v-if="query && klineSymbolSelected"
                                @click="clearKlineSelection"
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition-colors"
                                title="[[ currentLanguage === 'zh' ? 'æ¸…é™¤é€‰æ‹©' : 'Clear selection' ]]"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <div v-if="suggestions && suggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-lg shadow-xl border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in suggestions"
                                    @click="selectStock(item)"
                                    class="px-4 py-2.5 hover:bg-blue-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-100 last:border-0 transition-colors"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">[[ item.symbol ]]</span>
                                        <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">[[ item.type || 'STOCK' ]]</span>
                                        <span class="text-gray-500 text-xs">[[ item.name ]]</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                            <!--æç¤ºä¿¡æ¯ï¼šå¿…é¡»ä»æœç´¢ç»“æœä¸­é€‰æ‹©-->
                            <div v-if="query && !klineSymbolSelected" class="absolute z-40 w-full mt-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200">
                                <span class="font-medium">âš ï¸ [[ currentLanguage === 'zh' ? 'è¯·ä»æœç´¢ç»“æœä¸­é€‰æ‹©' : 'Please select from search results' ]]</span>
                            </div>
                        </div>
                        
                        <!-- Asset Type Selector -->
                        <div class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg hover:border-blue-300 transition-all">
                            <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                            <select 
                                v-model="klineAssetType"
                                class="bg-transparent border-none outline-none text-sm font-semibold text-gray-700 cursor-pointer pr-6 appearance-none"
                                style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.1rem center; background-size: 1.2em 1.2em;"
                            >
                                <option value="STOCK">[[ currentLanguage === 'zh' ? 'ğŸ“ˆ è‚¡ç¥¨' : 'ğŸ“ˆ Stock' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? 'â‚¿ åŠ å¯†è´§å¸' : 'â‚¿ Crypto' ]]</option>
                                <option value="COMMODITY">[[ currentLanguage === 'zh' ? 'ğŸ›¢ï¸ å¤§å®—å•†å“' : 'ğŸ›¢ï¸ Commodity' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? 'ğŸ¦ ä¸­å›½åŸºé‡‘' : 'ğŸ¦ CN Fund' ]]</option>
                                <option value="BOND">[[ currentLanguage === 'zh' ? 'ğŸ“œ å€ºåˆ¸' : 'ğŸ“œ Bond' ]]</option>
                                <option value="INDEX">[[ currentLanguage === 'zh' ? 'ğŸ“Š æŒ‡æ•°' : 'ğŸ“Š Index' ]]</option>
                                <option value="ETF">[[ currentLanguage === 'zh' ? 'ğŸ¯ ETF' : 'ğŸ¯ ETF' ]]</option>
                            </select>
                        </div>
                        
                        <button
                            @click="analyzeStock(query)" 
                            :disabled="creatingTask || !query || !klineSymbolSelected"
                            :class="[
                                'px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed font-semibold text-sm whitespace-nowrap flex items-center gap-2 relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : ''
                            ]"
                        >
                            <svg v-if="!creatingTask" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <svg v-else class="w-4 h-4 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>
                                [[ creatingTask ? (currentLanguage === 'zh' ? 'åˆ›å»ºä¸­...' : 'Creating...') : (currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze') ]]
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Result View -->
            <div v-if="!loadingAnalysis && analysisResult" class="flex-1 flex flex-col gap-6 animate-fade-in max-w-6xl mx-auto w-full">
                
                <!-- Model Info Banner -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-xl p-4 shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-blue-900 mb-1">
                                [[ currentLanguage === 'zh' ? 'ğŸ’¡ é‡è¦æç¤º' : 'ğŸ’¡ Important Notice' ]]
                            </div>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                <p class="mb-1">
                                    [[ currentLanguage === 'zh' ? 
                                        'â€¢ ä¸åŒ AI æ¨¡å‹çš„åˆ†æç»“æœå¯èƒ½ä¸åŒï¼Œæ¯ä¸ªæ¨¡å‹éƒ½æœ‰ç‹¬ç«‹çš„äº¤æ˜“å†å²è®°å½•' : 
                                        'â€¢ Different AI models may produce different analysis results. Each model maintains its own separate trading history' 
                                    ]]
                                </p>
                                <p>
                                    [[ currentLanguage === 'zh' ? 
                        'â€¢ ç›¸åŒæ¨¡å‹å¯¹åŒä¸€èµ„äº§çš„åˆ†æç»“æœä¼šè¢«ç¼“å­˜ï¼Œå½“å¤©é‡å¤åˆ†æå°†ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ' :
                                        'â€¢ Analysis results from the same model are cached. Repeated analysis on the same day will return cached results' 
                                    ]]
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fallback Warning Banner -->
                <div v-if="analysisResult.analysis.is_fallback" class="bg-gradient-to-r from-orange-50 to-amber-50 border-l-4 border-orange-500 rounded-xl p-5 shadow-sm animate-pulse">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-orange-800 flex items-center gap-2">
                                    <span>âš¡</span>
                                    [[ currentLanguage === 'zh' ? 'æœ¬åœ°é‡åŒ–ç­–ç•¥' : 'Local Quantitative Strategy' ]]
                                </h3>
                                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                                    MA + RSI
                                </span>
                            </div>
                            <p class="text-sm text-orange-700 leading-relaxed mb-2">
                                [[ currentLanguage === 'zh' ? 
                                    'ç”±äº AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨åˆ‡æ¢è‡³æœ¬åœ°é‡åŒ–ç­–ç•¥ã€‚ç»“æœåŸºäºç»å…¸æŠ€æœ¯æŒ‡æ ‡ï¼ˆå‡çº¿äº¤å‰ + RSI åŠ¨é‡ï¼‰ï¼Œä»…ä¾›å‚è€ƒã€‚' : 
                                    'AI service is temporarily unavailable. System has automatically switched to local quantitative strategy based on classic technical indicators (MA crossover + RSI momentum) for reference only.' 
                                ]]
                            </p>
                            <div class="flex items-center gap-2 text-xs text-orange-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-semibold">[[ currentLanguage === 'zh' ? 'åŸå› ï¼š' : 'Reason: ' ]]</span>
                                <span class="italic">[[ analysisResult.analysis.fallback_reason ]]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Info Banner -->
                <div v-if="currentPortfolio" class="bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 rounded-xl p-5 shadow-sm mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">
                                    [[ currentLanguage === 'zh' ? 'å½“å‰æŒä»“' : 'Current Holdings' ]]
                                </h3>
                                <div class="flex gap-4 text-sm text-gray-600 mt-1">
                                    <span>[[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Qty' ]]: <strong>[[ currentPortfolio.total_quantity ]]</strong></span>
                                    <span>[[ currentLanguage === 'zh' ? 'å‡ä»·' : 'Avg' ]]: <strong>[[ currentPortfolio.avg_cost.toFixed(2) ]]</strong></span>
                                    <span>[[ currentLanguage === 'zh' ? 'æˆæœ¬' : 'Cost' ]]: <strong>[[ currentPortfolio.total_cost.toFixed(2) ]]</strong></span>
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="openAddTransactionModal(currentPortfolio)"
                            class="px-4 py-2 bg-white border border-purple-200 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors text-sm font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'è°ƒæ•´æŒä»“' : 'Adjust' ]]
                        </button>
                    </div>
                </div>

                <!-- 1. Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-blue-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'æ€»äº¤æ˜“æ¬¡æ•°' : 'Total Trades' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.totalTrades ]]</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.winRate >= 50 ? 'border-green-500' : 'border-yellow-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'èƒœç‡' : 'Win Rate' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.winRate ]]%</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.totalReturn > 0 ? 'border-green-500' : 'border-red-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'ç´¯è®¡æ”¶ç›Š (ä¼°ç®—)' : 'Total Return' ]]</div>
                        <div class="text-2xl font-bold" :class="stats.totalReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ stats.totalReturn > 0 ? '+' : '' ]][[ stats.totalReturn ]]%
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-purple-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'å½“å‰çŠ¶æ€' : 'Status' ]]</div>
                        <div class="text-xl font-bold" :class="analysisResult.analysis.is_fallback ? 'text-orange-700' : 'text-purple-700'">[[ stats.currentStatus ]]</div>
                        <div v-if="stats.currentStatus === 'HOLDING' || stats.currentStatus === 'æŒä»“ä¸­'" class="text-sm mt-1 font-semibold" :class="stats.unrealizedReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ currentLanguage === 'zh' ? 'æœªå®ç°' : 'Unrealized' ]]: [[ stats.unrealizedReturn > 0 ? '+' : '' ]][[ stats.unrealizedReturn ]]%
                        </div>
                    </div>
                </div>

                <!-- Current Action Recommendation Card (Prominent Display) -->
                <div v-if="analysisResult.analysis.current_action" class="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 p-5 animate-fade-in"
                     :class="{
                         'border-green-400 shadow-green-100': analysisResult.analysis.current_action.action === 'BUY',
                         'border-teal-400 shadow-teal-100': analysisResult.analysis.current_action.action === 'ADD',
                         'border-amber-400 shadow-amber-100': analysisResult.analysis.current_action.action === 'REDUCE',
                         'border-red-400 shadow-red-100': analysisResult.analysis.current_action.action === 'SELL',
                         'border-orange-400 shadow-orange-100': analysisResult.analysis.current_action.action === 'WAIT',
                         'border-indigo-400 shadow-indigo-100': analysisResult.analysis.current_action.action === 'HOLD'
                     }">
                    <div class="flex items-start gap-4">
                        <!-- Icon Badge -->
                        <div class="flex-shrink-0">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg"
                                 :class="{
                                     'bg-gradient-to-br from-green-400 to-green-600': analysisResult.analysis.current_action.action === 'BUY',
                                     'bg-gradient-to-br from-teal-400 to-teal-600': analysisResult.analysis.current_action.action === 'ADD',
                                     'bg-gradient-to-br from-amber-400 to-amber-600': analysisResult.analysis.current_action.action === 'REDUCE',
                                     'bg-gradient-to-br from-red-400 to-red-600': analysisResult.analysis.current_action.action === 'SELL',
                                     'bg-gradient-to-br from-orange-400 to-orange-600': analysisResult.analysis.current_action.action === 'WAIT',
                                     'bg-gradient-to-br from-indigo-400 to-indigo-600': analysisResult.analysis.current_action.action === 'HOLD'
                                 }">
                                [[ analysisResult.analysis.current_action.action === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°' : 'B') :
                                   analysisResult.analysis.current_action.action === 'ADD' ? (currentLanguage === 'zh' ? 'åŠ ' : 'A') :
                                   analysisResult.analysis.current_action.action === 'REDUCE' ? (currentLanguage === 'zh' ? 'å‡' : 'R') :
                                   analysisResult.analysis.current_action.action === 'SELL' ? (currentLanguage === 'zh' ? 'å¹³' : 'S') :
                                   analysisResult.analysis.current_action.action === 'WAIT' ? (currentLanguage === 'zh' ? 'ç­‰' : 'W') :
                                   (currentLanguage === 'zh' ? 'æŒ' : 'H') ]]
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    [[ currentLanguage === 'zh' ? 'ğŸ¯ AI æ“ä½œå»ºè®®' : 'ğŸ¯ AI Recommendation' ]]
                                </h3>
                                <span v-if="analysisResult.analysis.agent_mode" class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-purple-100 text-purple-700 border border-purple-200">
                                    ğŸ¤– Agent
                                </span>
                            </div>
                            <div class="text-2xl font-bold mb-2"
                                 :class="{
                                     'text-green-600': analysisResult.analysis.current_action.action === 'BUY',
                                     'text-teal-600': analysisResult.analysis.current_action.action === 'ADD',
                                     'text-amber-600': analysisResult.analysis.current_action.action === 'REDUCE',
                                     'text-red-600': analysisResult.analysis.current_action.action === 'SELL',
                                     'text-orange-600': analysisResult.analysis.current_action.action === 'WAIT',
                                     'text-indigo-600': analysisResult.analysis.current_action.action === 'HOLD'
                                 }">
                                [[ analysisResult.analysis.current_action.action === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥å»ºä»“' : 'BUY') :
                                   analysisResult.analysis.current_action.action === 'ADD' ? (currentLanguage === 'zh' ? 'åŠ ä»“' : 'ADD') :
                                   analysisResult.analysis.current_action.action === 'REDUCE' ? (currentLanguage === 'zh' ? 'å‡ä»“' : 'REDUCE') :
                                   analysisResult.analysis.current_action.action === 'SELL' ? (currentLanguage === 'zh' ? 'å¹³ä»“æ¸…ä»“' : 'SELL') :
                                   analysisResult.analysis.current_action.action === 'WAIT' ? (currentLanguage === 'zh' ? 'è§‚æœ›ç­‰å¾…' : 'WAIT') :
                                   (currentLanguage === 'zh' ? 'ç»§ç»­æŒæœ‰' : 'HOLD') ]]
                            </div>
                            <p class="text-sm text-gray-700 leading-relaxed mb-3">
                                [[ analysisResult.analysis.current_action.reason ]]
                            </p>
                            
                            <!-- Additional Details for actionable signals (BUY/ADD/REDUCE/SELL) -->
                            <div v-if="['BUY','ADD','REDUCE','SELL'].includes(analysisResult.analysis.current_action.action)" 
                                 class="flex flex-wrap gap-3 text-xs">
                                <div v-if="analysisResult.analysis.current_action.price" 
                                     class="bg-white px-3 py-1.5 rounded-lg border border-gray-200 font-semibold">
                                    <span class="text-gray-500">[[ currentLanguage === 'zh' ? 'å»ºè®®ä»·æ ¼' : 'Price' ]]:</span>
                                    <span class="text-gray-800 ml-1">[[ analysisResult.analysis.current_action.price ]]</span>
                                </div>
                                <div v-if="analysisResult.analysis.current_action.quantity_percent" 
                                     class="bg-white px-3 py-1.5 rounded-lg border border-gray-200 font-semibold">
                                    <span class="text-gray-500">[[ currentLanguage === 'zh' ? 'ä»“ä½æ¯”ä¾‹' : 'Position' ]]:</span>
                                    <span class="text-gray-800 ml-1">[[ analysisResult.analysis.current_action.quantity_percent ]]%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Main Chart Area (Full Width) -->
                <div class="bg-white rounded-xl shadow-sm p-4 w-full">
                    <div ref="chartRef" class="chart-container" style="height: 550px; width: 100%;"></div>
                </div>

                <!-- 3. Bottom Section: Analysis & Logs (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px] lg:h-[500px]">
                    
                    <!-- AI Summary (Takes 1/3) -->
                    <div class="analysis-card p-6 flex flex-col relative group lg:col-span-1 h-full overflow-hidden" :class="analysisResult.analysis.is_fallback ? 'border-orange-200 bg-orange-50/30' : ''">
                        <div class="flex justify-between items-center mb-4 flex-none">
                            <h3 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2" :class="analysisResult.analysis.is_fallback ? 'text-orange-800' : 'text-gray-800'">
                                <span class="w-1 h-4 rounded-full" :class="analysisResult.analysis.is_fallback ? 'bg-orange-600' : 'bg-blue-600'"></span>
                                [[ analysisResult.analysis.is_fallback ? 
                                    (currentLanguage === 'zh' ? 'ç­–ç•¥è¯´æ˜' : 'Strategy Info') : 
                                    (currentLanguage === 'zh' ? 'AI åˆ†ææ‘˜è¦' : 'AI Summary') 
                                ]]
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 pr-2">
                            <p class="text-sm text-gray-700 leading-relaxed font-serif text-justify whitespace-pre-wrap">[[ analysisResult.analysis.analysis_summary ]]</p>
                            
                            <!-- Agent Reasoning Trace Timeline (thinking + tool calls interleaved) -->
                            <div v-if="(analysisResult.analysis.agent_trace && analysisResult.analysis.agent_trace.length > 0) || (analysisResult.analysis.tool_calls && analysisResult.analysis.tool_calls.length > 0)" class="mt-4 pt-4 border-t border-purple-200">
                                <div class="flex items-center gap-2 mb-3 cursor-pointer" @click="showToolCalls = !showToolCalls">
                                    <span class="text-xs font-bold text-purple-700 uppercase tracking-wider">
                                        ğŸ¤– [[ currentLanguage === 'zh' ? 'Agent æ¨ç†è¿‡ç¨‹' : 'Agent Reasoning Trace' ]]
                                    </span>
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-bold bg-purple-100 text-purple-600">
                                        [[ (analysisResult.analysis.agent_trace || analysisResult.analysis.tool_calls || []).length ]] [[ currentLanguage === 'zh' ? 'ä¸ªæ­¥éª¤' : 'steps' ]]
                                    </span>
                                    <svg class="w-3 h-3 text-purple-500 transition-transform" :class="showToolCalls ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <div v-if="showToolCalls" class="relative">
                                    <!-- Timeline vertical line -->
                                    <div class="absolute left-[11px] top-3 bottom-3 w-0.5 bg-purple-200"></div>

                                    <!-- Use agent_trace if available, otherwise fallback to tool_calls -->
                                    <div class="space-y-3" v-if="analysisResult.analysis.agent_trace && analysisResult.analysis.agent_trace.length > 0">
                                        <div v-for="(step, idx) in analysisResult.analysis.agent_trace" :key="idx" class="relative pl-8">
                                            <!-- Timeline dot -->
                                            <div class="absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full flex items-center justify-center text-[10px] font-bold z-10"
                                                 :class="step.type === 'thinking' ? 'bg-blue-100 text-blue-600 border-2 border-blue-300' : (step.error ? 'bg-red-100 text-red-600 border-2 border-red-300' : 'bg-purple-500 text-white')">
                                                <span v-if="step.type === 'thinking'">ğŸ’­</span>
                                                <span v-else>ğŸ”§</span>
                                            </div>

                                            <!-- Thinking block -->
                                            <div v-if="step.type === 'thinking'" class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-xs">
                                                <div class="flex items-center gap-1.5 mb-1.5">
                                                    <span class="font-bold text-blue-700">[[ currentLanguage === 'zh' ? 'æ€è€ƒ' : 'Thinking' ]]</span>
                                                </div>
                                                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap text-[11px]">[[ step.content ]]</p>
                                            </div>

                                            <!-- Tool call block -->
                                            <div v-else class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-mono font-bold text-purple-700">[[ step.tool ]]</span>
                                                    <span v-if="step.error" class="text-red-500 text-[10px]">âŒ failed</span>
                                                    <span v-else class="text-green-500 text-[10px]">âœ“</span>
                                                    <span class="text-gray-400 ml-auto text-[10px]">[[ step.elapsed_seconds ]]s</span>
                                                </div>
                                                <div v-if="step.arguments && Object.keys(step.arguments).length > 0" class="text-gray-500 font-mono text-[10px] mb-1">
                                                    <span v-for="(v, k) in step.arguments" :key="k" class="mr-2">
                                                        <span class="text-gray-400">[[ k ]]:</span> <span class="text-gray-600">[[ typeof v === 'object' ? JSON.stringify(v) : v ]]</span>
                                                    </span>
                                                </div>
                                                <div v-if="step.result_preview && !step.error" class="text-[10px] text-gray-400 font-mono mt-1 truncate max-w-full" :title="step.result_preview">
                                                    â†’ [[ step.result_preview.substring(0, 120) ]][[ step.result_preview.length > 120 ? '...' : '' ]]
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Fallback: plain tool_calls list (for backward compat when no agent_trace) -->
                                    <div class="space-y-3" v-else>
                                        <div v-for="(tc, idx) in analysisResult.analysis.tool_calls" :key="idx" class="relative pl-8">
                                            <div class="absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full bg-purple-500 text-white flex items-center justify-center text-[10px] font-bold z-10">ğŸ”§</div>
                                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-mono font-bold text-purple-700">[[ tc.tool ]]</span>
                                                    <span v-if="tc.error" class="text-red-500 text-[10px]">âŒ failed</span>
                                                    <span v-else class="text-green-500 text-[10px]">âœ“</span>
                                                    <span class="text-gray-400 ml-auto text-[10px]">[[ tc.elapsed_seconds ]]s</span>
                                                </div>
                                                <div v-if="tc.arguments && Object.keys(tc.arguments).length > 0" class="text-gray-500 font-mono text-[10px] mb-1">
                                                    <span v-for="(v, k) in tc.arguments" :key="k" class="mr-2">
                                                        <span class="text-gray-400">[[ k ]]:</span> [[ typeof v === 'object' ? JSON.stringify(v) : v ]]
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Action Quick Reference (Simplified - Main display is at top) -->
                            <div v-if="analysisResult.analysis.current_action" class="mt-4 pt-4 border-t border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">
                                    [[ currentLanguage === 'zh' ? 'ğŸ’¡ æ“ä½œå»ºè®®è¯¦æƒ…è§ä¸Šæ–¹å¡ç‰‡' : 'ğŸ’¡ See recommendation card above' ]]
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Records Table (Takes 2/3) -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col overflow-hidden border border-gray-100 lg:col-span-2 h-full">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex-none">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">
                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction Records' ]]
                                <span class="ml-2 text-xs text-gray-500">([[ allTransactionRecords?.length || 0 ]])</span>
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <!-- Empty State -->
                            <div v-if="!allTransactionRecords || allTransactionRecords.length === 0" class="flex items-center justify-center h-full text-gray-400 text-sm">
                                [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transaction records' ]]
                            </div>
                            
                            <!-- Transaction List -->
                            <div v-else class="divide-y divide-gray-100">
                                <div v-for="(record, index) in allTransactionRecords" :key="index" 
                                     class="px-4 py-3 hover:bg-gray-50 transition-colors"
                                     :class="{
                                         'bg-blue-50/30': record.source === 'user',
                                         'bg-green-50/20': record.source === 'ai' && record.type === 'BUY',
                                         'bg-red-50/20': record.source === 'ai' && record.type === 'SELL',
                                         'border-l-4 border-amber-400': record.is_current
                                     }">
                                    <div class="flex items-start justify-between gap-4">
                                        <!-- Left: Type Badge + Info -->
                                        <div class="flex items-start gap-3 flex-1 min-w-0">
                                            <!-- Type Badge -->
                                            <div class="flex-shrink-0">
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md font-bold text-xs whitespace-nowrap"
                                                      :class="{
                                                          'bg-blue-100 text-blue-700': record.source === 'user' && record.type === 'BUY',
                                                          'bg-orange-100 text-orange-700': record.source === 'user' && record.type === 'SELL',
                                                          'bg-green-100 text-green-700 border border-green-300': record.source === 'ai' && record.type === 'BUY' && record.adopted,
                                                          'bg-green-50 text-green-600 border border-green-200': record.source === 'ai' && record.type === 'BUY' && !record.adopted,
                                                          'bg-red-100 text-red-700 border border-red-300': record.source === 'ai' && record.type === 'SELL' && record.adopted,
                                                          'bg-red-50 text-red-600 border border-red-200': record.source === 'ai' && record.type === 'SELL' && !record.adopted
                                                      }">
                                                    <!-- Icon -->
                                                    <span v-if="record.source === 'user'">ğŸ’</span>
                                                    <span v-else-if="record.adopted">âœ“</span>
                                                    <span v-else>ğŸ¤–</span>
                                                    
                                                    <!-- Label -->
                                                    <span v-if="record.source === 'user'">
                                                        [[ getUserActionLabel(record) ]]
                                                    </span>
                                                    <span v-else>
                                                        [[ getAIActionLabel(record) ]]
                                                    </span>
                                                </span>
                                                
                                                <!-- Current indicator -->
                                                <div v-if="record.is_current" class="mt-1 text-xs text-amber-600 font-semibold">
                                                    [[ currentLanguage === 'zh' ? 'å½“å‰' : 'Current' ]]
                                                </div>
                                            </div>
                                            
                                            <!-- Transaction Details -->
                                            <div class="flex-1 min-w-0">
                                                <!-- Date & Price -->
                                                <div class="text-sm font-semibold text-gray-800 mb-1">
                                                    [[ record.date ]] @ <span class="text-indigo-600">[[ record.price ]]</span>
                                                </div>
                                                
                                                <!-- Quantity & Amount (for user transactions) -->
                                                <div v-if="record.source === 'user' && (record.quantity || record.amount)" class="text-xs text-gray-600 mb-1">
                                                    <span v-if="record.quantity">[[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Qty' ]]: [[ record.quantity ]]</span>
                                                    <span v-if="record.quantity && record.amount" class="mx-1">|</span>
                                                    <span v-if="record.amount">[[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]: [[ record.amount ]]</span>
                                                </div>
                                                
                                                <!-- Reason/Notes -->
                                                <div v-if="record.reason" class="text-xs text-gray-600 leading-relaxed mt-1">
                                                    <span class="font-semibold text-gray-500">[[ currentLanguage === 'zh' ? 'åŸå› ' : 'Reason' ]]:</span>
                                                    <span class="ml-1">[[ record.reason ]]</span>
                                                </div>
                                                
                                                <!-- Adopted indicator -->
                                                <div v-if="record.source === 'ai' && record.adopted" class="text-xs text-green-600 font-semibold mt-1">
                                                    âœ“ [[ currentLanguage === 'zh' ? 'å·²é‡‡çº³' : 'Adopted' ]]
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loadingAnalysis && !analysisResult" class="flex-1 flex flex-col items-center justify-center animate-fade-in py-12">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 max-w-6xl w-full text-center">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">[[ currentLanguage === 'zh' ? 'å¼€å¯ AI é‡åŒ–ä¹‹æ—…' : 'Start AI Quant Journey' ]]</h2>
                    <p class="text-gray-500 mb-8 max-w-lg mx-auto leading-relaxed">
                        [[ currentLanguage === 'zh' ? 'è¾“å…¥èµ„äº§ä»£ç ï¼Œè®© AI æ·±åº¦è§£æå†å²æ•°æ®ï¼Œç»“åˆæŠ€æœ¯æŒ‡æ ‡ä¸å¸‚åœºæƒ…ç»ªï¼Œä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„ä¹°å–ç‚¹å»ºè®®ã€‚æ”¯æŒè‚¡ç¥¨ã€åŠ å¯†è´§å¸ã€å¤§å®—å•†å“å’Œå€ºåˆ¸ã€‚' : 'Enter an asset symbol to let AI analyze historical data, technical indicators, and market sentiment for professional trading signals. Supports stocks, crypto, commodities, and bonds.' ]]
                    </p>
                    
                    <!-- Hot Assets Quick Analysis (Inside Card) -->
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider text-center">[[ currentLanguage === 'zh' ? 'ğŸ”¥ çƒ­é—¨èµ„äº§å¿«é€Ÿåˆ†æ' : 'ğŸ”¥ Popular Assets' ]]</p>
                        
                        <!-- Loading State -->
                        <div v-if="loadingHotStocks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="i in 8" :key="i" class="p-4 border border-gray-200 rounded-xl bg-gray-50 animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-20 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-16 mb-3"></div>
                                <div class="h-6 bg-gray-300 rounded w-24 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-12"></div>
                            </div>
                        </div>
                        
                        <!-- Stocks Grid -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button 
                                v-for="stock in hotStocks" 
                                :key="stock.symbol"
                                @click="selectStock(stock.symbol); analyzeStock(stock.symbol)"
                                class="stock-card relative p-4 border border-gray-200 rounded-xl hover:border-blue-400 hover:shadow-lg transition-all group text-left bg-gradient-to-br from-white to-gray-50 overflow-hidden"
                            >
                                <!-- Trend Background -->
                                <div class="absolute inset-0 opacity-5 pointer-events-none">
                                    <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                        <polyline
                                            :points="stock.trendData"
                                            fill="none"
                                            :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                            stroke-width="2"
                                        />
                                    </svg>
                                </div>
                                
                                <!-- Content -->
                                <div class="relative z-10">
                                    <!-- Header -->
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-gray-900 group-hover:text-blue-700 text-sm">[[ stock.symbol ]]</div>
                                            <div class="text-xs text-gray-500 mt-0.5">[[ stock.name ]]</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-semibold" :class="stock.change >= 0 ? 'text-green-600' : 'text-red-600'">
                                                [[ stock.change >= 0 ? '+' : '' ]][[ stock.change ]]%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price & Mini Chart -->
                                    <div class="flex items-end justify-between mt-3">
                                        <div>
                                            <div class="text-lg font-bold text-gray-900">[[ stock.price ]]</div>
                                            <div class="text-xs text-gray-400">[[ stock.market ]]</div>
                                        </div>
                                        
                                        <!-- Mini Trend Line -->
                                        <div class="w-16 h-8">
                                            <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                                <polyline
                                                    :points="stock.trendData"
                                                    fill="none"
                                                    :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                                    stroke-width="3"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Volume -->
                                    <div class="mt-2 pt-2 border-t border-gray-100">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æˆäº¤é‡' : 'Volume' ]]</span>
                                            <span class="text-gray-600 font-medium">[[ stock.volume ]]</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hover Effect Indicator -->
                                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-indigo-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </template>

        <!-- Recommendation Tab Content -->
        <div v-if="currentTab === 'recommend' && !loadingRecommend" class="flex-1 grid grid-cols-1 gap-6 animate-fade-in max-w-7xl mx-auto w-full">
                
            <!-- Filters & Generate Button (Top Section) -->
            <div class="space-y-6">
                <!-- Filters & Generate Button -->
                <div class="bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/30 p-8 rounded-2xl shadow-lg border-2 border-blue-100/50 backdrop-blur-sm">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    [[ currentLanguage === 'zh' ? 'å¸‚åœºæœºä¼šæŒ–æ˜' : 'Market Scanner' ]]
                        </h3>
                                <p class="text-xs text-gray-500 mt-1">[[ currentLanguage === 'zh' ? 'AI é©±åŠ¨çš„æ™ºèƒ½é€‰è‚¡æ¨è' : 'AI-Powered Stock Recommendations' ]]</p>
                            </div>
                        </div>
                        <button 
                            @click="getRecommendations" 
                            :disabled="creatingTask || loadingRecommend"
                            :class="[
                                'px-8 py-3 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white rounded-full hover:shadow-xl transition-all font-bold text-sm flex items-center gap-2 disabled:opacity-70 disabled:cursor-wait relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : 'btn-pulse'
                            ]"
                        >
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></span>
                            <svg v-if="!creatingTask && !loadingRecommend" class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <svg v-else class="w-5 h-5 spinner relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="relative z-10">
                                [[ creatingTask ? (currentLanguage === 'zh' ? 'åˆ›å»ºä»»åŠ¡ä¸­...' : 'Creating task...') : (loadingRecommend ? (currentLanguage === 'zh' ? 'æ‰«æä¸­...' : 'Scanning...') : (currentLanguage === 'zh' ? 'AI æ™ºèƒ½æ‰«æ' : 'AI Smart Scan')) ]]
                            </span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'èµ„äº§ç±»å‹' : 'Asset Type' ]]
                            </label>
                            <select v-model="recCriteria.asset_type" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="STOCK">[[ currentLanguage === 'zh' ? 'è‚¡ç¥¨ (Stock)' : 'Stock' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? 'ä¸­å›½åŸºé‡‘ (CN Fund)' : 'Chinese Fund' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? 'åŠ å¯†è´§å¸ (Crypto)' : 'Crypto' ]]</option>
                                <option value="COMMODITY">[[ currentLanguage === 'zh' ? 'å¤§å®—å•†å“ (Commodity)' : 'Commodity' ]]</option>
                                <option value="BOND">[[ currentLanguage === 'zh' ? 'å€ºåˆ¸ (Bond)' : 'Bond' ]]</option>
                            </select>
                        </div>
                        <!-- ETF Toggle - only show for STOCK asset type -->
                        <div class="portfolio-input-group" v-show="recCriteria.asset_type === 'STOCK'" style="transition: all 0.3s ease;">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'åŒ…å« ETF' : 'Include ETF' ]]
                                <span class="text-xs text-gray-400 normal-case ml-1">([[ currentLanguage === 'zh' ? 'ä»…è‚¡ç¥¨' : 'Stock only' ]])</span>
                            </label>
                            <select v-model="recCriteria.include_etf" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="false">[[ currentLanguage === 'zh' ? 'ä»…ä¸ªè‚¡' : 'Individual Stocks Only' ]]</option>
                                <option value="true">[[ currentLanguage === 'zh' ? 'åŒ…å« ETF' : 'Include ETFs' ]]</option>
                            </select>
                        </div>
                        <!-- Market selector - only show for STOCK asset type -->
                        <div class="portfolio-input-group" v-show="recCriteria.asset_type === 'STOCK'" style="transition: all 0.3s ease;">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'å¸‚åœºé€‰æ‹©' : 'Market' ]]
                                <span class="text-xs text-gray-400 normal-case ml-1">([[ currentLanguage === 'zh' ? 'ä»…è‚¡ç¥¨' : 'Stock only' ]])</span>
                            </label>
                            <select v-model="recCriteria.market" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="US">[[ currentLanguage === 'zh' ? 'ç¾è‚¡ (US)' : 'US Stocks' ]]</option>
                                <option value="HK">[[ currentLanguage === 'zh' ? 'æ¸¯è‚¡ (HK)' : 'HK Stocks' ]]</option>
                                <option value="A">[[ currentLanguage === 'zh' ? 'Aè‚¡ (A)' : 'A-Shares' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'èµ„é‡‘è§„æ¨¡' : 'Capital' ]]
                            </label>
                            <select v-model="recCriteria.capital" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Small (<10w)">[[ currentLanguage === 'zh' ? 'å°èµ„é‡‘ (<10w)' : 'Small (<10k)' ]]</option>
                                <option value="Medium (10w-50w)">[[ currentLanguage === 'zh' ? 'ä¸­ç­‰èµ„é‡‘ (10w-50w)' : 'Medium (10k-50k)' ]]</option>
                                <option value="Large (>50w)">[[ currentLanguage === 'zh' ? 'å¤§èµ„é‡‘ (>50w)' : 'Large (>50k)' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'é£é™©åå¥½' : 'Risk' ]]
                            </label>
                            <select v-model="recCriteria.risk" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Conservative">[[ currentLanguage === 'zh' ? 'ç¨³å¥å‹ (ä½é£é™©)' : 'Conservative' ]]</option>
                                <option value="Balanced">[[ currentLanguage === 'zh' ? 'å¹³è¡¡å‹ (ä¸­é£é™©)' : 'Balanced' ]]</option>
                                <option value="Aggressive">[[ currentLanguage === 'zh' ? 'è¿›å–å‹ (é«˜é£é™©)' : 'Aggressive' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“é¢‘ç‡' : 'Frequency' ]]
                            </label>
                            <select v-model="recCriteria.frequency" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Short-term">[[ currentLanguage === 'zh' ? 'çŸ­çº¿ (æ—¥å†…/å‘¨)' : 'Short-term' ]]</option>
                                <option value="Swing">[[ currentLanguage === 'zh' ? 'æ³¢æ®µ (å‘¨/æœˆ)' : 'Swing' ]]</option>
                                <option value="Long-term">[[ currentLanguage === 'zh' ? 'é•¿çº¿ (å­£åº¦+)' : 'Long-term' ]]</option>
                            </select>
                        </div>
                        </div>
                    </div>
                </div>

            <!-- Dashboard & Right Panel Row (1/2 + 1/2) - Only show when no recommendations -->
            <div v-if="currentTab === 'recommend' && !recommendationResult" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Market Indices Dashboard (Left 1/2) -->
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">[[ currentLanguage === 'zh' ? 'ğŸ“Š å…¨çƒå¸‚åœºå¤§ç›˜' : 'ğŸ“Š Global Market Indices' ]]</p>
                    
                    <!-- Loading State -->
                    <div v-if="loadingMarketIndices" class="grid grid-cols-2 gap-3">
                        <div v-for="i in 8" :key="i" class="p-3 border border-gray-200 rounded-lg bg-gray-50 animate-pulse">
                            <div class="h-3 bg-gray-300 rounded w-16 mb-2"></div>
                            <div class="h-5 bg-gray-300 rounded w-20 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-12"></div>
                        </div>
                    </div>
                    
                    <!-- Indices Grid (2 columns: 4 left, 4 right) -->
                    <div v-else class="grid grid-cols-2 gap-3">
                        <div 
                            v-for="index in marketIndices" 
                            :key="index.symbol"
                            @click="selectStock(index.symbol); currentTab='analysis'; analyzeStock(index.symbol)"
                            @mouseenter="(e) => { showTooltip = index.symbol; tooltipPosition = { x: e.clientX, y: e.clientY }; }"
                            @mouseleave="showTooltip = null"
                            @mousemove="(e) => { if (showTooltip === index.symbol) tooltipPosition = { x: e.clientX, y: e.clientY }; }"
                            class="group relative p-3 border border-gray-200 rounded-lg hover:border-blue-400 hover:shadow-md transition-all cursor-pointer bg-gradient-to-br from-white to-gray-50"
                        >
                            <!-- Enhanced Hover Tooltip (Fixed positioning to avoid overflow issues) -->
                            <div 
                                v-if="showTooltip === index.symbol"
                                class="fixed z-[100] pointer-events-none"
                                :style="{ 
                                    left: (tooltipPosition.x + 15) + 'px',
                                    top: (tooltipPosition.y - 15) + 'px',
                                    transform: 'translateY(-100%)'
                                }"
                            >
                                <div class="bg-gray-900 text-white text-xs rounded-lg px-4 py-3 shadow-2xl min-w-[220px]">
                                    <div class="font-bold mb-2 text-sm flex items-center gap-2">
                                        <span>[[ index.icon ]]</span>
                                        <span>[[ currentLanguage === 'zh' ? index.name_zh : index.name ]]</span>
                                        <span class="text-gray-400 text-xs">([[ index.symbol ]])</span>
                                    </div>
                                    <div class="space-y-1.5 border-t border-gray-700 pt-2 mt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'å½“å‰ä»·' : 'Price' ]]</span>
                                            <span class="font-semibold">[[ index.price ]]</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æ¶¨è·Œ' : 'Change' ]]</span>
                                            <span :class="index.is_up ? 'text-green-400' : 'text-red-400'" class="font-medium">
                                                [[ index.is_up ? '+' : '' ]][[ index.change ]] ([[ index.is_up ? '+' : '' ]][[ index.change_pct ]]%)
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æœ€é«˜' : 'High' ]]</span>
                                            <span class="text-gray-300">[[ index.high ]]</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æœ€ä½' : 'Low' ]]</span>
                                            <span class="text-gray-300">[[ index.low ]]</span>
                                        </div>
                                        <div v-if="index.volume" class="flex justify-between items-center border-t border-gray-700 pt-1.5 mt-1.5">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æˆäº¤é‡' : 'Volume' ]]</span>
                                            <span class="text-gray-300">[[ index.volume ]]</span>
                                        </div>
                                    </div>
                                    <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
                                </div>
                </div>

                            <!-- Trend Background -->
                            <div class="absolute inset-0 opacity-5 pointer-events-none">
                                <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                    <polyline
                                        :points="index.trend_data"
                                        fill="none"
                                        :stroke="index.is_up ? '#10b981' : '#ef4444'"
                                        stroke-width="2"
                                    />
                                </svg>
                            </div>
                            
                            <!-- Content -->
                            <div class="relative z-10">
                                <!-- Icon & Name -->
                                <div class="flex items-center gap-1 mb-1.5">
                                    <span class="text-base">[[ index.icon ]]</span>
                                    <span class="text-xs font-bold text-gray-700 truncate">[[ currentLanguage === 'zh' ? index.name_zh : index.name ]]</span>
                                </div>
                                
                                <!-- Price -->
                                <div class="text-base font-bold text-gray-900 mb-1">[[ index.price ]]</div>
                                
                                <!-- Change -->
                                <div class="flex items-center gap-1">
                                    <span 
                                        class="text-xs font-semibold px-1.5 py-0.5 rounded"
                                        :class="index.is_up ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                    >
                                        [[ index.is_up ? 'â–²' : 'â–¼' ]] [[ Math.abs(index.change_pct) ]]%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: News (Right 1/2) -->
                <div>
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">[[ currentLanguage === 'zh' ? 'ğŸ“ˆ å®æ—¶å¸‚åœºåŠ¨æ€' : 'ğŸ“ˆ Live Market Insights' ]]</p>
                    </div>
                    
                    <!-- News Container with Scroll -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm h-[600px] flex flex-col overflow-hidden">
                    <!-- Loading State -->
                            <div v-if="loadingMarketNews" class="flex-1 overflow-y-auto p-4 space-y-3">
                                <div v-for="i in 6" :key="i" class="bg-gray-50 p-4 rounded-lg border border-gray-100 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/2 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/4"></div>
                        </div>
                    </div>
                    
                            <!-- News List (Scrollable) -->
                            <div v-else-if="marketNews && marketNews.length > 0" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <a 
                            v-for="news in marketNews"
                            :key="news.id"
                            :href="news.link"
                            target="_blank"
                                    class="block bg-gradient-to-br from-gray-50 to-blue-50/30 p-4 rounded-lg border border-gray-100 hover:border-blue-300 hover:shadow-md transition-all group cursor-pointer"
                                >
                                    <!-- Type Badge -->
                                    <div class="flex items-center gap-2 mb-2">
                                        <span 
                                            class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                            :class="{
                                                'bg-purple-100 text-purple-700': news.type === 'earnings',
                                                'bg-yellow-100 text-yellow-700': news.type === 'rating',
                                                'bg-blue-100 text-blue-700': news.type === 'deal',
                                                'bg-green-100 text-green-700': news.type === 'dividend' || news.type === 'bullish',
                                                'bg-red-100 text-red-700': news.type === 'bearish',
                                                'bg-gray-100 text-gray-700': news.type === 'news'
                                            }"
                                        >
                                            [[ news.icon ]] 
                                            <span v-if="news.type === 'earnings'">[[ currentLanguage === 'zh' ? 'è´¢æŠ¥' : 'Earnings' ]]</span>
                                            <span v-else-if="news.type === 'rating'">[[ currentLanguage === 'zh' ? 'è¯„çº§' : 'Rating' ]]</span>
                                            <span v-else-if="news.type === 'deal'">[[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Deal' ]]</span>
                                            <span v-else-if="news.type === 'dividend'">[[ currentLanguage === 'zh' ? 'åˆ†çº¢' : 'Dividend' ]]</span>
                                            <span v-else-if="news.type === 'bullish'">[[ currentLanguage === 'zh' ? 'åˆ©å¥½' : 'Bullish' ]]</span>
                                            <span v-else-if="news.type === 'bearish'">[[ currentLanguage === 'zh' ? 'åˆ©ç©º' : 'Bearish' ]]</span>
                                            <span v-else>[[ currentLanguage === 'zh' ? 'èµ„è®¯' : 'News' ]]</span>
                                        </span>
                                        <span class="text-xs text-gray-400">[[ news.time_ago ]]</span>
                                    </div>
                                    
                                    <!-- Title -->
                                    <h4 class="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors line-clamp-2 leading-snug mb-2">
                                        [[ news.title ]]
                                    </h4>
                                    
                                    <!-- Footer -->
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <span class="truncate">[[ news.publisher ]]</span>
                                        <span v-if="news.related_symbols && news.related_symbols.length > 0" class="font-mono font-semibold ml-2">[[ news.related_symbols[0] ]]</span>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Empty State -->
                            <div v-else class="flex-1 flex items-center justify-center p-8">
                                <div class="text-center">
                                    <div class="text-gray-300 text-4xl mb-2">ğŸ“°</div>
                                    <p class="text-gray-400 text-sm">[[ currentLanguage === 'zh' ? 'æš‚æ— å¸‚åœºèµ„è®¯' : 'No market news available' ]]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                    
            <!-- Market Overview & Recommendations (Replaces Dashboard when available) -->
            <div v-if="currentTab === 'recommend' && recommendationResult" class="space-y-6">
                <!-- Header with Clear Button -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">[[ currentLanguage === 'zh' ? 'ğŸ“Š å¸‚åœºæ¨èç»“æœ' : 'ğŸ“Š Market Recommendations' ]]</h2>
                    <button 
                        @click="recommendationResult = null"
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        [[ currentLanguage === 'zh' ? 'è¿”å›å¤§ç›˜è§†å›¾' : 'Back to Dashboard' ]]
                    </button>
                </div>
                
                <!-- Market Overview -->
                <div v-if="recommendationResult.market_overview" class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-2 border-blue-200/50 p-6 rounded-2xl text-gray-800 leading-relaxed shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-200/20 rounded-full -mr-16 -mt-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-indigo-200/20 rounded-full -ml-12 -mb-12"></div>
                    <div class="relative z-10">
                        <div class="mb-3 flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                    </div>
                            <div class="font-bold text-blue-700 text-lg flex items-center gap-2">
                                [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Market Overview' ]]
                            </div>
                        </div>
                        <p class="font-serif text-gray-700 leading-relaxed text-base whitespace-pre-wrap">[[ recommendationResult.market_overview ]]</p>
                    </div>
                </div>

                <!-- Agent Reasoning Trace Timeline -->
                <div v-if="(recommendationResult.agent_trace && recommendationResult.agent_trace.length > 0) || (recommendationResult.tool_calls && recommendationResult.tool_calls.length > 0)" class="bg-white rounded-2xl border-2 border-purple-200 shadow-md overflow-hidden">
                    <div class="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-purple-100 via-indigo-50 to-blue-50 border-b border-purple-200 cursor-pointer select-none" @click="showRecommendToolCalls = !showRecommendToolCalls">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-sm">
                            <span class="text-white text-sm">ğŸ¤–</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-purple-800">
                                [[ currentLanguage === 'zh' ? 'Agent æ¨ç†è¿‡ç¨‹' : 'Agent Reasoning Trace' ]]
                            </span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-purple-200 text-purple-700">
                                [[ (recommendationResult.agent_trace || recommendationResult.tool_calls || []).length ]] [[ currentLanguage === 'zh' ? 'ä¸ªæ­¥éª¤' : 'steps' ]]
                            </span>
                        </div>
                        <svg class="w-4 h-4 text-purple-500 transition-transform duration-200 ml-auto" :class="showRecommendToolCalls ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div v-if="showRecommendToolCalls" class="p-5 max-h-[700px] overflow-y-auto">
                        <div class="relative">
                            <!-- Timeline vertical line -->
                            <div class="absolute left-[11px] top-3 bottom-3 w-0.5 bg-purple-200"></div>

                            <!-- Use agent_trace if available, otherwise fallback to tool_calls -->
                            <div class="space-y-3" v-if="recommendationResult.agent_trace && recommendationResult.agent_trace.length > 0">
                                <div v-for="(step, idx) in recommendationResult.agent_trace" :key="idx" class="relative pl-8">
                                    <!-- Timeline dot -->
                                    <div class="absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full flex items-center justify-center text-[10px] font-bold z-10"
                                         :class="step.type === 'thinking' ? 'bg-blue-100 text-blue-600 border-2 border-blue-300' : (step.error ? 'bg-red-100 text-red-600 border-2 border-red-300' : 'bg-purple-500 text-white')">
                                        <span v-if="step.type === 'thinking'">ğŸ’­</span>
                                        <span v-else>ğŸ”§</span>
                                    </div>

                                    <!-- Thinking block -->
                                    <div v-if="step.type === 'thinking'" class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-xs">
                                        <div class="flex items-center gap-1.5 mb-1.5">
                                            <span class="font-bold text-blue-700">[[ currentLanguage === 'zh' ? 'æ€è€ƒ' : 'Thinking' ]]</span>
                                        </div>
                                        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap text-[11px]">[[ step.content ]]</p>
                                    </div>

                                    <!-- Tool call block -->
                                    <div v-else class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-mono font-bold text-purple-700">[[ step.tool ]]</span>
                                            <span v-if="step.error" class="text-red-500 text-[10px]">âŒ failed</span>
                                            <span v-else class="text-green-500 text-[10px]">âœ“</span>
                                            <span class="text-gray-400 ml-auto text-[10px]">[[ step.elapsed_seconds ]]s</span>
                                        </div>
                                        <div v-if="step.arguments && Object.keys(step.arguments).length > 0" class="text-gray-500 font-mono text-[10px] mb-1">
                                            <span v-for="(v, k) in step.arguments" :key="k" class="mr-2">
                                                <span class="text-gray-400">[[ k ]]:</span> <span class="text-gray-600">[[ typeof v === 'object' ? JSON.stringify(v) : v ]]</span>
                                            </span>
                                        </div>
                                        <div v-if="step.result_preview && !step.error" class="text-[10px] text-gray-400 font-mono mt-1 truncate max-w-full" :title="step.result_preview">
                                            â†’ [[ step.result_preview.substring(0, 120) ]][[ step.result_preview.length > 120 ? '...' : '' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Fallback: plain tool_calls list -->
                            <div class="space-y-3" v-else>
                                <div v-for="(tc, idx) in recommendationResult.tool_calls" :key="idx" class="relative pl-8">
                                    <div class="absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full bg-purple-500 text-white flex items-center justify-center text-[10px] font-bold z-10">ğŸ”§</div>
                                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-mono font-bold text-purple-700">[[ tc.tool ]]</span>
                                            <span v-if="tc.error" class="text-red-500 text-[10px]">âŒ failed</span>
                                            <span v-else class="text-green-500 text-[10px]">âœ“</span>
                                            <span class="text-gray-400 ml-auto text-[10px]">[[ tc.elapsed_seconds ]]s</span>
                                        </div>
                                        <div v-if="tc.arguments && Object.keys(tc.arguments).length > 0" class="text-gray-500 font-mono text-[10px] mb-1">
                                            <span v-for="(v, k) in tc.arguments" :key="k" class="mr-2">
                                                <span class="text-gray-400">[[ k ]]:</span> [[ typeof v === 'object' ? JSON.stringify(v) : v ]]
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations List -->
                <div v-if="recommendationResult.recommendations && Array.isArray(recommendationResult.recommendations) && recommendationResult.recommendations.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-for="(rec, idx) in recommendationResult.recommendations" :key="idx" 
                         :class="[
                             'recommendation-card p-6 rounded-2xl group relative overflow-hidden',
                             rec.level.includes('ğŸ”»') ? 'border-2 border-red-300 bg-red-50/30' : 
                             rec.level.includes('âš ï¸') ? 'border-2 border-yellow-300 bg-yellow-50/30' : 
                             'border border-gray-200'
                         ]">
                        <!-- Decorative gradient overlay -->
                        <div :class="[
                            'absolute inset-0 transition-all duration-300',
                            rec.level.includes('ğŸ”»') ? 'bg-gradient-to-br from-red-50/0 via-red-100/0 to-red-50/0 group-hover:from-red-50/50 group-hover:via-red-100/30 group-hover:to-red-50/20' :
                            rec.level.includes('âš ï¸') ? 'bg-gradient-to-br from-yellow-50/0 via-yellow-100/0 to-yellow-50/0 group-hover:from-yellow-50/50 group-hover:via-yellow-100/30 group-hover:to-yellow-50/20' :
                            'bg-gradient-to-br from-blue-50/0 via-indigo-50/0 to-purple-50/0 group-hover:from-blue-50/50 group-hover:via-indigo-50/30 group-hover:to-purple-50/20'
                        ]"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                                        <h4 class="text-xl font-extrabold text-gray-900 group-hover:text-blue-600 transition-colors">[[ rec.symbol ]]</h4>
                                        <span class="text-sm text-gray-500 font-medium">[[ rec.name ]]</span>
                                        <span :class="[
                                            'px-3 py-1 text-white text-xs rounded-full font-bold shadow-sm',
                                            rec.level.includes('ğŸ”»') ? 'bg-gradient-to-r from-red-500 to-red-600' :
                                            rec.level.includes('âš ï¸') ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                                            rec.level.includes('â­â­â­') ? 'bg-gradient-to-r from-green-400 to-emerald-500' :
                                            rec.level.includes('â­â­') ? 'bg-gradient-to-r from-blue-400 to-indigo-500' :
                                            'bg-gradient-to-r from-yellow-400 to-orange-400'
                                        ]">
                                            [[ rec.level ]]
                                        </span>
                                    </div>
                                    <div class="text-3xl font-extrabold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mt-2">
                                        [[ rec.price ]]
                                    </div>
                                </div>
                                <button 
                                    @click="selectStock(rec.symbol); currentTab='analysis'; analyzeStock(rec.symbol)" 
                                    class="ml-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg opacity-0 group-hover:opacity-100 transition-all transform hover:scale-105 flex items-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                </button>
                            </div>
                            <div :class="[
                                'text-sm leading-relaxed p-4 rounded-xl border',
                                rec.level.includes('ğŸ”»') ? 'text-red-800 bg-gradient-to-br from-red-50 to-red-100/50 border-red-200' :
                                rec.level.includes('âš ï¸') ? 'text-yellow-800 bg-gradient-to-br from-yellow-50 to-yellow-100/50 border-yellow-200' :
                                'text-gray-700 bg-gradient-to-br from-gray-50 to-blue-50/30 border-gray-100'
                            ]">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs font-bold uppercase tracking-wider" :class="[
                                        rec.level.includes('ğŸ”»') ? 'text-red-600' :
                                        rec.level.includes('âš ï¸') ? 'text-yellow-600' :
                                        rec.level.includes('â­â­â­') ? 'text-green-600' :
                                        rec.level.includes('â­â­') ? 'text-blue-600' :
                                        'text-orange-600'
                                    ]">[[ currentLanguage === 'zh' ? 'ğŸ“‹ æ¨èç†ç”±' : 'ğŸ“‹ Rationale' ]]</span>
                                </div>
                                <p class="font-medium whitespace-pre-wrap leading-relaxed">[[ rec.reason ]]</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Empty State (when no recommendations) - Show below dashboard -->
            <div v-if="currentTab === 'recommend' && !recommendationResult" class="text-center py-12 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100 mt-6">
                <div class="text-gray-300 text-6xl mb-4">ğŸ”</div>
                <p class="text-gray-500 text-sm">[[ currentLanguage === 'zh' ? 'AI å°†æ ¹æ®æ‚¨çš„ç­›é€‰æ¡ä»¶æ¨èä¼˜è´¨èµ„äº§' : 'AI will recommend quality assets based on your criteria' ]]</p>
            </div>

        <!-- ============================================================ -->
        <!-- Stock Tracking Tab Content -->
        <!-- ============================================================ -->
        <div v-if="currentTab === 'tracking' && !loadingTracking" class="animate-fade-in">
            <div class="max-w-7xl mx-auto space-y-4">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">
                            [[ currentLanguage === 'zh' ? 'ç²¾é€‰è‚¡ç¥¨è·Ÿè¸ª' : 'Curated Stock Tracking' ]]
                        </h2>
                        <p class="text-xs text-gray-500 mt-0.5">
                            [[ currentLanguage === 'zh' ? 'AI æ¯æ—¥æ·±åº¦å†³ç­–ï¼Œç»´æŠ¤ç²¾é€‰ç¾è‚¡è§‚å¯Ÿåå•' : 'AI daily deep analysis to maintain a curated US stock watchlist' ]]
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button
                            @click="refreshTrackingPrices()"
                            :disabled="trackingRefreshing"
                            class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center gap-1.5 text-xs font-medium disabled:opacity-50"
                        >
                            <svg :class="{'animate-spin': trackingRefreshing}" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'åˆ·æ–°ä»·æ ¼' : 'Refresh Prices' ]]
                        </button>
                        <button
                            @click="runTrackingDecision()"
                            :disabled="trackingRunning"
                            class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all flex items-center gap-1.5 text-xs font-medium disabled:opacity-50"
                        >
                            <svg v-if="trackingRunning" class="animate-spin w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <svg v-else class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            [[ trackingRunning ? (currentLanguage === 'zh' ? 'AI å†³ç­–ä¸­...' : 'AI Deciding...') : (currentLanguage === 'zh' ? 'æ‰‹åŠ¨è¿è¡Œ AI å†³ç­–' : 'Run AI Decision') ]]
                        </button>
                    </div>
                </div>

                <!-- Portfolio Summary Cards -->
                <div v-if="trackingSummary" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Portfolio Value -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-xs text-gray-500 mb-1">[[ currentLanguage === 'zh' ? 'ç»„åˆä»·å€¼' : 'Portfolio Value' ]]</div>
                        <div class="text-lg font-bold text-gray-900">$[[ formatNumber(trackingSummary.portfolio_value) ]]</div>
                        <div class="text-xs mt-1" :class="trackingSummary.total_return_pct >= 0 ? 'text-green-600' : 'text-red-600'">
                            [[ trackingSummary.total_return_pct >= 0 ? '+' : '' ]][[ formatNumber(trackingSummary.total_return_pct) ]]%
                        </div>
                    </div>
                    <!-- Unrealized P&L -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-xs text-gray-500 mb-1">[[ currentLanguage === 'zh' ? 'æœªå®ç°ç›ˆäº' : 'Unrealized P&L' ]]</div>
                        <div class="text-lg font-bold" :class="trackingSummary.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'">
                            [[ trackingSummary.unrealized_pnl >= 0 ? '+' : '' ]]$[[ formatNumber(trackingSummary.unrealized_pnl) ]]
                        </div>
                    </div>
                    <!-- Realized P&L -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-xs text-gray-500 mb-1">[[ currentLanguage === 'zh' ? 'å·²å®ç°ç›ˆäº' : 'Realized P&L' ]]</div>
                        <div class="text-lg font-bold" :class="trackingSummary.realized_pnl >= 0 ? 'text-green-600' : 'text-red-600'">
                            [[ trackingSummary.realized_pnl >= 0 ? '+' : '' ]]$[[ formatNumber(trackingSummary.realized_pnl) ]]
                        </div>
                    </div>
                    <!-- Cash / Holdings -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-xs text-gray-500 mb-1">[[ currentLanguage === 'zh' ? 'æŒä»“ / ç°é‡‘' : 'Holdings / Cash' ]]</div>
                        <div class="text-lg font-bold text-gray-900">[[ trackingSummary.num_holdings ]]/[[ trackingSummary.max_holdings ]]</div>
                        <div class="text-xs text-gray-500 mt-1">[[ currentLanguage === 'zh' ? 'ç°é‡‘' : 'Cash' ]]: $[[ formatNumber(trackingSummary.cash) ]]</div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="bg-white rounded-lg border border-gray-200 p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-semibold text-gray-700">
                            [[ currentLanguage === 'zh' ? 'æ”¶ç›Šç‡å¯¹æ¯”' : 'Performance Comparison' ]]
                        </h3>
                        <div class="flex items-center gap-4 text-xs">
                            <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-blue-600 inline-block rounded"></span> [[ currentLanguage === 'zh' ? 'ç²¾é€‰ç»„åˆ' : 'Curated Picks' ]]</span>
<span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-orange-500 inline-block rounded"></span> SPY (S&P 500)</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-green-500 inline-block rounded"></span> QQQ (NASDAQ 100)</span>
                        </div>
                    </div>
                    <div ref="trackingChartRef" style="height: 320px; width: 100%;"></div>
                    <div v-if="!trackingBenchmark || !trackingBenchmark.dates || trackingBenchmark.dates.length === 0" class="flex items-center justify-center h-48 text-gray-400 text-sm">
                        [[ currentLanguage === 'zh' ? 'æš‚æ— å†å²æ•°æ®ï¼Œè¿è¡Œ AI å†³ç­–åå°†å¼€å§‹è®°å½•' : 'No historical data yet. Run AI decision to start tracking.' ]]
                    </div>
                </div>

                <!-- Current Holdings Table -->
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                            [[ currentLanguage === 'zh' ? 'å½“å‰æŒä»“' : 'Current Holdings' ]]
                        </h3>
                        <span class="text-xs text-gray-500" v-if="trackingSummary">
                            [[ trackingSummary.num_holdings ]] / [[ trackingSummary.max_holdings ]] [[ currentLanguage === 'zh' ? 'ä¸ªå¸­ä½' : 'slots' ]]
                        </span>
                    </div>
                    <div v-if="trackingHoldings.length === 0" class="p-8 text-center text-gray-400 text-sm">
                        [[ currentLanguage === 'zh' ? 'æš‚æ— æŒä»“ï¼Œç­‰å¾… AI å†³ç­–ä¹°å…¥' : 'No holdings yet. Waiting for AI to make buy decisions.' ]]
                    </div>
                    <div v-else class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'æ ‡çš„' : 'Symbol' ]]</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'ä¹°å…¥ä»·' : 'Buy Price' ]]</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'ç°ä»·' : 'Current' ]]</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'æ”¶ç›Šç‡' : 'Return' ]]</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'å æ¯”' : 'Weight' ]]</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">[[ currentLanguage === 'zh' ? 'ä¹°å…¥æ—¥æœŸ' : 'Buy Date' ]]</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase w-8"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template v-for="h in trackingHoldings" :key="h.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer transition-colors" @click="expandedHoldingId = expandedHoldingId === h.id ? null : h.id">
                                        <td class="px-4 py-3">
                                            <div class="flex flex-col">
                                                <span class="text-sm font-semibold text-gray-900">[[ h.symbol ]]</span>
                                                <span v-if="h.name && h.name !== h.symbol" class="text-xs text-gray-500">[[ h.name ]]</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-right text-sm text-gray-900">$[[ formatNumber(h.buy_price) ]]</td>
                                        <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">$[[ formatNumber(h.current_price || h.buy_price) ]]</td>
                                        <td class="px-4 py-3 text-right">
                                            <span class="text-sm font-semibold" :class="(h.unrealized_pct || 0) >= 0 ? 'text-green-600' : 'text-red-600'">
                                                [[ (h.unrealized_pct || 0) >= 0 ? '+' : '' ]][[ formatNumber(h.unrealized_pct || 0) ]]%
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-medium text-gray-900">[[ formatNumber(h.allocation_pct || 0) ]]%</span>
                                                <span class="text-xs text-gray-400">$[[ formatNumber(h.market_value || 0) ]]</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-right text-xs text-gray-500">[[ h.buy_date ]]</td>
                                        <td class="px-4 py-3 text-center">
                                            <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 inline-block" :class="{'rotate-180': expandedHoldingId === h.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </td>
                                    </tr>
                                    <!-- Expanded Reason Row -->
                                    <tr v-if="expandedHoldingId === h.id">
                                        <td colspan="7" class="px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50">
                                            <div class="flex items-start gap-2">
                                                <span class="text-blue-500 mt-0.5 flex-shrink-0">ğŸ’¡</span>
                                                <div>
                                                    <div class="text-xs font-semibold text-blue-700 mb-1">[[ currentLanguage === 'zh' ? 'ä¹°å…¥ç†ç”±' : 'Buy Rationale' ]]</div>
                                                    <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">[[ h.reason || (currentLanguage === 'zh' ? 'æš‚æ— ç†ç”±' : 'No reason provided') ]]</p>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Transaction History & Decision Logs -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction History' ]]
                            </h3>
                        </div>
                        <div v-if="trackingTransactions.length === 0" class="p-6 text-center text-gray-400 text-sm">
                            [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transactions yet' ]]
                        </div>
                        <div v-else class="divide-y divide-gray-100 max-h-80 overflow-y-auto">
                            <div v-for="tx in trackingTransactions" :key="tx.id" class="px-4 py-3 flex items-center justify-between hover:bg-gray-50">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold" :class="tx.action === 'BUY' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                        [[ tx.action ]]
                                    </span>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900">[[ tx.symbol ]]</div>
                                        <div class="text-xs text-gray-500">[[ tx.date ]] Â· $[[ formatNumber(tx.price) ]]</div>
                                    </div>
                                </div>
                                <div v-if="tx.action === 'SELL' && tx.realized_pct !== null" class="text-right">
                                    <span class="text-sm font-semibold" :class="tx.realized_pct >= 0 ? 'text-green-600' : 'text-red-600'">
                                        [[ tx.realized_pct >= 0 ? '+' : '' ]][[ formatNumber(tx.realized_pct) ]]%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Decision Logs -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'AI å†³ç­–æ—¥å¿—' : 'AI Decision Logs' ]]
                            </h3>
                        </div>
                        <div v-if="trackingDecisions.length === 0" class="p-6 text-center text-gray-400 text-sm">
                            [[ currentLanguage === 'zh' ? 'æš‚æ— å†³ç­–è®°å½•' : 'No decision logs yet' ]]
                        </div>
                        <div v-else class="divide-y divide-gray-100 max-h-80 overflow-y-auto">
                            <div v-for="d in trackingDecisions" :key="d.id" class="px-4 py-3 hover:bg-gray-50 cursor-pointer" @click="expandedDecisionId = expandedDecisionId === d.id ? null : d.id">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <span class="text-xs font-mono text-gray-500 flex-shrink-0">[[ d.date ]]</span>
                                        <span class="px-1.5 py-0.5 rounded text-xs font-bold flex-shrink-0" :class="d.has_changes ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'">
                                            [[ d.has_changes ? (currentLanguage === 'zh' ? 'æœ‰å˜æ›´' : 'Changed') : (currentLanguage === 'zh' ? 'æ— å˜æ›´' : 'No Change') ]]
                                        </span>
                                        <!-- Action tags preview (collapsed) -->
                                        <div v-if="expandedDecisionId !== d.id && d.actions && d.actions.length > 0" class="flex items-center gap-1 min-w-0 overflow-hidden">
                                            <span v-for="(a, idx) in d.actions" :key="idx" class="inline-flex items-center gap-0.5 px-1 py-0.5 rounded text-xs flex-shrink-0" :class="a.action === 'BUY' ? 'text-green-600' : 'text-red-600'">
                                                <span class="font-semibold">[[ a.action === 'BUY' ? 'â†‘' : 'â†“' ]][[ a.symbol ]]</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-400 flex-shrink-0">
                                        <span>[[ d.model_name ]]</span>
                                        <span v-if="d.elapsed_seconds">[[ formatNumber(d.elapsed_seconds) ]]s</span>
                                        <svg class="w-4 h-4 transition-transform duration-200" :class="{'rotate-180': expandedDecisionId === d.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Expanded Decision Details -->
                                <div v-if="expandedDecisionId === d.id" class="mt-3 pt-3 border-t border-gray-200 space-y-3">
                                    <!-- Action cards -->
                                    <div v-if="d.actions && d.actions.length > 0" class="space-y-2">
                                        <div v-for="(a, idx) in d.actions" :key="idx" class="rounded-lg p-3" :class="a.action === 'BUY' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                                            <div class="flex items-center gap-2 mb-1.5">
                                                <span class="px-2 py-0.5 rounded text-xs font-bold" :class="a.action === 'BUY' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'">[[ a.action ]]</span>
                                                <span class="text-sm font-bold text-gray-900">[[ a.symbol ]]</span>
                                            </div>
                                            <p v-if="a.reason" class="text-xs text-gray-700 leading-relaxed whitespace-pre-line">[[ a.reason ]]</p>
                                        </div>
                                    </div>
                                    <!-- Summary -->
                                    <div v-if="d.summary" class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                        <div class="text-xs font-semibold text-gray-500 mb-1.5">[[ currentLanguage === 'zh' ? 'ğŸ“ å†³ç­–æ‘˜è¦' : 'ğŸ“ Decision Summary' ]]</div>
                                        <p class="text-xs text-gray-700 leading-relaxed whitespace-pre-line">[[ d.summary ]]</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Decision Info -->
                <div v-if="trackingSummary && trackingSummary.last_decision_date" class="text-center text-xs text-gray-400 py-2">
                    [[ currentLanguage === 'zh' ? 'ä¸Šæ¬¡ AI å†³ç­–' : 'Last AI Decision' ]]: [[ trackingSummary.last_decision_date ]]
                    Â· [[ currentLanguage === 'zh' ? 'èµ·å§‹æ—¥æœŸ' : 'Inception' ]]: [[ trackingSummary.inception_date ]]
                    Â· [[ currentLanguage === 'zh' ? 'åˆå§‹èµ„é‡‘' : 'Initial Capital' ]]: $[[ formatNumber(trackingSummary.initial_capital) ]]
                </div>
            </div>
        </div>

        <!-- Portfolio Diagnosis Tab Content -->
        <div v-if="currentTab === 'portfolio' && !loadingPortfolio" class="animate-fade-in">
            <div class="max-w-7xl mx-auto space-y-4">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">
                            [[ currentLanguage === 'zh' ? 'æŒä»“ç®¡ç†' : 'Portfolio Management' ]]
                        </h2>
                        <p class="text-xs text-gray-500 mt-0.5">
                            [[ currentLanguage === 'zh' ? 'ç®¡ç†æ‚¨çš„è™šæ‹ŸæŠ•èµ„ç»„åˆ' : 'Manage your virtual investment portfolio' ]]
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            @click="editMode = !editMode"
                            class="px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1.5 text-xs font-medium"
                            :class="editMode ? 'bg-orange-600 text-white hover:bg-orange-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            [[ editMode ? (currentLanguage === 'zh' ? 'é€€å‡ºç¼–è¾‘' : 'Exit Edit') : (currentLanguage === 'zh' ? 'ç¼–è¾‘æ¨¡å¼' : 'Edit Mode') ]]
                        </button>
                        <button 
                            @click="diagnosePortfolio()"
                            :disabled="portfolios.length === 0"
                            class="px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-1.5 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'æŒä»“åˆ†æ' : 'Analysis' ]]
                        </button>
                        <button 
                            @click="openCashModal()"
                            class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1.5 text-xs font-medium"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'ç°é‡‘æ“ä½œ' : 'Cash' ]]
                        </button>
                        <button 
                            @click="openAddTransactionModal()"
                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5 text-xs font-medium"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'æ·»åŠ äº¤æ˜“' : 'Add Transaction' ]]
                        </button>
                    </div>
                </div>

                <!-- AI Analysis Result -->
                <div v-if="portfolioResult" class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-200 p-6 mb-4 animate-fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <h3 class="text-lg font-bold text-gray-900">
                                [[ currentLanguage === 'zh' ? 'AI æŒä»“åˆ†æ' : 'AI Portfolio Analysis' ]]
                            </h3>
                            <span v-if="portfolioResult.overall_rating" class="ml-2 px-3 py-1 rounded-full text-sm font-semibold"
                                  :class="{
                                      'bg-green-100 text-green-800': portfolioResult.overall_rating === 'ä¼˜ç§€' || portfolioResult.overall_rating === 'Excellent',
                                      'bg-blue-100 text-blue-800': portfolioResult.overall_rating === 'è‰¯å¥½' || portfolioResult.overall_rating === 'Good',
                                      'bg-yellow-100 text-yellow-800': portfolioResult.overall_rating === 'ä¸€èˆ¬' || portfolioResult.overall_rating === 'Fair',
                                      'bg-red-100 text-red-800': portfolioResult.overall_rating === 'è¾ƒå·®' || portfolioResult.overall_rating === 'Poor'
                                  }">
                                [[ portfolioResult.overall_rating ]]
                            </span>
                        </div>
                        <button 
                            @click="portfolioResult = null"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Performance Analysis -->
                        <div v-if="portfolioResult.performance_analysis" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'æ”¶ç›Šåˆ†æ' : 'Performance Analysis' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.performance_analysis ]]</p>
                        </div>
                        
                        <!-- Asset Allocation Analysis -->
                        <div v-if="portfolioResult.asset_allocation_analysis" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'èµ„äº§é…ç½®åˆ†æ' : 'Asset Allocation Analysis' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.asset_allocation_analysis ]]</p>
                        </div>
                        
                        <!-- Risk Assessment -->
                        <div v-if="portfolioResult.risk_assessment" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'é£é™©è¯„ä¼°' : 'Risk Assessment' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.risk_assessment ]]</p>
                        </div>
                        
                        <!-- Market Outlook -->
                        <div v-if="portfolioResult.market_outlook" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'å¸‚åœºå±•æœ›' : 'Market Outlook' ]]
                            </h4>
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">[[ portfolioResult.market_outlook ]]</p>
                        </div>
                        
                        <!-- Recommendations -->
                        <div v-if="portfolioResult.recommendations && portfolioResult.recommendations.length > 0" class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'æ“ä½œå»ºè®®' : 'Recommendations' ]]
                            </h4>
                            <ul class="space-y-2">
                                <li v-for="(rec, index) in portfolioResult.recommendations" :key="index" 
                                    class="flex items-start gap-2 text-sm text-gray-700">
                                    <span class="flex-shrink-0 w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-semibold mt-0.5">
                                        [[ index + 1 ]]
                                    </span>
                                    <span class="flex-1 leading-relaxed">[[ rec ]]</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div v-if="loadingPortfolios" class="space-y-4">
                    <!-- éª¨æ¶å± - æ€»èµ„äº§å¡ç‰‡ -->
                    <div class="bg-gradient-to-r from-gray-200 to-gray-300 rounded-lg p-5 animate-pulse">
                        <div class="h-4 bg-gray-400 rounded w-24 mb-3"></div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                            <div class="bg-white/50 rounded-lg p-4">
                                <div class="h-3 bg-gray-400 rounded w-16 mb-2"></div>
                                <div class="h-8 bg-gray-400 rounded w-32"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- éª¨æ¶å± - æŒä»“åˆ—è¡¨ -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-200 bg-gray-50">
                            <div class="h-5 bg-gray-300 rounded w-32 animate-pulse"></div>
                        </div>
                        <div class="divide-y divide-gray-200">
                            <div v-for="i in 3" :key="i" class="p-4 animate-pulse">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="h-5 bg-gray-300 rounded w-24 mb-2"></div>
                                        <div class="h-4 bg-gray-200 rounded w-32"></div>
                                    </div>
                                    <div class="text-right">
                                        <div class="h-5 bg-gray-300 rounded w-20 mb-2 ml-auto"></div>
                                        <div class="h-4 bg-gray-200 rounded w-16 ml-auto"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŠ è½½æç¤º -->
                    <div class="flex justify-center items-center py-4">
                        <div class="spinner w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mr-3"></div>
                        <span class="text-gray-600 text-sm">
                            [[ currentLanguage === 'zh' ? 'åŠ è½½ä¸­...' : 'Loading...' ]]
                        </span>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-else-if="portfolios.length === 0" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        [[ currentLanguage === 'zh' ? 'æš‚æ— æŒä»“' : 'No Holdings' ]]
                    </h3>
                    <p class="text-sm text-gray-500">
                        [[ currentLanguage === 'zh' ? 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç¬”äº¤æ˜“' : 'Click the button above to add your first transaction' ]]
                    </p>
                </div>

                <!-- Portfolio Display (with Total Assets Summary) -->
                <div v-else>
                    <!-- Total Assets Summary -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-5 mb-4 shadow-md">
                        <!-- æ ‡é¢˜æ  -->
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-white text-sm font-semibold uppercase tracking-wider">
                                [[ currentLanguage === 'zh' ? 'èµ„äº§æ¦‚è§ˆ' : 'Assets Overview' ]]
                            </h2>
                            <button 
                                @click="toggleAmountVisibility"
                                class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors"
                                :title="currentLanguage === 'zh' ? (hideAmounts ? 'æ˜¾ç¤ºé‡‘é¢' : 'éšè—é‡‘é¢') : (hideAmounts ? 'Show Amounts' : 'Hide Amounts')"
                            >
                                <!-- çœ¼ç›çå¼€å›¾æ ‡ (æ˜¾ç¤ºçŠ¶æ€) -->
                                <svg v-if="!hideAmounts" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <!-- çœ¼ç›é—­åˆå›¾æ ‡ (éšè—çŠ¶æ€) -->
                                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <!-- Total Assets -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm relative group">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                            [[ currentLanguage === 'zh' ? 'æ€»èµ„äº§' : 'Total Assets' ]]
                                        </p>
                                        <p class="text-white text-2xl font-bold">
                                            [[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(displayedTotalAssets) ]]
                                        </p>
                                    </div>
                                    <button 
                                        @click="toggleCurrency"
                                        class="text-xs bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded transition-colors"
                                        :title="currentLanguage === 'zh' ? 'åˆ‡æ¢å¸ç§' : 'Switch Currency'"
                                    >
                                        [[ displayCurrency ]]
                                    </button>
                                </div>
                            </div>
                            <!-- Today's Change -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? 'ä»Šæ—¥æ¶¨è·Œ' : 'Today\'s Change' ]]
                                </p>
                                <p :class="displayedTotalDailyChange >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ displayedTotalDailyChange >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(Math.abs(displayedTotalDailyChange)) ]]
                                </p>
                            </div>
                            <!-- Total Profit/Loss -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? 'æ€»ç›ˆäº' : 'Total Profit/Loss' ]]
                                </p>
                                <p :class="portfolioStats.total_pnl >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ portfolioStats.total_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(Math.abs(portfolioStats.total_pnl || 0)) ]]
                                </p>
                                <div class="text-blue-100 text-xs mt-2 space-y-1">
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? 'å·²å®ç°' : 'Realized' ]]:</span>
                                        <span :class="portfolioStats.realized_pnl >= 0 ? 'text-green-300' : 'text-red-300'">
                                            [[ portfolioStats.realized_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(Math.abs(portfolioStats.realized_pnl || 0)) ]]
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? 'æœªå®ç°' : 'Unrealized' ]]:</span>
                                        <span :class="portfolioStats.unrealized_pnl >= 0 ? 'text-green-300' : 'text-red-300'">
                                            [[ portfolioStats.unrealized_pnl >= 0 ? '+' : '-' ]][[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(Math.abs(portfolioStats.unrealized_pnl || 0)) ]]
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Total Profit/Loss Percentage -->
                            <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">
                                    [[ currentLanguage === 'zh' ? 'æ€»æ”¶ç›Šç‡' : 'Total Return' ]]
                                </p>
                                <p :class="(portfolioStats.total_return_rate || 0) >= 0 ? 'text-green-300' : 'text-red-300'" class="text-2xl font-bold">
                                    [[ (portfolioStats.total_return_rate || 0) >= 0 ? '+' : '' ]][[ ((portfolioStats.total_return_rate || 0)).toFixed(2) ]]%
                                </p>
                                <div class="text-blue-100 text-xs mt-2">
                                    <div class="flex justify-between">
                                        <span>[[ currentLanguage === 'zh' ? 'å‡€å…¥é‡‘' : 'Net Deposit' ]]:</span>
                                        <span>[[ displayCurrency === 'USD' ? '$' : 'Â¥' ]][[ maskAmount(portfolioStats.net_deposit) ]]</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio Tables by Asset Type -->
                    <div class="space-y-4">
                    <!-- Cash Holdings -->
                    <div v-if="portfoliosByType.CASH && portfoliosByType.CASH.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'ç°é‡‘' : 'Cash' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å¸ç§' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ä½™é¢' : 'Balance' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å æ¯”' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="p in portfoliosByType.CASH" :key="p.id" class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                    <td class="px-4 py-2.5 whitespace-nowrap">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-900">[[ p.currency ]]</span>
                                            <span v-if="p.currency !== 'USD' && p.exchange_rate" class="text-xs text-gray-500">
                                                1:[[ p.exchange_rate.toFixed(4) ]]
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-right">
                                        <div class="flex flex-col items-end">
                                            <span v-if="p.currency !== 'USD'" class="text-sm font-semibold text-gray-900">
                                                $[[ maskAmount(p.value_in_usd) ]]
                                            </span>
                                            <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-semibold text-gray-900'">
                                                [[ maskAmount(p.total_quantity) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-right">
                                        <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || p.total_quantity) ]]%</span>
                                    </td>
                                    <td class="px-4 py-2.5 whitespace-nowrap text-center">
                                        <div v-if="editMode" class="flex gap-2 justify-center">
                                            <button 
                                                @click.stop="openEditCashModal(p)"
                                                class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                            >
                                                [[ currentLanguage === 'zh' ? 'ç¼–è¾‘ä½™é¢' : 'Edit Balance' ]]
                                            </button>
                                        </div>
                                        <button 
                                            v-else
                                            @click.stop="openCashFlowModal()"
                                            class="text-green-600 hover:text-green-800 text-sm font-medium"
                                        >
                                            [[ currentLanguage === 'zh' ? 'å…¥é‡‘/å‡ºé‡‘' : 'Deposit/Withdraw' ]]
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stock Holdings -->
                    <div v-if="portfoliosByType.STOCK && portfoliosByType.STOCK.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'è‚¡ç¥¨' : 'Stocks' ]]
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full relative">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="sticky left-0 z-10 bg-gray-50 px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? 'æ ‡çš„' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'è´§å¸' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å‡ä»·' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç°ä»·' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ä»Šæ—¥æ¶¨è·Œ' : 'Today' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ¶¨è·Œé‡‘é¢' : 'Change $' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å¸‚å€¼' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç›ˆäº' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å æ¯”' : 'Allocation' ]]
                                    </th>
                                    <th class="sticky right-0 z-10 bg-gray-50 px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.STOCK" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="sticky left-0 z-10 bg-white px-6 py-4 whitespace-nowrap border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="sticky right-0 z-10 bg-white px-6 py-4 whitespace-nowrap text-center border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol, p.asset_type)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-6 py-4">                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'ç±»å‹' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]]</th>
                                                        <th v-if="editMode" class="px-4 py-2 text-center text-gray-600">[[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY') : (currentLanguage === 'zh' ? 'å–å‡º' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                        <td v-if="editMode" class="px-4 py-2 text-center">
                                                            <div class="flex gap-2 justify-center">
                                                                <button @click.stop="openEditTransactionModal(t, p.id)" class="text-blue-600 hover:text-blue-800" :title="currentLanguage === 'zh' ? 'ç¼–è¾‘' : 'Edit'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                </button>
                                                                <button v-if="t.source !== 'auto'" @click.stop="deleteTransaction(t.id, p.id)" class="text-red-600 hover:text-red-800" :title="currentLanguage === 'zh' ? 'åˆ é™¤' : 'Delete'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                    <!-- CN Fund Holdings -->
                    <div v-if="portfoliosByType.FUND_CN && portfoliosByType.FUND_CN.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'ä¸­å›½åŸºé‡‘' : 'CN Funds' ]]
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full relative">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="sticky left-0 z-10 bg-gray-50 px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? 'æ ‡çš„' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'è´§å¸' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ä»½é¢' : 'Shares' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å‡ä»·' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç°ä»·' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ä»Šæ—¥æ¶¨è·Œ' : 'Today' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ¶¨è·Œé‡‘é¢' : 'Change $' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å¸‚å€¼' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç›ˆäº' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å æ¯”' : 'Allocation' ]]
                                    </th>
                                    <th class="sticky right-0 z-10 bg-gray-50 px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                        [[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.FUND_CN" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="sticky left-0 z-10 bg-white px-6 py-4 whitespace-nowrap border-r border-gray-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="sticky right-0 z-10 bg-white px-6 py-4 whitespace-nowrap text-center border-l border-gray-200 shadow-[-2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol, 'FUND_CN', true)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'ç±»å‹' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'ä»½é¢' : 'Shares' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]]</th>
                                                        <th v-if="editMode" class="px-4 py-2 text-center text-gray-600">[[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY') : (currentLanguage === 'zh' ? 'å–å‡º' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                        <td v-if="editMode" class="px-4 py-2 text-center">
                                                            <div class="flex gap-2 justify-center">
                                                                <button @click.stop="openEditTransactionModal(t, p.id)" class="text-blue-600 hover:text-blue-800" :title="currentLanguage === 'zh' ? 'ç¼–è¾‘' : 'Edit'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                </button>
                                                                <button v-if="t.source !== 'auto'" @click.stop="deleteTransaction(t.id, p.id)" class="text-red-600 hover:text-red-800" :title="currentLanguage === 'zh' ? 'åˆ é™¤' : 'Delete'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bitcoin Holdings -->
                    <div v-if="portfoliosByType.BITCOIN && portfoliosByType.BITCOIN.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'æ¯”ç‰¹å¸' : 'Bitcoin' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ ‡çš„' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'è´§å¸' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å‡ä»·' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç°ä»·' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å¸‚å€¼' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç›ˆäº' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å æ¯”' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.BITCOIN" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.value_in_usd || (p.current_value || p.total_cost)) ]]%</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol, p.asset_type)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'ç±»å‹' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]]</th>
                                                        <th v-if="editMode" class="px-4 py-2 text-center text-gray-600">[[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY') : (currentLanguage === 'zh' ? 'å–å‡º' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                        <td v-if="editMode" class="px-4 py-2 text-center">
                                                            <div class="flex gap-2 justify-center">
                                                                <button @click.stop="openEditTransactionModal(t, p.id)" class="text-blue-600 hover:text-blue-800" :title="currentLanguage === 'zh' ? 'ç¼–è¾‘' : 'Edit'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                </button>
                                                                <button v-if="t.source !== 'auto'" @click.stop="deleteTransaction(t.id, p.id)" class="text-red-600 hover:text-red-800" :title="currentLanguage === 'zh' ? 'åˆ é™¤' : 'Delete'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Gold Holdings -->
                    <div v-if="portfoliosByType.GOLD && portfoliosByType.GOLD.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                                [[ currentLanguage === 'zh' ? 'é»„é‡‘' : 'Gold' ]]
                            </h3>
                        </div>
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ ‡çš„' : 'Symbol' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'è´§å¸' : 'Currency' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å‡ä»·' : 'Avg Cost' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç°ä»·' : 'Current' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å¸‚å€¼' : 'Value' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'ç›ˆäº' : 'P&L' ]]
                                    </th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'å æ¯”' : 'Allocation' ]]
                                    </th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        [[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template v-for="p in portfoliosByType.GOLD" :key="p.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="togglePortfolioExpand(p.id)">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center gap-2">
                                                <svg v-if="expandedPortfolios.includes(p.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-semibold text-gray-900">[[ p.symbol ]]</span>
                                                    <span v-if="p.name && p.name !== p.symbol" class="text-xs text-gray-500">[[ p.name ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap text-center">
                                            <span class="text-xs font-medium text-gray-600">[[ p.currency ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-900">[[ maskAmount(p.total_quantity) ]]</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm text-gray-900">
                                                    $[[ formatNumber(p.avg_cost * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm text-gray-900'">
                                                    [[ formatNumber(p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span v-if="p.currency !== 'USD'" class="text-sm font-medium text-gray-900">
                                                    $[[ formatNumber((p.current_price || p.avg_cost) * (p.exchange_rate || 1)) ]]
                                                </span>
                                                <span :class="p.currency !== 'USD' ? 'text-xs text-gray-500' : 'text-sm font-medium text-gray-900'">
                                                    [[ formatNumber(p.current_price || p.avg_cost) ]] [[ p.currency !== 'USD' ? p.currency : '' ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined" :class="[
                                                'text-sm font-semibold',
                                                p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                            ]">
                                                [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ formatNumber(p.daily_change_percent) ]]%
                                            </span>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div v-if="p.daily_change_percent !== null && p.daily_change_percent !== undefined && p.current_price" class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-semibold',
                                                    p.daily_change_percent > 0 ? 'text-green-600' : p.daily_change_percent < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount((p.current_price * p.daily_change_percent / 100 * p.total_quantity) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ p.daily_change_percent >= 0 ? '+' : '' ]][[ maskAmount(p.current_price * p.daily_change_percent / 100 * p.total_quantity) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                            <span v-else class="text-xs text-gray-400">-</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span class="text-sm font-semibold text-gray-900">
                                                    $[[ maskAmount(p.value_in_usd || (p.current_value || p.total_cost)) ]]
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ maskAmount(p.current_value || p.total_cost) ]] [[ p.currency ]]
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <div class="flex flex-col items-end">
                                                <span :class="[
                                                    'text-sm font-bold',
                                                    (p.profit_loss || 0) > 0 ? 'text-green-600' : (p.profit_loss || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount((p.profit_loss || 0) * (p.exchange_rate || 1)) ]] USD
                                                </span>
                                                <span v-if="p.currency !== 'USD'" class="text-xs text-gray-500">
                                                    [[ (p.profit_loss || 0) >= 0 ? '+' : '' ]][[ maskAmount(p.profit_loss || 0) ]] [[ p.currency ]]
                                                </span>
                                                <span :class="[
                                                    'text-xs font-semibold',
                                                    (p.profit_loss_percent || 0) > 0 ? 'text-green-600' : (p.profit_loss_percent || 0) < 0 ? 'text-red-600' : 'text-gray-600'
                                                ]">
                                                    [[ (p.profit_loss_percent || 0) >= 0 ? '+' : '' ]][[ formatNumber(p.profit_loss_percent || 0) ]]%
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">
                                            <span class="text-sm text-gray-600">[[ calculateAllocation(p.current_value || p.total_cost) ]]%</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <div class="flex items-center justify-center gap-3">
                                                <button 
                                                    @click.stop="openAddTransactionModal(p)"
                                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Trade' ]]
                                                </button>
                                                <button 
                                                    @click.stop="query = p.symbol; currentTab = 'analysis'; analyzeStock(p.symbol, p.asset_type)"
                                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                >
                                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expanded Transaction Records -->
                                    <tr v-if="expandedPortfolios.includes(p.id)" class="bg-gray-50">
                                        <td colspan="11" class="px-4 py-3">
                                            <div class="text-xs text-gray-600 mb-2 font-semibold">
                                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“è®°å½•' : 'Transaction History' ]]
                                            </div>
                                            <div v-if="loadingTransactions[p.id]" class="text-center py-4">
                                                <div class="spinner w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                                            </div>
                                            <div v-else-if="!portfolioTransactions[p.id] || portfolioTransactions[p.id].length === 0" class="text-center py-4 text-sm text-gray-500">
                                                [[ currentLanguage === 'zh' ? 'æš‚æ— äº¤æ˜“è®°å½•' : 'No transactions' ]]
                                            </div>
                                            <table v-else class="w-full text-xs">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'ç±»å‹' : 'Type' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]</th>
                                                        <th class="px-4 py-2 text-right text-gray-600">[[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]</th>
                                                        <th class="px-4 py-2 text-left text-gray-600">[[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]]</th>
                                                        <th v-if="editMode" class="px-4 py-2 text-center text-gray-600">[[ currentLanguage === 'zh' ? 'æ“ä½œ' : 'Actions' ]]</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white">
                                                    <tr v-for="t in portfolioTransactions[p.id]" :key="t.id" class="border-t border-gray-200">
                                                        <td class="px-4 py-2 text-gray-700">[[ t.trade_date ]]</td>
                                                        <td class="px-4 py-2">
                                                            <span :class="t.transaction_type === 'BUY' ? 'text-red-600' : 'text-green-600'" class="font-medium">
                                                                [[ t.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY') : (currentLanguage === 'zh' ? 'å–å‡º' : 'SELL') ]]
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.price) ]]</td>
                                                        <td class="px-4 py-2 text-right text-gray-700">[[ maskAmount(t.quantity) ]]</td>
                                                        <td class="px-4 py-2 text-right font-medium text-gray-900">[[ maskAmount(t.amount) ]]</td>
                                                        <td class="px-4 py-2 text-gray-600">[[ t.notes || '-' ]]</td>
                                                        <td v-if="editMode" class="px-4 py-2 text-center">
                                                            <div class="flex gap-2 justify-center">
                                                                <button @click.stop="openEditTransactionModal(t, p.id)" class="text-blue-600 hover:text-blue-800" :title="currentLanguage === 'zh' ? 'ç¼–è¾‘' : 'Edit'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                </button>
                                                                <button v-if="t.source !== 'auto'" @click.stop="deleteTransaction(t.id, p.id)" class="text-red-600 hover:text-red-800" :title="currentLanguage === 'zh' ? 'åˆ é™¤' : 'Delete'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    </div>  <!-- End v-else block -->
                </div>
            </div>
        </div>

        <!-- Add Transaction Modal -->
        <div v-if="showAddTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showAddTransactionModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? 'æ·»åŠ äº¤æ˜“è®°å½•' : 'Add Transaction' ]]
                    </h3>
                    <button @click="showAddTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Symbol -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-700">
                                [[ currentLanguage === 'zh' ? 'æ ‡çš„ä»£ç ' : 'Symbol' ]]
                            </label>
                            <div class="flex bg-gray-100 rounded-lg p-1">
                                <button 
                                    @click="searchType = 'ALL'"
                                    :class="['px-3 py-1 text-xs rounded-md transition-all', searchType === 'ALL' ? 'bg-white shadow text-purple-600 font-bold' : 'text-gray-500 hover:text-gray-700']"
                                >
                                    Global
                                </button>
                                <button 
                                    @click="searchType = 'FUND_CN'"
                                    :class="['px-3 py-1 text-xs rounded-md transition-all', searchType === 'FUND_CN' ? 'bg-white shadow text-purple-600 font-bold' : 'text-gray-500 hover:text-gray-700']"
                                >
                                    CN Fund
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <input 
                                v-model="transactionForm.symbol" 
                                @input="handleTransactionSymbolSearch"
                                type="text" 
                                placeholder="AAPL"
                                :readonly="transactionSymbolSelected"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none uppercase"
                            >
                            <button 
                                v-if="transactionForm.symbol && transactionSymbolSelected"
                                @click="clearTransactionSymbol"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <div v-if="transactionSymbolSuggestions && transactionSymbolSuggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-lg shadow-xl border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in transactionSymbolSuggestions"
                                    @click="selectTransactionSymbol(item)"
                                    class="px-4 py-2.5 hover:bg-purple-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-100 last:border-0 transition-colors"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">[[ item.symbol ]]</span>
                                        <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">[[ item.type || 'STOCK' ]]</span>
                                        <span class="text-gray-500 text-xs">[[ item.name ]]</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                            <!--æç¤ºä¿¡æ¯ï¼šå¿…é¡»ä»æœç´¢ç»“æœä¸­é€‰æ‹©-->
                            <div v-if="transactionForm.symbol && !transactionSymbolSelected" class="absolute z-40 w-full mt-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200">
                                <span class="font-medium">âš ï¸ [[ currentLanguage === 'zh' ? 'è¯·ä»æœç´¢ç»“æœä¸­é€‰æ‹©' : 'Please select from search results' ]]</span>
                            </div>
                        </div>                    </div>

                    <!-- Asset Type & Currency -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'èµ„äº§ç±»å‹' : 'Asset Type' ]]
                            </label>
                            <select v-model="transactionForm.asset_type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                                <option value="STOCK">[[ currentLanguage === 'zh' ? 'è‚¡ç¥¨' : 'Stock' ]]</option>
                                <option value="FUND_CN">[[ currentLanguage === 'zh' ? 'ä¸­å›½åŸºé‡‘' : 'CN Fund' ]]</option>
                                <option value="CRYPTO">[[ currentLanguage === 'zh' ? 'åŠ å¯†è´§å¸' : 'Crypto' ]]</option>
                                <option value="GOLD">[[ currentLanguage === 'zh' ? 'é»„é‡‘' : 'Gold' ]]</option>
                                <option value="CASH">[[ currentLanguage === 'zh' ? 'ç°é‡‘' : 'Cash' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'å¸ç§' : 'Currency' ]]
                            </label>
                            <select v-model="transactionForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                                <option value="USD">USD</option>
                                <option value="HKD">HKD</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                    </div>

                    <!-- Transaction Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'äº¤æ˜“ç±»å‹' : 'Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="transactionForm.transaction_type = 'BUY'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    transactionForm.transaction_type === 'BUY' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY' ]]
                            </button>
                            <button 
                                @click="transactionForm.transaction_type = 'SELL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    transactionForm.transaction_type === 'SELL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'å–å‡º' : 'SELL' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'äº¤æ˜“æ—¥æœŸ' : 'Date' ]]
                        </label>
                        <input 
                            v-model="transactionForm.trade_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                        >
                    </div>

                    <!-- Price, Quantity & Total Amount -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]
                            </label>
                            <input 
                                v-model="transactionForm.price" 
                                @input="calculateTotal"
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]
                            </label>
                            <input 
                                v-model="transactionForm.quantity" 
                                @input="calculateTotal"
                                type="number" 
                                step="0.01"
                                placeholder="0"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'æ€»é‡‘é¢' : 'Total' ]]
                            </label>
                            <input 
                                v-model="transactionForm.total_amount" 
                                @input="calculateQuantity"
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]] ([[ currentLanguage === 'zh' ? 'å¯é€‰' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="transactionForm.notes" 
                            rows="3"
                            placeholder="..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showAddTransactionModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="addTransaction"
                            :disabled="!transactionSymbolSelected"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition-all font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            [[ currentLanguage === 'zh' ? 'ç¡®è®¤' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div v-if="showEditTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditTransactionModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? 'ç¼–è¾‘äº¤æ˜“è®°å½•' : 'Edit Transaction' ]]
                    </h3>
                    <button @click="showEditTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Transaction Type (Read-only) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'äº¤æ˜“ç±»å‹' : 'Type' ]]
                        </label>
                        <div class="px-4 py-3 bg-gray-100 rounded-xl font-bold text-gray-700">
                            [[ editingTransaction?.transaction_type === 'BUY' ? (currentLanguage === 'zh' ? 'ä¹°å…¥' : 'BUY') : (currentLanguage === 'zh' ? 'å–å‡º' : 'SELL') ]]
                        </div>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'äº¤æ˜“æ—¥æœŸ' : 'Date' ]]
                        </label>
                        <input 
                            v-model="editTransactionForm.trade_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                        >
                    </div>

                    <!-- Price & Quantity -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'ä»·æ ¼' : 'Price' ]]
                            </label>
                            <input 
                                v-model="editTransactionForm.price" 
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                [[ currentLanguage === 'zh' ? 'æ•°é‡' : 'Quantity' ]]
                            </label>
                            <input 
                                v-model="editTransactionForm.quantity" 
                                type="number" 
                                step="0.01"
                                placeholder="0"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                            >
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]] ([[ currentLanguage === 'zh' ? 'å¯é€‰' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="editTransactionForm.notes" 
                            rows="3"
                            placeholder="..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showEditTransactionModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="updateTransaction"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'ä¿å­˜' : 'Save' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Cash Balance Modal -->
        <div v-if="showEditCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditCashModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? 'ç¼–è¾‘ç°é‡‘ä½™é¢' : 'Edit Cash Balance' ]]
                    </h3>
                    <button @click="showEditCashModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Currency (Read-only) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¸ç§' : 'Currency' ]]
                        </label>
                        <div class="px-4 py-3 bg-gray-100 rounded-xl font-bold text-gray-700">
                            [[ editingCash?.currency ]]
                        </div>
                    </div>

                    <!-- Current Balance (Read-only) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å½“å‰ä½™é¢' : 'Current Balance' ]]
                        </label>
                        <div class="px-4 py-3 bg-gray-100 rounded-xl font-bold text-gray-700">
                            [[ editingCash?.total_quantity?.toFixed(2) ]]
                        </div>
                    </div>

                    <!-- New Balance -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ–°ä½™é¢' : 'New Balance' ]]
                        </label>
                        <input 
                            v-model="editCashForm.balance" 
                            type="number" 
                            step="0.01"
                            placeholder="0.00"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                        >
                    </div>

                    <!-- Warning -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex gap-2">
                            <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="text-xs text-yellow-800">
                                [[ currentLanguage === 'zh' ? 'âš ï¸ ç›´æ¥ä¿®æ”¹ä½™é¢å°†ä¸ä¼šè®°å½•èµ„é‡‘æµæ°´ã€‚å»ºè®®ä½¿ç”¨"å…¥é‡‘/å‡ºé‡‘"åŠŸèƒ½æ¥æ­£å¸¸è®°å½•èµ„é‡‘å˜åŠ¨ã€‚' : 'âš ï¸ Directly editing balance will not record cash flow. It is recommended to use "Deposit/Withdraw" to properly record fund changes.' ]]
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showEditCashModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="updateCashBalance"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'ä¿å­˜' : 'Save' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Operation Modal -->
        <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showCashModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? 'ç°é‡‘æ“ä½œ' : 'Cash Operation' ]]
                    </h3>
                    <button @click="showCashModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Operation Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ“ä½œç±»å‹' : 'Operation Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="cashForm.transaction_type = 'BUY'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashForm.transaction_type === 'BUY' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'å…¥é‡‘' : 'DEPOSIT' ]]
                            </button>
                            <button 
                                @click="cashForm.transaction_type = 'SELL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashForm.transaction_type === 'SELL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'å‡ºé‡‘' : 'WITHDRAW' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Currency -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¸ç§' : 'Currency' ]]
                        </label>
                        <select v-model="cashForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none">
                            <option value="USD">USD (ç¾å…ƒ)</option>
                            <option value="HKD">HKD (æ¸¯å¸)</option>
                            <option value="CNY">CNY (äººæ°‘å¸)</option>
                        </select>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]
                        </label>
                        <input 
                            v-model="cashForm.amount" 
                            type="number" 
                            step="0.01"
                            placeholder="0.00"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-lg font-bold"
                        >
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]
                        </label>
                        <input 
                            v-model="cashForm.trade_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                        >
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]] ([[ currentLanguage === 'zh' ? 'å¯é€‰' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="cashForm.notes" 
                            rows="3"
                            placeholder="..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showCashModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="addCashTransaction"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'ç¡®è®¤' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cash Flow Modal (v2.0 - Investment Return Tracking) -->
        <div v-if="showCashFlowModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showCashFlowModal = false">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        [[ currentLanguage === 'zh' ? 'èµ„é‡‘æµæ°´' : 'Cash Flow' ]]
                    </h3>
                    <button @click="showCashFlowModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Flow Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'ç±»å‹' : 'Type' ]]
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button 
                                @click="cashFlowForm.flow_type = 'DEPOSIT'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashFlowForm.flow_type === 'DEPOSIT' 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'å…¥é‡‘' : 'Deposit' ]]
                            </button>
                            <button 
                                @click="cashFlowForm.flow_type = 'WITHDRAWAL'"
                                :class="[
                                    'px-4 py-3 rounded-xl font-bold transition-all',
                                    cashFlowForm.flow_type === 'WITHDRAWAL' 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                ]"
                            >
                                [[ currentLanguage === 'zh' ? 'å‡ºé‡‘' : 'Withdrawal' ]]
                            </button>
                        </div>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ—¥æœŸ' : 'Date' ]]
                        </label>
                        <input 
                            v-model="cashFlowForm.flow_date" 
                            type="date" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        >
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'é‡‘é¢' : 'Amount' ]]
                        </label>
                        <input 
                            v-model="cashFlowForm.amount" 
                            type="number" 
                            step="0.01"
                            min="0"
                            :placeholder="currentLanguage === 'zh' ? 'è¯·è¾“å…¥é‡‘é¢' : 'Enter amount'"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg font-bold"
                        >
                    </div>

                    <!-- Currency -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¸ç§' : 'Currency' ]]
                        </label>
                        <select v-model="cashFlowForm.currency" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="USD">USD (ç¾å…ƒ)</option>
                            <option value="CNY">CNY (äººæ°‘å¸)</option>
                            <option value="HKD">HKD (æ¸¯å¸)</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'å¤‡æ³¨' : 'Notes' ]] ([[ currentLanguage === 'zh' ? 'é€‰å¡«' : 'Optional' ]])
                        </label>
                        <textarea 
                            v-model="cashFlowForm.notes" 
                            rows="2"
                            :placeholder="currentLanguage === 'zh' ? 'é€‰å¡«' : 'Optional'"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-4">
                        <button 
                            @click="showCashFlowModal = false"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                        <button 
                            @click="submitCashFlow"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-lg transition-all font-bold"
                        >
                            [[ currentLanguage === 'zh' ? 'ç¡®å®š' : 'Confirm' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>

