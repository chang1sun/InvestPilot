<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Pilot</title>
    <link rel="icon" type="image/png" href="/static/thumbnail.png">
    <link rel="apple-touch-icon" href="/static/thumbnail.png">
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none !important; }
        .chart-container { height: 500px; width: 100%; } /* Fixed height for chart */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Text Content Styling */
        .prose-sm { font-size: 0.875rem; line-height: 1.6; }
        .analysis-card { background: #ffffff; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .analysis-header { border-left: 4px solid #3b82f6; padding-left: 1rem; margin-bottom: 0.75rem; }
        .market-card { background: linear-gradient(to bottom right, #eff6ff, #ffffff); border: 1px solid #bfdbfe; }
        
        /* Button Animation */
        .btn-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Stock Card Animation */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stock-card {
            animation: fade-in-up 0.5s ease-out;
        }
        
        .stock-card:nth-child(1) { animation-delay: 0s; }
        .stock-card:nth-child(2) { animation-delay: 0.1s; }
        .stock-card:nth-child(3) { animation-delay: 0.2s; }
        .stock-card:nth-child(4) { animation-delay: 0.3s; }
        .stock-card:nth-child(5) { animation-delay: 0.4s; }
        .stock-card:nth-child(6) { animation-delay: 0.5s; }
        .stock-card:nth-child(7) { animation-delay: 0.6s; }
        .stock-card:nth-child(8) { animation-delay: 0.7s; }
        
        /* Text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="flex flex-col min-h-screen">
        <!-- Disclaimer Banner (Always Visible at Top) -->
        <div class="bg-gradient-to-r from-red-50 via-orange-50 to-yellow-50 border-b-2 border-red-400 shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-base font-bold text-red-900 mb-1 flex items-center gap-2">
                            <span>âš ï¸</span>
                            <span>[[ currentLanguage === 'zh' ? 'å…è´£å£°æ˜' : 'Disclaimer' ]]</span>
                        </div>
                        <div class="text-sm text-red-800 leading-relaxed">
                            [[ currentLanguage === 'zh' ? 
                                'æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚' : 
                                'This project is for learning and research purposes only and does not constitute any investment advice. The stock market involves risks, and investment requires caution. Users are solely responsible for all consequences of using this system for investment decisions.' 
                            ]]
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-4 flex-1 flex flex-col">
        <!-- Header & Search Row -->
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <img src="/static/logo.png" alt="Invest Pilot Logo" class="w-12 h-12 object-contain">
                
                <!-- Title -->
                <div class="flex flex-col">
                    <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 leading-tight">Invest Pilot</h1>
                    <p class="text-xs text-gray-500 font-medium mt-0.5 hidden sm:block">AI-Powered Investment Copilot</p>
                </div>
                
                <!-- Model Selector -->
                <div class="relative">
                    <select 
                        v-model="selectedModel" 
                        class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pr-8 cursor-pointer font-medium"
                    >
                        <option v-for="m in availableModels" :key="m.id" :value="m.id" :disabled="m.disabled || m.isHeader" :class="{'font-bold text-gray-400': m.isHeader}">
                            [[ m.name ]] [[ m.status === 'limit' ? '(å·²é™é¢)' : '' ]]
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                    <div v-if="currentModelStatus === 'limit'"  
                         class="absolute -top-2 -right-2 bg-yellow-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold cursor-help shadow-sm z-10"
                         title="è¯¥æ¨¡å‹è§¦å‘äº† API é…é¢é™åˆ¶ (429)ï¼Œå½“å‰å¯èƒ½ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æˆ–æ— æ³•å·¥ä½œã€‚"
                    >!</div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Language Selector -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button @click="currentLanguage = 'zh'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'zh' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">ä¸­æ–‡</button>
                    <button @click="currentLanguage = 'en'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">EN</button>
                </div>

                <!-- Search Box (Only visible in analysis tab) -->
                <div v-if="currentTab === 'analysis'" class="relative w-80">
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input 
                                type="text" 
                                v-model="query" 
                                @input="handleSearch"
                                @keyup.enter="analyzeStock(query)"
                                :placeholder="currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚ AAPL, 0700.HK)' : 'Enter Symbol (e.g., AAPL)'"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            >
                            <div v-if="suggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-md shadow-lg border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in suggestions" 
                                    @click="selectStock(item.symbol)"
                                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between text-sm"
                                >
                                    <span class="font-medium">[[ item.symbol ]]</span>
                                    <span class="text-gray-500">[[ item.name ]]</span>
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="analyzeStock(query)" 
                            :disabled="loadingAnalysis || !query"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap shadow-md transition-all active:scale-95"
                        >
                            [[ loadingAnalysis ? (currentLanguage === 'zh' ? 'åˆ†æä¸­...' : 'Analyzing...') : (currentLanguage === 'zh' ? 'å¼€å§‹' : 'Start') ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex gap-8 mb-6 border-b border-gray-200 px-2">
            <button 
                @click="currentTab = 'analysis'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'analysis' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                [[ currentLanguage === 'zh' ? 'ä¸ªè‚¡åˆ†æ' : 'Trend Analysis' ]]
            </button>
            <button 
                @click="currentTab = 'recommend'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'recommend' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Smart Picks' ]]
            </button>
            <button 
                @click="currentTab = 'portfolio'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'portfolio' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                [[ currentLanguage === 'zh' ? 'æŒä»“è¯Šæ–­' : 'Portfolio Diagnosis' ]]
            </button>
        </div>

        <!-- Loading State -->
        <div v-if="(currentTab === 'analysis' && loadingAnalysis) || (currentTab === 'recommend' && loadingRecommend) || (currentTab === 'portfolio' && loadingPortfolio)" class="flex-1 flex items-center justify-center min-h-[400px]">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...' : 'AI is analyzing deep data...' ]]</p>
                <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? 'æ­£åœ¨æœç´¢å®æ—¶å¸‚åœºèµ„è®¯ & è®¡ç®—ç­–ç•¥...' : 'Searching real-time market info & calculating strategies...' ]]</p>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <template v-if="currentTab === 'analysis'">
            <!-- Result View -->
            <div v-if="!loadingAnalysis && analysisResult" class="flex-1 flex flex-col gap-6 animate-fade-in">
                
                <!-- Model Info Banner -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-xl p-4 shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-blue-900 mb-1">
                                [[ currentLanguage === 'zh' ? 'ğŸ’¡ é‡è¦æç¤º' : 'ğŸ’¡ Important Notice' ]]
                            </div>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                <p class="mb-1">
                                    [[ currentLanguage === 'zh' ? 
                                        'â€¢ ä¸åŒ AI æ¨¡å‹çš„åˆ†æç»“æœå¯èƒ½ä¸åŒï¼Œæ¯ä¸ªæ¨¡å‹éƒ½æœ‰ç‹¬ç«‹çš„äº¤æ˜“å†å²è®°å½•' : 
                                        'â€¢ Different AI models may produce different analysis results. Each model maintains its own separate trading history' 
                                    ]]
                                </p>
                                <p>
                                    [[ currentLanguage === 'zh' ? 
                                        'â€¢ ç›¸åŒæ¨¡å‹å¯¹åŒä¸€è‚¡ç¥¨çš„åˆ†æç»“æœä¼šè¢«ç¼“å­˜ï¼Œå½“å¤©é‡å¤åˆ†æå°†ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ' : 
                                        'â€¢ Analysis results from the same model are cached. Repeated analysis on the same day will return cached results' 
                                    ]]
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fallback Warning Banner -->
                <div v-if="analysisResult.analysis.is_fallback" class="bg-gradient-to-r from-orange-50 to-amber-50 border-l-4 border-orange-500 rounded-xl p-5 shadow-sm animate-pulse">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-orange-800 flex items-center gap-2">
                                    <span>âš¡</span>
                                    [[ currentLanguage === 'zh' ? 'æœ¬åœ°é‡åŒ–ç­–ç•¥' : 'Local Quantitative Strategy' ]]
                                </h3>
                                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                                    MA + RSI
                                </span>
                            </div>
                            <p class="text-sm text-orange-700 leading-relaxed mb-2">
                                [[ currentLanguage === 'zh' ? 
                                    'ç”±äº AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨åˆ‡æ¢è‡³æœ¬åœ°é‡åŒ–ç­–ç•¥ã€‚ç»“æœåŸºäºç»å…¸æŠ€æœ¯æŒ‡æ ‡ï¼ˆå‡çº¿äº¤å‰ + RSI åŠ¨é‡ï¼‰ï¼Œä»…ä¾›å‚è€ƒã€‚' : 
                                    'AI service is temporarily unavailable. System has automatically switched to local quantitative strategy based on classic technical indicators (MA crossover + RSI momentum) for reference only.' 
                                ]]
                            </p>
                            <div class="flex items-center gap-2 text-xs text-orange-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-semibold">[[ currentLanguage === 'zh' ? 'åŸå› ï¼š' : 'Reason: ' ]]</span>
                                <span class="italic">[[ analysisResult.analysis.fallback_reason ]]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 1. Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-blue-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'æ€»äº¤æ˜“æ¬¡æ•°' : 'Total Trades' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.totalTrades ]]</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.winRate >= 50 ? 'border-green-500' : 'border-yellow-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'èƒœç‡' : 'Win Rate' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.winRate ]]%</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.totalReturn > 0 ? 'border-green-500' : 'border-red-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'ç´¯è®¡æ”¶ç›Š (ä¼°ç®—)' : 'Total Return' ]]</div>
                        <div class="text-2xl font-bold" :class="stats.totalReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ stats.totalReturn > 0 ? '+' : '' ]][[ stats.totalReturn ]]%
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-purple-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'å½“å‰çŠ¶æ€' : 'Status' ]]</div>
                        <div class="text-xl font-bold" :class="analysisResult.analysis.is_fallback ? 'text-orange-700' : 'text-purple-700'">[[ stats.currentStatus ]]</div>
                    </div>
                </div>

                <!-- 2. Main Chart Area (Full Width) -->
                <div class="bg-white rounded-xl shadow-sm p-4 w-full">
                    <div ref="chartRef" class="chart-container" style="height: 550px; width: 100%;"></div>
                </div>

                <!-- 3. Bottom Section: Analysis & Logs (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px] lg:h-[500px]">
                    
                    <!-- AI Summary (Takes 1/3) -->
                    <div class="analysis-card p-6 flex flex-col relative group lg:col-span-1 h-full overflow-hidden" :class="analysisResult.analysis.is_fallback ? 'border-orange-200 bg-orange-50/30' : ''">
                        <div class="flex justify-between items-center mb-4 flex-none">
                            <h3 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2" :class="analysisResult.analysis.is_fallback ? 'text-orange-800' : 'text-gray-800'">
                                <span class="w-1 h-4 rounded-full" :class="analysisResult.analysis.is_fallback ? 'bg-orange-600' : 'bg-blue-600'"></span>
                                [[ analysisResult.analysis.is_fallback ? 
                                    (currentLanguage === 'zh' ? 'ç­–ç•¥è¯´æ˜' : 'Strategy Info') : 
                                    (currentLanguage === 'zh' ? 'AI åˆ†ææ‘˜è¦' : 'AI Summary') 
                                ]]
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 pr-2">
                            <p class="text-sm text-gray-700 leading-relaxed font-serif text-justify whitespace-pre-wrap">[[ analysisResult.analysis.analysis_summary ]]</p>
                        </div>
                    </div>

                    <!-- Trades Table (Takes 2/3) -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col overflow-hidden border border-gray-100 lg:col-span-2 h-full">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex-none">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">[[ currentLanguage === 'zh' ? 'äº¤æ˜“æ˜ç»†' : 'Trade Log' ]]</h3>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <div class="divide-y divide-gray-100">
                                <div v-for="(trade, index) in analysisResult.analysis.trades" :key="index" class="border-b border-gray-100 last:border-0">
                                    <!-- Row Content -->
                                    <div 
                                        @click="toggleTrade(index)"
                                        class="px-4 py-3 hover:bg-gray-50 transition-colors cursor-pointer"
                                        :class="{
                                            'bg-green-50': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                            'bg-red-50': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                            'bg-blue-50': trade.status === 'HOLDING'
                                        }"
                                    >
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4">
                                                <!-- Expand Icon -->
                                                <svg class="w-4 h-4 text-gray-400 transition-transform flex-shrink-0" :class="{'rotate-90': expandedTrades[index]}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                                
                                                <!-- Badge -->
                                                <span class="px-2 py-1 rounded-md font-bold text-xs whitespace-nowrap" :class="{
                                                    'bg-green-100 text-green-700': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                                    'bg-red-100 text-red-700': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                                    'bg-blue-100 text-blue-700': trade.status === 'HOLDING'
                                                }">
                                                    [[ trade.status === 'HOLDING' ? (currentLanguage === 'zh' ? 'æŒä»“' : 'HOLD') : (trade.return_rate.includes('+') ? (currentLanguage === 'zh' ? 'æ­¢ç›ˆ' : 'WIN') : (currentLanguage === 'zh' ? 'æ­¢æŸ' : 'LOSS')) ]]
                                                </span>
                                                
                                                <!-- Date info -->
                                                <div class="text-xs text-gray-600 flex flex-col sm:flex-row sm:gap-2">
                                                    <span><span class="font-bold">Buy:</span> [[ trade.buy_date ]] @ [[ trade.buy_price ]]</span>
                                                    <span v-if="trade.sell_date" class="hidden sm:inline text-gray-300">|</span>
                                                    <span v-if="trade.sell_date"><span class="font-bold">Sell:</span> [[ trade.sell_date ]] @ [[ trade.sell_price ]]</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Return -->
                                            <div class="text-sm font-bold whitespace-nowrap" :class="{
                                                'text-green-600': trade.return_rate.includes('+'),
                                                'text-red-600': trade.return_rate.includes('-'),
                                                'text-blue-600': trade.status === 'HOLDING'
                                            }">
                                                [[ trade.return_rate ]]
                                            </div>
                                        </div>

                                        <!-- Expanded Details (Inline) -->
                                        <div v-if="expandedTrades[index]" class="mt-3 pt-3 border-t border-gray-200/50 text-xs text-gray-600">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                                <div>
                                                    <span class="font-bold text-gray-500 block mb-1">[[ currentLanguage === 'zh' ? 'æŒä»“æ—¶é—´' : 'Duration' ]]</span>
                                                    [[ trade.holding_period ]]
                                                </div>
                                                <div>
                                                    <div class="font-bold text-gray-500 mb-1">
                                                        <span>[[ currentLanguage === 'zh' ? 'ç­–ç•¥é€»è¾‘' : 'Reasoning' ]]</span>
                                                    </div>
                                                    <p class="leading-relaxed text-gray-700">[[ trade.reason ]]</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loadingAnalysis && !analysisResult" class="flex-1 flex flex-col items-center justify-center animate-fade-in py-12">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 max-w-3xl w-full text-center">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">[[ currentLanguage === 'zh' ? 'å¼€å¯ AI é‡åŒ–ä¹‹æ—…' : 'Start AI Quant Journey' ]]</h2>
                    <p class="text-gray-500 mb-10 max-w-lg mx-auto leading-relaxed">
                        [[ currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œè®© AI æ·±åº¦è§£æå†å²æ•°æ®ï¼Œç»“åˆæŠ€æœ¯æŒ‡æ ‡ä¸å¸‚åœºæƒ…ç»ªï¼Œä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„ä¹°å–ç‚¹å»ºè®®ã€‚' : 'Enter a stock symbol to let AI analyze historical data, technical indicators, and market sentiment for professional trading signals.' ]]
                    </p>
                    
                    <div class="text-left">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider text-center">[[ currentLanguage === 'zh' ? 'ğŸ”¥ çƒ­é—¨æ ‡çš„å¿«é€Ÿåˆ†æ' : 'ğŸ”¥ Popular Stocks' ]]</p>
                        
                        <!-- Loading State -->
                        <div v-if="loadingHotStocks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="i in 8" :key="i" class="p-4 border border-gray-200 rounded-xl bg-gray-50 animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-20 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-16 mb-3"></div>
                                <div class="h-6 bg-gray-300 rounded w-24 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-12"></div>
                            </div>
                        </div>
                        
                        <!-- Stocks Grid -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button 
                                v-for="stock in hotStocks" 
                                :key="stock.symbol"
                                @click="selectStock(stock.symbol); analyzeStock(stock.symbol)"
                                class="stock-card relative p-4 border border-gray-200 rounded-xl hover:border-blue-400 hover:shadow-lg transition-all group text-left bg-gradient-to-br from-white to-gray-50 overflow-hidden"
                            >
                                <!-- Trend Background -->
                                <div class="absolute inset-0 opacity-5 pointer-events-none">
                                    <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                        <polyline
                                            :points="stock.trendData"
                                            fill="none"
                                            :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                            stroke-width="2"
                                        />
                                    </svg>
                                </div>
                                
                                <!-- Content -->
                                <div class="relative z-10">
                                    <!-- Header -->
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-gray-900 group-hover:text-blue-700 text-sm">[[ stock.symbol ]]</div>
                                            <div class="text-xs text-gray-500 mt-0.5">[[ stock.name ]]</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-semibold" :class="stock.change >= 0 ? 'text-green-600' : 'text-red-600'">
                                                [[ stock.change >= 0 ? '+' : '' ]][[ stock.change ]]%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price & Mini Chart -->
                                    <div class="flex items-end justify-between mt-3">
                                        <div>
                                            <div class="text-lg font-bold text-gray-900">[[ stock.price ]]</div>
                                            <div class="text-xs text-gray-400">[[ stock.market ]]</div>
                                        </div>
                                        
                                        <!-- Mini Trend Line -->
                                        <div class="w-16 h-8">
                                            <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                                <polyline
                                                    :points="stock.trendData"
                                                    fill="none"
                                                    :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                                    stroke-width="3"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Volume -->
                                    <div class="mt-2 pt-2 border-t border-gray-100">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æˆäº¤é‡' : 'Volume' ]]</span>
                                            <span class="text-gray-600 font-medium">[[ stock.volume ]]</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hover Effect Indicator -->
                                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-indigo-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Recommendation Tab Content -->
        <div v-if="currentTab === 'recommend' && !loadingRecommend" class="flex-1 grid grid-cols-1 gap-6 animate-fade-in max-w-5xl mx-auto w-full">
            <!-- Recommendations (Full Width) -->
            <div class="space-y-6">
                
                <!-- Filters & Generate Button -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="text-blue-500 text-xl">â˜…</span> [[ currentLanguage === 'zh' ? 'å¸‚åœºæœºä¼šæŒ–æ˜' : 'Market Scanner' ]]
                        </h3>
                        <button 
                            @click="getRecommendations" 
                            :disabled="loadingRecommend"
                            class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full hover:shadow-lg transition-all font-bold text-sm btn-pulse flex items-center gap-2 disabled:opacity-70 disabled:cursor-wait"
                        >
                            <svg v-if="!loadingRecommend" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <svg v-else class="animate-spin w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            [[ loadingRecommend ? (currentLanguage === 'zh' ? 'æ‰«æä¸­...' : 'Scanning...') : (currentLanguage === 'zh' ? 'AI æ™ºèƒ½æ‰«æ' : 'AI Smart Scan') ]]
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'å¸‚åœºé€‰æ‹©' : 'Market' ]]</label>
                            <select v-model="recCriteria.market" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="US">[[ currentLanguage === 'zh' ? 'ç¾è‚¡ (US)' : 'US Stocks' ]]</option>
                                <option value="HK">[[ currentLanguage === 'zh' ? 'æ¸¯è‚¡ (HK)' : 'HK Stocks' ]]</option>
                                <option value="A">[[ currentLanguage === 'zh' ? 'Aè‚¡ (A)' : 'A-Shares' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'èµ„é‡‘è§„æ¨¡' : 'Capital' ]]</label>
                            <select v-model="recCriteria.capital" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Small (<10w)">[[ currentLanguage === 'zh' ? 'å°èµ„é‡‘ (<10w)' : 'Small (<10k)' ]]</option>
                                <option value="Medium (10w-50w)">[[ currentLanguage === 'zh' ? 'ä¸­ç­‰èµ„é‡‘ (10w-50w)' : 'Medium (10k-50k)' ]]</option>
                                <option value="Large (>50w)">[[ currentLanguage === 'zh' ? 'å¤§èµ„é‡‘ (>50w)' : 'Large (>50k)' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'é£é™©åå¥½' : 'Risk' ]]</label>
                            <select v-model="recCriteria.risk" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Conservative">[[ currentLanguage === 'zh' ? 'ç¨³å¥å‹ (ä½é£é™©)' : 'Conservative' ]]</option>
                                <option value="Balanced">[[ currentLanguage === 'zh' ? 'å¹³è¡¡å‹ (ä¸­é£é™©)' : 'Balanced' ]]</option>
                                <option value="Aggressive">[[ currentLanguage === 'zh' ? 'è¿›å–å‹ (é«˜é£é™©)' : 'Aggressive' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'äº¤æ˜“é¢‘ç‡' : 'Frequency' ]]</label>
                            <select v-model="recCriteria.frequency" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Short-term">[[ currentLanguage === 'zh' ? 'çŸ­çº¿ (æ—¥å†…/å‘¨)' : 'Short-term' ]]</option>
                                <option value="Swing">[[ currentLanguage === 'zh' ? 'æ³¢æ®µ (å‘¨/æœˆ)' : 'Swing' ]]</option>
                                <option value="Long-term">[[ currentLanguage === 'zh' ? 'é•¿çº¿ (å­£åº¦+)' : 'Long-term' ]]</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Market Overview -->
                <div v-if="recommendationResult && recommendationResult.market_overview" class="bg-blue-50 border border-blue-100 p-5 rounded-xl text-gray-800 text-sm leading-relaxed shadow-sm relative">
                     <div class="mb-2">
                        <div class="font-bold text-blue-600 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Market Overview' ]]
                        </div>
                    </div>
                    <p class="font-serif text-gray-700 leading-relaxed">[[ recommendationResult.market_overview ]]</p>
                </div>

                <!-- Recommendations List -->
                <div v-if="recommendationResult && recommendationResult.recommendations" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="(rec, idx) in recommendationResult.recommendations" :key="idx" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h4 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors">[[ rec.symbol ]]</h4>
                                    <span class="text-sm text-gray-500">[[ rec.name ]]</span>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-bold">[[ rec.level ]]</span>
                                </div>
                                <div class="text-2xl font-bold text-gray-800 mt-1">[[ rec.price ]]</div>
                            </div>
                            <button @click="selectStock(rec.symbol); currentTab='analysis'; analyzeStock(rec.symbol)" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline opacity-0 group-hover:opacity-100 transition-opacity">
                                [[ currentLanguage === 'zh' ? 'æŸ¥çœ‹Kçº¿åˆ†æ' : 'Analyze' ]] â†’
                            </button>
                        </div>
                        <div class="text-gray-600 text-sm leading-relaxed bg-gray-50 p-3 rounded-lg">
                            [[ rec.reason ]]
                        </div>
                    </div>
                </div>
                
                <!-- Market News Section (shown when no recommendations) -->
                <div v-if="!recommendationResult" class="space-y-6">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">[[ currentLanguage === 'zh' ? 'ğŸ“ˆ å®æ—¶å¸‚åœºåŠ¨æ€' : 'ğŸ“ˆ Live Market Insights' ]]</h3>
                        <p class="text-sm text-gray-500">[[ currentLanguage === 'zh' ? 'æœ€æ–°èµ„è®¯ã€è´¢æŠ¥å‘å¸ƒã€æœºæ„è¯„çº§å˜åŠ¨' : 'Latest news, earnings, and analyst ratings' ]]</p>
                    </div>
                    
                    <!-- Loading State -->
                    <div v-if="loadingMarketNews" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="i in 6" :key="i" class="bg-white p-5 rounded-xl border border-gray-100 animate-pulse">
                            <div class="flex gap-3">
                                <div class="w-16 h-16 bg-gray-200 rounded-lg"></div>
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/2 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- News Grid -->
                    <div v-else-if="marketNews.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a 
                            v-for="news in marketNews" 
                            :key="news.id"
                            :href="news.link"
                            target="_blank"
                            class="bg-white p-5 rounded-xl border border-gray-100 hover:border-blue-300 hover:shadow-lg transition-all group cursor-pointer"
                        >
                            <div class="flex gap-4">
                                <!-- Icon or Thumbnail -->
                                <div class="flex-shrink-0">
                                    <div v-if="news.thumbnail" class="w-20 h-20 rounded-lg overflow-hidden bg-gray-100">
                                        <img :src="news.thumbnail" :alt="news.title" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                    </div>
                                    <div v-else class="w-20 h-20 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center text-3xl">
                                        [[ news.icon ]]
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <!-- Type Badge -->
                                    <div class="flex items-center gap-2 mb-2">
                                        <span 
                                            class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                            :class="{
                                                'bg-purple-100 text-purple-700': news.type === 'earnings',
                                                'bg-yellow-100 text-yellow-700': news.type === 'rating',
                                                'bg-blue-100 text-blue-700': news.type === 'deal',
                                                'bg-green-100 text-green-700': news.type === 'dividend' || news.type === 'bullish',
                                                'bg-red-100 text-red-700': news.type === 'bearish',
                                                'bg-gray-100 text-gray-700': news.type === 'news'
                                            }"
                                        >
                                            [[ news.icon ]] 
                                            <span v-if="news.type === 'earnings'">[[ currentLanguage === 'zh' ? 'è´¢æŠ¥' : 'Earnings' ]]</span>
                                            <span v-else-if="news.type === 'rating'">[[ currentLanguage === 'zh' ? 'è¯„çº§' : 'Rating' ]]</span>
                                            <span v-else-if="news.type === 'deal'">[[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Deal' ]]</span>
                                            <span v-else-if="news.type === 'dividend'">[[ currentLanguage === 'zh' ? 'åˆ†çº¢' : 'Dividend' ]]</span>
                                            <span v-else-if="news.type === 'bullish'">[[ currentLanguage === 'zh' ? 'åˆ©å¥½' : 'Bullish' ]]</span>
                                            <span v-else-if="news.type === 'bearish'">[[ currentLanguage === 'zh' ? 'åˆ©ç©º' : 'Bearish' ]]</span>
                                            <span v-else>[[ currentLanguage === 'zh' ? 'èµ„è®¯' : 'News' ]]</span>
                                        </span>
                                        <span class="text-xs text-gray-400">[[ news.time_ago ]]</span>
                                    </div>
                                    
                                    <!-- Title -->
                                    <h4 class="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors line-clamp-2 leading-snug mb-2">
                                        [[ news.title ]]
                                    </h4>
                                    
                                    <!-- Footer -->
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <span>[[ news.publisher ]]</span>
                                        <span v-if="news.related_symbols.length > 0" class="font-mono font-semibold">[[ news.related_symbols[0] ]]</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Empty State -->
                    <div v-else class="text-center py-12">
                        <div class="text-gray-300 text-6xl mb-4">ğŸ“°</div>
                        <p class="text-gray-400">[[ currentLanguage === 'zh' ? 'æš‚æ— å¸‚åœºèµ„è®¯' : 'No market news available' ]]</p>
                    </div>
                    
                    <!-- Call to Action -->
                    <div class="text-center mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                        <p class="text-gray-600 mb-4">
                            [[ currentLanguage === 'zh' ? 'ğŸ‘† ç‚¹å‡»ä¸Šæ–¹ã€ŒAI æ™ºèƒ½æ‰«æã€è·å–ä¸ªæ€§åŒ–é€‰è‚¡æ¨è' : 'ğŸ‘† Click "AI Smart Scan" above for personalized recommendations' ]]
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Diagnosis Tab Content -->
        <div v-if="currentTab === 'portfolio' && !loadingPortfolio" class="flex-1 flex flex-col items-center animate-fade-in">
             <div class="max-w-2xl w-full space-y-6">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3 justify-center">
                        <span class="text-purple-500 text-3xl">ğŸ’Š</span> [[ currentLanguage === 'zh' ? 'æŒä»“è¯Šæ–­ä¸“å®¶' : 'Portfolio Doctor' ]]
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'æŒæœ‰ä»£ç ' : 'Symbol' ]]</label>
                            <input v-model="portfolio.symbol" type="text" placeholder="ä¾‹å¦‚ AAPL" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-base uppercase focus:ring-2 focus:ring-purple-500 outline-none font-bold text-center">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'ä¹°å…¥å‡ä»·' : 'Avg Price' ]]</label>
                            <input v-model="portfolio.avg_price" type="text" placeholder="0.00" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-base focus:ring-2 focus:ring-purple-500 outline-none text-center">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'ä»“ä½å æ¯” (%)' : 'Weight (%)' ]]</label>
                            <input v-model="portfolio.percentage" type="number" placeholder="20" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-base focus:ring-2 focus:ring-purple-500 outline-none text-center">
                        </div>
                    </div>

                    <button @click="diagnosePortfolio" :disabled="!portfolio.symbol" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition-all disabled:opacity-50 font-bold text-lg shadow-md flex justify-center items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        [[ currentLanguage === 'zh' ? 'å¼€å§‹è¯Šæ–­' : 'Start Diagnosis' ]]
                    </button>
                </div>

                <!-- Diagnosis Result -->
                <div v-if="portfolioResult" class="bg-white rounded-xl p-8 shadow-lg border border-purple-100 animate-fade-in relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-500 to-pink-500"></div>
                    
                    <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <div class="text-sm text-gray-400 uppercase font-bold mb-1">[[ currentLanguage === 'zh' ? 'è¯Šæ–­å¯¹è±¡' : 'Target' ]]</div>
                            <div class="text-3xl font-extrabold text-gray-800">[[ portfolioResult.symbol ]]</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400 uppercase font-bold mb-1">[[ currentLanguage === 'zh' ? 'è¯„çº§' : 'Rating' ]]</div>
                            <span class="px-4 py-2 rounded-lg text-xl font-bold shadow-sm inline-block"
                                :class="{
                                    'bg-green-100 text-green-700': portfolioResult.rating && portfolioResult.rating.includes('Buy'),
                                    'bg-red-100 text-red-700': portfolioResult.rating && portfolioResult.rating.includes('Sell'),
                                    'bg-gray-100 text-gray-700': portfolioResult.rating && portfolioResult.rating.includes('Hold')
                                }">
                                [[ portfolioResult.rating ]]
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-6 bg-purple-50 p-4 rounded-lg border border-purple-100">
                        <div class="text-sm text-purple-800 font-bold mb-1 flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                             [[ currentLanguage === 'zh' ? 'å»ºè®®æ“ä½œ' : 'Action' ]]
                        </div>
                        <div class="font-bold text-gray-900 text-lg">[[ portfolioResult.action ]]</div>
                    </div>
                    
                    <div>
                        <div class="mb-2">
                            <span class="text-sm text-gray-500 font-bold uppercase">[[ currentLanguage === 'zh' ? 'æ·±åº¦åˆ†æ' : 'Analysis' ]]</span>
                        </div>
                        <p class="text-gray-700 leading-relaxed font-serif text-justify">
                            [[ portfolioResult.analysis ]]
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, watch, onMounted } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // è¿ç§»æ—§çš„ localStorage key åˆ°æ–°çš„ key
                if (localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences')) {
                    try {
                        const oldState = JSON.parse(localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences') || '{}');
                        localStorage.setItem('investPilotPreferences', JSON.stringify({
                            currentTab: oldState.currentTab,
                            currentLanguage: oldState.currentLanguage,
                            selectedModel: oldState.selectedModel
                        }));
                        localStorage.removeItem('quantAgentState'); // åˆ é™¤æ—§ key
                        localStorage.removeItem('quantAgentPreferences'); // åˆ é™¤æ—§ key
                    } catch (e) {
                        console.warn('Failed to migrate old state:', e);
                    }
                }
                
                // State Initialization with Persistence Check
                const getSavedPreferences = () => {
                    try {
                        return JSON.parse(localStorage.getItem('investPilotPreferences') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const getSessionData = () => {
                    try {
                        return JSON.parse(sessionStorage.getItem('investPilotSession') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const savedPreferences = getSavedPreferences();
                const sessionData = getSessionData();

                const currentTab = ref(savedPreferences.currentTab || 'analysis');
                const currentLanguage = ref(savedPreferences.currentLanguage || 'en');
                
                // Loading States (Independent)
                const loadingAnalysis = ref(false);
                const loadingRecommend = ref(false);
                const loadingPortfolio = ref(false);
                
                // ä» sessionStorage æ¢å¤ä¼šè¯æ•°æ®ï¼ˆåˆ·æ–°é¡µé¢æ—¶ä¿ç•™ï¼‰
                const recCriteria = ref(sessionData.recCriteria || { market: 'Any', capital: 'Any', risk: 'Any', frequency: 'Any' });
                const recommendationResult = ref(sessionData.recommendationResult || null);
                const portfolio = ref(sessionData.portfolio || { symbol: '', avg_price: '', percentage: '' });
                const portfolioResult = ref(sessionData.portfolioResult || null);
                
                const query = ref(sessionData.query || '');
                const suggestions = ref([]);
                const analysisResult = ref(sessionData.analysisResult || null);
                const chartRef = ref(null);
                let chartInstance = null;
                
                // Model Management
                const models = ref([]);
                const selectedModel = ref(savedPreferences.selectedModel || 'gemini-2.5-flash');
                
                // Hot Stocks Management
                const hotStocks = ref([]);
                const loadingHotStocks = ref(false);
                
                // Market News Management
                const marketNews = ref([]);
                const loadingMarketNews = ref(false);
                
                // Load models from API
                const loadModels = async () => {
                    try {
                        const res = await fetch('/api/models');
                        const modelList = await res.json();
                        
                        // Group models by provider
                        const grouped = {};
                        modelList.forEach(m => {
                            if (!grouped[m.provider]) {
                                grouped[m.provider] = [];
                            }
                            grouped[m.provider].push({
                                id: m.id,
                                name: m.name,
                                provider: m.provider,
                                supports_search: m.supports_search,
                                status: 'normal'
                            });
                        });
                        
                        // Flatten with provider labels
                        const flattened = [];
                        const providerOrder = ['gemini', 'openai', 'anthropic', 'xai', 'qwen', 'local'];
                        const providerNames = {
                            'gemini': 'Google Gemini',
                            'openai': 'OpenAI GPT',
                            'anthropic': 'Anthropic Claude',
                            'xai': 'xAI Grok',
                            'qwen': 'Alibaba Qwen',
                            'local': 'Local Strategy'
                        };
                        
                        providerOrder.forEach(provider => {
                            if (grouped[provider]) {
                                flattened.push({
                                    id: `header_${provider}`,
                                    name: `â”â”â” ${providerNames[provider]} â”â”â”`,
                                    isHeader: true,
                                    disabled: true
                                });
                                flattened.push(...grouped[provider]);
                            }
                        });
                        
                        models.value = flattened;
                        
                        // Validate saved model
                        const validIds = modelList.map(m => m.id);
                        if (!validIds.includes(selectedModel.value)) {
                            console.warn(`Invalid saved model: ${selectedModel.value}, resetting to default`);
                            selectedModel.value = 'gemini-2.5-flash';
                        }
                    } catch (err) {
                        console.error('Failed to load models:', err);
                        // Fallback to default models
                        models.value = [
                            { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', status: 'normal' },
                            { id: 'local-strategy', name: 'Local Algo (MA+RSI)', status: 'normal' }
                        ];
                    }
                };
                
                // Load trending stocks from API
                const loadTrendingStocks = async () => {
                    loadingHotStocks.value = true;
                    try {
                        const res = await fetch('/api/trending');
                        const trendingList = await res.json();
                        hotStocks.value = trendingList;
                    } catch (err) {
                        console.error('Failed to load trending stocks:', err);
                        // Fallback to default stocks
                        hotStocks.value = [
                            { symbol: 'NVDA', name: 'NVIDIA', price: '$850', change: 2.5, volume: '50M', market: 'NASDAQ', trendData: '10,35 30,28 50,32 70,25 90,30' },
                            { symbol: 'TSLA', name: 'Tesla', price: '$245', change: -1.2, volume: '95M', market: 'NASDAQ', trendData: '10,15 30,18 50,22 70,25 90,20' },
                            { symbol: 'AAPL', name: 'Apple', price: '$195', change: 1.8, volume: '42M', market: 'NASDAQ', trendData: '10,28 30,25 50,30 70,27 90,32' },
                            { symbol: 'MSFT', name: 'Microsoft', price: '$420', change: 1.2, volume: '22M', market: 'NASDAQ', trendData: '10,25 30,22 50,28 70,24 90,30' },
                            { symbol: '600519.SS', name: 'è´µå·èŒ…å°', price: 'Â¥1,680', change: 0.5, volume: '1M', market: 'SSE', trendData: '10,20 30,23 50,19 70,25 90,22' },
                            { symbol: '0700.HK', name: 'è…¾è®¯æ§è‚¡', price: 'HK$380', change: -0.8, volume: '18M', market: 'HKEX', trendData: '10,30 30,28 50,32 70,29 90,34' },
                            { symbol: '300750.SZ', name: 'å®å¾·æ—¶ä»£', price: 'Â¥235', change: 3.5, volume: '8M', market: 'SZSE', trendData: '10,35 30,32 50,37 70,34 90,38' },
                            { symbol: '9988.HK', name: 'é˜¿é‡Œå·´å·´', price: 'HK$90', change: 1.5, volume: '40M', market: 'HKEX', trendData: '10,22 30,25 50,20 70,27 90,24' }
                        ];
                    } finally {
                        loadingHotStocks.value = false;
                    }
                };
                
                // Load market news from API
                const loadMarketNews = async () => {
                    loadingMarketNews.value = true;
                    try {
                        const res = await fetch('/api/market_news');
                        const newsList = await res.json();
                        marketNews.value = newsList;
                    } catch (err) {
                        console.error('Failed to load market news:', err);
                        marketNews.value = [];
                    } finally {
                        loadingMarketNews.value = false;
                    }
                };
                
                // Trade Expansion State
                const expandedTrades = ref({});

                // --- Computed Properties ---

                const currentModelStatus = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.status : 'normal';
                });

                const selectedModelName = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.name : '';
                });

                // Filter models based on tab
                const availableModels = computed(() => {
                    let filtered = models.value;
                    
                    if (currentTab.value === 'recommend') {
                        // Disable local strategy for recommendation tab
                        filtered = filtered.map(m => {
                            if (m.id === 'local-strategy') {
                                return { ...m, disabled: true };
                            }
                            return m;
                        });
                    }
                    
                    return filtered;
                });

                // Computed Stats
                const stats = computed(() => {
                    if (!analysisResult.value) return {};
                    const trades = analysisResult.value.analysis.trades || [];
                    const totalTrades = trades.length;
                    
                    let winCount = 0;
                    let totalReturnVal = 0.0;
                    let closedCount = 0;
                    let isHolding = false;

                    trades.forEach(t => {
                        if (t.status === 'CLOSED') {
                            closedCount++;
                            const rateStr = t.return_rate.replace('%', '');
                            const rate = parseFloat(rateStr);
                            if (!isNaN(rate)) {
                                totalReturnVal += rate;
                                if (rate > 0) winCount++;
                            }
                        } else if (t.status === 'HOLDING') {
                            isHolding = true;
                        }
                    });

                    const winRate = closedCount > 0 ? Math.round((winCount / closedCount) * 100) : 0;
                    
                    return {
                        totalTrades,
                        winRate,
                        totalReturn: totalReturnVal.toFixed(1),
                        currentStatus: isHolding ? (currentLanguage.value === 'zh' ? 'æŒä»“ä¸­' : 'HOLDING') : (currentLanguage.value === 'zh' ? 'ç©ºä»“' : 'EMPTY')
                    };
                });

                // --- Persistence & Watchers ---

                // ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®åˆ° localStorageï¼ˆæ°¸ä¹…ä¿å­˜ï¼‰
                watch(
                    [currentTab, currentLanguage, selectedModel],
                    () => {
                        const preferences = {
                            currentTab: currentTab.value,
                            currentLanguage: currentLanguage.value,
                            selectedModel: selectedModel.value
                        };
                        localStorage.setItem('investPilotPreferences', JSON.stringify(preferences));
                    },
                    { deep: true }
                );
                
                // ä¿å­˜ä¼šè¯æ•°æ®åˆ° sessionStorageï¼ˆåˆ·æ–°ä¿ç•™ï¼Œå…³é—­æ ‡ç­¾é¡µæ¸…é™¤ï¼‰
                watch(
                    [recCriteria, recommendationResult, portfolio, portfolioResult, query, analysisResult],
                    () => {
                        const sessionData = {
                            recCriteria: recCriteria.value,
                            recommendationResult: recommendationResult.value,
                            portfolio: portfolio.value,
                            portfolioResult: portfolioResult.value,
                            query: query.value,
                            analysisResult: analysisResult.value
                        };
                        sessionStorage.setItem('investPilotSession', JSON.stringify(sessionData));
                    },
                    { deep: true }
                );

                // Auto-switch model if invalid for current tab
                watch(currentTab, (newTab) => {
                    if (newTab === 'recommend' && selectedModel.value === 'local-strategy') {
                        selectedModel.value = 'models/gemini-2.5-flash';
                    }
                });

                // ç›‘å¬ tab åˆ‡æ¢ï¼Œæ¢å¤ k çº¿å›¾
                watch(currentTab, (newTab, oldTab) => {
                    if (newTab === 'analysis' && analysisResult.value) {
                        // åˆ‡æ¢å›åˆ†æé¡µæ—¶ï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œé‡æ–°åˆå§‹åŒ–å›¾è¡¨
                        nextTick(() => {
                            if (chartRef.value) {
                                initChart(analysisResult.value);
                                // ç¡®ä¿å›¾è¡¨å°ºå¯¸æ­£ç¡®
                                if (chartInstance) {
                                    setTimeout(() => {
                                        chartInstance.resize();
                                    }, 100);
                                }
                            }
                        });
                    }
                });

                // åˆ·æ–°é¡µé¢åæ¢å¤å›¾è¡¨ï¼ˆå¦‚æœæœ‰ analysisResultï¼‰
                onMounted(() => {
                    // Load available models, trending stocks, and market news
                    loadModels();
                    loadTrendingStocks();
                    loadMarketNews();
                    
                    if (analysisResult.value) {
                        nextTick(() => {
                            initChart(analysisResult.value);
                        });
                    }
                });

                // --- Functions ---

                const debounce = (fn, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                };

                const handleSearch = debounce(async (e) => {
                    const val = e.target.value;
                    if (val.length < 1) {
                        suggestions.value = [];
                        return;
                    }
                    try {
                        const res = await fetch(`/api/search?q=${val}`);
                        suggestions.value = await res.json();
                    } catch (err) {
                        console.error(err);
                    }
                }, 300);

                const selectStock = (symbol) => {
                    query.value = symbol;
                    suggestions.value = [];
                };

                const toggleTrade = (index) => {
                    expandedTrades.value[index] = !expandedTrades.value[index];
                };

                const analyzeStock = async (symbol) => {
                    if (!symbol) return;
                    suggestions.value = []; // Clear suggestions
                    loadingAnalysis.value = true;
                    // Note: We DON'T clear analysisResult immediately to prevent flicker if just refreshing logic, 
                    // but usually we want to show new loading state.
                    // For better UX, we can clear it or keep it stale. Let's clear for clarity of new request.
                    analysisResult.value = null; 
                    expandedTrades.value = {}; // Reset expansion state
                    
                    try {
                        const res = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                symbol,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        if (!res.ok) throw new Error('Analysis failed');
                        
                        const data = await res.json();
                        analysisResult.value = data;
                        
                        if (data.analysis.analysis_summary && data.analysis.analysis_summary.includes('Quota Exceeded')) {
                            const m = models.value.find(m => m.id === selectedModel.value);
                            if (m) m.status = 'limit';
                        }

                    } catch (err) {
                        alert('åˆ†æå¤±è´¥ (Analysis Failed): ' + err);
                        console.error(err);
                    } finally {
                        loadingAnalysis.value = false;
                        if (analysisResult.value) {
                            nextTick(() => {
                                initChart(analysisResult.value);
                            });
                        }
                    }
                };

                const initChart = (data) => {
                    if (!chartRef.value) return;
                    if (chartInstance) {
                        chartInstance.dispose();
                    }
                    chartInstance = echarts.init(chartRef.value);

                    const klineData = data.kline_data.map(item => [
                        item.open, item.close, item.low, item.high
                    ]);
                    const dates = data.kline_data.map(item => item.date);
                    const volumes = data.kline_data.map((item, index) => [index, item.volume, item.open > item.close ? 1 : -1]);

                    const trades = data.analysis.trades || [];
                    const signals = data.analysis.signals || [];
                    const markPoints = signals.map(sig => {
                        let tradeInfo = null;
                        if (sig.type === 'BUY') {
                            tradeInfo = trades.find(t => t.buy_date === sig.date);
                        } else if (sig.type === 'SELL') {
                            tradeInfo = trades.find(t => t.sell_date === sig.date);
                        }
                        return {
                            name: sig.type,
                            coord: [sig.date, sig.price],
                            value: sig.type === 'BUY' ? (currentLanguage.value === 'zh' ? 'ä¹°' : 'B') : (currentLanguage.value === 'zh' ? 'å–' : 'S'),
                            itemStyle: {
                                color: sig.type === 'BUY' ? '#10B981' : '#EF4444'
                            },
                            tradeDetails: tradeInfo
                        };
                    });

                    const option = {
                        title: { text: `${data.symbol} ${currentLanguage.value === 'zh' ? 'Kçº¿è¶‹åŠ¿åˆ†æ' : 'Trend'}`, left: 'center' },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(item => {
                                    if (item.componentSubType === 'candlestick') {
                                        const values = item.value;
                                        result += `å¼€ç›˜: ${values[1]}<br/>`;
                                        result += `æ”¶ç›˜: ${values[2]}<br/>`;
                                        result += `æœ€ä½: ${values[3]}<br/>`;
                                        result += `æœ€é«˜: ${values[4]}<br/>`;
                                    } else if (item.seriesName === 'Volume') {
                                        result += `æˆäº¤é‡: ${item.value}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        grid: [
                            { left: '8%', right: '5%', top: '12%', height: '58%' },
                            { left: '8%', right: '5%', top: '75%', height: '15%' }
                        ],
                        xAxis: [
                            { 
                                type: 'category', 
                                data: dates, 
                                scale: true, 
                                boundaryGap: true,
                                axisLine: { onZero: false }, 
                                splitLine: { show: false }, 
                                min: 'dataMin', 
                                max: 'dataMax'
                            },
                            { 
                                type: 'category', 
                                gridIndex: 1, 
                                data: dates, 
                                axisLabel: { show: false } 
                            }
                        ],
                        yAxis: [
                            { 
                                scale: true, 
                                splitArea: { show: true },
                                splitNumber: 5,
                                axisLabel: {
                                    formatter: '{value}'
                                }
                            },
                            { 
                                scale: true, 
                                gridIndex: 1, 
                                splitNumber: 2, 
                                axisLabel: { show: false }, 
                                axisLine: { show: false }, 
                                axisTick: { show: false }, 
                                splitLine: { show: false } 
                            }
                        ],
                        dataZoom: [
                            { 
                                type: 'inside', 
                                xAxisIndex: [0, 1], 
                                start: 50, 
                                end: 100,
                                zoomOnMouseWheel: false, // Prevent page scroll hijack
                                moveOnMouseWheel: false,
                                moveOnMouseMove: true
                            },
                            { show: true, xAxisIndex: [0, 1], type: 'slider', top: '92%', height: 20, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'K-Line',
                                type: 'candlestick',
                                data: klineData,
                                itemStyle: {
                                    color: '#EF4444',
                                    color0: '#10B981',
                                    borderColor: '#EF4444',
                                    borderColor0: '#10B981'
                                },
                                markPoint: {
                                    data: markPoints,
                                    symbol: 'pin',
                                    symbolSize: 40,
                                    label: { fontSize: 10 },
                                    tooltip: {
                                        trigger: 'item',
                                        formatter: function(params) {
                                            const data = params.data;
                                            const type = data.name; 
                                            const details = data.tradeDetails;
                                            const isZh = currentLanguage.value === 'zh';
                                            
                                            let html = `<div style="font-family: sans-serif; padding: 4px;">`;
                                            html += `<div style="font-weight: bold; margin-bottom: 4px; color: ${type === 'BUY' ? '#10B981' : '#EF4444'}">${params.value} (${type})</div>`;
                                            
                                            if (details) {
                                                if (type === 'BUY') {
                                                    html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${details.buy_date}</div>`;
                                                    html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: <b>${details.buy_price}</b></div>`;
                                                } else {
                                                    html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${details.sell_date}</div>`;
                                                    html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: <b>${details.sell_price}</b></div>`;
                                                    html += `<div style="margin-top: 4px;">${isZh ? 'æ”¶ç›Š' : 'Return'}: <span style="font-weight: bold; color: ${details.return_rate.includes('+') ? '#10B981' : '#EF4444'}">${details.return_rate}</span></div>`;
                                                }
                                                if (details.reason) {
                                                     const reason = details.reason.length > 60 ? details.reason.substring(0, 60) + '...' : details.reason;
                                                     html += `<div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #555; padding-top: 4px; max-width: 200px; white-space: normal;">${reason}</div>`;
                                                }
                                            } else {
                                                html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${data.coord[0]}</div>`;
                                                html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: ${data.coord[1]}</div>`;
                                            }
                                            html += `</div>`;
                                            return html;
                                        }
                                    }
                                }
                            },
                            {
                                name: 'Volume',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: volumes.map(item => item[1]),
                                itemStyle: {
                                    color: (params) => {
                                        return klineData[params.dataIndex][0] < klineData[params.dataIndex][1] ? '#EF4444' : '#10B981';
                                    }
                                }
                            }
                        ]
                    };

                    chartInstance.setOption(option);
                    window.addEventListener('resize', () => chartInstance.resize());
                };

                const getRecommendations = async () => {
                    loadingRecommend.value = true;
                    recommendationResult.value = null;
                    try {
                         const res = await fetch('/api/recommend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...recCriteria.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        recommendationResult.value = await res.json();
                    } catch (err) {
                        alert('æ¨èè¯·æ±‚å¤±è´¥: ' + err);
                        console.error(err);
                    } finally {
                        loadingRecommend.value = false;
                    }
                };

                const diagnosePortfolio = async () => {
                    if(!portfolio.value.symbol) return;
                    loadingPortfolio.value = true; 
                    portfolioResult.value = null;
                    try {
                         const res = await fetch('/api/portfolio_advice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...portfolio.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        portfolioResult.value = await res.json();
                    } catch (err) {
                        alert('è¯Šæ–­è¯·æ±‚å¤±è´¥: ' + err);
                        console.error(err);
                    } finally {
                        loadingPortfolio.value = false;
                    }
                };

                return {
                    currentTab,
                    currentLanguage,
                    recCriteria,
                    recommendationResult,
                    portfolio,
                    portfolioResult,
                    getRecommendations,
                    diagnosePortfolio,
                    query,
                    suggestions,
                    loadingAnalysis,
                    loadingRecommend,
                    loadingPortfolio,
                    analysisResult,
                    chartRef,
                    handleSearch,
                    selectStock,
                    analyzeStock,
                    stats,
                    models,
                    availableModels,
                    selectedModel,
                    selectedModelName,
                    currentModelStatus,
                    expandedTrades,
                    toggleTrade,
                    hotStocks,
                    loadingHotStocks,
                    marketNews,
                    loadingMarketNews
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

