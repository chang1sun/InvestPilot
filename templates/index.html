<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quant Agent - æ™ºèƒ½é‡åŒ–åˆ†æ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
        .chart-container { height: 400px; width: 100%; } /* Reduced height for compact layout */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Text Content Styling */
        .prose-sm { font-size: 0.875rem; line-height: 1.6; }
        .analysis-card { background: #ffffff; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .analysis-header { border-left: 4px solid #3b82f6; padding-left: 1rem; margin-bottom: 0.75rem; }
        .market-card { background: linear-gradient(to bottom right, #eff6ff, #ffffff); border: 1px solid #bfdbfe; }
        
        /* Button Animation */
        .btn-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="container mx-auto px-4 py-4 flex-1 flex flex-col">
        <!-- Header & Search Row -->
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">AI Quant Agent</h1>
                
                <!-- Model Selector -->
                <div class="relative">
                    <select 
                        v-model="selectedModel" 
                        class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pr-8 cursor-pointer font-medium"
                    >
                        <option v-for="m in models" :key="m.id" :value="m.id" :disabled="m.disabled">
                            [[ m.name ]] [[ m.status === 'limit' ? '(å·²é™é¢)' : '' ]]
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                    <div v-if="currentModelStatus === 'limit'" 
                         class="absolute -top-2 -right-2 bg-yellow-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold cursor-help shadow-sm z-10"
                         title="è¯¥æ¨¡å‹è§¦å‘äº† API é…é¢é™åˆ¶ (429)ï¼Œå½“å‰å¯èƒ½ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æˆ–æ— æ³•å·¥ä½œã€‚"
                    >!</div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Language Selector -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button @click="currentLanguage = 'zh'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'zh' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">ä¸­æ–‡</button>
                    <button @click="currentLanguage = 'en'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">EN</button>
                </div>

                <!-- Search Box -->
                <div class="relative w-80">
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input 
                                type="text" 
                                v-model="query" 
                                @input="handleSearch"
                                @keyup.enter="analyzeStock(query)"
                                :placeholder="currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚ AAPL, 0700.HK)' : 'Enter Symbol (e.g., AAPL)'"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            >
                            <div v-if="suggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-md shadow-lg border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in suggestions" 
                                    @click="selectStock(item.symbol)"
                                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between text-sm"
                                >
                                    <span class="font-medium">[[ item.symbol ]]</span>
                                    <span class="text-gray-500">[[ item.name ]]</span>
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="analyzeStock(query)" 
                            :disabled="loading || !query"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap shadow-md transition-all active:scale-95"
                        >
                            [[ loading ? (currentLanguage === 'zh' ? 'åˆ†æä¸­...' : 'Analyzing...') : (currentLanguage === 'zh' ? 'å¼€å§‹' : 'Start') ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex gap-8 mb-6 border-b border-gray-200 px-2">
            <button 
                @click="currentTab = 'analysis'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'analysis' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                [[ currentLanguage === 'zh' ? 'Kçº¿è¶‹åŠ¿åˆ†æ' : 'Trend Analysis' ]]
            </button>
            <button 
                @click="currentTab = 'recommend'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'recommend' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                [[ currentLanguage === 'zh' ? 'æ™ºèƒ½é€‰è‚¡æ¨è' : 'Smart Picks' ]]
            </button>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="flex-1 flex items-center justify-center min-h-[400px]">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...' : 'AI is analyzing deep data...' ]]</p>
                <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? 'æ­£åœ¨æœç´¢å®æ—¶å¸‚åœºèµ„è®¯ & è®¡ç®—ç­–ç•¥...' : 'Searching real-time market info & calculating strategies...' ]]</p>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <template v-if="currentTab === 'analysis'">
            <!-- Result View -->
            <div v-if="!loading && analysisResult" class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0 animate-fade-in">
                
                <!-- Left Column: Chart (Takes 2/3 width) -->
                <div class="lg:col-span-2 flex flex-col gap-4">
                    <!-- Stats Bar -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'æ€»äº¤æ˜“æ¬¡æ•°' : 'Total Trades' ]]</div>
                            <div class="text-2xl font-bold text-gray-800">[[ stats.totalTrades ]]</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.winRate >= 50 ? 'border-green-500' : 'border-yellow-500'">
                            <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'èƒœç‡' : 'Win Rate' ]]</div>
                            <div class="text-2xl font-bold text-gray-800">[[ stats.winRate ]]%</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.totalReturn > 0 ? 'border-green-500' : 'border-red-500'">
                            <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'ç´¯è®¡æ”¶ç›Š (ä¼°ç®—)' : 'Total Return' ]]</div>
                            <div class="text-2xl font-bold" :class="stats.totalReturn > 0 ? 'text-green-600' : 'text-red-600'">
                                [[ stats.totalReturn > 0 ? '+' : '' ]][[ stats.totalReturn ]]%
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                            <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'å½“å‰çŠ¶æ€' : 'Status' ]]</div>
                            <div class="text-xl font-bold text-purple-700">[[ stats.currentStatus ]]</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-white rounded-xl shadow-sm p-4 flex-1 flex flex-col">
                        <div ref="chartRef" class="chart-container flex-1"></div>
                    </div>
                </div>

                <!-- Right Column: Summary & Table (Takes 1/3 width) -->
                <div class="flex flex-col gap-6 h-full overflow-hidden">
                    <!-- Summary -->
                    <div class="analysis-card p-5 overflow-y-auto max-h-60 flex flex-col relative group">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1 h-4 bg-blue-600 rounded-full"></span>
                                [[ currentLanguage === 'zh' ? 'AI åˆ†ææ‘˜è¦' : 'AI Summary' ]]
                            </h3>
                            <button 
                                @click="translateContent('analysis_summary', analysisResult.analysis.analysis_summary)" 
                                class="text-xs text-blue-500 hover:text-blue-700 font-medium border border-blue-200 rounded px-2 py-0.5 hover:bg-blue-50 transition-colors"
                            >
                                [[ translationStatus['analysis_summary'] ? 'Translating...' : (currentLanguage === 'zh' ? 'EN' : 'ä¸­æ–‡') ]]
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 leading-relaxed font-serif text-justify">
                            [[ analysisResult.analysis.analysis_summary ]]
                        </p>
                    </div>

                    <!-- Trades Table (Scrollable) -->
                    <div class="bg-white rounded-xl shadow-sm flex-1 flex flex-col overflow-hidden border border-gray-100">
                        <div class="px-5 py-3 border-b border-gray-100 bg-gray-50">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">[[ currentLanguage === 'zh' ? 'äº¤æ˜“æ˜ç»†' : 'Trade Log' ]]</h3>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <div class="divide-y divide-gray-100">
                                <div v-for="(trade, index) in analysisResult.analysis.trades" :key="index" class="border-b border-gray-100">
                                    <!-- Collapsed Row (Default) -->
                                    <div 
                                        @click="toggleTrade(index)"
                                        class="px-4 py-3 hover:bg-gray-50 transition-colors cursor-pointer flex items-center justify-between"
                                        :class="{
                                            'bg-green-50': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                            'bg-red-50': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                            'bg-blue-50': trade.status === 'HOLDING'
                                        }"
                                    >
                                        <div class="flex items-center gap-3 flex-1">
                                            <!-- Expand Icon -->
                                            <svg class="w-4 h-4 text-gray-400 transition-transform" :class="{'rotate-90': expandedTrades[index]}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                            
                                            <!-- Status Badge -->
                                            <span class="px-2 py-1 rounded-md font-bold text-xs" :class="{
                                                'bg-green-100 text-green-700': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                                'bg-red-100 text-red-700': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                                'bg-blue-100 text-blue-700': trade.status === 'HOLDING'
                                            }">
                                                [[ trade.status === 'HOLDING' ? (currentLanguage === 'zh' ? 'æŒä»“' : 'HOLD') : (trade.return_rate.includes('+') ? (currentLanguage === 'zh' ? 'æ­¢ç›ˆ' : 'WIN') : (currentLanguage === 'zh' ? 'æ­¢æŸ' : 'LOSS')) ]]
                                            </span>
                                            
                                            <!-- Date Range -->
                                            <span class="text-xs text-gray-600">
                                                [[ trade.buy_date ]] 
                                                <span v-if="trade.sell_date" class="text-gray-400">â†’ [[ trade.sell_date ]]</span>
                                            </span>
                                        </div>
                                        
                                        <!-- Return Rate -->
                                        <div class="text-sm font-bold" :class="{
                                            'text-green-600': trade.return_rate.includes('+'),
                                            'text-red-600': trade.return_rate.includes('-'),
                                            'text-blue-600': trade.status === 'HOLDING'
                                        }">
                                            [[ trade.return_rate ]]
                                        </div>
                                    </div>
                                    
                                    <!-- Expanded Details -->
                                    <div v-if="expandedTrades[index]" class="px-4 py-4 bg-gray-50 text-xs space-y-3 border-t border-gray-200">
                                        <div class="pt-2 border-t border-gray-200">
                                            <div class="text-gray-500 font-semibold mb-1 flex justify-between">
                                                <span>[[ currentLanguage === 'zh' ? 'ç­–ç•¥è§£é‡Š' : 'Reasoning' ]]</span>
                                                <button 
                                                    @click.stop="translateContent(`reason_${index}`, trade.reason, (txt) => trade.reason = txt)" 
                                                    class="text-xs text-blue-500 hover:underline"
                                                >
                                                    [[ translationStatus[`reason_${index}`] ? '...' : 'Translate' ]]
                                                </button>
                                            </div>
                                            <div class="text-gray-700 leading-relaxed">[[ trade.reason ]]</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loading && !analysisResult" class="flex-1 flex flex-col items-center justify-center animate-fade-in py-12">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 max-w-3xl w-full text-center">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">[[ currentLanguage === 'zh' ? 'å¼€å¯ AI é‡åŒ–ä¹‹æ—…' : 'Start AI Quant Journey' ]]</h2>
                    <p class="text-gray-500 mb-10 max-w-lg mx-auto leading-relaxed">
                        [[ currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œè®© Gemini Pro æ·±åº¦è§£æå†å²æ•°æ®ï¼Œç»“åˆæŠ€æœ¯æŒ‡æ ‡ä¸å¸‚åœºæƒ…ç»ªï¼Œä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„ä¹°å–ç‚¹å»ºè®®ã€‚' : 'Enter a stock symbol to let Gemini Pro analyze historical data, technical indicators, and market sentiment for professional trading signals.' ]]
                    </p>
                    
                    <div class="text-left">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider text-center">[[ currentLanguage === 'zh' ? 'çƒ­é—¨æ ‡çš„å¿«é€Ÿåˆ†æ' : 'Popular Stocks' ]]</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button 
                                v-for="stock in hotStocks" 
                                :key="stock.symbol"
                                @click="selectStock(stock.symbol); analyzeStock(stock.symbol)"
                                class="p-4 border border-gray-100 rounded-xl hover:border-blue-500 hover:shadow-md hover:bg-blue-50 transition-all group text-left"
                            >
                                <div class="font-bold text-gray-800 group-hover:text-blue-700">[[ stock.symbol ]]</div>
                                <div class="text-xs text-gray-500 mt-1">[[ stock.name ]]</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Recommendation Tab Content -->
        <div v-if="currentTab === 'recommend' && !loading" class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
            <!-- Left Column: Recommendations -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Filters & Generate Button -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="text-blue-500 text-xl">â˜…</span> [[ currentLanguage === 'zh' ? 'å¸‚åœºæœºä¼šæŒ–æ˜' : 'Market Scanner' ]]
                        </h3>
                        <button @click="getRecommendations" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full hover:shadow-lg transition-all font-bold text-sm btn-pulse flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            [[ currentLanguage === 'zh' ? 'AI æ™ºèƒ½æ‰«æ' : 'AI Smart Scan' ]]
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'èµ„é‡‘è§„æ¨¡' : 'Capital' ]]</label>
                            <select v-model="recCriteria.capital" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Small (<10w)">[[ currentLanguage === 'zh' ? 'å°èµ„é‡‘ (<10w)' : 'Small (<10k)' ]]</option>
                                <option value="Medium (10w-50w)">[[ currentLanguage === 'zh' ? 'ä¸­ç­‰èµ„é‡‘ (10w-50w)' : 'Medium (10k-50k)' ]]</option>
                                <option value="Large (>50w)">[[ currentLanguage === 'zh' ? 'å¤§èµ„é‡‘ (>50w)' : 'Large (>50k)' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'é£é™©åå¥½' : 'Risk' ]]</label>
                            <select v-model="recCriteria.risk" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Conservative">[[ currentLanguage === 'zh' ? 'ç¨³å¥å‹ (ä½é£é™©)' : 'Conservative' ]]</option>
                                <option value="Balanced">[[ currentLanguage === 'zh' ? 'å¹³è¡¡å‹ (ä¸­é£é™©)' : 'Balanced' ]]</option>
                                <option value="Aggressive">[[ currentLanguage === 'zh' ? 'è¿›å–å‹ (é«˜é£é™©)' : 'Aggressive' ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">[[ currentLanguage === 'zh' ? 'äº¤æ˜“é¢‘ç‡' : 'Frequency' ]]</label>
                            <select v-model="recCriteria.frequency" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Short-term">[[ currentLanguage === 'zh' ? 'çŸ­çº¿ (æ—¥å†…/å‘¨)' : 'Short-term' ]]</option>
                                <option value="Swing">[[ currentLanguage === 'zh' ? 'æ³¢æ®µ (å‘¨/æœˆ)' : 'Swing' ]]</option>
                                <option value="Long-term">[[ currentLanguage === 'zh' ? 'é•¿çº¿ (å­£åº¦+)' : 'Long-term' ]]</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Market Overview -->
                <div v-if="recommendationResult && recommendationResult.market_overview" class="market-card p-5 rounded-xl text-blue-900 text-sm leading-relaxed shadow-sm relative">
                     <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-blue-600 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Market Overview' ]]
                        </div>
                         <button 
                            @click="translateContent('market_overview', recommendationResult.market_overview, (txt) => recommendationResult.market_overview = txt)" 
                            class="text-xs text-blue-400 hover:text-blue-600 font-medium"
                        >
                            [[ translationStatus['market_overview'] ? 'Translating...' : 'Translate' ]]
                        </button>
                    </div>
                    <p class="font-serif">[[ recommendationResult.market_overview ]]</p>
                </div>

                <!-- Recommendations List -->
                <div v-if="recommendationResult && recommendationResult.recommendations" class="space-y-4">
                    <div v-for="(rec, idx) in recommendationResult.recommendations" :key="idx" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h4 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors">[[ rec.symbol ]]</h4>
                                    <span class="text-sm text-gray-500">[[ rec.name ]]</span>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-bold">[[ rec.level ]]</span>
                                </div>
                                <div class="text-2xl font-bold text-gray-800 mt-1">[[ rec.price ]]</div>
                            </div>
                            <button @click="selectStock(rec.symbol); currentTab='analysis'; analyzeStock(rec.symbol)" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline opacity-0 group-hover:opacity-100 transition-opacity">
                                [[ currentLanguage === 'zh' ? 'æŸ¥çœ‹Kçº¿åˆ†æ' : 'Analyze' ]] â†’
                            </button>
                        </div>
                        <div class="text-gray-600 text-sm leading-relaxed bg-gray-50 p-3 rounded-lg relative">
                            <button 
                                @click="translateContent(`rec_${idx}`, rec.reason, (txt) => rec.reason = txt)" 
                                class="absolute top-2 right-2 text-xs text-gray-400 hover:text-blue-500"
                            >
                                [[ translationStatus[`rec_${idx}`] ? '...' : 'Translate' ]]
                            </button>
                            [[ rec.reason ]]
                        </div>
                    </div>
                </div>
                
                <div v-if="!recommendationResult" class="text-center py-12 text-gray-400">
                    [[ currentLanguage === 'zh' ? 'ç‚¹å‡»â€œAI æ™ºèƒ½æ‰«æâ€è·å–æœ€æ–°å¸‚åœºæœºä¼š' : 'Click "AI Smart Scan" to find opportunities' ]]
                </div>
            </div>

            <!-- Right Column: Portfolio Diagnosis -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm h-full flex flex-col border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="text-purple-500">ğŸ’Š</span> [[ currentLanguage === 'zh' ? 'æŒä»“è¯Šæ–­' : 'Portfolio Doctor' ]]
                    </h3>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">[[ currentLanguage === 'zh' ? 'æŒæœ‰ä»£ç ' : 'Symbol' ]]</label>
                            <input v-model="portfolio.symbol" type="text" placeholder="ä¾‹å¦‚ AAPL" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm uppercase">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">[[ currentLanguage === 'zh' ? 'ä¹°å…¥å‡ä»·' : 'Avg Price' ]]</label>
                            <input v-model="portfolio.avg_price" type="text" placeholder="0.00" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">[[ currentLanguage === 'zh' ? 'ä»“ä½å æ¯” (%)' : 'Weight (%)' ]]</label>
                            <input v-model="portfolio.percentage" type="number" placeholder="20" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <button @click="diagnosePortfolio" :disabled="!portfolio.symbol" class="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 font-medium text-sm shadow-md">
                            [[ currentLanguage === 'zh' ? 'å¼€å§‹è¯Šæ–­' : 'Diagnose' ]]
                        </button>
                    </div>

                    <!-- Diagnosis Result -->
                    <div v-if="portfolioResult" class="flex-1 bg-gray-50 rounded-xl p-4 border border-gray-200 animate-fade-in">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-2">
                            <span class="font-bold text-gray-800">[[ portfolioResult.symbol ]]</span>
                            <span class="px-2 py-1 rounded text-xs font-bold"
                                :class="{
                                    'bg-green-100 text-green-700': portfolioResult.rating && portfolioResult.rating.includes('Buy'),
                                    'bg-red-100 text-red-700': portfolioResult.rating && portfolioResult.rating.includes('Sell'),
                                    'bg-gray-200 text-gray-700': portfolioResult.rating && portfolioResult.rating.includes('Hold')
                                }">
                                [[ portfolioResult.rating ]]
                            </span>
                        </div>
                        <div class="mb-3">
                            <span class="text-xs text-gray-500">[[ currentLanguage === 'zh' ? 'å»ºè®®æ“ä½œ' : 'Action' ]]</span>
                            <div class="font-bold text-gray-800">[[ portfolioResult.action ]]</div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">[[ currentLanguage === 'zh' ? 'åˆ†æç†ç”±' : 'Analysis' ]]</span>
                                <button 
                                    @click="translateContent('port_analysis', portfolioResult.analysis, (txt) => portfolioResult.analysis = txt)" 
                                    class="text-xs text-blue-400 hover:text-blue-600"
                                >Translate</button>
                            </div>
                            <p class="text-xs text-gray-600 mt-1 leading-relaxed font-serif">
                                [[ portfolioResult.analysis ]]
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, watch } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const currentTab = ref('analysis');
                const currentLanguage = ref('zh'); // 'zh' or 'en'
                const translationStatus = ref({});

                const recCriteria = ref({ capital: 'Any', risk: 'Any', frequency: 'Any' });
                const recommendationResult = ref(null);
                const portfolio = ref({ symbol: '', avg_price: '', percentage: '' });
                const portfolioResult = ref(null);
                
                const query = ref('');
                const suggestions = ref([]);
                const loading = ref(false);
                const analysisResult = ref(null);
                const chartRef = ref(null);
                let chartInstance = null;
                
                // Model Management
                const models = ref([
                    { id: 'gemini-3-pro', name: 'Gemini 3 Pro', status: 'normal' },
                    { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', status: 'normal' },
                    { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', status: 'normal' },
                    { id: 'local-strategy', name: 'Local Algo (MA+RSI)', status: 'normal' }
                ]);
                const selectedModel = ref('gemini-2.5-flash');
                
                // Trade Expansion State
                const expandedTrades = ref({});

                const currentModelStatus = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.status : 'normal';
                });

                const selectedModelName = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.name : '';
                });

                // Computed Stats
                const stats = computed(() => {
                    if (!analysisResult.value) return {};
                    const trades = analysisResult.value.analysis.trades || [];
                    const totalTrades = trades.length;
                    
                    let winCount = 0;
                    let totalReturnVal = 0.0;
                    let closedCount = 0;
                    let isHolding = false;

                    trades.forEach(t => {
                        if (t.status === 'CLOSED') {
                            closedCount++;
                            const rateStr = t.return_rate.replace('%', '');
                            const rate = parseFloat(rateStr);
                            if (!isNaN(rate)) {
                                totalReturnVal += rate;
                                if (rate > 0) winCount++;
                            }
                        } else if (t.status === 'HOLDING') {
                            isHolding = true;
                        }
                    });

                    const winRate = closedCount > 0 ? Math.round((winCount / closedCount) * 100) : 0;
                    
                    return {
                        totalTrades,
                        winRate,
                        totalReturn: totalReturnVal.toFixed(1),
                        currentStatus: isHolding ? (currentLanguage.value === 'zh' ? 'æŒä»“ä¸­' : 'HOLDING') : (currentLanguage.value === 'zh' ? 'ç©ºä»“' : 'EMPTY')
                    };
                });

                // Debounce helper
                const debounce = (fn, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                };

                const handleSearch = debounce(async (e) => {
                    const val = e.target.value;
                    if (val.length < 1) {
                        suggestions.value = [];
                        return;
                    }
                    try {
                        const res = await fetch(`/api/search?q=${val}`);
                        suggestions.value = await res.json();
                    } catch (err) {
                        console.error(err);
                    }
                }, 300);

                const selectStock = (symbol) => {
                    query.value = symbol;
                    suggestions.value = [];
                };

                const toggleTrade = (index) => {
                    expandedTrades.value[index] = !expandedTrades.value[index];
                };

                const analyzeStock = async (symbol) => {
                    if (!symbol) return;
                    suggestions.value = []; // Clear suggestions
                    loading.value = true;
                    analysisResult.value = null;
                    expandedTrades.value = {}; // Reset expansion state
                    
                    try {
                        const res = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                symbol,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        if (!res.ok) throw new Error('Analysis failed');
                        
                        const data = await res.json();
                        analysisResult.value = data;
                        
                        if (data.analysis.analysis_summary && data.analysis.analysis_summary.includes('Quota Exceeded')) {
                            const m = models.value.find(m => m.id === selectedModel.value);
                            if (m) m.status = 'limit';
                        }

                    } catch (err) {
                        alert('åˆ†æå¤±è´¥ (Analysis Failed): ' + err);
                        console.error(err);
                    } finally {
                        loading.value = false;
                        if (analysisResult.value) {
                            nextTick(() => {
                                initChart(analysisResult.value);
                            });
                        }
                    }
                };

                // Re-init chart when switching back to analysis tab
                watch(currentTab, (newVal) => {
                    if (newVal === 'analysis' && analysisResult.value) {
                        nextTick(() => {
                            initChart(analysisResult.value);
                        });
                    }
                });

                const initChart = (data) => {
                    if (chartInstance) {
                        chartInstance.dispose();
                    }
                    chartInstance = echarts.init(chartRef.value);

                    const klineData = data.kline_data.map(item => [
                        item.open, item.close, item.low, item.high
                    ]);
                    const dates = data.kline_data.map(item => item.date);
                    const volumes = data.kline_data.map((item, index) => [index, item.volume, item.open > item.close ? 1 : -1]);

                    const signals = data.analysis.signals || [];
                    const markPoints = signals.map(sig => {
                        return {
                            name: sig.type,
                            coord: [sig.date, sig.price],
                            value: sig.type === 'BUY' ? (currentLanguage.value === 'zh' ? 'ä¹°' : 'B') : (currentLanguage.value === 'zh' ? 'å–' : 'S'),
                            itemStyle: {
                                color: sig.type === 'BUY' ? '#10B981' : '#EF4444'
                            }
                        };
                    });

                    const option = {
                        title: { text: `${data.symbol} ${currentLanguage.value === 'zh' ? 'Kçº¿è¶‹åŠ¿åˆ†æ' : 'Trend'}`, left: 'center' },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' }
                        },
                        grid: [
                            { left: '5%', right: '5%', top: '10%', height: '60%' },
                            { left: '5%', right: '5%', top: '75%', height: '15%' }
                        ],
                        xAxis: [
                            { type: 'category', data: dates, scale: true, boundaryGap: false, axisLine: { onZero: false }, splitLine: { show: false }, splitNumber: 20, min: 'dataMin', max: 'dataMax' },
                            { type: 'category', gridIndex: 1, data: dates, axisLabel: { show: false } }
                        ],
                        yAxis: [
                            { scale: true, splitArea: { show: true } },
                            { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false }, splitLine: { show: false } }
                        ],
                        dataZoom: [
                            { type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 },
                            { show: true, xAxisIndex: [0, 1], type: 'slider', top: '92%', height: 20, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'K-Line',
                                type: 'candlestick',
                                data: klineData,
                                itemStyle: {
                                    color: '#EF4444', // Red for up
                                    color0: '#10B981', // Green for down
                                    borderColor: '#EF4444',
                                    borderColor0: '#10B981'
                                },
                                markPoint: {
                                    data: markPoints,
                                    symbol: 'pin',
                                    symbolSize: 40,
                                    label: { fontSize: 10 }
                                }
                            },
                            {
                                name: 'Volume',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: volumes.map(item => item[1]),
                                itemStyle: {
                                    color: (params) => {
                                        return klineData[params.dataIndex][0] < klineData[params.dataIndex][1] ? '#EF4444' : '#10B981';
                                    }
                                }
                            }
                        ]
                    };

                    chartInstance.setOption(option);
                    window.addEventListener('resize', () => chartInstance.resize());
                };

                const getRecommendations = async () => {
                    loading.value = true;
                    recommendationResult.value = null;
                    try {
                         const res = await fetch('/api/recommend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...recCriteria.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        recommendationResult.value = await res.json();
                    } catch (err) {
                        alert('æ¨èè¯·æ±‚å¤±è´¥: ' + err);
                        console.error(err);
                    } finally {
                        loading.value = false;
                    }
                };

                const diagnosePortfolio = async () => {
                    if(!portfolio.value.symbol) return;
                    loading.value = true; 
                    portfolioResult.value = null;
                    try {
                         const res = await fetch('/api/portfolio_advice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...portfolio.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        portfolioResult.value = await res.json();
                    } catch (err) {
                        alert('è¯Šæ–­è¯·æ±‚å¤±è´¥: ' + err);
                        console.error(err);
                    } finally {
                        loading.value = false;
                    }
                };

                const translateContent = async (id, text, updateCallback) => {
                    if (!text) return;
                    // Toggle back if already translated? Simplification: just translate.
                    // Actually, usually users want to translate cache (EN) -> ZH, or ZH -> EN.
                    // We'll just ask AI to translate to the "other" language based on currentLanguage state, 
                    // or specifically target language.
                    // Let's assume we translate TO the current selected language if the content seems different, 
                    // or just toggle. Simpler: Always translate to the current UI language (if cache was in other lang).
                    // Or just explicit target.
                    
                    // Let's just default to: if current is 'zh', translate to 'zh'. If 'en', to 'en'.
                    // But wait, if I'm in 'zh' mode and content is 'zh', button shouldn't do much?
                    // The requirement says: "If result is already output... support translation".
                    // Usually means: I see English, I want Chinese.
                    const target = currentLanguage.value === 'zh' ? 'zh' : 'en';
                    // To be safe, let's flip it. If I click translate, I probably want the OTHER language than what I see?
                    // No, usually I set UI to Chinese, I expect Chinese. If cache gave me English, I click "Translate" to make it Chinese.
                    
                    translationStatus.value[id] = true;
                    try {
                        const res = await fetch('/api/translate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: text,
                                target_lang: target === 'zh' ? 'Chinese' : 'English',
                                model: selectedModel.value
                            })
                        });
                        const data = await res.json();
                        if (data.translation) {
                            // Check if caller provided a callback to update the text in place
                            if (updateCallback) {
                                updateCallback(data.translation);
                            } else {
                                // Default update logic if needed
                                if (id === 'analysis_summary') analysisResult.value.analysis.analysis_summary = data.translation;
                            }
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        translationStatus.value[id] = false;
                    }
                };

                return {
                    currentTab,
                    currentLanguage,
                    recCriteria,
                    recommendationResult,
                    portfolio,
                    portfolioResult,
                    getRecommendations,
                    diagnosePortfolio,
                    query,
                    suggestions,
                    loading,
                    analysisResult,
                    chartRef,
                    handleSearch,
                    selectStock,
                    analyzeStock,
                    stats,
                    models,
                    selectedModel,
                    selectedModelName,
                    currentModelStatus,
                    expandedTrades,
                    toggleTrade,
                    translateContent,
                    translationStatus,
                    hotStocks: [
                        { symbol: 'NVDA', name: 'è‹±ä¼Ÿè¾¾' },
                        { symbol: 'TSLA', name: 'ç‰¹æ–¯æ‹‰' },
                        { symbol: 'AAPL', name: 'è‹¹æœ' },
                        { symbol: 'MSFT', name: 'å¾®è½¯' },
                        { symbol: '600519.SS', name: 'è´µå·èŒ…å°' },
                        { symbol: '0700.HK', name: 'è…¾è®¯æ§è‚¡' },
                        { symbol: '300750.SZ', name: 'å®å¾·æ—¶ä»£' },
                        { symbol: '9988.HK', name: 'é˜¿é‡Œå·´å·´' }
                    ]
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
