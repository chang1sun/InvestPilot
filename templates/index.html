<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Pilot</title>
    <link rel="icon" type="image/png" href="/static/thumbnail.png">
    <link rel="apple-touch-icon" href="/static/thumbnail.png">
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none !important; }
        .chart-container { height: 500px; width: 100%; } /* Fixed height for chart */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Text Content Styling */
        .prose-sm { font-size: 0.875rem; line-height: 1.6; }
        .analysis-card { background: #ffffff; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .analysis-header { border-left: 4px solid #3b82f6; padding-left: 1rem; margin-bottom: 0.75rem; }
        .market-card { background: linear-gradient(to bottom right, #eff6ff, #ffffff); border: 1px solid #bfdbfe; }
        
        /* Button Animation */
        .btn-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Stock Card Animation */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stock-card {
            animation: fade-in-up 0.5s ease-out;
        }
        
        .stock-card:nth-child(1) { animation-delay: 0s; }
        .stock-card:nth-child(2) { animation-delay: 0.1s; }
        .stock-card:nth-child(3) { animation-delay: 0.2s; }
        .stock-card:nth-child(4) { animation-delay: 0.3s; }
        .stock-card:nth-child(5) { animation-delay: 0.4s; }
        .stock-card:nth-child(6) { animation-delay: 0.5s; }
        .stock-card:nth-child(7) { animation-delay: 0.6s; }
        .stock-card:nth-child(8) { animation-delay: 0.7s; }
        
        /* Text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Task List Animation */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* Task Item Animation */
        @keyframes task-add {
            0% {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .task-item {
            animation: task-add 0.3s ease-out;
        }
        
        /* Toast Notification */
        @keyframes toast-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toast-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: toast-slide-in 0.3s ease-out;
        }
        
        .toast-exit {
            animation: toast-slide-out 0.3s ease-out;
        }
        
        /* Button Click Animation */
        @keyframes button-click {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .btn-click-animation {
            animation: button-click 0.3s ease-out;
        }
        
        /* Loading Spinner */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Task List Slide Animation */
        .task-list-slide {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Pulse Animation for New Task */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }
        
        .task-new {
            animation: pulse-glow 1.5s ease-out, task-add 0.3s ease-out;
        }
        
        /* Draggable Button Styles */
        .dragging {
            cursor: grabbing !important;
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        /* Recommendation Card Enhancements */
        .recommendation-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .recommendation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #3b82f6;
        }
        
        /* Portfolio Diagnosis Enhancements */
        .portfolio-input-group {
            position: relative;
        }
        
        .portfolio-input-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #9333ea, #ec4899);
            border-radius: 3px 0 0 3px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .portfolio-input-group:focus-within::before {
            opacity: 1;
        }
        
        .portfolio-result-card {
            background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);
            border: 2px solid #e9d5ff;
            box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.1), 0 4px 6px -2px rgba(139, 92, 246, 0.05);
        }
        
        /* Shimmer animation for buttons */
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        .animate-shimmer {
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="flex flex-col min-h-screen">
        <!-- Disclaimer Banner (Always Visible at Top) -->
        <div v-if="showDisclaimer" class="bg-gradient-to-r from-red-50 via-orange-50 to-yellow-50 border-b-2 border-red-400 shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-base font-bold text-red-900 mb-1 flex items-center gap-2">
                            <span>[[ currentLanguage === 'zh' ? 'å…è´£å£°æ˜' : 'Disclaimer' ]]</span>
                        </div>
                        <div class="text-sm text-red-800 leading-relaxed">
                            [[ currentLanguage === 'zh' ? 
                                'æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚' : 
                                'This project is for learning and research purposes only and does not constitute any investment advice. The stock market involves risks, and investment requires caution. Users are solely responsible for all consequences of using this system for investment decisions.' 
                            ]]
                        </div>
                    </div>
                    <button 
                        @click="closeDisclaimer"
                        class="flex-shrink-0 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full p-1 transition-colors"
                        :title="currentLanguage === 'zh' ? 'å…³é—­' : 'Close'"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Login Modal -->
        <div v-if="showLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showLoginModal = false">
            <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full mx-4 animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                    [[ currentLanguage === 'zh' ? 'æ¬¢è¿ä½¿ç”¨ Invest Pilot' : 'Welcome to Invest Pilot' ]]
                </h2>
                <form @submit.prevent="handleLogin">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'æ˜µç§°' : 'Nickname' ]]
                        </label>
                        <input 
                            v-model="loginForm.nickname"
                            type="text"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? 'è¯·è¾“å…¥æ‚¨çš„æ˜µç§°' : 'Enter your nickname'"
                        >
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            [[ currentLanguage === 'zh' ? 'é‚®ç®±' : 'Email' ]]
                        </label>
                        <input 
                            v-model="loginForm.email"
                            type="email"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :placeholder="currentLanguage === 'zh' ? 'è¯·è¾“å…¥æ‚¨çš„é‚®ç®±' : 'Enter your email'"
                        >
                    </div>
                    <button 
                        type="submit"
                        class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors"
                    >
                        [[ currentLanguage === 'zh' ? 'å¼€å§‹ä½¿ç”¨' : 'Get Started' ]]
                    </button>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div 
            v-if="toastMessage"
            class="fixed top-20 right-4 z-50 toast-enter"
            :class="toastType === 'success' ? 'bg-green-500' : toastType === 'error' ? 'bg-red-500' : 'bg-blue-500'"
        >
            <div class="flex items-center gap-3 px-6 py-4 rounded-lg shadow-xl text-white min-w-[300px]">
                <svg v-if="toastType === 'success'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <svg v-else-if="toastType === 'error'" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-6 h-6 flex-shrink-0 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <div class="flex-1">
                    <p class="font-semibold text-sm">[[ toastMessage ]]</p>
                </div>
                <button @click="toastMessage = ''" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Duplicate Task Dialog -->
        <div 
            v-if="showDuplicateTaskDialog"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in"
            @click.self="showDuplicateTaskDialog = false"
        >
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all animate-fade-in">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">
                                [[ currentLanguage === 'zh' ? 'ä»»åŠ¡å·²å­˜åœ¨' : 'Task Already Running' ]]
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">
                                [[ currentLanguage === 'zh' ? 'æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡' : 'A running task detected' ]]
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 font-medium mb-1">
                                    [[ currentLanguage === 'zh' ? 'å·²æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼š' : 'Running task: ' ]]
                                    <span class="font-bold text-blue-700">[[ duplicateTaskInfo.symbol ]]</span>
                                </p>
                                <p class="text-xs text-gray-500">
                                    [[ currentLanguage === 'zh' ? 'åˆ›å»ºæ—¶é—´ï¼š' : 'Created: ' ]]
                                    [[ formatTime(duplicateTaskInfo.created_at) ]]
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button 
                            @click="handleDuplicateTaskChoice('wait')"
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ' : 'Wait for Existing Task' ]]
                        </button>
                        <button 
                            @click="handleDuplicateTaskChoice('cancel')"
                            class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆç°æœ‰ä»»åŠ¡å¹¶åˆ›å»ºæ–°ä»»åŠ¡' : 'Cancel Existing & Create New' ]]
                        </button>
                        <button 
                            @click="showDuplicateTaskDialog = false"
                            class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors"
                        >
                            [[ currentLanguage === 'zh' ? 'å–æ¶ˆ' : 'Cancel' ]]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Sidebar (Always Visible) -->
        <div class="fixed right-0 top-0 h-full w-80 bg-white shadow-2xl z-40 task-list-slide" :class="taskListVisible ? 'translate-x-0' : 'translate-x-full'">
            <div class="h-full flex flex-col">
                <!-- Task List Header -->
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            [[ currentLanguage === 'zh' ? 'ä»»åŠ¡åˆ—è¡¨' : 'Task List' ]]
                        </h3>
                        <button @click="taskListVisible = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Status Filter -->
                    <div class="flex gap-2 flex-wrap">
                        <button 
                            v-for="status in taskStatusFilters" 
                            :key="status.value"
                            @click="taskFilterStatus = status.value"
                            class="px-3 py-1 text-xs rounded-full font-medium transition-colors"
                            :class="taskFilterStatus === status.value ? 
                                'bg-blue-600 text-white' : 
                                'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        >
                            [[ status.label ]]
                        </button>
                    </div>
                </div>
                
                <!-- Task List Content -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="filteredTasks.length === 0" class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>[[ currentLanguage === 'zh' ? 'æš‚æ— ä»»åŠ¡' : 'No tasks' ]]</p>
                    </div>
                    <div v-else class="space-y-3">
                        <div 
                            v-for="task in filteredTasks" 
                            :key="task.task_id"
                            class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                            :class="{
                                'task-new': task._isNew,
                                'task-item': !task._isNew,
                                'border-blue-300 bg-blue-50': task.status === 'running',
                                'border-green-300 bg-green-50': task.status === 'completed',
                                'border-red-300 bg-red-50': task.status === 'failed',
                                'border-gray-300 bg-gray-50': task.status === 'terminated'
                            }"
                        >
                            <!-- Task Header -->
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 text-xs rounded font-bold" :class="{
                                            'bg-blue-100 text-blue-700': task.status === 'running',
                                            'bg-green-100 text-green-700': task.status === 'completed',
                                            'bg-red-100 text-red-700': task.status === 'failed',
                                            'bg-gray-100 text-gray-700': task.status === 'terminated'
                                        }">
                                            [[ getTaskStatusLabel(task.status) ]]
                                        </span>
                                        <span class="text-xs text-gray-500">[[ getTaskTypeLabel(task.task_type) ]]</span>
                                    </div>
                                    <div class="text-sm font-medium text-gray-800" v-if="task.task_params">
                                        [[ getTaskTitle(task) ]]
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Task Time -->
                            <div class="text-xs text-gray-500 mb-3">
                                [[ formatTime(task.created_at) ]]
                            </div>
                            
                            <!-- Task Actions -->
                            <div class="flex gap-2">
                                <button 
                                    v-if="task.status === 'running'"
                                    @click="terminateTask(task.task_id)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? 'ç»ˆæ­¢' : 'Terminate' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'completed'"
                                    @click="showTaskResult(task)"
                                    class="flex-1 px-3 py-1.5 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium transition-colors"
                                >
                                    [[ currentLanguage === 'zh' ? 'æ˜¾ç¤ºç»“æœ' : 'Show Result' ]]
                                </button>
                                <button 
                                    v-if="task.status === 'failed'"
                                    class="flex-1 px-3 py-1.5 text-xs bg-gray-100 text-gray-600 rounded cursor-not-allowed"
                                    :title="task.error_message"
                                >
                                    [[ currentLanguage === 'zh' ? 'å¤±è´¥' : 'Failed' ]]
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Toggle Button (Draggable) -->
        <div 
            ref="taskButtonRef"
            class="fixed bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition-colors z-30 flex items-center gap-2 cursor-move select-none"
            :class="{'bg-red-600 hover:bg-red-700': taskListVisible}"
            :style="{ left: taskButtonPosition.x + 'px', top: taskButtonPosition.y + 'px' }"
            @mousedown="startDrag"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span class="font-bold" v-if="runningTasksCount > 0">[[ runningTasksCount ]]</span>
            <button 
                @click.stop="taskListVisible = !taskListVisible"
                class="ml-1 text-white hover:text-gray-200"
                :title="currentLanguage === 'zh' ? 'ç‚¹å‡»åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨' : 'Click to toggle task list'"
            >
                <svg v-if="taskListVisible" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>

        <div class="container mx-auto px-4 py-4 flex-1 flex flex-col">
        <!-- Header & Search Row -->
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <img src="/static/logo.png" alt="Invest Pilot Logo" class="w-12 h-12 object-contain">
                
                <!-- Title -->
                <div class="flex flex-col">
                    <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 leading-tight">Invest Pilot</h1>
                    <p class="text-xs text-gray-500 font-medium mt-0.5 hidden sm:block">AI-Powered Investment Copilot</p>
                </div>
                
                <!-- Model Selector -->
                <div class="relative">
                    <select 
                        v-model="selectedModel" 
                        class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pr-8 cursor-pointer font-medium"
                    >
                        <option v-for="m in availableModels" :key="m.id" :value="m.id" :disabled="m.disabled || m.isHeader" :class="{'font-bold text-gray-400': m.isHeader}">
                            [[ m.name ]] [[ m.status === 'limit' ? '(å·²é™é¢)' : '' ]]
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                    <div v-if="currentModelStatus === 'limit'"  
                         class="absolute -top-2 -right-2 bg-yellow-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold cursor-help shadow-sm z-10"
                         title="è¯¥æ¨¡å‹è§¦å‘äº† API é…é¢é™åˆ¶ (429)ï¼Œå½“å‰å¯èƒ½ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æˆ–æ— æ³•å·¥ä½œã€‚"
                    >!</div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Language Selector -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button @click="currentLanguage = 'zh'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'zh' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">ä¸­æ–‡</button>
                    <button @click="currentLanguage = 'en'" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" :class="currentLanguage === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'">EN</button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex gap-8 mb-6 border-b border-gray-200 px-2">
            <button 
                @click="currentTab = 'analysis'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'analysis' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                [[ currentLanguage === 'zh' ? 'ä¸ªè‚¡åˆ†æ' : 'Trend Analysis' ]]
            </button>
            <button 
                @click="currentTab = 'recommend'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'recommend' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Smart Picks' ]]
            </button>
            <button 
                @click="currentTab = 'portfolio'"
                class="pb-3 font-bold text-base border-b-2 transition-all flex items-center gap-2 px-2"
                :class="currentTab === 'portfolio' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-800'"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                [[ currentLanguage === 'zh' ? 'æŒä»“è¯Šæ–­' : 'Portfolio Diagnosis' ]]
            </button>
        </div>

        <!-- Loading State -->
        <div v-if="(currentTab === 'analysis' && loadingAnalysis) || (currentTab === 'recommend' && loadingRecommend) || (currentTab === 'portfolio' && loadingPortfolio)" class="flex-1 flex items-center justify-center min-h-[400px]">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">[[ currentLanguage === 'zh' ? 'AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...' : 'AI is analyzing deep data...' ]]</p>
                <p class="text-sm text-gray-400 mt-2">[[ currentLanguage === 'zh' ? 'æ­£åœ¨æœç´¢å®æ—¶å¸‚åœºèµ„è®¯ & è®¡ç®—ç­–ç•¥...' : 'Searching real-time market info & calculating strategies...' ]]</p>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <template v-if="currentTab === 'analysis'">
            <!-- Compact Search Section -->
            <div class="mb-6">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 flex items-center gap-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                v-model="query" 
                                @input="handleSearch"
                                @keyup.enter="analyzeStock(query)"
                                :placeholder="currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚ AAPL, 0700.HK)' : 'Enter Symbol (e.g., AAPL)'"
                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white outline-none text-sm font-medium transition-all"
                            >
                            <div v-if="suggestions.length > 0" class="absolute z-50 w-full bg-white mt-1 rounded-lg shadow-xl border border-gray-200 max-h-60 overflow-auto">
                                <div 
                                    v-for="item in suggestions" 
                                    @click="selectStock(item.symbol)"
                                    class="px-4 py-2.5 hover:bg-blue-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-100 last:border-0 transition-colors"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">[[ item.symbol ]]</span>
                                        <span class="text-gray-500 text-xs">[[ item.name ]]</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="analyzeStock(query)" 
                            :disabled="creatingTask || !query"
                            :class="[
                                'px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed font-semibold text-sm whitespace-nowrap flex items-center gap-2 relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : ''
                            ]"
                        >
                            <svg v-if="!creatingTask" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <svg v-else class="w-4 h-4 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>
                                [[ creatingTask ? (currentLanguage === 'zh' ? 'åˆ›å»ºä¸­...' : 'Creating...') : (currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze') ]]
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Result View -->
            <div v-if="!loadingAnalysis && analysisResult" class="flex-1 flex flex-col gap-6 animate-fade-in">
                
                <!-- Model Info Banner -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-xl p-4 shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-blue-900 mb-1">
                                [[ currentLanguage === 'zh' ? 'ğŸ’¡ é‡è¦æç¤º' : 'ğŸ’¡ Important Notice' ]]
                            </div>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                <p class="mb-1">
                                    [[ currentLanguage === 'zh' ? 
                                        'â€¢ ä¸åŒ AI æ¨¡å‹çš„åˆ†æç»“æœå¯èƒ½ä¸åŒï¼Œæ¯ä¸ªæ¨¡å‹éƒ½æœ‰ç‹¬ç«‹çš„äº¤æ˜“å†å²è®°å½•' : 
                                        'â€¢ Different AI models may produce different analysis results. Each model maintains its own separate trading history' 
                                    ]]
                                </p>
                                <p>
                                    [[ currentLanguage === 'zh' ? 
                                        'â€¢ ç›¸åŒæ¨¡å‹å¯¹åŒä¸€è‚¡ç¥¨çš„åˆ†æç»“æœä¼šè¢«ç¼“å­˜ï¼Œå½“å¤©é‡å¤åˆ†æå°†ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ' : 
                                        'â€¢ Analysis results from the same model are cached. Repeated analysis on the same day will return cached results' 
                                    ]]
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fallback Warning Banner -->
                <div v-if="analysisResult.analysis.is_fallback" class="bg-gradient-to-r from-orange-50 to-amber-50 border-l-4 border-orange-500 rounded-xl p-5 shadow-sm animate-pulse">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-orange-800 flex items-center gap-2">
                                    <span>âš¡</span>
                                    [[ currentLanguage === 'zh' ? 'æœ¬åœ°é‡åŒ–ç­–ç•¥' : 'Local Quantitative Strategy' ]]
                                </h3>
                                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                                    MA + RSI
                                </span>
                            </div>
                            <p class="text-sm text-orange-700 leading-relaxed mb-2">
                                [[ currentLanguage === 'zh' ? 
                                    'ç”±äº AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨åˆ‡æ¢è‡³æœ¬åœ°é‡åŒ–ç­–ç•¥ã€‚ç»“æœåŸºäºç»å…¸æŠ€æœ¯æŒ‡æ ‡ï¼ˆå‡çº¿äº¤å‰ + RSI åŠ¨é‡ï¼‰ï¼Œä»…ä¾›å‚è€ƒã€‚' : 
                                    'AI service is temporarily unavailable. System has automatically switched to local quantitative strategy based on classic technical indicators (MA crossover + RSI momentum) for reference only.' 
                                ]]
                            </p>
                            <div class="flex items-center gap-2 text-xs text-orange-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-semibold">[[ currentLanguage === 'zh' ? 'åŸå› ï¼š' : 'Reason: ' ]]</span>
                                <span class="italic">[[ analysisResult.analysis.fallback_reason ]]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 1. Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-blue-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'æ€»äº¤æ˜“æ¬¡æ•°' : 'Total Trades' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.totalTrades ]]</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.winRate >= 50 ? 'border-green-500' : 'border-yellow-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'èƒœç‡' : 'Win Rate' ]]</div>
                        <div class="text-2xl font-bold text-gray-800">[[ stats.winRate ]]%</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="stats.totalReturn > 0 ? 'border-green-500' : 'border-red-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'ç´¯è®¡æ”¶ç›Š (ä¼°ç®—)' : 'Total Return' ]]</div>
                        <div class="text-2xl font-bold" :class="stats.totalReturn > 0 ? 'text-green-600' : 'text-red-600'">
                            [[ stats.totalReturn > 0 ? '+' : '' ]][[ stats.totalReturn ]]%
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4" :class="analysisResult.analysis.is_fallback ? 'border-orange-500' : 'border-purple-500'">
                        <div class="text-xs text-gray-500 uppercase font-bold">[[ currentLanguage === 'zh' ? 'å½“å‰çŠ¶æ€' : 'Status' ]]</div>
                        <div class="text-xl font-bold" :class="analysisResult.analysis.is_fallback ? 'text-orange-700' : 'text-purple-700'">[[ stats.currentStatus ]]</div>
                    </div>
                </div>

                <!-- 2. Main Chart Area (Full Width) -->
                <div class="bg-white rounded-xl shadow-sm p-4 w-full">
                    <div ref="chartRef" class="chart-container" style="height: 550px; width: 100%;"></div>
                </div>

                <!-- 3. Bottom Section: Analysis & Logs (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px] lg:h-[500px]">
                    
                    <!-- AI Summary (Takes 1/3) -->
                    <div class="analysis-card p-6 flex flex-col relative group lg:col-span-1 h-full overflow-hidden" :class="analysisResult.analysis.is_fallback ? 'border-orange-200 bg-orange-50/30' : ''">
                        <div class="flex justify-between items-center mb-4 flex-none">
                            <h3 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2" :class="analysisResult.analysis.is_fallback ? 'text-orange-800' : 'text-gray-800'">
                                <span class="w-1 h-4 rounded-full" :class="analysisResult.analysis.is_fallback ? 'bg-orange-600' : 'bg-blue-600'"></span>
                                [[ analysisResult.analysis.is_fallback ? 
                                    (currentLanguage === 'zh' ? 'ç­–ç•¥è¯´æ˜' : 'Strategy Info') : 
                                    (currentLanguage === 'zh' ? 'AI åˆ†ææ‘˜è¦' : 'AI Summary') 
                                ]]
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1 pr-2">
                            <p class="text-sm text-gray-700 leading-relaxed font-serif text-justify whitespace-pre-wrap">[[ analysisResult.analysis.analysis_summary ]]</p>
                        </div>
                    </div>

                    <!-- Trades Table (Takes 2/3) -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col overflow-hidden border border-gray-100 lg:col-span-2 h-full">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex-none">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">[[ currentLanguage === 'zh' ? 'äº¤æ˜“æ˜ç»†' : 'Trade Log' ]]</h3>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <div class="divide-y divide-gray-100">
                                <div v-for="(trade, index) in analysisResult.analysis.trades" :key="index" class="border-b border-gray-100 last:border-0">
                                    <!-- Row Content -->
                                    <div 
                                        @click="toggleTrade(index)"
                                        class="px-4 py-3 hover:bg-gray-50 transition-colors cursor-pointer"
                                        :class="{
                                            'bg-green-50': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                            'bg-red-50': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                            'bg-blue-50': trade.status === 'HOLDING'
                                        }"
                                    >
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4">
                                                <!-- Expand Icon -->
                                                <svg class="w-4 h-4 text-gray-400 transition-transform flex-shrink-0" :class="{'rotate-90': expandedTrades[index]}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                                
                                                <!-- Badge -->
                                                <span class="px-2 py-1 rounded-md font-bold text-xs whitespace-nowrap" :class="{
                                                    'bg-green-100 text-green-700': trade.status === 'CLOSED' && trade.return_rate.includes('+'),
                                                    'bg-red-100 text-red-700': trade.status === 'CLOSED' && trade.return_rate.includes('-'),
                                                    'bg-blue-100 text-blue-700': trade.status === 'HOLDING'
                                                }">
                                                    [[ trade.status === 'HOLDING' ? (currentLanguage === 'zh' ? 'æŒä»“' : 'HOLD') : (trade.return_rate.includes('+') ? (currentLanguage === 'zh' ? 'æ­¢ç›ˆ' : 'WIN') : (currentLanguage === 'zh' ? 'æ­¢æŸ' : 'LOSS')) ]]
                                                </span>
                                                
                                                <!-- Date info -->
                                                <div class="text-xs text-gray-600 flex flex-col sm:flex-row sm:gap-2">
                                                    <span><span class="font-bold">Buy:</span> [[ trade.buy_date ]] @ [[ trade.buy_price ]]</span>
                                                    <span v-if="trade.sell_date" class="hidden sm:inline text-gray-300">|</span>
                                                    <span v-if="trade.sell_date"><span class="font-bold">Sell:</span> [[ trade.sell_date ]] @ [[ trade.sell_price ]]</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Return -->
                                            <div class="text-sm font-bold whitespace-nowrap" :class="{
                                                'text-green-600': trade.return_rate.includes('+'),
                                                'text-red-600': trade.return_rate.includes('-'),
                                                'text-blue-600': trade.status === 'HOLDING'
                                            }">
                                                [[ trade.return_rate ]]
                                            </div>
                                        </div>

                                        <!-- Expanded Details (Inline) -->
                                        <div v-if="expandedTrades[index]" class="mt-3 pt-3 border-t border-gray-200/50 text-xs text-gray-600">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                                <div>
                                                    <span class="font-bold text-gray-500 block mb-1">[[ currentLanguage === 'zh' ? 'æŒä»“æ—¶é—´' : 'Duration' ]]</span>
                                                    [[ trade.holding_period ]]
                                                </div>
                                                <div>
                                                    <div class="font-bold text-gray-500 mb-1">
                                                        <span>[[ currentLanguage === 'zh' ? 'ç­–ç•¥é€»è¾‘' : 'Reasoning' ]]</span>
                                                    </div>
                                                    <p class="leading-relaxed text-gray-700">[[ trade.reason ]]</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loadingAnalysis && !analysisResult" class="flex-1 flex flex-col items-center justify-center animate-fade-in py-12">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 max-w-3xl w-full text-center">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">[[ currentLanguage === 'zh' ? 'å¼€å¯ AI é‡åŒ–ä¹‹æ—…' : 'Start AI Quant Journey' ]]</h2>
                    <p class="text-gray-500 mb-10 max-w-lg mx-auto leading-relaxed">
                        [[ currentLanguage === 'zh' ? 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œè®© AI æ·±åº¦è§£æå†å²æ•°æ®ï¼Œç»“åˆæŠ€æœ¯æŒ‡æ ‡ä¸å¸‚åœºæƒ…ç»ªï¼Œä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„ä¹°å–ç‚¹å»ºè®®ã€‚' : 'Enter a stock symbol to let AI analyze historical data, technical indicators, and market sentiment for professional trading signals.' ]]
                    </p>
                    
                    <div class="text-left">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider text-center">[[ currentLanguage === 'zh' ? 'ğŸ”¥ çƒ­é—¨æ ‡çš„å¿«é€Ÿåˆ†æ' : 'ğŸ”¥ Popular Stocks' ]]</p>
                        
                        <!-- Loading State -->
                        <div v-if="loadingHotStocks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="i in 8" :key="i" class="p-4 border border-gray-200 rounded-xl bg-gray-50 animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-20 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-16 mb-3"></div>
                                <div class="h-6 bg-gray-300 rounded w-24 mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-12"></div>
                            </div>
                        </div>
                        
                        <!-- Stocks Grid -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button 
                                v-for="stock in hotStocks" 
                                :key="stock.symbol"
                                @click="selectStock(stock.symbol); analyzeStock(stock.symbol)"
                                class="stock-card relative p-4 border border-gray-200 rounded-xl hover:border-blue-400 hover:shadow-lg transition-all group text-left bg-gradient-to-br from-white to-gray-50 overflow-hidden"
                            >
                                <!-- Trend Background -->
                                <div class="absolute inset-0 opacity-5 pointer-events-none">
                                    <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                        <polyline
                                            :points="stock.trendData"
                                            fill="none"
                                            :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                            stroke-width="2"
                                        />
                                    </svg>
                                </div>
                                
                                <!-- Content -->
                                <div class="relative z-10">
                                    <!-- Header -->
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-gray-900 group-hover:text-blue-700 text-sm">[[ stock.symbol ]]</div>
                                            <div class="text-xs text-gray-500 mt-0.5">[[ stock.name ]]</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-semibold" :class="stock.change >= 0 ? 'text-green-600' : 'text-red-600'">
                                                [[ stock.change >= 0 ? '+' : '' ]][[ stock.change ]]%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price & Mini Chart -->
                                    <div class="flex items-end justify-between mt-3">
                                        <div>
                                            <div class="text-lg font-bold text-gray-900">[[ stock.price ]]</div>
                                            <div class="text-xs text-gray-400">[[ stock.market ]]</div>
                                        </div>
                                        
                                        <!-- Mini Trend Line -->
                                        <div class="w-16 h-8">
                                            <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                                                <polyline
                                                    :points="stock.trendData"
                                                    fill="none"
                                                    :stroke="stock.change >= 0 ? '#10b981' : '#ef4444'"
                                                    stroke-width="3"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Volume -->
                                    <div class="mt-2 pt-2 border-t border-gray-100">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-gray-400">[[ currentLanguage === 'zh' ? 'æˆäº¤é‡' : 'Volume' ]]</span>
                                            <span class="text-gray-600 font-medium">[[ stock.volume ]]</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hover Effect Indicator -->
                                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-indigo-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Recommendation Tab Content -->
        <div v-if="currentTab === 'recommend' && !loadingRecommend" class="flex-1 grid grid-cols-1 gap-6 animate-fade-in max-w-5xl mx-auto w-full">
            <!-- Recommendations (Full Width) -->
            <div class="space-y-6">
                
                <!-- Filters & Generate Button -->
                <div class="bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/30 p-8 rounded-2xl shadow-lg border-2 border-blue-100/50 backdrop-blur-sm">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    [[ currentLanguage === 'zh' ? 'å¸‚åœºæœºä¼šæŒ–æ˜' : 'Market Scanner' ]]
                                </h3>
                                <p class="text-xs text-gray-500 mt-1">[[ currentLanguage === 'zh' ? 'AI é©±åŠ¨çš„æ™ºèƒ½é€‰è‚¡æ¨è' : 'AI-Powered Stock Recommendations' ]]</p>
                            </div>
                        </div>
                        <button 
                            @click="getRecommendations" 
                            :disabled="creatingTask || loadingRecommend"
                            :class="[
                                'px-8 py-3 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white rounded-full hover:shadow-xl transition-all font-bold text-sm flex items-center gap-2 disabled:opacity-70 disabled:cursor-wait relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : 'btn-pulse'
                            ]"
                        >
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></span>
                            <svg v-if="!creatingTask && !loadingRecommend" class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <svg v-else class="w-5 h-5 spinner relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="relative z-10">
                                [[ creatingTask ? (currentLanguage === 'zh' ? 'åˆ›å»ºä»»åŠ¡ä¸­...' : 'Creating task...') : (loadingRecommend ? (currentLanguage === 'zh' ? 'æ‰«æä¸­...' : 'Scanning...') : (currentLanguage === 'zh' ? 'AI æ™ºèƒ½æ‰«æ' : 'AI Smart Scan')) ]]
                            </span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'å¸‚åœºé€‰æ‹©' : 'Market' ]]
                            </label>
                            <select v-model="recCriteria.market" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="US">[[ currentLanguage === 'zh' ? 'ç¾è‚¡ (US)' : 'US Stocks' ]]</option>
                                <option value="HK">[[ currentLanguage === 'zh' ? 'æ¸¯è‚¡ (HK)' : 'HK Stocks' ]]</option>
                                <option value="A">[[ currentLanguage === 'zh' ? 'Aè‚¡ (A)' : 'A-Shares' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'èµ„é‡‘è§„æ¨¡' : 'Capital' ]]
                            </label>
                            <select v-model="recCriteria.capital" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Small (<10w)">[[ currentLanguage === 'zh' ? 'å°èµ„é‡‘ (<10w)' : 'Small (<10k)' ]]</option>
                                <option value="Medium (10w-50w)">[[ currentLanguage === 'zh' ? 'ä¸­ç­‰èµ„é‡‘ (10w-50w)' : 'Medium (10k-50k)' ]]</option>
                                <option value="Large (>50w)">[[ currentLanguage === 'zh' ? 'å¤§èµ„é‡‘ (>50w)' : 'Large (>50k)' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'é£é™©åå¥½' : 'Risk' ]]
                            </label>
                            <select v-model="recCriteria.risk" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Conservative">[[ currentLanguage === 'zh' ? 'ç¨³å¥å‹ (ä½é£é™©)' : 'Conservative' ]]</option>
                                <option value="Balanced">[[ currentLanguage === 'zh' ? 'å¹³è¡¡å‹ (ä¸­é£é™©)' : 'Balanced' ]]</option>
                                <option value="Aggressive">[[ currentLanguage === 'zh' ? 'è¿›å–å‹ (é«˜é£é™©)' : 'Aggressive' ]]</option>
                            </select>
                        </div>
                        <div class="portfolio-input-group">
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'äº¤æ˜“é¢‘ç‡' : 'Frequency' ]]
                            </label>
                            <select v-model="recCriteria.frequency" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium transition-all shadow-sm hover:shadow-md">
                                <option value="Any">[[ currentLanguage === 'zh' ? 'ä¸é™' : 'Any' ]]</option>
                                <option value="Short-term">[[ currentLanguage === 'zh' ? 'çŸ­çº¿ (æ—¥å†…/å‘¨)' : 'Short-term' ]]</option>
                                <option value="Swing">[[ currentLanguage === 'zh' ? 'æ³¢æ®µ (å‘¨/æœˆ)' : 'Swing' ]]</option>
                                <option value="Long-term">[[ currentLanguage === 'zh' ? 'é•¿çº¿ (å­£åº¦+)' : 'Long-term' ]]</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Market Overview -->
                <div v-if="recommendationResult && recommendationResult.market_overview" class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-2 border-blue-200/50 p-6 rounded-2xl text-gray-800 leading-relaxed shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-200/20 rounded-full -mr-16 -mt-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-indigo-200/20 rounded-full -ml-12 -mb-12"></div>
                    <div class="relative z-10">
                        <div class="mb-3 flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center shadow-md">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="font-bold text-blue-700 text-lg flex items-center gap-2">
                                [[ currentLanguage === 'zh' ? 'å¸‚åœºé£å‘' : 'Market Overview' ]]
                            </div>
                        </div>
                        <p class="font-serif text-gray-700 leading-relaxed text-base">[[ recommendationResult.market_overview ]]</p>
                    </div>
                </div>

                <!-- Recommendations List -->
                <div v-if="recommendationResult && recommendationResult.recommendations" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-for="(rec, idx) in recommendationResult.recommendations" :key="idx" class="recommendation-card p-6 rounded-2xl group relative overflow-hidden">
                        <!-- Decorative gradient overlay -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-50/0 via-indigo-50/0 to-purple-50/0 group-hover:from-blue-50/50 group-hover:via-indigo-50/30 group-hover:to-purple-50/20 transition-all duration-300"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                                        <h4 class="text-xl font-extrabold text-gray-900 group-hover:text-blue-600 transition-colors">[[ rec.symbol ]]</h4>
                                        <span class="text-sm text-gray-500 font-medium">[[ rec.name ]]</span>
                                        <span class="px-3 py-1 bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-xs rounded-full font-bold shadow-sm">
                                            [[ rec.level ]]
                                        </span>
                                    </div>
                                    <div class="text-3xl font-extrabold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mt-2">
                                        [[ rec.price ]]
                                    </div>
                                </div>
                                <button 
                                    @click="selectStock(rec.symbol); currentTab='analysis'; analyzeStock(rec.symbol)" 
                                    class="ml-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg opacity-0 group-hover:opacity-100 transition-all transform hover:scale-105 flex items-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'åˆ†æ' : 'Analyze' ]]
                                </button>
                            </div>
                            <div class="text-gray-700 text-sm leading-relaxed bg-gradient-to-br from-gray-50 to-blue-50/30 p-4 rounded-xl border border-gray-100">
                                <p class="font-medium">[[ rec.reason ]]</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Market News Section (shown when no recommendations) -->
                <div v-if="!recommendationResult" class="space-y-6">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">[[ currentLanguage === 'zh' ? 'ğŸ“ˆ å®æ—¶å¸‚åœºåŠ¨æ€' : 'ğŸ“ˆ Live Market Insights' ]]</h3>
                        <p class="text-sm text-gray-500">[[ currentLanguage === 'zh' ? 'æœ€æ–°èµ„è®¯ã€è´¢æŠ¥å‘å¸ƒã€æœºæ„è¯„çº§å˜åŠ¨' : 'Latest news, earnings, and analyst ratings' ]]</p>
                    </div>
                    
                    <!-- Loading State -->
                    <div v-if="loadingMarketNews" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="i in 6" :key="i" class="bg-white p-5 rounded-xl border border-gray-100 animate-pulse">
                            <div class="flex gap-3">
                                <div class="w-16 h-16 bg-gray-200 rounded-lg"></div>
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/2 mb-2"></div>
                                    <div class="h-3 bg-gray-100 rounded w-1/4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- News Grid -->
                    <div v-else-if="marketNews.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a 
                            v-for="news in marketNews" 
                            :key="news.id"
                            :href="news.link"
                            target="_blank"
                            class="bg-white p-5 rounded-xl border border-gray-100 hover:border-blue-300 hover:shadow-lg transition-all group cursor-pointer"
                        >
                            <div class="flex gap-4">
                                <!-- Icon or Thumbnail -->
                                <div class="flex-shrink-0">
                                    <div v-if="news.thumbnail" class="w-20 h-20 rounded-lg overflow-hidden bg-gray-100">
                                        <img :src="news.thumbnail" :alt="news.title" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                    </div>
                                    <div v-else class="w-20 h-20 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center text-3xl">
                                        [[ news.icon ]]
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <!-- Type Badge -->
                                    <div class="flex items-center gap-2 mb-2">
                                        <span 
                                            class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                            :class="{
                                                'bg-purple-100 text-purple-700': news.type === 'earnings',
                                                'bg-yellow-100 text-yellow-700': news.type === 'rating',
                                                'bg-blue-100 text-blue-700': news.type === 'deal',
                                                'bg-green-100 text-green-700': news.type === 'dividend' || news.type === 'bullish',
                                                'bg-red-100 text-red-700': news.type === 'bearish',
                                                'bg-gray-100 text-gray-700': news.type === 'news'
                                            }"
                                        >
                                            [[ news.icon ]] 
                                            <span v-if="news.type === 'earnings'">[[ currentLanguage === 'zh' ? 'è´¢æŠ¥' : 'Earnings' ]]</span>
                                            <span v-else-if="news.type === 'rating'">[[ currentLanguage === 'zh' ? 'è¯„çº§' : 'Rating' ]]</span>
                                            <span v-else-if="news.type === 'deal'">[[ currentLanguage === 'zh' ? 'äº¤æ˜“' : 'Deal' ]]</span>
                                            <span v-else-if="news.type === 'dividend'">[[ currentLanguage === 'zh' ? 'åˆ†çº¢' : 'Dividend' ]]</span>
                                            <span v-else-if="news.type === 'bullish'">[[ currentLanguage === 'zh' ? 'åˆ©å¥½' : 'Bullish' ]]</span>
                                            <span v-else-if="news.type === 'bearish'">[[ currentLanguage === 'zh' ? 'åˆ©ç©º' : 'Bearish' ]]</span>
                                            <span v-else>[[ currentLanguage === 'zh' ? 'èµ„è®¯' : 'News' ]]</span>
                                        </span>
                                        <span class="text-xs text-gray-400">[[ news.time_ago ]]</span>
                                    </div>
                                    
                                    <!-- Title -->
                                    <h4 class="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors line-clamp-2 leading-snug mb-2">
                                        [[ news.title ]]
                                    </h4>
                                    
                                    <!-- Footer -->
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <span>[[ news.publisher ]]</span>
                                        <span v-if="news.related_symbols.length > 0" class="font-mono font-semibold">[[ news.related_symbols[0] ]]</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Empty State -->
                    <div v-else class="text-center py-12">
                        <div class="text-gray-300 text-6xl mb-4">ğŸ“°</div>
                        <p class="text-gray-400">[[ currentLanguage === 'zh' ? 'æš‚æ— å¸‚åœºèµ„è®¯' : 'No market news available' ]]</p>
                    </div>
                    
                    <!-- Call to Action -->
                    <div class="text-center mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                        <p class="text-gray-600 mb-4">
                            [[ currentLanguage === 'zh' ? 'ğŸ‘† ç‚¹å‡»ä¸Šæ–¹ã€ŒAI æ™ºèƒ½æ‰«æã€è·å–ä¸ªæ€§åŒ–é€‰è‚¡æ¨è' : 'ğŸ‘† Click "AI Smart Scan" above for personalized recommendations' ]]
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Diagnosis Tab Content -->
        <div v-if="currentTab === 'portfolio' && !loadingPortfolio" class="flex-1 flex flex-col items-center animate-fade-in">
             <div class="max-w-3xl w-full space-y-8">
                <!-- Input Form Card -->
                <div class="bg-gradient-to-br from-white via-purple-50/30 to-pink-50/30 p-8 rounded-2xl shadow-xl border-2 border-purple-100/50 backdrop-blur-sm relative overflow-hidden">
                    <!-- Decorative elements -->
                    <div class="absolute top-0 right-0 w-40 h-40 bg-purple-200/20 rounded-full -mr-20 -mt-20"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-pink-200/20 rounded-full -ml-16 -mb-16"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-center gap-4 mb-8">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="text-center">
                                <h3 class="text-3xl font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                    [[ currentLanguage === 'zh' ? 'æŒä»“è¯Šæ–­ä¸“å®¶' : 'Portfolio Doctor' ]]
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">[[ currentLanguage === 'zh' ? 'AI é©±åŠ¨çš„ä¸“ä¸šæŒä»“åˆ†æ' : 'AI-Powered Portfolio Analysis' ]]</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="portfolio-input-group">
                                <label class="block text-sm font-bold text-gray-600 uppercase mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'æŒæœ‰ä»£ç ' : 'Symbol' ]]
                                </label>
                                <input 
                                    v-model="portfolio.symbol" 
                                    type="text" 
                                    placeholder="ä¾‹å¦‚ AAPL" 
                                    class="w-full bg-white border-2 border-gray-200 rounded-xl px-5 py-4 text-base uppercase focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none font-bold text-center transition-all shadow-sm hover:shadow-md"
                                >
                            </div>
                            <div class="portfolio-input-group">
                                <label class="block text-sm font-bold text-gray-600 uppercase mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'ä¹°å…¥å‡ä»·' : 'Avg Price' ]]
                                </label>
                                <input 
                                    v-model="portfolio.avg_price" 
                                    type="text" 
                                    placeholder="0.00" 
                                    class="w-full bg-white border-2 border-gray-200 rounded-xl px-5 py-4 text-base focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-center transition-all shadow-sm hover:shadow-md"
                                >
                            </div>
                            <div class="portfolio-input-group">
                                <label class="block text-sm font-bold text-gray-600 uppercase mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    [[ currentLanguage === 'zh' ? 'ä»“ä½å æ¯” (%)' : 'Weight (%)' ]]
                                </label>
                                <input 
                                    v-model="portfolio.percentage" 
                                    type="number" 
                                    placeholder="20" 
                                    class="w-full bg-white border-2 border-gray-200 rounded-xl px-5 py-4 text-base focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-center transition-all shadow-sm hover:shadow-md"
                                >
                            </div>
                        </div>

                        <button 
                            @click="diagnosePortfolio" 
                            :disabled="!portfolio.symbol || creatingTask"
                            :class="[
                                'w-full py-5 bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 text-white rounded-2xl hover:shadow-2xl transition-all disabled:opacity-50 font-bold text-lg shadow-xl flex justify-center items-center gap-3 relative overflow-hidden',
                                creatingTask ? 'btn-click-animation' : ''
                            ]"
                        >
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></span>
                            <svg v-if="!creatingTask" class="w-6 h-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <svg v-else class="w-6 h-6 spinner relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="relative z-10">
                                [[ creatingTask ? (currentLanguage === 'zh' ? 'åˆ›å»ºä»»åŠ¡ä¸­...' : 'Creating task...') : (currentLanguage === 'zh' ? 'å¼€å§‹è¯Šæ–­' : 'Start Diagnosis') ]]
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Diagnosis Result -->
                <div v-if="portfolioResult" class="portfolio-result-card rounded-2xl p-8 animate-fade-in relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-purple-500 via-pink-500 to-rose-500"></div>
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b-2 border-purple-100 pb-6 gap-4">
                        <div>
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                [[ currentLanguage === 'zh' ? 'è¯Šæ–­å¯¹è±¡' : 'Target' ]]
                            </div>
                            <div class="text-4xl font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                [[ portfolioResult.symbol ]]
                            </div>
                        </div>
                        <div class="text-center md:text-right">
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2">[[ currentLanguage === 'zh' ? 'è¯„çº§' : 'Rating' ]]</div>
                            <span class="px-6 py-3 rounded-xl text-xl font-bold shadow-lg inline-block transform hover:scale-105 transition-transform"
                                :class="{
                                    'bg-gradient-to-r from-green-400 to-emerald-500 text-white': portfolioResult.rating && portfolioResult.rating.includes('Buy'),
                                    'bg-gradient-to-r from-red-400 to-rose-500 text-white': portfolioResult.rating && portfolioResult.rating.includes('Sell'),
                                    'bg-gradient-to-r from-gray-400 to-slate-500 text-white': portfolioResult.rating && portfolioResult.rating.includes('Hold')
                                }">
                                [[ portfolioResult.rating ]]
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-8 bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 p-6 rounded-2xl border-2 border-purple-200/50 shadow-md">
                        <div class="text-sm text-purple-700 font-bold mb-3 flex items-center gap-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                             </svg>
                             [[ currentLanguage === 'zh' ? 'å»ºè®®æ“ä½œ' : 'Action' ]]
                        </div>
                        <div class="font-bold text-gray-900 text-xl leading-relaxed">[[ portfolioResult.action ]]</div>
                    </div>
                    
                    <div>
                        <div class="mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="text-sm text-gray-600 font-bold uppercase">[[ currentLanguage === 'zh' ? 'æ·±åº¦åˆ†æ' : 'Analysis' ]]</span>
                        </div>
                        <div class="bg-gradient-to-br from-gray-50 to-purple-50/30 p-6 rounded-xl border border-gray-200">
                            <p class="text-gray-700 leading-relaxed font-serif text-justify text-base">
                                [[ portfolioResult.analysis ]]
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, watch, onMounted } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // è¿ç§»æ—§çš„ localStorage key åˆ°æ–°çš„ key
                if (localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences')) {
                    try {
                        const oldState = JSON.parse(localStorage.getItem('quantAgentState') || localStorage.getItem('quantAgentPreferences') || '{}');
                        localStorage.setItem('investPilotPreferences', JSON.stringify({
                            currentTab: oldState.currentTab,
                            currentLanguage: oldState.currentLanguage,
                            selectedModel: oldState.selectedModel
                        }));
                        localStorage.removeItem('quantAgentState'); // åˆ é™¤æ—§ key
                        localStorage.removeItem('quantAgentPreferences'); // åˆ é™¤æ—§ key
                    } catch (e) {
                        console.warn('Failed to migrate old state:', e);
                    }
                }
                
                // State Initialization with Persistence Check
                const getSavedPreferences = () => {
                    try {
                        return JSON.parse(localStorage.getItem('investPilotPreferences') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const getSessionData = () => {
                    try {
                        return JSON.parse(sessionStorage.getItem('investPilotSession') || '{}');
                    } catch {
                        return {};
                    }
                };
                
                const savedPreferences = getSavedPreferences();
                const sessionData = getSessionData();

                const currentTab = ref(savedPreferences.currentTab || 'analysis');
                const currentLanguage = ref(savedPreferences.currentLanguage || 'en');
                
                // Disclaimer Banner State
                const showDisclaimer = ref(!localStorage.getItem('disclaimerDismissed'));
                
                // Toast Notification
                const toastMessage = ref('');
                const toastType = ref('info'); // 'success', 'error', 'info'
                
                // Duplicate Task Dialog
                const showDuplicateTaskDialog = ref(false);
                const duplicateTaskInfo = ref({ symbol: '', task_id: '', created_at: '' });
                const pendingAnalysisSymbol = ref(null);
                
                // Loading States (Independent)
                const loadingAnalysis = ref(false);
                const loadingRecommend = ref(false);
                const loadingPortfolio = ref(false);
                const creatingTask = ref(false);
                
                // ä» sessionStorage æ¢å¤ä¼šè¯æ•°æ®ï¼ˆåˆ·æ–°é¡µé¢æ—¶ä¿ç•™ï¼‰
                const recCriteria = ref(sessionData.recCriteria || { market: 'Any', capital: 'Any', risk: 'Any', frequency: 'Any' });
                const recommendationResult = ref(sessionData.recommendationResult || null);
                const portfolio = ref(sessionData.portfolio || { symbol: '', avg_price: '', percentage: '' });
                const portfolioResult = ref(sessionData.portfolioResult || null);
                
                const query = ref(sessionData.query || '');
                const suggestions = ref([]);
                const analysisResult = ref(sessionData.analysisResult || null);
                const chartRef = ref(null);
                let chartInstance = null;
                
                // Model Management
                const models = ref([]);
                const selectedModel = ref(savedPreferences.selectedModel || 'gemini-3-flash-preview');
                
                // Hot Stocks Management
                const hotStocks = ref([]);
                const loadingHotStocks = ref(false);
                
                // Market News Management
                const marketNews = ref([]);
                const loadingMarketNews = ref(false);
                
                // User Authentication
                const currentUser = ref(null);
                const showLoginModal = ref(false);
                const loginForm = ref({ nickname: '', email: '' });
                const sessionId = ref(localStorage.getItem('investPilotSessionId') || null);
                
                // Task Management
                const tasks = ref([]);
                const taskListVisible = ref(false);
                const taskFilterStatus = ref(null); // null = all, 'running', 'completed', 'terminated', 'failed'
                const taskButtonRef = ref(null);
                const taskButtonPosition = ref({ x: 0, y: 0 });
                const isDragging = ref(false);
                const dragStartPos = ref({ x: 0, y: 0 });
                const taskStatusFilters = computed(() => {
                    const isZh = currentLanguage.value === 'zh';
                    return [
                        { value: null, label: isZh ? 'å…¨éƒ¨' : 'All' },
                        { value: 'running', label: isZh ? 'è¿è¡Œä¸­' : 'Running' },
                        { value: 'completed', label: isZh ? 'å·²å®Œæˆ' : 'Completed' },
                        { value: 'terminated', label: isZh ? 'å·²ç»ˆæ­¢' : 'Terminated' },
                        { value: 'failed', label: isZh ? 'å¤±è´¥' : 'Failed' }
                    ];
                });
                let taskPollInterval = null;
                
                // Computed: Filtered tasks
                const filteredTasks = computed(() => {
                    if (!taskFilterStatus.value) {
                        return tasks.value;
                    }
                    return tasks.value.filter(t => t.status === taskFilterStatus.value);
                });
                
                // Computed: Running tasks count
                const runningTasksCount = computed(() => {
                    return tasks.value.filter(t => t.status === 'running').length;
                });
                
                // Load models from API
                const loadModels = async () => {
                    try {
                        const res = await fetch('/api/models');
                        const modelList = await res.json();
                        
                        // Group models by provider
                        const grouped = {};
                        modelList.forEach(m => {
                            if (!grouped[m.provider]) {
                                grouped[m.provider] = [];
                            }
                            grouped[m.provider].push({
                                id: m.id,
                                name: m.name,
                                provider: m.provider,
                                supports_search: m.supports_search,
                                status: 'normal'
                            });
                        });
                        
                        // Flatten with provider labels
                        const flattened = [];
                        const providerOrder = ['gemini', 'openai', 'anthropic', 'xai', 'qwen', 'local'];
                        const providerNames = {
                            'gemini': 'Google Gemini',
                            'openai': 'OpenAI GPT',
                            'anthropic': 'Anthropic Claude',
                            'xai': 'xAI Grok',
                            'qwen': 'Alibaba Qwen',
                            'local': 'Local Strategy'
                        };
                        
                        providerOrder.forEach(provider => {
                            if (grouped[provider]) {
                                flattened.push({
                                    id: `header_${provider}`,
                                    name: `â”â”â” ${providerNames[provider]} â”â”â”`,
                                    isHeader: true,
                                    disabled: true
                                });
                                flattened.push(...grouped[provider]);
                            }
                        });
                        
                        models.value = flattened;
                        
                        // Validate saved model
                        const validIds = modelList.map(m => m.id);
                        if (!validIds.includes(selectedModel.value)) {
                            console.warn(`Invalid saved model: ${selectedModel.value}, resetting to default`);
                            selectedModel.value = 'gemini-3-flash-preview';
                        }
                    } catch (err) {
                        console.error('Failed to load models:', err);
                        // Fallback to default models
                        models.value = [
                            { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash (Preview)', status: 'normal' },
                            { id: 'local-strategy', name: 'Local Algo (MA+RSI)', status: 'normal' }
                        ];
                    }
                };
                
                // Load trending stocks from API
                const loadTrendingStocks = async () => {
                    loadingHotStocks.value = true;
                    try {
                        const res = await fetch('/api/trending');
                        const trendingList = await res.json();
                        hotStocks.value = trendingList;
                    } catch (err) {
                        console.error('Failed to load trending stocks:', err);
                        // Fallback to default stocks
                        hotStocks.value = [
                            { symbol: 'NVDA', name: 'NVIDIA', price: '$850', change: 2.5, volume: '50M', market: 'NASDAQ', trendData: '10,35 30,28 50,32 70,25 90,30' },
                            { symbol: 'TSLA', name: 'Tesla', price: '$245', change: -1.2, volume: '95M', market: 'NASDAQ', trendData: '10,15 30,18 50,22 70,25 90,20' },
                            { symbol: 'AAPL', name: 'Apple', price: '$195', change: 1.8, volume: '42M', market: 'NASDAQ', trendData: '10,28 30,25 50,30 70,27 90,32' },
                            { symbol: 'MSFT', name: 'Microsoft', price: '$420', change: 1.2, volume: '22M', market: 'NASDAQ', trendData: '10,25 30,22 50,28 70,24 90,30' },
                            { symbol: '600519.SS', name: 'è´µå·èŒ…å°', price: 'Â¥1,680', change: 0.5, volume: '1M', market: 'SSE', trendData: '10,20 30,23 50,19 70,25 90,22' },
                            { symbol: '0700.HK', name: 'è…¾è®¯æ§è‚¡', price: 'HK$380', change: -0.8, volume: '18M', market: 'HKEX', trendData: '10,30 30,28 50,32 70,29 90,34' },
                            { symbol: '300750.SZ', name: 'å®å¾·æ—¶ä»£', price: 'Â¥235', change: 3.5, volume: '8M', market: 'SZSE', trendData: '10,35 30,32 50,37 70,34 90,38' },
                            { symbol: '9988.HK', name: 'é˜¿é‡Œå·´å·´', price: 'HK$90', change: 1.5, volume: '40M', market: 'HKEX', trendData: '10,22 30,25 50,20 70,27 90,24' }
                        ];
                    } finally {
                        loadingHotStocks.value = false;
                    }
                };
                
                // Load market news from API
                const loadMarketNews = async () => {
                    loadingMarketNews.value = true;
                    try {
                        const res = await fetch('/api/market_news');
                        const newsList = await res.json();
                        marketNews.value = newsList;
                    } catch (err) {
                        console.error('Failed to load market news:', err);
                        marketNews.value = [];
                    } finally {
                        loadingMarketNews.value = false;
                    }
                };
                
                // Trade Expansion State
                const expandedTrades = ref({});

                // --- Computed Properties ---

                const currentModelStatus = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.status : 'normal';
                });

                const selectedModelName = computed(() => {
                    const m = models.value.find(m => m.id === selectedModel.value);
                    return m ? m.name : '';
                });

                // Filter models based on tab
                const availableModels = computed(() => {
                    let filtered = models.value;
                    
                    if (currentTab.value === 'recommend') {
                        // Disable local strategy for recommendation tab
                        filtered = filtered.map(m => {
                            if (m.id === 'local-strategy') {
                                return { ...m, disabled: true };
                            }
                            return m;
                        });
                    }
                    
                    return filtered;
                });

                // Computed Stats
                const stats = computed(() => {
                    if (!analysisResult.value) return {};
                    const trades = analysisResult.value.analysis.trades || [];
                    const totalTrades = trades.length;
                    
                    let winCount = 0;
                    let totalReturnVal = 0.0;
                    let closedCount = 0;
                    let isHolding = false;

                    trades.forEach(t => {
                        if (t.status === 'CLOSED') {
                            closedCount++;
                            const rateStr = t.return_rate.replace('%', '');
                            const rate = parseFloat(rateStr);
                            if (!isNaN(rate)) {
                                totalReturnVal += rate;
                                if (rate > 0) winCount++;
                            }
                        } else if (t.status === 'HOLDING') {
                            isHolding = true;
                        }
                    });

                    const winRate = closedCount > 0 ? Math.round((winCount / closedCount) * 100) : 0;
                    
                    return {
                        totalTrades,
                        winRate,
                        totalReturn: totalReturnVal.toFixed(1),
                        currentStatus: isHolding ? (currentLanguage.value === 'zh' ? 'æŒä»“ä¸­' : 'HOLDING') : (currentLanguage.value === 'zh' ? 'ç©ºä»“' : 'EMPTY')
                    };
                });

                // --- Persistence & Watchers ---

                // ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®åˆ° localStorageï¼ˆæ°¸ä¹…ä¿å­˜ï¼‰
                watch(
                    [currentTab, currentLanguage, selectedModel],
                    () => {
                        const preferences = {
                            currentTab: currentTab.value,
                            currentLanguage: currentLanguage.value,
                            selectedModel: selectedModel.value
                        };
                        localStorage.setItem('investPilotPreferences', JSON.stringify(preferences));
                    },
                    { deep: true }
                );
                
                // ä¿å­˜ä¼šè¯æ•°æ®åˆ° sessionStorageï¼ˆåˆ·æ–°ä¿ç•™ï¼Œå…³é—­æ ‡ç­¾é¡µæ¸…é™¤ï¼‰
                watch(
                    [recCriteria, recommendationResult, portfolio, portfolioResult, query, analysisResult],
                    () => {
                        const sessionData = {
                            recCriteria: recCriteria.value,
                            recommendationResult: recommendationResult.value,
                            portfolio: portfolio.value,
                            portfolioResult: portfolioResult.value,
                            query: query.value,
                            analysisResult: analysisResult.value
                        };
                        sessionStorage.setItem('investPilotSession', JSON.stringify(sessionData));
                    },
                    { deep: true }
                );

                // Auto-switch model if invalid for current tab
                watch(currentTab, (newTab) => {
                    if (newTab === 'recommend' && selectedModel.value === 'local-strategy') {
                        selectedModel.value = 'models/gemini-3-flash-preview';
                    }
                });

                // ç›‘å¬ tab åˆ‡æ¢ï¼Œæ¢å¤ k çº¿å›¾
                watch(currentTab, (newTab, oldTab) => {
                    if (newTab === 'analysis' && analysisResult.value) {
                        // åˆ‡æ¢å›åˆ†æé¡µæ—¶ï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œé‡æ–°åˆå§‹åŒ–å›¾è¡¨
                        nextTick(() => {
                            if (chartRef.value) {
                                initChart(analysisResult.value);
                                // ç¡®ä¿å›¾è¡¨å°ºå¯¸æ­£ç¡®
                                if (chartInstance) {
                                    setTimeout(() => {
                                        chartInstance.resize();
                                    }, 100);
                                }
                            }
                        });
                    }
                });

                // Draggable Task Button Functions
                const startDrag = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return; // Don't drag if clicking the toggle button
                    }
                    isDragging.value = true;
                    dragStartPos.value = {
                        x: e.clientX - taskButtonPosition.value.x,
                        y: e.clientY - taskButtonPosition.value.y
                    };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                    e.preventDefault();
                };
                
                const onDrag = (e) => {
                    if (!isDragging.value) return;
                    const newX = e.clientX - dragStartPos.value.x;
                    const newY = e.clientY - dragStartPos.value.y;
                    
                    // Constrain to viewport
                    const maxX = window.innerWidth - (taskButtonRef.value?.offsetWidth || 80);
                    const maxY = window.innerHeight - (taskButtonRef.value?.offsetHeight || 80);
                    
                    taskButtonPosition.value = {
                        x: Math.max(0, Math.min(newX, maxX)),
                        y: Math.max(0, Math.min(newY, maxY))
                    };
                    
                    // Save position to localStorage
                    localStorage.setItem('taskButtonPosition', JSON.stringify(taskButtonPosition.value));
                };
                
                const stopDrag = () => {
                    isDragging.value = false;
                    document.removeEventListener('mousemove', onDrag);
                    document.removeEventListener('mouseup', stopDrag);
                };
                
                // Load saved button position
                const loadButtonPosition = () => {
                    try {
                        const saved = localStorage.getItem('taskButtonPosition');
                        if (saved) {
                            const pos = JSON.parse(saved);
                            // Validate position is still within viewport
                            const maxX = window.innerWidth - 80;
                            const maxY = window.innerHeight - 80;
                            taskButtonPosition.value = {
                                x: Math.max(0, Math.min(pos.x, maxX)),
                                y: Math.max(0, Math.min(pos.y, maxY))
                            };
                        } else {
                            // Default position: bottom right
                            taskButtonPosition.value = {
                                x: window.innerWidth - 80,
                                y: window.innerHeight - 80
                            };
                        }
                    } catch {
                        taskButtonPosition.value = {
                            x: window.innerWidth - 80,
                            y: window.innerHeight - 80
                        };
                    }
                };
                
                // åˆ·æ–°é¡µé¢åæ¢å¤å›¾è¡¨ï¼ˆå¦‚æœæœ‰ analysisResultï¼‰
                onMounted(async () => {
                    // Load button position
                    loadButtonPosition();
                    
                    // Update position on window resize
                    window.addEventListener('resize', () => {
                        const maxX = window.innerWidth - 80;
                        const maxY = window.innerHeight - 80;
                        taskButtonPosition.value = {
                            x: Math.min(taskButtonPosition.value.x, maxX),
                            y: Math.min(taskButtonPosition.value.y, maxY)
                        };
                    });
                    
                    // Check authentication first
                    await checkAuth();
                    
                    // Load available models, trending stocks, and market news
                    loadModels();
                    loadTrendingStocks();
                    loadMarketNews();
                    
                    if (analysisResult.value) {
                        nextTick(() => {
                            initChart(analysisResult.value);
                        });
                    }
                    
                    // Start task polling if authenticated
                    if (currentUser.value) {
                        loadTasks();
                        startTaskPolling();
                    }
                });

                // --- Functions ---

                const debounce = (fn, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                };

                const handleSearch = debounce(async (e) => {
                    const val = e.target.value;
                    if (val.length < 1) {
                        suggestions.value = [];
                        return;
                    }
                    try {
                        const res = await fetch(`/api/search?q=${val}`);
                        suggestions.value = await res.json();
                    } catch (err) {
                        console.error(err);
                    }
                }, 300);

                const selectStock = (symbol) => {
                    query.value = symbol;
                    suggestions.value = [];
                };

                const toggleTrade = (index) => {
                    expandedTrades.value[index] = !expandedTrades.value[index];
                };

                const showToast = (message, type = 'info', duration = 3000) => {
                    toastMessage.value = message;
                    toastType.value = type;
                    setTimeout(() => {
                        toastMessage.value = '';
                    }, duration);
                };

                const analyzeStock = async (symbol) => {
                    if (!symbol) return;
                    
                    // Check authentication
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    suggestions.value = []; // Clear suggestions
                    creatingTask.value = true;
                    
                    // Show initial toast
                    showToast(
                        currentLanguage.value === 'zh' ? 'æ­£åœ¨åˆ›å»ºåˆ†æä»»åŠ¡...' : 'Creating analysis task...',
                        'info',
                        2000
                    );
                    
                    try {
                        // Create async task
                        const res = await fetch('/api/analyze_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({ 
                                symbol,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            // Show success toast
                            showToast(
                                currentLanguage.value === 'zh' ? `ä»»åŠ¡å·²åˆ›å»ºï¼š${symbol}` : `Task created: ${symbol}`,
                                'success',
                                3000
                            );
                            
                            // Show task list with animation
                            taskListVisible.value = true;
                            
                            // Small delay to ensure task is saved to DB
                            await new Promise(resolve => setTimeout(resolve, 300));
                            await loadTasks();
                            
                            // Highlight the new task
                            const newTask = tasks.value.find(t => t.task_id === data.task_id);
                            if (newTask) {
                                newTask._isNew = true;
                                setTimeout(() => {
                                    if (newTask) delete newTask._isNew;
                                }, 2000);
                            }
                            
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                analysisResult.value = result;
                                expandedTrades.value = {};
                                if (result.analysis && result.analysis.analysis_summary && result.analysis.analysis_summary.includes('Quota Exceeded')) {
                            const m = models.value.find(m => m.id === selectedModel.value);
                            if (m) m.status = 'limit';
                        }

                                // Show completion toast
                                showToast(
                                    currentLanguage.value === 'zh' ? `ğŸ‰ åˆ†æå®Œæˆï¼š${symbol}` : `ğŸ‰ Analysis completed: ${symbol}`,
                                    'success',
                                    3000
                                );
                                
                                nextTick(() => {
                                    if (chartRef.value) {
                                        initChart(result);
                                    }
                                });
                            });
                        } else if (data.error === 'duplicate_task') {
                            // Handle duplicate task
                            duplicateTaskInfo.value = {
                                symbol: symbol,
                                task_id: data.existing_task_id,
                                created_at: data.existing_task_created_at
                            };
                            pendingAnalysisSymbol.value = symbol;
                            showDuplicateTaskDialog.value = true;
                        } else {
                            throw new Error(data.error || data.message || 'Failed to create task');
                        }
                    } catch (err) {
                        showToast(
                            currentLanguage.value === 'zh' ? `âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${err.message}` : `âŒ Failed to create task: ${err.message}`,
                            'error',
                            4000
                        );
                        console.error(err);
                    } finally {
                        creatingTask.value = false;
                    }
                };

                const initChart = (data) => {
                    if (!chartRef.value) return;
                    if (chartInstance) {
                        chartInstance.dispose();
                    }
                    chartInstance = echarts.init(chartRef.value);

                    const klineData = data.kline_data.map(item => [
                        item.open, item.close, item.low, item.high
                    ]);
                    const dates = data.kline_data.map(item => item.date);
                    const volumes = data.kline_data.map((item, index) => [index, item.volume, item.open > item.close ? 1 : -1]);

                    const trades = data.analysis.trades || [];
                    const signals = data.analysis.signals || [];
                    const markPoints = signals.map(sig => {
                        let tradeInfo = null;
                        if (sig.type === 'BUY') {
                            tradeInfo = trades.find(t => t.buy_date === sig.date);
                        } else if (sig.type === 'SELL') {
                            tradeInfo = trades.find(t => t.sell_date === sig.date);
                        }
                        return {
                            name: sig.type,
                            coord: [sig.date, sig.price],
                            value: sig.type === 'BUY' ? (currentLanguage.value === 'zh' ? 'ä¹°' : 'B') : (currentLanguage.value === 'zh' ? 'å–' : 'S'),
                            itemStyle: {
                                color: sig.type === 'BUY' ? '#10B981' : '#EF4444'
                            },
                            tradeDetails: tradeInfo
                        };
                    });

                    const option = {
                        title: { text: `${data.symbol} ${currentLanguage.value === 'zh' ? 'Kçº¿è¶‹åŠ¿åˆ†æ' : 'Trend'}`, left: 'center' },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(item => {
                                    if (item.componentSubType === 'candlestick') {
                                        const values = item.value;
                                        result += `å¼€ç›˜: ${values[1]}<br/>`;
                                        result += `æ”¶ç›˜: ${values[2]}<br/>`;
                                        result += `æœ€ä½: ${values[3]}<br/>`;
                                        result += `æœ€é«˜: ${values[4]}<br/>`;
                                    } else if (item.seriesName === 'Volume') {
                                        result += `æˆäº¤é‡: ${item.value}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        grid: [
                            { left: '8%', right: '5%', top: '12%', height: '58%' },
                            { left: '8%', right: '5%', top: '75%', height: '15%' }
                        ],
                        xAxis: [
                            { 
                                type: 'category', 
                                data: dates, 
                                scale: true, 
                                boundaryGap: true,
                                axisLine: { onZero: false }, 
                                splitLine: { show: false }, 
                                min: 'dataMin', 
                                max: 'dataMax'
                            },
                            { 
                                type: 'category', 
                                gridIndex: 1, 
                                data: dates, 
                                axisLabel: { show: false } 
                            }
                        ],
                        yAxis: [
                            { 
                                scale: true, 
                                splitArea: { show: true },
                                splitNumber: 5,
                                axisLabel: {
                                    formatter: '{value}'
                                }
                            },
                            { 
                                scale: true, 
                                gridIndex: 1, 
                                splitNumber: 2, 
                                axisLabel: { show: false }, 
                                axisLine: { show: false }, 
                                axisTick: { show: false }, 
                                splitLine: { show: false } 
                            }
                        ],
                        dataZoom: [
                            { 
                                type: 'inside', 
                                xAxisIndex: [0, 1], 
                                start: 50, 
                                end: 100,
                                zoomOnMouseWheel: false, // Prevent page scroll hijack
                                moveOnMouseWheel: false,
                                moveOnMouseMove: true
                            },
                            { show: true, xAxisIndex: [0, 1], type: 'slider', top: '92%', height: 20, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'K-Line',
                                type: 'candlestick',
                                data: klineData,
                                itemStyle: {
                                    color: '#EF4444',
                                    color0: '#10B981',
                                    borderColor: '#EF4444',
                                    borderColor0: '#10B981'
                                },
                                markPoint: {
                                    data: markPoints,
                                    symbol: 'pin',
                                    symbolSize: 40,
                                    label: { fontSize: 10 },
                                    tooltip: {
                                        trigger: 'item',
                                        formatter: function(params) {
                                            const data = params.data;
                                            const type = data.name; 
                                            const details = data.tradeDetails;
                                            const isZh = currentLanguage.value === 'zh';
                                            
                                            let html = `<div style="font-family: sans-serif; padding: 4px;">`;
                                            html += `<div style="font-weight: bold; margin-bottom: 4px; color: ${type === 'BUY' ? '#10B981' : '#EF4444'}">${params.value} (${type})</div>`;
                                            
                                            if (details) {
                                                if (type === 'BUY') {
                                                    html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${details.buy_date}</div>`;
                                                    html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: <b>${details.buy_price}</b></div>`;
                                                } else {
                                                    html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${details.sell_date}</div>`;
                                                    html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: <b>${details.sell_price}</b></div>`;
                                                    html += `<div style="margin-top: 4px;">${isZh ? 'æ”¶ç›Š' : 'Return'}: <span style="font-weight: bold; color: ${details.return_rate.includes('+') ? '#10B981' : '#EF4444'}">${details.return_rate}</span></div>`;
                                                }
                                                if (details.reason) {
                                                     const reason = details.reason.length > 60 ? details.reason.substring(0, 60) + '...' : details.reason;
                                                     html += `<div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #555; padding-top: 4px; max-width: 200px; white-space: normal;">${reason}</div>`;
                                                }
                                            } else {
                                                html += `<div>${isZh ? 'æ—¥æœŸ' : 'Date'}: ${data.coord[0]}</div>`;
                                                html += `<div>${isZh ? 'ä»·æ ¼' : 'Price'}: ${data.coord[1]}</div>`;
                                            }
                                            html += `</div>`;
                                            return html;
                                        }
                                    }
                                }
                            },
                            {
                                name: 'Volume',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: volumes.map(item => item[1]),
                                itemStyle: {
                                    color: (params) => {
                                        return klineData[params.dataIndex][0] < klineData[params.dataIndex][1] ? '#EF4444' : '#10B981';
                                    }
                                }
                            }
                        ]
                    };

                    chartInstance.setOption(option);
                    window.addEventListener('resize', () => chartInstance.resize());
                };

                const getRecommendations = async () => {
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    loadingRecommend.value = true;
                    recommendationResult.value = null;
                    try {
                        // Create async task
                        const res = await fetch('/api/recommend_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({
                                ...recCriteria.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            // Show task list and add animation
                            taskListVisible.value = true;
                            await loadTasks();
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                recommendationResult.value = result;
                                loadingRecommend.value = false;
                            });
                        } else {
                            throw new Error(data.error || 'Failed to create task');
                        }
                    } catch (err) {
                        alert('æ¨èè¯·æ±‚å¤±è´¥: ' + err);
                        console.error(err);
                        loadingRecommend.value = false;
                    }
                };

                const diagnosePortfolio = async () => {
                    if(!portfolio.value.symbol) return;
                    if (!currentUser.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    creatingTask.value = true;
                    loadingPortfolio.value = true; 
                    portfolioResult.value = null;
                    
                    showToast(
                        currentLanguage.value === 'zh' ? `æ­£åœ¨åˆ›å»ºæŒä»“è¯Šæ–­ä»»åŠ¡ï¼š${portfolio.value.symbol}` : `Creating portfolio diagnosis task: ${portfolio.value.symbol}`,
                        'info',
                        2000
                    );
                    
                    try {
                        // Create async task
                        const res = await fetch('/api/portfolio_advice_async', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Session-ID': sessionId.value
                            },
                            body: JSON.stringify({
                                ...portfolio.value,
                                model: selectedModel.value,
                                language: currentLanguage.value
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast(
                                currentLanguage.value === 'zh' ? `è¯Šæ–­ä»»åŠ¡å·²åˆ›å»ºï¼š${portfolio.value.symbol}` : `Diagnosis task created: ${portfolio.value.symbol}`,
                                'success',
                                3000
                            );
                            
                            // Show task list and add animation
                            taskListVisible.value = true;
                            await new Promise(resolve => setTimeout(resolve, 300));
                            await loadTasks();
                            
                            // Poll for completion
                            pollTaskUntilComplete(data.task_id, (result) => {
                                portfolioResult.value = result;
                                loadingPortfolio.value = false;
                                showToast(
                                    currentLanguage.value === 'zh' ? `ğŸ‰ æŒä»“è¯Šæ–­å®Œæˆï¼š${portfolio.value.symbol}` : `ğŸ‰ Portfolio diagnosis completed: ${portfolio.value.symbol}`,
                                    'success',
                                    3000
                                );
                            });
                        } else {
                            throw new Error(data.error || 'Failed to create task');
                        }
                    } catch (err) {
                        showToast(
                            currentLanguage.value === 'zh' ? `âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${err.message}` : `âŒ Failed to create task: ${err.message}`,
                            'error',
                            4000
                        );
                        console.error(err);
                        loadingPortfolio.value = false;
                    } finally {
                        creatingTask.value = false;
                    }
                };
                
                // ========== User Authentication Functions ==========
                
                const checkAuth = async () => {
                    if (!sessionId.value) {
                        showLoginModal.value = true;
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/auth/check?session_id=${sessionId.value}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.authenticated) {
                                currentUser.value = data.user;
                                return;
                            }
                        }
                    } catch (err) {
                        console.error('Auth check failed:', err);
                    }
                    
                    // Not authenticated, show login modal
                    showLoginModal.value = true;
                };
                
                const handleLogin = async () => {
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nickname: loginForm.value.nickname,
                                email: loginForm.value.email,
                                session_id: sessionId.value
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            currentUser.value = data.user;
                            sessionId.value = data.user.session_id;
                            localStorage.setItem('investPilotSessionId', sessionId.value);
                            showLoginModal.value = false;
                            loginForm.value = { nickname: '', email: '' };
                            
                            // Load tasks and start polling
                            loadTasks();
                            startTaskPolling();
                        } else {
                            alert(data.error || 'ç™»å½•å¤±è´¥');
                        }
                    } catch (err) {
                        alert('ç™»å½•å¤±è´¥: ' + err);
                        console.error(err);
                    }
                };
                
                // ========== Task Management Functions ==========
                
                const loadTasks = async () => {
                    if (!currentUser.value) return;
                    
                    try {
                        const res = await fetch('/api/tasks', {
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            tasks.value = data.tasks || [];
                        } else {
                            const errorData = await res.json().catch(() => ({}));
                            console.error('Failed to load tasks:', errorData.error || res.statusText);
                        }
                    } catch (err) {
                        console.error('Failed to load tasks:', err);
                    }
                };
                
                const startTaskPolling = () => {
                    if (taskPollInterval) return;
                    taskPollInterval = setInterval(() => {
                        if (currentUser.value) {
                            // Always poll if there are running tasks, or if we just created a task
                            loadTasks();
                        }
                    }, 2000); // Poll every 2 seconds
                };
                
                const stopTaskPolling = () => {
                    if (taskPollInterval) {
                        clearInterval(taskPollInterval);
                        taskPollInterval = null;
                    }
                };
                
                const pollTaskUntilComplete = async (taskId, callback) => {
                    const maxAttempts = 300; // 10 minutes max
                    let attempts = 0;
                    
                    const poll = async () => {
                        try {
                            const res = await fetch(`/api/tasks/${taskId}`, {
                                headers: { 'X-Session-ID': sessionId.value }
                            });
                            if (res.ok) {
                                const task = await res.json();
                                if (task.status === 'completed') {
                                    callback(task.task_result);
                                    loadTasks(); // Refresh task list
                                    return;
                                } else if (task.status === 'failed' || task.status === 'terminated') {
                                    loadTasks(); // Refresh task list
                                    return;
                                }
                            }
                        } catch (err) {
                            console.error('Task poll error:', err);
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 2000);
                        }
                    };
                    
                    poll();
                };
                
                const terminateTask = async (taskId) => {
                    if (!confirm(currentLanguage.value === 'zh' ? 'ç¡®å®šè¦ç»ˆæ­¢æ­¤ä»»åŠ¡å—ï¼Ÿ' : 'Are you sure you want to terminate this task?')) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/tasks/${taskId}/terminate`, {
                            method: 'POST',
                            headers: { 'X-Session-ID': sessionId.value }
                        });
                        if (res.ok) {
                            await loadTasks();
                        } else {
                            alert(currentLanguage.value === 'zh' ? 'ç»ˆæ­¢ä»»åŠ¡å¤±è´¥' : 'Failed to terminate task');
                        }
                    } catch (err) {
                        alert('ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ' + err);
                        console.error(err);
                    }
                };
                
                const showTaskResult = (task) => {
                    if (!task.task_result) return;
                    
                    const result = task.task_result;
                    
                    // Determine task type and show appropriate result
                    if (task.task_type === 'kline_analysis') {
                        // Switch to analysis tab and show result
                        currentTab.value = 'analysis';
                        analysisResult.value = result;
                        query.value = result.symbol || '';
                        nextTick(() => {
                            if (chartRef.value) {
                                initChart(result);
                            }
                        });
                        taskListVisible.value = false; // Close task list
                    } else if (task.task_type === 'portfolio_diagnosis') {
                        // Switch to portfolio tab and show result
                        currentTab.value = 'portfolio';
                        portfolioResult.value = result;
                        if (task.task_params && task.task_params.symbol) {
                            portfolio.value.symbol = task.task_params.symbol;
                        }
                        taskListVisible.value = false; // Close task list
                    } else if (task.task_type === 'stock_recommendation') {
                        // Switch to recommend tab and show result
                        currentTab.value = 'recommend';
                        recommendationResult.value = result;
                        taskListVisible.value = false; // Close task list
                    }
                };
                
                const getTaskStatusLabel = (status) => {
                    const labels = {
                        'running': currentLanguage.value === 'zh' ? 'è¿è¡Œä¸­' : 'Running',
                        'completed': currentLanguage.value === 'zh' ? 'å·²å®Œæˆ' : 'Completed',
                        'terminated': currentLanguage.value === 'zh' ? 'å·²ç»ˆæ­¢' : 'Terminated',
                        'failed': currentLanguage.value === 'zh' ? 'å¤±è´¥' : 'Failed'
                    };
                    return labels[status] || status;
                };
                
                const getTaskTypeLabel = (type) => {
                    const labels = {
                        'kline_analysis': currentLanguage.value === 'zh' ? 'Kçº¿åˆ†æ' : 'K-Line Analysis',
                        'portfolio_diagnosis': currentLanguage.value === 'zh' ? 'æŒä»“è¯Šæ–­' : 'Portfolio Diagnosis',
                        'stock_recommendation': currentLanguage.value === 'zh' ? 'è‚¡ç¥¨æ¨è' : 'Stock Recommendation'
                    };
                    return labels[type] || type;
                };
                
                const getTaskTitle = (task) => {
                    if (task.task_params) {
                        if (task.task_type === 'kline_analysis' && task.task_params.symbol) {
                            return task.task_params.symbol;
                        } else if (task.task_type === 'portfolio_diagnosis' && task.task_params.symbol) {
                            return `${task.task_params.symbol} - ${currentLanguage.value === 'zh' ? 'æŒä»“è¯Šæ–­' : 'Portfolio Diagnosis'}`;
                        } else if (task.task_type === 'stock_recommendation') {
                            return currentLanguage.value === 'zh' ? 'è‚¡ç¥¨æ¨è' : 'Stock Recommendation';
                        }
                    }
                    return getTaskTypeLabel(task.task_type);
                };
                
                const formatTime = (timeStr) => {
                    if (!timeStr) return '';
                    const date = new Date(timeStr);
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    
                    if (minutes < 1) {
                        return currentLanguage.value === 'zh' ? 'åˆšåˆš' : 'Just now';
                    } else if (minutes < 60) {
                        return `${minutes}${currentLanguage.value === 'zh' ? 'åˆ†é’Ÿå‰' : 'm ago'}`;
                    } else if (hours < 24) {
                        return `${hours}${currentLanguage.value === 'zh' ? 'å°æ—¶å‰' : 'h ago'}`;
                    } else {
                        return `${days}${currentLanguage.value === 'zh' ? 'å¤©å‰' : 'd ago'}`;
                    }
                };
                
                const handleDuplicateTaskChoice = async (choice) => {
                    showDuplicateTaskDialog.value = false;
                    const symbol = pendingAnalysisSymbol.value;
                    pendingAnalysisSymbol.value = null;
                    
                    if (choice === 'wait') {
                        // ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ
                        showToast(
                            currentLanguage.value === 'zh' ? 'æ­£åœ¨ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ...' : 'Waiting for existing task to complete...',
                            'info',
                            2000
                        );
                        
                        // æ‰“å¼€ä»»åŠ¡åˆ—è¡¨
                        taskListVisible.value = true;
                        await loadTasks();
                        
                        // æ‰¾åˆ°ç°æœ‰ä»»åŠ¡å¹¶è½®è¯¢
                        const existingTask = tasks.value.find(t => t.task_id === duplicateTaskInfo.value.task_id);
                        if (existingTask) {
                            pollTaskUntilComplete(existingTask.task_id, (result) => {
                                analysisResult.value = result;
                                expandedTrades.value = {};
                                if (result.analysis && result.analysis.analysis_summary && result.analysis.analysis_summary.includes('Quota Exceeded')) {
                                    const m = models.value.find(m => m.id === selectedModel.value);
                                    if (m) m.status = 'limit';
                                }
                                
                                showToast(
                                    currentLanguage.value === 'zh' ? `ğŸ‰ åˆ†æå®Œæˆï¼š${symbol}` : `ğŸ‰ Analysis completed: ${symbol}`,
                                    'success',
                                    3000
                                );
                                
                                nextTick(() => {
                                    if (chartRef.value) {
                                        initChart(result);
                                    }
                                });
                            });
                        }
                    } else if (choice === 'cancel') {
                        // å–æ¶ˆç°æœ‰ä»»åŠ¡å¹¶åˆ›å»ºæ–°ä»»åŠ¡
                        try {
                            // å…ˆç»ˆæ­¢ç°æœ‰ä»»åŠ¡
                            const res = await fetch(`/api/tasks/${duplicateTaskInfo.value.task_id}/terminate`, {
                                method: 'POST',
                                headers: { 'X-Session-ID': sessionId.value }
                            });
                            
                            if (res.ok) {
                                showToast(
                                    currentLanguage.value === 'zh' ? 'å·²å–æ¶ˆç°æœ‰ä»»åŠ¡ï¼Œæ­£åœ¨åˆ›å»ºæ–°ä»»åŠ¡...' : 'Cancelled existing task, creating new...',
                                    'info',
                                    2000
                                );
                                
                                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ä»»åŠ¡å·²ç»ˆæ­¢
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                // é‡æ–°è°ƒç”¨åˆ†æ
                                await analyzeStock(symbol);
                            } else {
                                throw new Error('Failed to terminate existing task');
                            }
                        } catch (err) {
                            showToast(
                                currentLanguage.value === 'zh' ? `âŒ å–æ¶ˆä»»åŠ¡å¤±è´¥ï¼š${err.message}` : `âŒ Failed to cancel task: ${err.message}`,
                                'error',
                                4000
                            );
                        }
                    }
                };
                
                const closeDisclaimer = () => {
                    showDisclaimer.value = false;
                    localStorage.setItem('disclaimerDismissed', 'true');
                };

                return {
                    currentTab,
                    currentLanguage,
                    recCriteria,
                    recommendationResult,
                    portfolio,
                    portfolioResult,
                    getRecommendations,
                    diagnosePortfolio,
                    query,
                    suggestions,
                    loadingAnalysis,
                    loadingRecommend,
                    loadingPortfolio,
                    analysisResult,
                    chartRef,
                    handleSearch,
                    selectStock,
                    analyzeStock,
                    stats,
                    models,
                    availableModels,
                    selectedModel,
                    selectedModelName,
                    currentModelStatus,
                    expandedTrades,
                    toggleTrade,
                    hotStocks,
                    loadingHotStocks,
                    marketNews,
                    loadingMarketNews,
                    // User Auth
                    currentUser,
                    showLoginModal,
                    loginForm,
                    handleLogin,
                    // Task Management
                    tasks,
                    taskListVisible,
                    taskFilterStatus,
                    taskStatusFilters,
                    filteredTasks,
                    runningTasksCount,
                    terminateTask,
                    showTaskResult,
                    getTaskStatusLabel,
                    getTaskTypeLabel,
                    getTaskTitle,
                    formatTime,
                    // Draggable Button
                    taskButtonRef,
                    taskButtonPosition,
                    isDragging,
                    startDrag,
                    // Toast
                    toastMessage,
                    toastType,
                    // Duplicate Task Dialog
                    showDuplicateTaskDialog,
                    duplicateTaskInfo,
                    handleDuplicateTaskChoice,
                    // Loading States
                    creatingTask,
                    // Disclaimer
                    showDisclaimer,
                    closeDisclaimer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

